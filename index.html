<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Mappa Verona – SpG</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map { position:absolute; inset:0; background:#050505; }

/* BANNER ALTO COMUNE SELEZIONATO */
#banner{
  position:fixed;
  top:0;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  padding:8px 18px;
  border-bottom:3px solid #00ff9c;
  color:#fff;
  font-size:13px;
  display:none;
  z-index:9999;
}

/* HUD COLONNA SINISTRA */
#hud {
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 9998;
  padding: 14px 16px;
  background: rgba(5,5,5,.94);
  border-left: 4px solid #00ff9c;
  min-width: 340px;
  box-shadow: 0 0 20px rgba(0,0,0,.85);
  max-height: calc(100vh - 36px);
  overflow: auto;
}

.hud-title {
  font-size: 18px;
  font-weight: 650;
  color: #fff;
  text-transform: uppercase;
}
.hud-sub {
  margin-top: 6px;
  font-size: 13px;
  color: #bdbdbd;
}

/* contatori comuni (GLOBALI) */
#statsLabel{
  margin-top: 10px;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #9ef5d9;
}
#stats {
  margin-top: 8px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.stat {
  background: #0e0e0e;
  padding: 8px;
}
.stat-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #cfcfcf;
}
.stat-value {
  font-size: 26px;
  font-weight: 700;
}
.stat-ok .stat-value { color:#00ff9c; }
.stat-warn .stat-value { color:#ffaa00; }

/* sezione per comune selezionato */
.box {
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid #222;
}
.box h4 {
  margin: 0 0 6px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #9ef5d9;
}
.box .count {
  font-size: 12px;
  margin-bottom: 6px;
  color: #e6e6e6;
}

/* LEGENDA COMPLETA */
#legend-box {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #222;
}
#legend-box h4 {
  margin: 6px 0 4px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #cccccc;
}

.legend-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  margin-bottom: 2px;
  color:#e6e6e6;
}

.dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}
.triangle {
  width: 0; height: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-bottom: 12px solid;
}
.square {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

/* colori stato strutture */
.accetta { background:#00ff9c; border-bottom-color:#00ff9c; }
.in_trattativa { background:#4da6ff; border-bottom-color:#4da6ff; }
.da_contattare { background:#ffaa00; border-bottom-color:#ffaa00; }
.rifiuta { background:#ff4d4d; border-bottom-color:#ff4d4d; }

/* colori legenda comuni */
.leg-coperto { background:#00ff9c; }
.leg-orfano { background:#ffaa00; }

/* “bastoncino con pallino” per MMG / Studi */
.mmg-pin {
  position: relative;
  width: 18px;
  height: 32px;
}
.mmg-pin .stem{
  position:absolute;
  left:50%;
  top:14px;
  transform:translateX(-50%);
  width:2px;
  height:18px;
  background: rgba(255,255,255,0.85);
  border-radius: 2px;
}
.mmg-pin .head{
  position:absolute;
  left:50%;
  top:0;
  transform:translateX(-50%);
  width:14px;
  height:14px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.9);
  box-shadow: 0 0 8px rgba(0,0,0,0.6);
}
.mmg-pin .plus{
  position:absolute;
  left:50%;
  top:0;
  transform:translate(-50%, 0);
  width:14px;
  height:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:12px;
  color:#050505;
}

/* buttons referenti */
.hud-buttons {
  margin-top: 12px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.hud-btn {
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:11px;
  padding:6px 10px;
  cursor:pointer;
  border-radius: 4px;
}
.hud-btn:hover {
  background:#00ff9c;
  color:#00110b;
}

/* pannello referenti */
.hud-section {
  margin-top: 10px;
  border-top: 1px solid #222;
  padding-top: 6px;
  display: none;
}
.hud-section ul{
  margin: 6px 0 0;
  padding-left: 18px;
}
.hud-section li {
  font-size: 12px;
  color: #fff;
  margin: 4px 0;
}

/* label comuni */
.label-comune {
  color: #ffffff;
  font-size: 11px;
  text-shadow: 0 0 6px rgba(0,0,0,.9);
  pointer-events: none;
}

.leaflet-interactive { cursor:pointer }

/* mobile */
@media (max-width: 520px){
  #hud{
    left: 10px;
    top: 10px;
    min-width: unset;
    width: calc(100vw - 20px);
    max-height: 48vh;
  }
  #banner{
    width: calc(100vw - 20px);
    left: 10px;
    transform:none;
    text-align:center;
  }
}
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div id="statsLabel">Statistiche globali</div>
  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
  </div>

  <div class="box" id="selBox">
    <h4>Comune selezionato</h4>
    <div class="count" id="selSummary">Seleziona un comune</div>
  </div>

  <div class="box" id="farmBox">
    <h4>Farmacie (comune selezionato)</h4>
    <div class="count" id="farmCount">—</div>
  </div>

  <div class="box" id="mmgBox">
    <h4>Studi MMG (comune selezionato)</h4>
    <div class="count" id="mmgCount">—</div>
  </div>

  <div id="legend-box">
    <h4>Legenda comuni</h4>
    <div class="legend-row">
      <span class="square leg-coperto"></span> Comune con referenti
    </div>
    <div class="legend-row">
      <span class="square leg-orfano"></span> Comune orfano
    </div>

    <h4>Legenda stato</h4>
    <div class="legend-row"><span class="dot accetta"></span> Aderisce / favorevole</div>
    <div class="legend-row"><span class="dot in_trattativa"></span> In trattativa</div>
    <div class="legend-row"><span class="dot da_contattare"></span> Da contattare</div>
    <div class="legend-row"><span class="dot rifiuta"></span> Contrario / rifiuta</div>

    <h4>Legenda farmacie</h4>
    <div class="legend-row"><span class="dot accetta"></span> Privata</div>
    <div class="legend-row"><span class="triangle accetta"></span> Comunale</div>

    <h4>Legenda MMG / Studi</h4>
    <div class="legend-row">
      <span class="mmg-pin"><span class="stem"></span><span class="head accetta"></span><span class="plus">✚</span></span>
      Studio MMG (colori = stato)
    </div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAdd">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggle">Vedi referenti</button>
  </div>

  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* =========================
   MAPPA BASE
========================= */
const map = L.map('map',{ attributionControl:false }).setView([45.43,10.99],10);

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  { maxZoom:18 }
).addTo(map);

/* =========================
   DATI IN MEMORIA (provvisori)
   - Referenti: modificabili in tempo reale (RAM)
   - Stato farmacie/MMG: per ora default "da_contattare" (RAM)
========================= */
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm";

const referenti = {
  "Verona": ["Vincenzo R."]
};

// Dataset (da CSV)
let farmacieAll = [];
let mmgAll = [];

/* =========================
   LAYER
========================= */
const farmLayer = L.layerGroup().addTo(map);
const mmgLayer  = L.layerGroup().addTo(map);

const layersByNome = {};
let labels = [];
let comuni = [];
let selectedLayer = null;
let selectedNome = null;
let selectedZoom = null;
let refVisibili = false;

/* =========================
   HUD/BANNER refs
========================= */
const hudTitle    = document.getElementById('hudTitle');
const hudSub      = document.getElementById('hudSub');
const selSummary  = document.getElementById('selSummary');
const refPanel    = document.getElementById('refPanel');
const refList     = document.getElementById('refList');
const btnToggle   = document.getElementById('btnToggle');
const banner      = document.getElementById('banner');
const farmCountEl = document.getElementById('farmCount');
const mmgCountEl  = document.getElementById('mmgCount');

/* helpers */
const nomeComune = p => (p?.nome || p?.DENOM_COM || p?.name || 'Comune').toString().trim();
const norm = s => (s ?? '').toString().trim().toUpperCase();
const hasRef = n => Array.isArray(referenti[n]) && referenti[n].length > 0;

function safeHtml(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}

/* =========================
   CONTATORI GLOBALI
========================= */
function aggiornaContatori(){
  const coperti = comuni.filter(n => hasRef(n)).length;
  const orfani  = Math.max(0, comuni.length - coperti);
  document.getElementById('cntOk').innerText     = coperti;
  document.getElementById('cntOrfani').innerText = orfani;
}

/* =========================
   STILI COMUNI
========================= */
function aggiornaStiliComuni(){
  Object.keys(layersByNome).forEach(n => {
    const layer = layersByNome[n];
    const ref   = hasRef(n);
    const base = {
      color: ref ? '#00ff9c' : '#ffaa00',
      weight: 1,
      fillColor: ref ? '#00ff9c' : '#000000',
      fillOpacity: ref ? 0.10 : 0   // verde meno intenso
    };
    if (selectedLayer && layer === selectedLayer){
      layer.setStyle({
        ...base,
        color:'#ffffff',
        weight:3,
        fillOpacity: base.fillOpacity // NON riempio extra quando seleziono
      });
    } else {
      layer.setStyle(base);
    }
  });
}

/* =========================
   LABEL COMUNI (zoom out)
========================= */
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    if(!selectedLayer && z >= 9 && z <= 13){
      if(!map.hasLayer(l)) map.addLayer(l);
    } else {
      if(map.hasLayer(l)) map.removeLayer(l);
    }
  });
}

/* =========================
   RESET SELEZIONE
========================= */
function resetSelezione(){
  selectedLayer = null;
  selectedNome = null;
  selectedZoom = null;

  hudTitle.innerText = 'Provincia di Verona';
  hudSub.innerText   = 'Vista generale';
  selSummary.innerText = 'Seleziona un comune';

  farmLayer.clearLayers();
  mmgLayer.clearLayers();
  farmCountEl.innerText = '—';
  mmgCountEl.innerText  = '—';

  refPanel.style.display = 'none';
  refVisibili = false;
  btnToggle.innerText = 'Vedi referenti';

  banner.style.display = 'none';

  aggiornaStiliComuni();
  aggiornaLabels();
}

/* =========================
   CARICA CSV (PapaParse)
========================= */
function loadCSV(url){
  return fetch(url, {cache: "no-store"})
    .then(r => {
      if(!r.ok) throw new Error("Impossibile caricare " + url + " ("+r.status+")");
      return r.text();
    })
    .then(txt => new Promise((resolve, reject) => {
      Papa.parse(txt, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        complete: (res) => resolve(res.data),
        error: (err) => reject(err)
      });
    }));
}

function num(x){
  const v = parseFloat((x ?? '').toString().replace(',','.'));
  return Number.isFinite(v) ? v : null;
}

/* farmacie: normalizza campi */
function parseCoordCell(cell){
  if(cell === null || cell === undefined) return {lat:null, lon:null};
  const s = String(cell).trim();
  if(!s) return {lat:null, lon:null};

  // Estrai numeri (supporta virgola decimale)
  const nums = s
    .replace(/;/g, ',')
    .split(',')
    .map(x => x.trim())
    .filter(Boolean)
    .slice(0,2)
    .map(x => parseFloat(String(x).replace(',', '.')));

  let lat = nums.length ? nums[0] : NaN;
  let lon = nums.length>1 ? nums[1] : NaN;

  // fallback: regex (se il formato è "lat lon")
  if(!(isFinite(lat) && isFinite(lon))){
    const m = s.match(/-?\d+(?:[\.,]\d+)?/g);
    if(m && m.length>=2){
      lat = parseFloat(m[0].replace(',', '.'));
      lon = parseFloat(m[1].replace(',', '.'));
    }
  }

  if(!(isFinite(lat) && isFinite(lon))) return {lat:null, lon:null};

  // sanity check Verona-ish: se invertite, swap
  const LAT_OK = (x)=> x >= 44.7 && x <= 46.2;
  const LON_OK = (x)=> x >= 9.8 && x <= 11.9;
  if(!LAT_OK(lat) && !LON_OK(lon) && LAT_OK(lon) && LON_OK(lat)){
    const t=lat; lat=lon; lon=t;
  }

  return {lat, lon};
}

function normalizeFarmacia(r){
  // ✅ Header definitivo: coordinate + maps_url
  const c = parseCoordCell(r.coordinate ?? r.Coordinate ?? r.COORDINATE);
  const lat = (c.lat ?? null);
  const lon = (c.lon ?? null);

  const nome = (r.descrizione_farmacia || r.denominazione || r.nome || r.farmacia || 'Farmacia').toString().trim();
  const comune = (r.comune || r.Comune || '').toString().trim();
  const indirizzo = (r.indirizzo || r.Indirizzo || r.indirizzo_full || '').toString().trim();
  const tel = (r.tel || r.telefono || r.Telefono || '').toString().trim();

  // gestione: nel tuo csv è già "Privata" / "Comunale"
  const gestioneRaw = (r.gestione || r.Gestione || '').toString().trim().toLowerCase();
  const tipo = gestioneRaw.includes('comun') ? 'comunale' : 'privata';

  const maps = (r.maps_url || '').toString().trim();

  return {
    nome, comune, indirizzo, tel,
    lat, lon,
    tipo,
    stato: 'da_contattare',
    maps_url: maps
  };
}
/* MMG: normalizza campi */
function normalizeMMG(r){
  const lat = num(r.lat);
  const lon = num(r.lon);
  const comune = (r.comune || '').toString().trim();
  const indirizzo = (r.indirizzo || '').toString().trim();
  const maps = (r.maps_url || '').toString().trim();

  return {
    studio_id: (r.studio_id || '').toString().trim(),
    comune,
    indirizzo,
    tipo_studio: (r.tipo_studio || '').toString().trim(),
    numero_medici: (r.numero_medici || '').toString().trim(),
    nomi_medici: (r.nomi_medici || '').toString().trim(),
    telefoni: (r.telefoni || '').toString().trim(),
    orari_per_medico: (r.orari_per_medico || '').toString(),
    lat, lon,
    stato: 'da_contattare',
    maps_url: maps
  };
}

/* =========================
   ICONS
========================= */
function iconFarmacia(stato, tipo){
  const html = (tipo === 'comunale')
    ? `<div class="triangle ${stato}"></div>`
    : `<div class="dot ${stato}"></div>`;

  return L.divIcon({
    html,
    iconSize: [14,14],
    className: ''
  });
}

function iconMMG(stato){
  // “bastoncino + pallino” (lollipop)
  const html = `
    <div class="mmg-pin">
      <span class="stem"></span>
      <span class="head ${stato}"></span>
      <span class="plus">✚</span>
    </div>
  `;
  return L.divIcon({
    html,
    iconSize: [18,32],
    iconAnchor: [9,32],
    className: ''
  });
}

/* =========================
   POPUP builders
========================= */
function popupFarmacia(f){
  const titolo = `<strong>${safeHtml(f.nome)}</strong>`;
  const sotto  = `${safeHtml(f.indirizzo)}<br>${safeHtml(f.comune)}`;
  const tipo   = (f.tipo === 'comunale') ? 'Farmacia comunale' : 'Farmacia privata';

  const tel = f.tel ? `<br>Tel: ${safeHtml(f.tel)}` : '';
  const maps = f.maps_url ? `<a href="${f.maps_url}" target="_blank" rel="noopener">Apri in Google Maps</a>` : '';
  const drive = `<a href="${DRIVE_MATERIALI}" target="_blank" rel="noopener">Materiali campagna</a>`;

  return `${titolo}<br>${tipo}<br>${sotto}${tel}<br>${maps}<br>${drive}`;
}

function popupMMG(s){
  const titolo = `<strong>Studio MMG</strong>`;
  const sotto  = `${safeHtml(s.indirizzo)}<br>${safeHtml(s.comune)}`;
  const badge  = s.tipo_studio ? `<br><em>${safeHtml(s.tipo_studio)}</em>` : '';
  const nmed   = s.numero_medici ? `<br>Medici: <b>${safeHtml(s.numero_medici)}</b>` : '';
  const nomi   = s.nomi_medici ? `<br>${safeHtml(s.nomi_medici).replaceAll(' | ','<br>')}` : '';
  const tels   = s.telefoni ? `<br><small>${safeHtml(s.telefoni).replaceAll(' | ','<br>')}</small>` : '';
  const orari  = s.orari_per_medico
    ? `<br><br><b>Orari</b><br><small>${safeHtml(s.orari_per_medico).replaceAll('\n','<br>')}</small>`
    : '';

  const maps = s.maps_url ? `<br><br><a href="${s.maps_url}" target="_blank" rel="noopener">Apri in Google Maps</a>` : '';
  const drive = `<br><a href="${DRIVE_MATERIALI}" target="_blank" rel="noopener">Materiali campagna</a>`;

  return `${titolo}<br>${sotto}${badge}${nmed}${nomi}${tels}${orari}${maps}${drive}`;
}

/* =========================
   MOSTRA PUNTI PER COMUNE
========================= */
function mostraPuntiPerComune(comuneNome){
  const key = norm(comuneNome);

  // farmacie
  farmLayer.clearLayers();
  const farmVis = farmacieAll.filter(f => norm(f.comune) === key && f.lat != null && f.lon != null);
  farmCountEl.innerText = `${farmVis.length} farmacie`;
  farmVis.forEach(f => {
    const m = L.marker([f.lat, f.lon], { icon: iconFarmacia(f.stato, f.tipo) })
      .bindPopup(popupFarmacia(f));
    farmLayer.addLayer(m);
  });

  // mmg
  mmgLayer.clearLayers();
  const mmgVis = mmgAll.filter(s => norm(s.comune) === key && s.lat != null && s.lon != null);
  const mmgNoCoord = mmgAll.filter(s => norm(s.comune) === key && (s.lat == null || s.lon == null)).length;
  mmgCountEl.innerText = mmgNoCoord > 0
    ? `${mmgVis.length} studi (+${mmgNoCoord} senza coordinate)`
    : `${mmgVis.length} studi`;

  mmgVis.forEach(s => {
    const m = L.marker([s.lat, s.lon], { icon: iconMMG(s.stato) })
      .bindPopup(popupMMG(s));
    mmgLayer.addLayer(m);
  });
}

/* =========================
   SELEZIONE COMUNE
========================= */
function selezionaComune(layer, nome){
  selectedLayer = layer;
  selectedNome = nome;
  selectedZoom = null;

  aggiornaStiliComuni();

  // zoom sul comune
  map.fitBounds(layer.getBounds(), { padding:[40,40] });
  // registra lo zoom “di dettaglio” dopo il fitBounds (serve per far ricomparire i nomi appena fai zoom-out)
  setTimeout(() => { selectedZoom = map.getZoom(); }, 0);

  const nRef = (referenti[nome] ? referenti[nome].length : 0);
  hudTitle.innerText = 'Comune di ' + nome;
  hudSub.innerText   = hasRef(nome) ? ('Referenti presenti: ' + nRef) : '⚠ Comune orfano';
  selSummary.innerText = hasRef(nome) ? (`Referenti: ${nRef}`) : 'Comune orfano (nessun referente)';

  // nascondi labels
  labels.forEach(l => { if(map.hasLayer(l)) map.removeLayer(l); });

  // banner
  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + safeHtml(nome) + '</b> – Referenti: ' + nRef;

  // punti
  mostraPuntiPerComune(nome);

  // referenti panel se aperto
  if(refVisibili){
    mostraReferenti(nome);
  }
}

/* =========================
   REFERENTI
========================= */
function mostraReferenti(nome){
  refList.innerHTML = '';
  const lista = referenti[nome] || [];
  lista.forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = (lista.length > 0) ? 'block' : 'none';
}

document.getElementById('btnAdd').onclick = () => {
  if(!selectedNome){
    alert('Seleziona prima un comune sulla mappa');
    return;
  }
  const n = prompt('Inserisci il tuo nome (comparirà come referente)');
  if(!n) return;

  if(!referenti[selectedNome]) referenti[selectedNome] = [];
  referenti[selectedNome].push(n.trim());

  // aggiornamenti UI + stili
  const nRef = referenti[selectedNome].length;
  hudSub.innerText = 'Referenti presenti: ' + nRef;
  selSummary.innerText = `Referenti: ${nRef}`;
  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + safeHtml(selectedNome) + '</b> – Referenti: ' + nRef;

  aggiornaContatori();
  aggiornaStiliComuni();

  if(refVisibili){
    mostraReferenti(selectedNome);
  }
};

document.getElementById('btnToggle').onclick = () => {
  if(!selectedNome){
    alert('Seleziona prima un comune sulla mappa');
    return;
  }
  refVisibili = !refVisibili;
  btnToggle.innerText = refVisibili ? 'Nascondi referenti' : 'Vedi referenti';

  if(refVisibili){
    mostraReferenti(selectedNome);
  } else {
    refPanel.style.display = 'none';
  }
};

/* =========================
   COMUNI + CSV bootstrap
========================= */
Promise.all([
  loadCSV('data/farmacie.csv'),
  loadCSV('data/mmg2025.csv')
]).then(([farmRows, mmgRows]) => {
  farmacieAll = farmRows.map(normalizeFarmacia);
  mmgAll      = mmgRows.map(normalizeMMG);

  // COMUNI
  return fetch('data/comuni_verona.json', {cache:"no-store"}).then(r => r.json());
}).then((geo) => {

  const layer = L.geoJSON(geo, {
    style: (f) => {
      const n = nomeComune(f.properties);
      if(!comuni.includes(n)) comuni.push(n);
      const ref = hasRef(n);
      return {
        color: ref ? '#00ff9c' : '#ffaa00',
        weight: 1,
        fillColor: ref ? '#00ff9c' : '#000000',
        fillOpacity: ref ? 0.10 : 0
      };
    },
    onEachFeature: (f, l) => {
      const nome = nomeComune(f.properties);
      layersByNome[nome] = l;

      const center = l.getBounds().getCenter();
      const label = L.marker(center,{
        icon: L.divIcon({ className:'label-comune', html: safeHtml(nome), iconSize:[120,16] }),
        interactive:false
      });
      labels.push(label);
      label.addTo(map);

      l.on('click', () => selezionaComune(l, nome));
    }
  }).addTo(map);

  map.fitBounds(layer.getBounds());
  aggiornaContatori();
  aggiornaStiliComuni();
  aggiornaLabels();

  // zoom behavior: appena fai zoom-out (qualsiasi), esci dalla selezione e ri-mostri i nomi
  map.on('zoomend', () => {
    const z = map.getZoom();
    if(selectedLayer && selectedZoom !== null && z < selectedZoom){
      resetSelezione();
      return;
    }
    aggiornaLabels();
  });

}).catch(err => {
  console.error(err);
  alert("Errore caricamento dati. Controlla che esistano: data/comuni_verona.json, data/farmacie.csv, data/mmg2025.csv");
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Verona – SpG (Farmacie + Status)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui, sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* banner alto */
#banner{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  padding:8px 18px;
  border-bottom:3px solid #00ff9c;
  color:#fff; font-size:13px;
  display:none; z-index:9999;
  max-width: calc(100% - 24px);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* HUD */
#hud{
  position:fixed; top:18px; left:18px; z-index:9998;
  padding:14px 16px;
  background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c;
  min-width:340px; max-width:440px;
  box-shadow:0 0 20px rgba(0,0,0,.85);
  max-height: calc(100vh - 36px);
  overflow:auto;
}

.hud-title{ font-size:18px; font-weight:750; color:#fff; text-transform:uppercase; }
.hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

.hud-chip{
  display:inline-block; margin-top:10px;
  font-size:10px; letter-spacing:.14em; text-transform:uppercase;
  color:#9ef5d9; background:#0e0e0e;
  padding:6px 8px; border:1px solid #1f1f1f;
}

/* cards */
#stats{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:26px; font-weight:800; }
.stat-ok .stat-value{ color:#00ff9c; }
.stat-warn .stat-value{ color:#ffaa00; }
.stat-info .stat-value{ color:#4da6ff; }
.stat-muted .stat-value{ color:#d0d0d0; }
.stat-bad .stat-value{ color:#ff4d4d; }

.small-note{ margin-top:8px; font-size:11px; color:#bdbdbd; }
.small-note .warn{ color:#ffaa00; }
.small-note .info{ color:#4da6ff; }

/* section separators */
.section{
  margin-top:14px; padding-top:10px;
  border-top:1px solid #222;
}
.section h4{
  margin:0 0 8px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#9ef5d9;
}

/* Comune selezionato */
#comuneCounts { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
#comuneTotals { font-size:12px; color:#e6e6e6; margin-bottom:8px; }

/* Farmacia selezionata tools */
.field{ margin:10px 0; }
label{ display:block; font-size:10px; letter-spacing:.12em; text-transform:uppercase; color:#bdbdbd; margin-bottom:4px; }
input[type="text"], select, textarea{
  width:100%;
  box-sizing:border-box;
  background:#0e0e0e;
  border:1px solid #1f1f1f;
  color:#e6e6e6;
  padding:8px;
  font-size:13px;
}
textarea{ min-height:72px; resize:vertical; }

.btn-row{ display:flex; gap:8px; flex-wrap:wrap; }
.btn{
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:12px;
  padding:8px 10px;
  cursor:pointer;
}
.btn:hover{ background:#00ff9c; color:#00110b; }
.btn-danger{ border-color:#ff4d4d; background:#1a0505; }
.btn-danger:hover{ background:#ff4d4d; color:#1a0505; }

.btn:disabled{
  opacity:.45;
  cursor:not-allowed;
}

/* legenda */
#legend-box h4{
  margin:10px 0 6px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#cccccc;
}
.legend-row{
  display:flex; align-items:center; gap:8px;
  font-size:11px; margin-bottom:6px;
  color:#e6e6e6;
}
.dot{ width:12px; height:12px; border-radius:50%; }
.triangle{
  width:0; height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-bottom:12px solid;
}
.square{ width:12px; height:12px; border-radius:2px; }

.st-nc{ background:#ffaa00; border-bottom-color:#ffaa00; color:#ffaa00; }
.st-tr{ background:#4da6ff; border-bottom-color:#4da6ff; color:#4da6ff; }
.st-ok{ background:#00ff9c; border-bottom-color:#00ff9c; color:#00ff9c; }
.st-bd{ background:#00d18a; border-bottom-color:#00d18a; color:#00d18a; } /* boicotta */
.st-no{ background:#ff4d4d; border-bottom-color:#ff4d4d; color:#ff4d4d; }

.note-pill{
  display:inline-block;
  font-size:10px;
  padding:2px 6px;
  border:1px solid #333;
  border-radius:999px;
  opacity:.9;
}

/* comuni labels */
.label-comune{
  color:#ffffff; font-size:11px;
  text-shadow:0 0 6px rgba(0,0,0,.9);
  pointer-events:none;
}

/* marker icons */
.mrk{ width:14px; height:14px; border-radius:50%; }
.mrk.square{ border-radius:2px; }
.mrk.muted{ opacity:.35; }

/* HUD toggle (mobile) */
#hudToggle{
  position:fixed;
  right:12px;
  bottom:12px;
  z-index:9999;
  border:1px solid #00ff9c;
  background:rgba(5,5,5,.92);
  color:#eafff7;
  padding:10px 12px;
  border-radius:12px;
  font-size:12px;
  display:none;
}

@media (max-width: 820px){
  #hud{
    left:0; right:0;
    top:auto; bottom:0;
    min-width:auto; max-width:none;
    border-left:none;
    border-top:3px solid #00ff9c;
    border-radius:16px 16px 0 0;
    max-height:60vh;
  }
  #hudToggle{ display:block; }
  #hud.hud-collapsed{
    transform: translateY(calc(100% - 64px));
  }
  #banner{ display:none !important; }
  .stat-value{ font-size:22px; }
}

/* leaf cursor */
.leaflet-interactive{ cursor:pointer; }
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>
<button id="hudToggle" type="button">Pannello</button>

<div id="hud" class="hud-collapsed">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div class="hud-chip">Globali</div>
  <div id="stats">
    <div class="stat stat-muted">
      <div class="stat-title">Farmacie totali</div>
      <div class="stat-value" id="g_tot">0</div>
    </div>
    <div class="stat stat-info">
      <div class="stat-title">Privata / Comunale</div>
      <div class="stat-value" id="g_priv_com">0 / 0</div>
    </div>

    <div class="stat stat-warn">
      <div class="stat-title">Non contattate</div>
      <div class="stat-value" id="g_nc">0</div>
    </div>
    <div class="stat stat-info">
      <div class="stat-title">In trattativa</div>
      <div class="stat-value" id="g_tr">0</div>
    </div>

    <div class="stat stat-ok">
      <div class="stat-title">Aderisce</div>
      <div class="stat-value" id="g_ok">0</div>
    </div>
    <div class="stat stat-bad">
      <div class="stat-title">Non aderisce</div>
      <div class="stat-value" id="g_no">0</div>
    </div>
  </div>

  <div class="small-note" id="loadInfo"></div>

  <div class="section">
    <h4>Comune selezionato</h4>
    <div id="comuneTotals">Farmacie: —</div>
    <div id="comuneCounts">
      <div class="stat stat-warn">
        <div class="stat-title">Non contattate</div>
        <div class="stat-value" id="c_nc">—</div>
      </div>
      <div class="stat stat-info">
        <div class="stat-title">In trattativa</div>
        <div class="stat-value" id="c_tr">—</div>
      </div>
      <div class="stat stat-ok">
        <div class="stat-title">Aderisce</div>
        <div class="stat-value" id="c_ok">—</div>
      </div>
      <div class="stat stat-bad">
        <div class="stat-title">Non aderisce</div>
        <div class="stat-value" id="c_no">—</div>
      </div>
    </div>
    <div class="small-note" id="comuneExtra"></div>
  </div>

  <div class="section">
    <h4>Farmacia selezionata</h4>
    <div class="small-note" id="selPharmLabel">Nessuna farmacia selezionata.</div>

    <div class="field">
      <label for="statoSel">Stato</label>
      <select id="statoSel" disabled>
        <option value="non_contattata">Non contattata</option>
        <option value="in_trattativa">In trattativa</option>
        <option value="aderisce_poster">Aderisce – poster/visibile</option>
        <option value="aderisce_info">Aderisce – informativa</option>
        <option value="boicotta">Aderisce – boicotta (stop fornitura)</option>
        <option value="non_aderisce">Non aderisce</option>
      </select>
    </div>

    <div class="field">
      <label for="incaricatoSel">Incaricato</label>
      <input id="incaricatoSel" type="text" placeholder="Es. Marco / Team 2" disabled />
    </div>

    <div class="field">
      <label for="noteSel">Note</label>
      <textarea id="noteSel" placeholder="Poster, BDS, note operative…" disabled></textarea>
    </div>

    <div class="btn-row">
      <button class="btn" id="btnSave" disabled>Salva</button>
      <button class="btn btn-danger" id="btnTempClose" disabled>Segna chiusa temporaneamente</button>
      <button class="btn" id="btnResetUI" type="button">Reset UI</button>
    </div>
    <div class="small-note">Lo stato è salvato nel browser (localStorage). Quando avremo il database dinamico, lo sposteremo su file/server.</div>
  </div>

  <div class="section" id="legend-box">
    <h4>Legenda gestione</h4>
    <div class="legend-row"><span class="dot st-ok"></span> Privata (cerchio)</div>
    <div class="legend-row"><span class="triangle st-ok"></span> Comunale (triangolo)</div>

    <h4>Legenda avanzamento</h4>
    <div class="legend-row"><span class="dot st-nc"></span> Non contattata</div>
    <div class="legend-row"><span class="dot st-tr"></span> In trattativa</div>
    <div class="legend-row"><span class="dot st-ok"></span> Aderisce (informativa/poster)</div>
    <div class="legend-row"><span class="dot st-bd"></span> Aderisce – boicotta</div>
    <div class="legend-row"><span class="dot st-no"></span> Non aderisce</div>

    <h4>Note</h4>
    <div class="legend-row"><span class="dot st-ok" style="opacity:.35"></span> Chiusa temporaneamente <span class="note-pill">semi-trasparente</span></div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===============================
   CONFIG
================================ */
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm";
const STATUS_KEY = "spg_farmacie_status_v1";

/* ===============================
   MAPPA BASE
================================ */
const map = L.map('map',{ attributionControl:false }).setView([45.43,10.99],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

const banner      = document.getElementById('banner');
const hudTitle    = document.getElementById('hudTitle');
const hudSub      = document.getElementById('hudSub');
const loadInfo    = document.getElementById('loadInfo');

const g_tot       = document.getElementById('g_tot');
const g_priv_com  = document.getElementById('g_priv_com');
const g_nc        = document.getElementById('g_nc');
const g_tr        = document.getElementById('g_tr');
const g_ok        = document.getElementById('g_ok');
const g_no        = document.getElementById('g_no');

const comuneTotals = document.getElementById('comuneTotals');
const comuneExtra  = document.getElementById('comuneExtra');
const c_nc        = document.getElementById('c_nc');
const c_tr        = document.getElementById('c_tr');
const c_ok        = document.getElementById('c_ok');
const c_no        = document.getElementById('c_no');

const selPharmLabel = document.getElementById('selPharmLabel');
const statoSel      = document.getElementById('statoSel');
const incaricatoSel = document.getElementById('incaricatoSel');
const noteSel       = document.getElementById('noteSel');
const btnSave       = document.getElementById('btnSave');
const btnTempClose  = document.getElementById('btnTempClose');
const btnResetUI    = document.getElementById('btnResetUI');

const hudToggle = document.getElementById('hudToggle');
hudToggle.addEventListener('click', () => {
  document.getElementById('hud').classList.toggle('hud-collapsed');
});

function isSmallScreen(){ return window.matchMedia("(max-width: 820px)").matches; }
if(!isSmallScreen()){
  document.getElementById('hud').classList.remove('hud-collapsed');
}

/* ===============================
   DATA / STATE
================================ */
const farmLayer = L.layerGroup().addTo(map);
let farmRows = []; // normalized rows
let farmById = {}; // id -> row
let farmMarkers = []; // {id, comune, marker, gestione}
let statsByComune = {}; // from farmacie_stats_comune.csv
let selectedComune = null;
let selectedPharmId = null;

function normKey(s){
  return (s || '')
    .toString()
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ');
}

let comuniCanonByNorm = {};
let layersByNome = {};
let labels = [];

function hasValue(s){ return s !== null && s !== undefined && String(s).trim() !== ''; }

/* ===============================
   STATUS STORE (localStorage)
================================ */
function loadStatus(){
  try { return JSON.parse(localStorage.getItem(STATUS_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveStatus(obj){
  try { localStorage.setItem(STATUS_KEY, JSON.stringify(obj)); }
  catch(e){}
}
let statusStore = loadStatus();
/* statusStore[pharm_id] = { stato, incaricato, note, chiusa_temp } */

/* ===============================
   ICONS
================================ */
function statoClass(stato){
  switch(stato){
    case 'in_trattativa': return 'st-tr';
    case 'aderisce_poster':
    case 'aderisce_info': return 'st-ok';
    case 'boicotta': return 'st-bd';
    case 'non_aderisce': return 'st-no';
    case 'non_contattata':
    default: return 'st-nc';
  }
}

function iconFarmacia(gestione, stato, chiusaTemp){
  const cls = statoClass(stato);
  const muted = chiusaTemp ? 'muted' : '';
  if((gestione || '').toString().toLowerCase().includes('comunal')){
    return L.divIcon({
      className:'',
      html:`<div class="triangle ${cls}" style="${chiusaTemp ? 'opacity:.35' : ''}"></div>`,
      iconSize:[14,14],
      iconAnchor:[7,7]
    });
  }
  return L.divIcon({
    className:'',
    html:`<div class="mrk ${cls} ${muted}"></div>`,
    iconSize:[14,14],
    iconAnchor:[7,7]
  });
}

/* ===============================
   MAPS LINK (popup)
   Priorità: maps_share_url > maps_url_addr > maps_url_coords > api search
================================ */
function mapsSearchUrl(query){
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
}
function getMapsUrl(row){
  const share = (row.maps_share_url || '').trim();
  if(share) return share;
  const addr = (row.maps_url_addr || '').trim();
  if(addr) return addr;
  const coords = (row.maps_url_coords || '').trim();
  if(coords) return coords;

  const q = `farmacia ${row.descrizione_farmacia || ''}, ${row.indirizzo_full || ''}, ${row.cap || ''} ${row.comune || ''}`;
  return mapsSearchUrl(q);
}

/* ===============================
   CSV parsing helpers
================================ */
function parseFloatIT(x){
  if(x === null || x === undefined) return NaN;
  const s = String(x).trim().replace(',', '.');
  return parseFloat(s);
}

/* ===============================
   COUNTERS
================================ */
function getPharmStatus(id){
  const s = statusStore[id] || {};
  return {
    stato: s.stato || 'non_contattata',
    incaricato: s.incaricato || '',
    note: s.note || '',
    chiusa_temp: !!s.chiusa_temp
  };
}

function computeCounts(filterComune=null){
  const items = farmMarkers.filter(x => !filterComune || x.comune === filterComune);

  let tot = items.length;
  let priv = 0, com = 0;

  let nc=0,tr=0,ok=0,no=0,bd=0,chiuse=0;

  items.forEach(x => {
    const row = farmById[x.id];
    const gestione = (row.gestione || '').toLowerCase();
    if(gestione.includes('comunal')) com++; else priv++;

    const st = getPharmStatus(x.id);
    if(st.chiusa_temp || (row.stato_attivita || '').toLowerCase().includes('chiusa')) chiuse++;

    switch(st.stato){
      case 'in_trattativa': tr++; break;
      case 'aderisce_poster':
      case 'aderisce_info': ok++; break;
      case 'boicotta': bd++; ok++; break; // boicotta è anche "aderisce"
      case 'non_aderisce': no++; break;
      case 'non_contattata':
      default: nc++; break;
    }
  });

  return { tot, priv, com, nc, tr, ok, no, bd, chiuse };
}

function refreshGlobalUI(){
  const c = computeCounts(null);
  g_tot.textContent = c.tot;
  g_priv_com.textContent = `${c.priv} / ${c.com}`;
  g_nc.textContent = c.nc;
  g_tr.textContent = c.tr;
  g_ok.textContent = c.ok;
  g_no.textContent = c.no;
}

function refreshComuneUI(){
  if(!selectedComune){
    comuneTotals.textContent = "Farmacie: —";
    comuneExtra.textContent = "";
    c_nc.textContent = "—";
    c_tr.textContent = "—";
    c_ok.textContent = "—";
    c_no.textContent = "—";
    return;
  }
  const c = computeCounts(selectedComune);
  comuneTotals.textContent = `Farmacie: ${c.tot}`;
  c_nc.textContent = c.nc;
  c_tr.textContent = c.tr;
  c_ok.textContent = c.ok;
  c_no.textContent = c.no;

  // extra: confronto con stats "ufficiali"
  const expected = statsByComune[normKey(selectedComune)]?.n_farmacie;
  const chiuseTemp = c.chiuse;
  let line = '';
  if(typeof expected === 'number'){
    line += `Attese (stats): ${expected} — In mappa: ${c.tot}`;
    if(expected !== c.tot) line += `  ⚠ mismatch`;
  }
  if(chiuseTemp){
    line += (line ? ' — ' : '') + `Chiuse temporaneamente: ${chiuseTemp}`;
  }
  comuneExtra.innerHTML = line ? `<span class="${(expected!==undefined && expected!==c.tot) ? 'warn' : 'info'}">${line}</span>` : '';
}

/* ===============================
   SELECTION LOGIC
================================ */
function setSelectedComune(nome){
  selectedComune = nome || null;

  if(!selectedComune){
    hudTitle.textContent = "Provincia di Verona";
    hudSub.textContent = "Vista generale";
    banner.style.display = 'none';

    farmMarkers.forEach(x => x.marker.setOpacity(1));
  } else {
    hudTitle.textContent = "Comune di " + selectedComune;
    hudSub.textContent = "Farmacie evidenziate";
    banner.style.display = 'block';
    banner.innerHTML = `↑ Comune di <b>${selectedComune}</b>`;

    farmMarkers.forEach(x => x.marker.setOpacity(x.comune === selectedComune ? 1 : 0.18));
  }

  refreshComuneUI();
}

function setSelectedPharmacy(id){
  selectedPharmId = id || null;
  if(!selectedPharmId){
    selPharmLabel.textContent = "Nessuna farmacia selezionata.";
    statoSel.disabled = true;
    incaricatoSel.disabled = true;
    noteSel.disabled = true;
    btnSave.disabled = true;
    btnTempClose.disabled = true;
    btnTempClose.textContent = "Segna chiusa temporaneamente";
    return;
  }

  const row = farmById[selectedPharmId];
  const st = getPharmStatus(selectedPharmId);

  selPharmLabel.innerHTML = `<b>${row.descrizione_farmacia || 'Farmacia'}</b><br/><span style="opacity:.9">${row.indirizzo_full || ''} — ${row.comune || ''}</span>`;
  statoSel.disabled = false;
  incaricatoSel.disabled = false;
  noteSel.disabled = false;
  btnSave.disabled = false;
  btnTempClose.disabled = false;

  statoSel.value = st.stato;
  incaricatoSel.value = st.incaricato;
  noteSel.value = st.note;

  const chiusa = st.chiusa_temp || (row.stato_attivita || '').toLowerCase().includes('chiusa');
  btnTempClose.textContent = chiusa ? "Segna riaperta" : "Segna chiusa temporaneamente";
}

/* ===============================
   UPDATE MARKER STYLE AFTER STATUS CHANGE
================================ */
function applyMarkerStyle(id){
  const row = farmById[id];
  const st = getPharmStatus(id);
  const chiusa = st.chiusa_temp || (row.stato_attivita || '').toLowerCase().includes('chiusa');
  const markerObj = farmMarkers.find(x => x.id === id);
  if(!markerObj) return;

  markerObj.marker.setIcon(iconFarmacia(row.gestione, st.stato, chiusa));

  // opacity: if comune selected, preserve dim rules
  let baseOpacity = 1;
  if(selectedComune && markerObj.comune !== selectedComune) baseOpacity = 0.18;
  if(chiusa) baseOpacity = Math.min(baseOpacity, 0.35);
  markerObj.marker.setOpacity(baseOpacity);
}

/* ===============================
   LOAD STATS (farmacie_stats_comune.csv)
================================ */
function loadStatsComune(){
  return new Promise((resolve) => {
    Papa.parse('data/farmacie_stats_comune.csv', {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete: (res) => {
        const rows = res.data || [];
        rows.forEach(r => {
          const k = normKey(r.comune);
          const n = parseInt(r.n_farmacie, 10);
          statsByComune[k] = { n_farmacie: isFinite(n) ? n : undefined };
        });
        resolve();
      },
      error: () => resolve()
    });
  });
}

/* ===============================
   LOAD FARMACIE CSV
   Colonne attese:
   - farmacia_id
   - comune
   - gestione
   - latitudine
   - longitudine
   - descrizione_farmacia
   - indirizzo_full
   - cap
   - stato_attivita
   - maps_share_url
   - maps_url_addr
================================ */
function loadFarmacie(){
  Papa.parse('data/farmacie.csv', {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete: (res) => {
      const rows = res.data || [];
      let added = 0, skipped = 0, invalid = 0, comuneMiss = 0;
      rows.forEach(r => {
        const id = (r.farmacia_id || '').toString().trim();
        const comune = (r.comune || '').toString().trim();
        if(!id || !comune){ skipped++; return; }

        const lat = parseFloatIT(r.latitudine);
        const lon = parseFloatIT(r.longitudine);
        if(!isFinite(lat) || !isFinite(lon)){ invalid++; return; }

        // canon comune (se disponibile)
        let canon = comune;
        const nrm = normKey(comune);
        if(comuniCanonByNorm[nrm]) canon = comuniCanonByNorm[nrm];
        else comuneMiss++;

        const row = {
          farmacia_id: id,
          comune: canon,
          gestione: (r.gestione || '').toString().trim(),
          descrizione_farmacia: (r.descrizione_farmacia || '').toString().trim(),
          indirizzo_full: (r.indirizzo_full || '').toString().trim(),
          cap: (r.cap || '').toString().trim(),
          stato_attivita: (r.stato_attivita || '').toString().trim(),
          maps_share_url: (r.maps_share_url || '').toString().trim(),
          maps_url_addr: (r.maps_url_addr || '').toString().trim(),
          maps_url_coords: (r.maps_url_coords || '').toString().trim(),
          latitudine: lat,
          longitudine: lon
        };

        farmRows.push(row);
        farmById[id] = row;

        const st = getPharmStatus(id);
        const chiusa = st.chiusa_temp || (row.stato_attivita || '').toLowerCase().includes('chiusa');
        const marker = L.marker([lat, lon], { icon: iconFarmacia(row.gestione, st.stato, chiusa) });

        const mapsUrl = getMapsUrl(row);
        const popupHtml = `
          <strong>${row.descrizione_farmacia || 'Farmacia'}</strong><br/>
          <div style="opacity:.9">${row.indirizzo_full || ''}${row.cap ? ' — ' + row.cap : ''} — ${row.comune}</div>
          <div style="margin-top:6px; font-size:12px; opacity:.95">
            ${row.gestione ? `<b>Gestione:</b> ${row.gestione}<br/>` : ''}
            ${row.stato_attivita ? `<b>Attività:</b> ${row.stato_attivita}<br/>` : ''}
          </div>
          <div style="margin-top:8px">
            <a href="${mapsUrl}" target="_blank" rel="noopener">Apri in Google Maps</a><br/>
            <a href="${DRIVE_MATERIALI}" target="_blank" rel="noopener">Materiali campagna</a>
          </div>
        `;
        marker.bindPopup(popupHtml);

        marker.on('popupopen', () => {
          setSelectedPharmacy(id);
        });

        marker.addTo(farmLayer);
        farmMarkers.push({ id, comune: canon, gestione: row.gestione, marker });
        added++;
      });

      refreshGlobalUI();
      refreshComuneUI();

      // info load
      loadInfo.innerHTML =
        `Farmacie caricate: <b>${added}</b>` +
        (skipped ? ` — righe saltate (mancano campi): ${skipped}` : '') +
        (invalid ? ` — coordinate invalide: ${invalid}` : '') +
        (comuneMiss ? `<br/><span class="warn">⚠ Comune non riconosciuto dal GeoJSON: ${comuneMiss}</span>` : '');

      // If a comune already selected, apply dim rules now
      if(selectedComune){
        farmMarkers.forEach(x => applyMarkerStyle(x.id));
      }
    }
  });
}

/* ===============================
   COMUNI GEOJSON (solo per selezione e labels)
================================ */
fetch('data/comuni_verona.json')
  .then(r => r.json())
  .then(data => {

    const geo = L.geoJSON(data, {
      style: () => ({ color:'#ffaa00', weight:1, dashArray:'5 5', fillOpacity:0 }),
      onEachFeature: (f, layer) => {
        const nome = (f.properties && (f.properties.nome || f.properties.DENOM_COM || f.properties.name)) || 'Comune';
        layersByNome[nome] = layer;
        comuniCanonByNorm[normKey(nome)] = nome;

        // label (solo vista generale)
        const center = layer.getBounds().getCenter();
        const label = L.marker(center,{
          icon: L.divIcon({ className:'label-comune', html: nome, iconSize:[160,16] }),
          interactive:false
        }).addTo(map);
        labels.push(label);

        layer.on('click', () => {
          setSelectedComune(nome);
          map.fitBounds(layer.getBounds(), { padding:[40,40] });
          // nascondi labels in dettaglio
          labels.forEach(l => { if(map.hasLayer(l)) map.removeLayer(l); });
        });
      }
    }).addTo(map);

    map.fitBounds(geo.getBounds());

    map.on('zoomend', () => {
      const z = map.getZoom();
      // se zoom-out abbastanza, reset selezione e mostra labels
      if(selectedComune && z < 9.5){
        setSelectedComune(null);
        labels.forEach(l => { if(!map.hasLayer(l)) map.addLayer(l); });
      } else {
        // labels visibili solo se nessun comune selezionato
        const show = (!selectedComune && z >= 9 && z <= 13);
        labels.forEach(l => {
          if(show){ if(!map.hasLayer(l)) map.addLayer(l); }
          else { if(map.hasLayer(l)) map.removeLayer(l); }
        });
      }
    });

    // load data
    loadStatsComune().then(loadFarmacie);
  });

/* ===============================
   SAVE / TOOLS
================================ */
btnSave.addEventListener('click', () => {
  if(!selectedPharmId) return;

  const cur = statusStore[selectedPharmId] || {};
  statusStore[selectedPharmId] = {
    ...cur,
    stato: statoSel.value,
    incaricato: incaricatoSel.value.trim(),
    note: noteSel.value.trim()
  };
  saveStatus(statusStore);

  applyMarkerStyle(selectedPharmId);
  refreshGlobalUI();
  refreshComuneUI();

  // refresh popup text (status is not shown inside popup yet; keeping simple)
});

btnTempClose.addEventListener('click', () => {
  if(!selectedPharmId) return;

  const row = farmById[selectedPharmId];
  const cur = statusStore[selectedPharmId] || {};
  const baseClosed = (row.stato_attivita || '').toLowerCase().includes('chiusa');
  const nowClosed = !!cur.chiusa_temp || baseClosed;

  // toggle only RAM flag; does not alter csv activity
  statusStore[selectedPharmId] = {
    ...cur,
    chiusa_temp: !nowClosed
  };
  saveStatus(statusStore);

  setSelectedPharmacy(selectedPharmId);
  applyMarkerStyle(selectedPharmId);
  refreshGlobalUI();
  refreshComuneUI();
});

btnResetUI.addEventListener('click', () => {
  // reset selection + restore HUD
  setSelectedComune(null);
  setSelectedPharmacy(null);
  labels.forEach(l => { if(!map.hasLayer(l)) map.addLayer(l); });
  document.getElementById('hud').classList.remove('hud-collapsed');
});

/* Allow ESC to clear selected pharmacy */
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){
    setSelectedPharmacy(null);
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Campagna SpG Verona ‚Äì Mappa (rev2.1.4)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* TOP BANNER (comune selezionato) */
#banner{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.86);
  padding:8px 14px;
  border-bottom:3px solid #00ff9c;
  color:#fff; font-size:13px;
  display:none; z-index:9999;
  max-width: calc(100% - 24px);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* HUD */
#hud{
  position:fixed; top:14px; left:14px; z-index:9998;
  padding:12px 14px;
  background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c;
  width: min(430px, calc(100vw - 28px));
  box-shadow:0 0 20px rgba(0,0,0,.85);
  max-height: calc(100vh - 28px);
  overflow:auto;
  border-radius: 6px;
}

.hud-title{ font-size:16px; font-weight:750; color:#fff; text-transform:uppercase; letter-spacing:.04em; }
.hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

.section-chip{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  margin-top:10px;
  font-size:10px; letter-spacing:.14em; text-transform:uppercase;
  color:#9ef5d9; background:#0e0e0e;
  padding:6px 8px; border:1px solid #1f1f1f;
  border-radius: 6px;
}
.section-chip small{ color:#9a9a9a; letter-spacing:.08em; text-transform:none; font-size:11px; }

.grid2{ margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }

.stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; border-radius: 6px; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:24px; font-weight:800; margin-top:2px; }
.v-green{ color:#00ff9c; }
.v-amber{ color:#ffaa00; }
.v-blue{ color:#4da6ff; }
.v-red{ color:#ff4d4d; }
.v-muted{ color:#d0d0d0; }

.progressBox{
  margin-top:10px;
  background:#0e0e0e;
  border:1px solid #1f1f1f;
  border-radius: 10px;
  padding:10px;
}
.p-main{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap; }
.p-main b{ color:#fff; }
.p-main .big{
  font-size:18px; font-weight:850; color:#00ff9c;
}
.p-main .big span{ color:#fff; }
.p-main .pct{ font-size:13px; color:#bdbdbd; font-weight:700; }
.p-bar{
  margin-top:8px;
  height:10px;
  background:#111;
  border:1px solid #242424;
  border-radius:999px;
  overflow:hidden;
}
.p-bar > div{
  height:100%;
  width:0%;
  background:linear-gradient(90deg, rgba(0,255,156,.25), rgba(0,255,156,1));
}
.p-mini{
  margin-top:8px;
  font-size:12px;
  color:#cfcfcf;
  line-height:1.35;
}
.p-mini b{ color:#fff; }

#miniLegend{
  margin-top:10px; padding-top:8px;
  border-top:1px solid #222;
}

.legend-row{ display:flex; align-items:center; gap:8px; font-size:12px; color:#e6e6e6; margin:6px 0; }
.badge{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:18px; height:18px; padding:0 6px;
  border-radius:999px;
  background:#141414; border:1px solid #2a2a2a;
  font-size:11px; color:#e6e6e6;
}

.dot{ width:12px; height:12px; border-radius:50%; }
.square{ width:12px; height:12px; border-radius:2px; }

.c-contattare{ background:#ffaa00; }
.c-trattativa{ background:#4da6ff; }
.c-aderisce{ background:#00ff9c; }
.c-rifiuta{ background:#ff4d4d; }
.c-chiusa{ background:#9a9a9a; opacity:.45; }

.c-comune-coperto{ background:#00ff9c; }
.c-comune-orfano{ background:#ffaa00; }

#comuneBox{
  margin-top:12px; padding-top:10px;
  border-top:1px solid #222;
}
#comuneCounts{ margin-top:8px; }
#comuneCounts .stat-value{ font-size:20px; }

.hud-buttons{
  margin-top:12px;
  display:flex; gap:6px; flex-wrap:wrap;
  position:sticky; bottom:0;
  padding-top:10px;
  background: rgba(5,5,5,.96);
  border-top: 1px solid #222;
}
.hud-btn{
  border:1px solid #00ff9c;
  background:#041812; color:#eafff7;
  font-size:12px; padding:8px 10px; cursor:pointer;
  border-radius: 8px;
}
.hud-btn:hover{ background:#00ff9c; color:#00110b; }

#refPanel{ display:none; margin-top:8px; }
#refList{ list-style:none; padding-left: 0; margin:6px 0 0; }
#refList li{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  font-size:12px; color:#fff;
  background:#0e0e0e; border:1px solid #1f1f1f;
  padding:6px 8px; border-radius: 8px;
  margin-bottom:6px;
}
.xbtn{
  width:18px; height:18px;
  border-radius: 6px;
  border:1px solid #333;
  background:#151515; color:#ddd;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  font-size:12px; line-height:12px;
}
.xbtn:hover{ background:#ff4d4d; border-color:#ff4d4d; color:#120000; }

.label-comune{
  color:#ffffff; font-size:11px;
  text-shadow:0 0 6px rgba(0,0,0,.9);
  pointer-events:none;
}

.leaflet-control-zoom{ margin-top: 88px !important; } /* evita sovrapposizione col HUD */

/* === Barra non contattate (arancione) === */
.ms-bar2{
  margin-top:12px; /* pi√π distanza dalla barra verde */
  height:8px;
  border-radius:999px;
  overflow:hidden;
  background: rgba(255, 191, 0, .10);
  border:1px solid rgba(255,191,0,.28);
}
#ms_bar_nc{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(255,191,0,.35), rgba(255,191,0,.85));
  border-radius:999px;
}
.ms-mini .nc-label{ color:rgba(255,191,0,.95); font-weight:900; }
/* === Incaricati: riga input + pulsante aggiungi === */
.ownersRow{
  display:flex;
  gap:8px;
  align-items:stretch;
}
.ownersRow .inlineInput{ flex:1; }
.miniBtn{
  width:40px;
  border-radius:12px;
  border:1px solid #2a2a2a;
  background:#00ff9c;
  color:#111;
  font-weight:1000;
  cursor:pointer;
}
.miniBtn:active{ transform: translateY(1px); }

@media (max-width: 720px){
  #hud{ top:auto; bottom:12px; left:12px; right:12px; width:auto; max-height: 58vh; }
  .leaflet-control-zoom{ margin-top: 12px !important; }
}

/* === Marker farmacia (divIcon) === */
.mrk{
  width:14px; height:14px;
  border-radius:50%;
  border:1px solid rgba(255,255,255,.18);
  box-shadow: 0 0 12px rgba(0,0,0,.35);
}
.mrk.square{ border-radius:2px; }
.mrk.contattare{ background:#ffaa00; }
.mrk.trattativa{ background:#4da6ff; }
.mrk.aderisce{ background:#00ff9c; }
.mrk.rifiuta{ background:#ff4d4d; }
.mrk.chiusa{ opacity:.35; filter: grayscale(1); }

/* === Popup farmacia === */
.popupWrap{
  min-width: 260px;
  color:#0b0b0b;
  font-size:13px;
}
.popupWrap h3{
  margin:0 0 6px;
  font-size:14px;
  color:#0b0b0b;
}
.popupMeta{ color:#3b3b3b; font-size:12px; }
.popupDivider{ height:1px; background:#e6e6e6; margin:10px 0; }

.seg{
  display:flex; gap:6px; flex-wrap:wrap;
}
.seg button{
  border:1px solid #d8d8d8;
  background:#ffffff;
  color:#0b0b0b;
  padding:6px 8px;
  font-size:12px;
  border-radius: 10px;
  cursor:pointer;
}
.seg button[data-on="1"]{
  border-color:#0b0b0b;
  background:#0b0b0b;
  color:#ffffff;
}
.seg button.state-contattare[data-on="1"]{ background:#ffaa00; color:#1d1200; border-color:#ffaa00; }
.seg button.state-trattativa[data-on="1"]{ background:#4da6ff; color:#001427; border-color:#4da6ff; }
.seg button.state-aderisce[data-on="1"]{ background:#00ff9c; color:#00110b; border-color:#00ff9c; }
.seg button.state-rifiuta[data-on="1"]{ background:#ff4d4d; color:#250000; border-color:#ff4d4d; }

.flagRow{ display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:#1a1a1a; }
.flagRow label{ display:flex; align-items:center; gap:6px; }

.inlineInput{
  width:100%;
  box-sizing:border-box;
  padding:8px 10px;
  border-radius: 10px;
  border:1px solid #d8d8d8;
  font-size:12px;
}
textarea.inlineInput{ min-height: 64px; resize: vertical; }

.chipBar{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
.chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 8px;
  border-radius: 999px;
  border:1px solid #d8d8d8;
  background:#fff;
  font-size:12px;
  color:#111;
}
.chip .xbtn{ width:16px; height:16px; border-radius: 999px; font-size:11px; }

.popupActions{ display:flex; gap:8px; margin-top:10px; }
.popupActions button{
  flex:1;
  border:1px solid #0b0b0b;
  background:#0b0b0b;
  color:#fff;
  padding:8px 10px;
  font-size:12px;
  border-radius: 10px;
  cursor:pointer;
}
.popupActions button.secondary{
  background:#ffffff;
  color:#0b0b0b;
  border-color:#d8d8d8;
}
.smallLink{ font-size:12px; }
.smallLink a{ color:#0b0b0b; font-weight:700; text-decoration:none; }
.smallLink a:hover{ text-decoration:underline; }

/* === Overlay statistiche mappa (bottom-right) === */
#mapStats{
  position:fixed;
  right:14px;
  bottom:14px;
  z-index:9997;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 0 18px rgba(0,0,0,.55);
  border-radius: 12px;
  padding:12px 12px 10px;
  width: min(360px, calc(100vw - 28px));
  color:#fff;
  pointer-events:none; /* non blocca drag/zoom mappa */
  backdrop-filter: blur(3px);
}
.ms-title{
  font-size:10px;
  letter-spacing:.16em;
  text-transform:uppercase;
  color:#bfeee0;
}
.ms-line{
  margin-top:6px;
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.ms-main{
  font-size:18px;
  font-weight:900;
  color:#00ff9c;
}
.ms-main span{ color:#fff; }
.ms-pct{
  font-size:12px;
  color:#d0d0d0;
  font-weight:700;
}
.ms-bar{
  margin-top:8px;
  height:10px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  border-radius:999px;
  overflow:hidden;
}
.ms-bar > div{
  height:100%;
  width:0%;
  background:linear-gradient(90deg, rgba(0,255,156,.25), rgba(0,255,156,1));
}
.ms-mini{
  margin-top:8px;
  font-size:12px;
  color:#e6e6e6;
}
.ms-mini b{ color:#fff; }
.ms-tag{
  display:inline-flex;
  margin-top:6px;
  font-size:11px;
  color:#111;
  background:#00ff9c;
  padding:2px 8px;
  border-radius: 999px;
  font-weight:800;
}
@media (max-width: 720px){
  #mapStats{ right:12px; bottom:12px; width: min(420px, calc(100vw - 24px)); }
}
/* ===============================
   UI MODE: splash + mobile panel
================================ */
.uiSplash{
  position:fixed;
  inset:0;
  z-index:10001;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(0,255,156,.18), rgba(0,0,0,0) 55%),
    radial-gradient(900px 600px at 90% 90%, rgba(255,191,0,.10), rgba(0,0,0,0) 60%),
    rgba(0,0,0,.92);
  backdrop-filter: blur(3px);
}
.uiSplash.hidden{ display:none; }
.uiCard{
  width: min(520px, 100%);
  background: rgba(5,5,5,.92);
  border:1px solid rgba(0,255,156,.28);
  box-shadow: 0 0 28px rgba(0,0,0,.75);
  border-radius: 18px;
  padding: 18px 16px 16px;
}
.uiKicker{
  font-size:10px;
  letter-spacing:.22em;
  text-transform:uppercase;
  color:#bfeee0;
}
.uiTitle{
  margin-top:6px;
  font-size:22px;
  font-weight:900;
  color:#fff;
  letter-spacing:.02em;
}
.uiSub{
  margin-top:8px;
  color:#cfcfcf;
  font-size:13px;
  line-height:1.35;
}
.uiBtns{
  margin-top:14px;
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}
.uiBtn{
  width:100%;
  padding:14px 14px;
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.14);
  background:#0e0e0e;
  color:#fff;
  font-size:15px;
  font-weight:900;
  cursor:pointer;
}
.uiBtn:hover{ border-color: rgba(0,255,156,.55); }
.uiBtnMobile{
  border-color: rgba(0,255,156,.35);
  background: linear-gradient(180deg, rgba(0,255,156,.10), rgba(14,14,14,1));
}
.uiBtnDesktop{
  border-color: rgba(77,166,255,.35);
  background: linear-gradient(180deg, rgba(77,166,255,.10), rgba(14,14,14,1));
}
.uiHint{
  margin-top:10px;
  color:#9a9a9a;
  font-size:12px;
}

/* Mobile HUD toggle + close */
#hudToggle{
  position:fixed;
  left:14px;
  bottom:14px;
  z-index:9999;
  display:none;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 14px;
  border-radius: 16px;
  border:1px solid rgba(0,255,156,.35);
  background: rgba(0,0,0,.82);
  color:#eafff7;
  font-size:13px;
  font-weight:950;
  cursor:pointer;
  box-shadow: 0 0 18px rgba(0,0,0,.6);
}
#hudToggle:active{ transform: translateY(1px); }

#hudClose{
  position:absolute;
  top:10px;
  right:10px;
  width:34px;
  height:34px;
  border-radius: 12px;
  border:1px solid rgba(0,255,156,.55);
  background:#0b0b0b;
  color:#00ff9c;
  font-size:20px;
  font-weight:900;
  display:none;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
#hudClose:hover{ background:#00ff9c; color:#00110b; }

/* Modalit√† mobile: HUD collassabile */
body[data-uimode="mobile"] #hudToggle{ display:flex; }
body[data-uimode="mobile"] #hudClose{ display:flex; }

/* In mobile, se collassato lo nascondo */
body[data-uimode="mobile"] #hud{
  transition: transform .22s ease, opacity .22s ease;
}
body[data-uimode="mobile"] #hud.hud-collapsed{
  transform: translateY(120%);
  opacity: 0;
  pointer-events:none;
}

/* Micro-leggenda dentro overlay (utile su smartphone) */
.ms-legendline{
  margin-top:8px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  font-size:11px;
  color:#e6e6e6;
}
.ms-legendline .k{
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.ms-legendline .b{
  width:10px; height:10px; border-radius:3px;
}
.ms-legendline .b.round{ border-radius:50%; }
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>

<!-- UI mode splash (smartphone / desktop) -->
<div id="uiSplash" class="uiSplash hidden" role="dialog" aria-modal="true" aria-label="Scelta interfaccia">
  <div class="uiCard">
    <div class="uiKicker">Campagna</div>
    <div class="uiTitle">SpG Verona</div>
    <div class="uiSub">Scegli l‚Äôinterfaccia. Puoi cambiarla in qualsiasi momento dal pannello.</div>
    <div class="uiBtns">
      <button type="button" id="btnModeMobile" class="uiBtn uiBtnMobile">üì± Smartphone</button>
      <button type="button" id="btnModeDesktop" class="uiBtn uiBtnDesktop">üñ•Ô∏è Desktop</button>
    </div>
    <div class="uiHint" id="uiHint"></div>
  </div>
</div>

<button id="hudToggle" type="button" aria-label="Apri pannello">‚ò∞ Legenda</button>

<div id="hud">
  <button id="hudClose" type="button" aria-label="Chiudi pannello">√ó</button>
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div class="section-chip">Avanzamento <small id="g_hint"></small></div>
  <div class="progressBox">
    <div class="p-main">
      <div class="big">Aderiscono <span id="g_aderisce">0</span>/<span id="g_total">0</span></div>
      <div class="pct" id="g_aderisce_pct">0%</div>
    </div>
    <div class="p-bar"><div id="g_bar"></div></div>
    <div class="p-mini">
      Trattativa: <b id="g_trattativa">0</b> ¬∑ Non aderisce: <b id="g_rifiuta">0</b> ¬∑ Da contattare: <b id="g_contattare">0</b><br/>
      Private: <b id="g_private">0</b> ¬∑ Comunali: <b id="g_comunali">0</b><br/>
      Comuni (coperti / orfani): <b id="g_comuni_coperti">0</b> / <b id="g_comuni_orfani">0</b>
    </div>
  </div>

  <div id="miniLegend">
    <div class="section-chip">Stati <small>clicca per filtrare la vista</small></div>
    <div class="grid2" id="g_statusGrid"></div>

    <div style="margin-top:10px">
      <div class="section-chip">Aderisce <small>dettagli (facoltativi)</small></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
        <span class="badge">Poster <b id="g_poster" style="margin-left:6px">0</b></span>
        <span class="badge">Boicotta <b id="g_boicotta" style="margin-left:6px">0</b></span>
        <span class="badge">Promo <b id="g_promo" style="margin-left:6px">0</b></span>
        <span class="badge">Info <b id="g_info" style="margin-left:6px">0</b></span>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="section-chip">Legenda <small>forme + colori</small></div>
      <div class="legend-row"><span class="dot" style="background:#fff"></span> Privata (puntino)</div>
      <div class="legend-row"><span class="square" style="background:#fff"></span> Comunale (quadratino)</div>
      <div class="legend-row"><span class="dot c-contattare"></span> Da contattare</div>
      <div class="legend-row"><span class="dot c-trattativa"></span> In trattativa</div>
      <div class="legend-row"><span class="dot c-aderisce"></span> Aderisce</div>
      <div class="legend-row"><span class="dot c-rifiuta"></span> Non aderisce</div>
      <div class="legend-row"><span class="dot c-chiusa"></span> Chiusa temporaneamente (strumento)</div>
      <div class="legend-row" style="margin-top:10px; color:#cfcfcf">
        <span class="square c-comune-coperto"></span> Bordo verde = comune con referente
      </div>
      <div class="legend-row" style="color:#cfcfcf">
        <span class="square c-comune-orfano"></span> Bordo ambra tratteggiato = senza referente
      </div>
    </div>
  </div>

  <div id="comuneBox">
    <div class="section-chip">Comune selezionato <small id="sel_nome">‚Äî</small></div>
    <div class="grid2" id="comuneCounts"></div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAddRef">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggleRef">Vedi referenti</button>
    <button class="hud-btn" id="btnClearFilter" title="Rimuovi filtro stati" style="display:none">Reset filtro stati</button>
  
    <button class="hud-btn" id="btnExportXLSX" title="Scarica un file Excel con statistiche + liste per stato">Esporta Excel</button>
    <button class="hud-btn" id="btnExportCSV" title="Scarica un CSV (apribile in Excel) con tutte le farmacie e i campi campagna">Esporta CSV</button>
    <button class="hud-btn" id="btnPrintReport" title="Apri una pagina stampabile con statistiche + liste per stato">Stampa</button>
    <button class="hud-btn" id="btnExportAderisce" title="Export rapido per coordinamento: elenco SOLO ADERISCE">Solo aderisce</button>
    <button class="hud-btn" id="btnUIMode" title="Cambia interfaccia (Smartphone/Desktop)">Cambia UI</button>
  </div>

  <div id="refPanel">
    <ul id="refList"></ul>
  </div>
</div>

<!-- Overlay sempre visibile in mappa -->
<div id="mapStats" aria-hidden="true">
  <div class="ms-title" id="ms_title">Avanzamento campagna</div>
  <div class="ms-line">
    <div class="ms-main"><span id="ms_aderisce">0</span>/<span id="ms_total">0</span> aderisce</div>
    <div class="ms-pct" id="ms_pct">0%</div>
  </div>
  <div class="ms-bar"><div id="ms_bar"></div></div>
    <div class="ms-bar2"><div id="ms_bar_nc"></div></div>
<div class="ms-mini">
    Trattativa: <b id="ms_trattativa">0</b> ¬∑ Non aderisce: <b id="ms_rifiuta">0</b> ¬∑ Da contattare: <b id="ms_contattare">0</b>
  </div>
    <div class="ms-mini"><span class="nc-label">Da contattare (non contattate)</span>: <b id="ms_nc">0</b> ¬∑ <span id="ms_nc_pct">0%</span></div>
  <div class="ms-legendline" id="ms_legendline">
    <span class="k"><span class="b round" style="background:#ffaa00"></span>Da contattare</span>
    <span class="k"><span class="b round" style="background:#4da6ff"></span>Trattativa</span>
    <span class="k"><span class="b round" style="background:#00ff9c"></span>Aderisce</span>
    <span class="k"><span class="b round" style="background:#ff4d4d"></span>Non aderisce</span>
  </div>
<div class="ms-mini" id="ms_filter" style="display:none"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===============================
   CONFIG
================================ */
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1oMqJ_6ZLthMK73FkpirBtvQ_Ycif4OYS";

/* Path robusti: prova prima DATA/ (GitHub case-sensitive), poi data/ */
const PATHS_FARMACIE = ["data/farmacie.csv", "DATA/farmacie.csv"];
const PATHS_COMUNI   = ["data/comuni_verona.json", "DATA/comuni_verona.json"];

/* ===============================
   UI MODE (Smartphone / Desktop)
================================ */
const UI_MODE_KEY = "spg_ui_mode_rev2";
function recommendedMode(){
  const vw = window.innerWidth || document.documentElement.clientWidth;
  return (vw <= 820) ? "mobile" : "desktop";
}
function setUIMode(mode){
  document.body.dataset.uimode = mode;
  const hud = document.getElementById("hud");
  const toggle = document.getElementById("hudToggle");
  if(mode === "mobile"){
    hud.classList.add("hud-collapsed"); // default chiuso
    if(toggle) toggle.textContent = "‚ò∞ Legenda";
  }else{
    hud.classList.remove("hud-collapsed");
  }
  try{ map && map.invalidateSize(); }catch(e){}
}
function showUIModeSplash(){
  const splash = document.getElementById("uiSplash");
  const hint = document.getElementById("uiHint");
  if(!splash) return;
  splash.classList.remove("hidden");
  const rec = recommendedMode();
  if(hint){
    hint.textContent = `Suggerito: ${rec === "mobile" ? "Smartphone" : "Desktop"} (in base allo schermo).`;
  }
}
function hideUIModeSplash(){
  const splash = document.getElementById("uiSplash");
  if(splash) splash.classList.add("hidden");
}
function initUIMode(){
  const saved = localStorage.getItem(UI_MODE_KEY);
  if(saved){
    setUIMode(saved);
    hideUIModeSplash();
  }else{
    // pre-applica la modalit√† consigliata ma chiedi conferma
    document.body.dataset.uimode = recommendedMode();
    showUIModeSplash();
  }

  const bM = document.getElementById("btnModeMobile");
  const bD = document.getElementById("btnModeDesktop");
  if(bM) bM.addEventListener("click", () => {
    localStorage.setItem(UI_MODE_KEY, "mobile");
    setUIMode("mobile");
    hideUIModeSplash();
  });
  if(bD) bD.addEventListener("click", () => {
    localStorage.setItem(UI_MODE_KEY, "desktop");
    setUIMode("desktop");
    hideUIModeSplash();
  });

  const hud = document.getElementById("hud");
  const toggle = document.getElementById("hudToggle");
  const closeBtn = document.getElementById("hudClose");
  const toggleHud = () => {
    if(document.body.dataset.uimode !== "mobile") return;
    hud.classList.toggle("hud-collapsed");
    try{
      farmMarkers.forEach(f => {
        const m = f.marker;
        if(m && m.isPopupOpen && m.isPopupOpen()){
          applyPopupAutoPan(m.getPopup());
        }
      });
    }catch(e){}
  };
  if(toggle) toggle.addEventListener("click", toggleHud);
  if(closeBtn) closeBtn.addEventListener("click", (ev)=>{ ev.preventDefault(); ev.stopPropagation(); hud.classList.add("hud-collapsed"); });

  const btnUIMode = document.getElementById("btnUIMode");
  if(btnUIMode) btnUIMode.addEventListener("click", () => showUIModeSplash());

  window.addEventListener("resize", () => {
    const current = localStorage.getItem(UI_MODE_KEY) || document.body.dataset.uimode || recommendedMode();
    document.body.dataset.uimode = current;
  });
}

/* ===============================
   HELPERS
================================ */
function esc(s){
  return String(s||"").replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}
function normKey(s){
  return (s||"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ");
}
function stableId(str){
  let h = 0;
  const s = String(str||"");
  for (let i=0; i<s.length; i++){
    h = ((h<<5) - h) + s.charCodeAt(i);
    h |= 0;
  }
  return String(h);
}
function parseCoordinateCell(v){
  if(v===null || v===undefined) return null;
  const s = String(v).trim();
  if(!s) return null;
  const parts = s.split(",").map(x=>x.trim().replace(",","."));
  if(parts.length<2) return null;
  const lat = parseFloat(parts[0]);
  const lon = parseFloat(parts[1]);
  if(!isFinite(lat) || !isFinite(lon)) return null;
  return { lat, lon };
}
async function fetchFirst(paths, type){
  let lastErr = null;
  for(const p of paths){
    try{
      const r = await fetch(p, { cache:"no-store" });
      if(!r.ok) continue;
      if(type==="json") return { path:p, data: await r.json() };
      if(type==="text") return { path:p, data: await r.text() };
    }catch(e){ lastErr = e; }
  }
  throw (lastErr || new Error("Impossibile caricare risorsa"));
}

/* ===============================
   STATUS STORE (localStorage)
================================ */
const STATUS_STORE_KEY = "spg_farmacie_status_rev2";
function loadStatusStore(){
  try { return JSON.parse(localStorage.getItem(STATUS_STORE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveStatusStore(obj){
  try { localStorage.setItem(STATUS_STORE_KEY, JSON.stringify(obj)); }
  catch(e){}
}
const statusStore = loadStatusStore();

function normalizeOwners(val){
  if(Array.isArray(val)){
    return val.map(x=>String(x||"").trim()).filter(Boolean);
  }
  if(typeof val === "string"){
    return val.split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean);
  }
  return [];
}
function uniq(arr){
  const out=[];
  (arr||[]).forEach(x=>{ const v=String(x||"").trim(); if(v && !out.includes(v)) out.push(v); });
  return out;
}

function defaultStatus(){
  return { state:"contattare", owners:[], note:"", flags:{poster:false, boicotta:false, promo:false, info:false}, closed:false };
}
function getSt(id){
  return statusStore[id] || defaultStatus();
}
function setSt(id, next){
  statusStore[id] = next;
  saveStatusStore(statusStore);
}

/* ===============================
   REFERENTI COMUNE (localStorage)
================================ */
const REF_STORE_KEY = "spg_referenti_comune_rev2";
function loadRefStore(){
  try { return JSON.parse(localStorage.getItem(REF_STORE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveRefStore(obj){
  try { localStorage.setItem(REF_STORE_KEY, JSON.stringify(obj)); }
  catch(e){}
}
const referentiComune = loadRefStore();
// seed minimo se vuoto
if(Object.keys(referentiComune).length === 0){
  referentiComune["Verona"] = ["Vincenzo Russo"];
  saveRefStore(referentiComune);
}
function hasRef(nome){ return (referentiComune[nome] && referentiComune[nome].length>0); }

/* ===============================
   MAPPA
================================ */
const map = L.map("map", { attributionControl:false }).setView([45.43, 10.99], 10);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom:18 }).addTo(map);

/* ===============================
   PADDING "SMART" (HUD + overlay)
================================ */
function getSmartPadding(opts){
  const options = opts || {};
  const includeHud = options.includeHud !== false;
  const includeStats = options.includeStats !== false;
  const base = 40;
  let padLeft = base, padTop = base, padRight = base, padBottom = base;

  const vw = window.innerWidth || document.documentElement.clientWidth;
  const vh = window.innerHeight || document.documentElement.clientHeight;

  const hud = document.getElementById("hud");
  if(includeHud && hud){
    const hudCollapsed = hud.classList.contains("hud-collapsed");
    const r = hud.getBoundingClientRect();
    // HUD tipicamente a sinistra: conta sempre il suo ingombro per centrare nell'area mappa
    const hudVisible = (!hudCollapsed) && (r.width > 120) && (r.height > 120) && (r.right > 0) && (r.bottom > 0);
    const hudLeft = hudVisible && (r.left <= 80);
    if(hudLeft) padLeft = Math.max(padLeft, Math.round(r.width + 24));

    // HUD eventualmente in basso (mobile)
    const hudBottom = hudVisible && (r.bottom >= vh - 12) && (r.height > 120) && (r.top > vh * 0.35);
    if(hudBottom) padBottom = Math.max(padBottom, Math.round(r.height + 24));
  }

  const ms = document.getElementById("mapStats");
  if(includeStats && ms){
    const r = ms.getBoundingClientRect();
    const msVisible = (r.width > 120) && (r.height > 40) && (r.left < vw) && (r.top < vh);
    const msRight = msVisible && (r.right >= vw - 12);
    if(msRight) padRight = Math.max(padRight, Math.round(r.width + 18));
    const msBottom = msVisible && (r.bottom >= vh - 12);
    if(msBottom) padBottom = Math.max(padBottom, Math.round(r.height + 18));
  }
  return { padLeft, padTop, padRight, padBottom };
}
function fitBoundsSmart(bounds){
  // Per il "centro" del comune: privilegia l'HUD, ignora l'overlay bottom-right
  const p = getSmartPadding({ includeStats:false });
  map.fitBounds(bounds, {
    paddingTopLeft: [p.padLeft, p.padTop],
    paddingBottomRight: [p.padRight, p.padBottom]
  });
}
function applyPopupAutoPan(popup){
  // Per i popup: considera sia HUD che overlay
  const p = getSmartPadding({ includeStats:true });
  popup.options.autoPan = true;
  popup.options.autoPanPaddingTopLeft = [p.padLeft, p.padTop];
  popup.options.autoPanPaddingBottomRight = [p.padRight, p.padBottom];
}

/* Per capire se l'utente sta facendo zoom-in o zoom-out */
let lastZoomLevel = null;

const banner   = document.getElementById("banner");
const hudTitle = document.getElementById("hudTitle");
const hudSub   = document.getElementById("hudSub");
const selNomeEl = document.getElementById("sel_nome");

let comuniLayer = null;
let selectedComuneLayer = null;
let selectedComuneNome = null;

/* pharmacy markers */
const farmLayer = L.layerGroup().addTo(map);
/* { id, comune, gestione, isComunale, marker, row } */
const farmMarkers = [];

const comuniCanon = new Set(); // dall'GeoJSON
const comuneCanonByNorm = {}; // norm -> canon

/* label comuni */
const labels = [];
function nomeComuneFromFeature(f){
  const p = (f && f.properties) ? f.properties : {};
  return p.nome || p.DENOM_COM || p.name || "Comune";
}
function canonComune(raw){
  const k = normKey(raw);
  return comuneCanonByNorm[k] || (raw||"").trim();
}

/* ===============================
   STILI COMUNI
================================ */
function styleComuneBase(nome){
  const ref = hasRef(nome);
  return {
    color: ref ? "#00ff9c" : "#ffaa00",
    weight: ref ? 2 : 1,
    dashArray: ref ? null : "5 5",
    fillColor: "#00ff9c",
    fillOpacity: ref ? 0.10 : 0
  };
}
function aggiornaStiliComuni(){
  if(!comuniLayer) return;
  comuniLayer.eachLayer(layer => {
    const nome = nomeComuneFromFeature(layer.feature);
    let st = styleComuneBase(nome);
    if(selectedComuneLayer && layer === selectedComuneLayer){
      st = { ...st, color:"#ffffff", weight:3, dashArray:null, fillOpacity:0 };
    }
    layer.setStyle(st);
  });
}

/* ===============================
   FILTRO STATO (solo vista)
================================ */
let stateFilter = null; // "contattare" | "trattativa" | "aderisce" | "rifiuta" | null
const btnClearFilter = document.getElementById("btnClearFilter");
function setStateFilter(next){
  stateFilter = next;
  btnClearFilter.style.display = stateFilter ? "" : "none";
  applyMarkerVisibility();
  aggiornaHUD();
  aggiornaMapStats();
}
btnClearFilter.addEventListener("click", () => setStateFilter(null));

/* ===============================
   MARKER ICON (forma diversa se comunale)
================================ */
function isComunaleFromGestione(gestione){
  return /comun/i.test(String(gestione||""));
}
function iconFarmacia(state, closed, isComunale){
  const cls = (state || "contattare");
  const closeCls = closed ? " chiusa" : "";
  const shapeCls = isComunale ? " square" : "";
  return L.divIcon({
    className:"",
    html:`<div class="mrk ${cls}${closeCls}${shapeCls}"></div>`,
    iconSize:[14,14],
    iconAnchor:[7,7]
  });
}

function applyStatusToMarker(marker, farmaciaId, row, isComunale){
  const st = getSt(farmaciaId);
  marker.setIcon(iconFarmacia(st.state, st.closed, isComunale));
  marker.setOpacity(st.closed ? 0.35 : 1);

  // tooltip rapido
  const nome = row.descrizione_farmacia || "Farmacia";
  const extra = (st.owners && st.owners.length) ? ` ¬∑ incaricati: ${st.owners.join(", ")}` : "";
  marker.bindTooltip(`${nome}${extra}`, { direction:"top", opacity:0.9, offset:[0,-8] });
}

/* ===============================
   POPUP HTML + HANDLERS
================================ */
function buildPopupHtml(row, farmaciaId){
  const st = getSt(farmaciaId);

  const nome = row.descrizione_farmacia || row.nome || "Farmacia";
  const comune = canonComune(row.comune || "");
  const indirizzo = row.indirizzo_full || row.indirizzo || "";
  const cap = row.cap || "";
  const gestione = row.gestione || "";
  const maps = row.maps_url || "";

  const state = st.state || "contattare";
  const owners = uniq(normalizeOwners(st.owners));
  const note = st.note || "";
  const flags = st.flags || { poster:false, boicotta:false, promo:false, info:false };
  const closed = !!st.closed;

  const stateBtn = (key, label) => `<button class="state-${key}" data-role="state" data-value="${key}" data-on="${key===state?1:0}">${label}</button>`;

  return `
  <div class="popupWrap" data-farm-id="${esc(farmaciaId)}">
    <h3>${esc(nome)}</h3>
    <div class="popupMeta">${esc(indirizzo)}${cap?` ‚Äì ${esc(cap)}`:""} ‚Äì <b>${esc(comune)}</b>${gestione?` ¬∑ ${esc(gestione)}`:""}</div>

    <div class="popupDivider"></div>

    <div style="font-size:12px; color:#3b3b3b; margin-bottom:6px"><b>Stato</b></div>
    <div class="seg" data-role="stateSeg">
      ${stateBtn("contattare","Da contattare")}
      ${stateBtn("trattativa","In trattativa")}
      ${stateBtn("aderisce","Aderisce")}
      ${stateBtn("rifiuta","Non aderisce")}
    </div>

    <div class="popupDivider"></div>

    <div data-role="aderisceFlags" style="${state==="aderisce"?"":"display:none"}">
      <div style="font-size:12px; color:#3b3b3b; margin-bottom:6px"><b>Dettagli adesione</b> (puoi selezionare pi√π voci)</div>
      <div class="flagRow">
        <label><input type="checkbox" data-flag="boicotta" ${flags.boicotta?"checked":""}/> Boicotta (stop fornitura)</label>
        <label><input type="checkbox" data-flag="poster" ${flags.poster?"checked":""}/> Poster</label>
        <label><input type="checkbox" data-flag="promo" ${flags.promo?"checked":""}/> Promo BDS</label>
        <label><input type="checkbox" data-flag="info" ${flags.info?"checked":""}/> Informativa</label>
      </div>
      <div class="popupDivider"></div>
    </div>

    <div style="font-size:12px; color:#3b3b3b; margin-bottom:6px"><b>Incaricati</b> (puoi aggiungere pi√π nomi)</div>
    <div class="ownersRow">
      <input class="inlineInput" type="text" data-role="ownersInput" placeholder="Es: Marco, Lucia" />
      <button class="miniBtn" type="button" data-role="ownersAdd" title="Aggiungi">+</button>
    </div>
    <div class="chipBar" data-role="ownersChips">
      ${owners.map(o => `<span class="chip">${esc(o)} <span class="xbtn" data-role="rmOwner" data-owner="${encodeURIComponent(o)}">√ó</span></span>`).join("")}
    </div>

    <div class="popupDivider"></div>

    <div style="font-size:12px; color:#3b3b3b; margin-bottom:6px"><b>Note</b></div>
    <textarea class="inlineInput" data-role="note" placeholder="Es: espone poster NOTEVA, parla ai clienti...">${esc(note)}</textarea>

    <div class="popupDivider"></div>

    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between">
      <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#1a1a1a">
        <input type="checkbox" data-role="closed" ${closed?"checked":""}/>
        Chiusa temporaneamente
      </label>
      <div class="smallLink">
        <a href="${esc(maps)}" target="_blank" rel="noopener">Apri in Maps</a>
        &nbsp;¬∑&nbsp;
        <a href="${esc(DRIVE_MATERIALI)}" target="_blank" rel="noopener">Materiali</a>
      </div>
    </div>

    <div class="popupActions">
      <button data-role="save">Salva e chiudi</button>
      <button class="secondary" data-role="reset">Chiudi senza salvare</button>
    </div>
  </div>`;
}

/* ===============================
   POPUP: autosave + refresh + binding robusto
================================ */
const POPUP_BINDERS = new WeakMap();
// Cache "bozza" per autosave affidabile anche se il DOM del popup non √® pi√π disponibile al momento del close
const POPUP_DRAFT_CACHE = new Map(); // farmaciaId -> { state, owners, note, flags, closed }

function collectPopupDraft(wrap){
  const onBtn = wrap.querySelector('button[data-role="state"][data-on="1"]');
  const state = onBtn ? (onBtn.getAttribute("data-value") || "contattare") : "contattare";

  // owners gi√† presenti nei chip (decode)
  const ownersFromChips = Array.from(wrap.querySelectorAll('[data-role="rmOwner"]'))
    .map(el => {
      const enc = (el.getAttribute("data-owner") || "").trim();
      try { return decodeURIComponent(enc); } catch(e){ return enc; }
    })
    .filter(Boolean);

  // owners nuovi dall'input
  const raw = (wrap.querySelector('[data-role="ownersInput"]')?.value || "").trim();
  const ownersFromInput = raw ? raw.split(",").map(s => s.trim()).filter(Boolean) : [];

  // merge unico (preserva ordine: chip -> input)
  const owners = uniq([ ...ownersFromChips, ...ownersFromInput ]);
const note = wrap.querySelector('[data-role="note"]')?.value || "";
  const closed = !!wrap.querySelector('[data-role="closed"]')?.checked;

  const flags = { poster:false, boicotta:false, promo:false, info:false };
  wrap.querySelectorAll("input[type=checkbox][data-flag]").forEach(cb => {
    const k = cb.getAttribute("data-flag");
    if(k) flags[k] = cb.checked;
  });

  return { state, owners, note, flags, closed };
}

function applyDraftToStore(marker, row, farmaciaId, isComunale, draft){
  const prev = getSt(farmaciaId);
  const next = { ...prev, ...draft };
  next.flags = draft.flags || prev.flags || { poster:false, boicotta:false, promo:false, info:false };
  next.owners = uniq(normalizeOwners(next.owners));
// timestamp ultimo aggiornamento (utile anche per export)
  next.updatedAt = new Date().toISOString();
  setSt(farmaciaId, next);

  applyStatusToMarker(marker, farmaciaId, row, isComunale);
  aggiornaHUD();
  aggiornaComuneSelezionato();
  aggiornaMapStats();
  applyMarkerVisibility();
}

function autoSavePopup(marker, row, farmaciaId, isComunale){
  const root = marker.getPopup()?.getElement();
  if(!root) return;
  const wrap = root.querySelector(".popupWrap");
  if(!wrap) return;
  const draft = collectPopupDraft(wrap);
  applyDraftToStore(marker, row, farmaciaId, isComunale, draft);
}

function refreshPopup(marker, row, farmaciaId, reopen=true){
  const wasOpen = marker.isPopupOpen && marker.isPopupOpen();
  marker.setPopupContent(buildPopupHtml(row, farmaciaId));
  if(reopen || wasOpen) marker.openPopup();
  setTimeout(() => attachPopupHandlers(marker, row, farmaciaId), 0);
}

function handlePopupClose(marker, row, farmaciaId, isComunale){
  if(marker._skipAutosave){
    marker._skipAutosave = false;
    POPUP_DRAFT_CACHE.delete(farmaciaId);
    return;
  }
  // Autosave: prova dal DOM; se Leaflet ha gi√† rimosso il nodo, usa la bozza cache.
  const root = marker.getPopup()?.getElement();
  const wrap = root ? root.querySelector(".popupWrap") : null;
  if(wrap){
    const draft = collectPopupDraft(wrap);
    applyDraftToStore(marker, row, farmaciaId, isComunale, draft);
  }else{
    const cached = POPUP_DRAFT_CACHE.get(farmaciaId);
    if(cached){
      applyDraftToStore(marker, row, farmaciaId, isComunale, cached);
    }
  }
  POPUP_DRAFT_CACHE.delete(farmaciaId);
}

function attachPopupHandlers(marker, row, farmaciaId){
  const root = marker.getPopup()?.getElement();
  if(!root) return;

  const prev = POPUP_BINDERS.get(root);
  if(prev) prev.abort();
  const ac = new AbortController();
  POPUP_BINDERS.set(root, ac);
  const { signal } = ac;

  const wrap = root.querySelector(".popupWrap");
  if(!wrap) return;

  // Mantieni una bozza aggiornata per autosave affidabile (anche se Leaflet rimuove il DOM al close)
  const cacheNow = () => {
    try { POPUP_DRAFT_CACHE.set(farmaciaId, collectPopupDraft(wrap)); } catch(e){}
  };
  cacheNow();

  const flagsBox = wrap.querySelector('[data-role="aderisceFlags"]');

  const getCurrentState = () => {
    const onBtn = wrap.querySelector('button[data-role="state"][data-on="1"]');
    return onBtn ? (onBtn.getAttribute("data-value") || "contattare") : "contattare";
  };

  // state buttons
  wrap.querySelectorAll('button[data-role="state"]').forEach(btn => {
    btn.addEventListener("click", (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      wrap.querySelectorAll('button[data-role="state"]').forEach(b => b.setAttribute("data-on","0"));
      btn.setAttribute("data-on","1");
      const st = getCurrentState();
      if(flagsBox) flagsBox.style.display = (st==="aderisce") ? "" : "none";
      cacheNow();
    }, { signal });
  });

  // note + checkbox (closed + flags) -> aggiorna cache bozza
  const noteEl = wrap.querySelector('[data-role="note"]');
  if(noteEl){
    noteEl.addEventListener("input", () => cacheNow(), { signal });
  }
  wrap.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener("change", () => cacheNow(), { signal });
  });

  // remove owner chip (delegation)
  // IMPORTANTE: la X modifica SOLO la "bozza" (DOM). Il salvataggio avviene con Salva e chiudi
  // o con autosave (chiusura popup). Questo evita effetti strani (nomi che spariscono/ricompaiono).
  wrap.addEventListener("click", (ev) => {
    const t = ev.target;
    if(!(t instanceof HTMLElement)) return;
    if(t.getAttribute("data-role") === "rmOwner"){
      ev.preventDefault(); ev.stopPropagation();
      const chip = t.closest(".chip");
      if(chip) chip.remove();
      cacheNow();
    }
  }, { signal });

  // reset button (chiudi SENZA salvare)
  const btnReset = wrap.querySelector('[data-role="reset"]');
  if(btnReset){
    btnReset.addEventListener("click", (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      marker._skipAutosave = true;
      POPUP_DRAFT_CACHE.delete(farmaciaId);
      marker.closePopup();
    }, { signal });
  }

  // save button -> salva e chiudi
  const btnSave = wrap.querySelector('[data-role="save"]');
  if(btnSave){
    btnSave.addEventListener("click", (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      const draft = collectPopupDraft(wrap);
      const rec = farmMarkers.find(x => x.id === farmaciaId);
      const isComunale = rec ? rec.isComunale : isComunaleFromGestione(row.gestione);
      applyDraftToStore(marker, row, farmaciaId, isComunale, draft);

      // aggiorna contenuto "bound" per coerenza immediata
      marker.setPopupContent(buildPopupHtml(row, farmaciaId));
      POPUP_DRAFT_CACHE.delete(farmaciaId);

      marker._skipAutosave = true; // gi√† salvato
      marker.closePopup();
    }, { signal });
  }

  // Incaricati: aggiungi come chip (Enter o pulsante +)
  const ownersInput = wrap.querySelector('[data-role="ownersInput"]');
  const ownersChips = wrap.querySelector('[data-role="ownersChips"]');

  const addOwnersFromInput = () => {
    if(!ownersInput || !ownersChips) return;
    const raw = (ownersInput.value || "").trim();
    if(!raw) return;
    const names = uniq(raw.split(/[,;\n]+/).map(s=>s.trim()).filter(Boolean));
    if(!names.length) return;

    const existing = Array.from(ownersChips.querySelectorAll('[data-role="rmOwner"]'))
      .map(el => {
        const enc = (el.getAttribute("data-owner") || "").trim();
        try { return decodeURIComponent(enc); } catch(e){ return enc; }
      })
      .filter(Boolean);

    const merged = uniq([...existing, ...names]);
    ownersChips.innerHTML = merged.map(o => `<span class="chip">${esc(o)} <span class="xbtn" data-role="rmOwner" data-owner="${encodeURIComponent(o)}">√ó</span></span>`).join("");
    ownersInput.value = "";
    cacheNow();
  };

  const btnAdd = wrap.querySelector('[data-role="ownersAdd"]');
  if(btnAdd){
    btnAdd.addEventListener("click", (ev) => {
      ev.preventDefault(); ev.stopPropagation();
      addOwnersFromInput();
    }, { signal });
  }

  if(ownersInput){
    ownersInput.addEventListener("keydown", (ev) => {
      if(ev.key === "Enter"){
        ev.preventDefault();
        ev.stopPropagation();
        addOwnersFromInput();
      }
    }, { signal });
  }
}

/* ===============================
   STATS
================================ */
const MAIN_STATES = [
  { key:"contattare", label:"Da contattare", cls:"v-amber" },
  { key:"trattativa", label:"Trattativa", cls:"v-blue" },
  { key:"aderisce", label:"Aderisce", cls:"v-green" },
  { key:"rifiuta", label:"Non aderisce", cls:"v-red" },
];

function computeStats(ids){
  const counts = { contattare:0, trattativa:0, aderisce:0, rifiuta:0 };
  let priv=0, comu=0;
  ids.forEach(id => {
    const st = getSt(id).state || "contattare";
    if(counts[st] !== undefined) counts[st]++; else counts.contattare++;
    const rec = farmMarkers.find(x => x.id === id);
    if(rec){
      if(rec.isComunale) comu++; else priv++;
    }
  });
  return { counts, total: ids.length, priv, comu };
}

function aggiornaHUD(){
  const total = farmMarkers.length;
  const aderisce = farmMarkers.filter(x => getSt(x.id).state === "aderisce").length;
  const trattativa = farmMarkers.filter(x => getSt(x.id).state === "trattativa").length;
  const rifiuta = farmMarkers.filter(x => getSt(x.id).state === "rifiuta").length;
  const contattare = farmMarkers.filter(x => getSt(x.id).state === "contattare").length;

  const priv = farmMarkers.filter(x => !x.isComunale).length;
  const comu = farmMarkers.filter(x => x.isComunale).length;

  let coperti=0;
  comuniCanon.forEach(n => { if(hasRef(n)) coperti++; });
  const orfani = Math.max(0, comuniCanon.size - coperti);

  document.getElementById("g_total").textContent = String(total);
  document.getElementById("g_aderisce").textContent = String(aderisce);

  const pct = total ? Math.round((aderisce/total)*100) : 0;
  document.getElementById("g_aderisce_pct").textContent = `${pct}%`;
  document.getElementById("g_bar").style.width = `${pct}%`;

  document.getElementById("g_trattativa").textContent = String(trattativa);
  document.getElementById("g_rifiuta").textContent = String(rifiuta);
  document.getElementById("g_contattare").textContent = String(contattare);

  document.getElementById("g_private").textContent = String(priv);
  document.getElementById("g_comunali").textContent = String(comu);

  document.getElementById("g_comuni_coperti").textContent = String(coperti);
  document.getElementById("g_comuni_orfani").textContent = String(orfani);

  // status grid (cliccabile)
  const grid = document.getElementById("g_statusGrid");
  grid.innerHTML = "";
  for(const s of MAIN_STATES){
    const n = farmMarkers.filter(x => getSt(x.id).state === s.key).length;
    const el = document.createElement("div");
    el.className = "stat";
    el.style.cursor = "pointer";
    el.style.borderColor = (stateFilter===s.key) ? "#00ff9c" : "#1f1f1f";
    el.innerHTML = `<div class="stat-title">${s.label}</div><div class="stat-value ${s.cls}">${n}</div>`;
    el.setAttribute("data-state", s.key);
    grid.appendChild(el);
  }

  // flags among aderisce
  const aderIds = farmMarkers.filter(x => getSt(x.id).state==="aderisce").map(x=>x.id);
  let poster=0, boicotta=0, promo=0, info=0;
  aderIds.forEach(id => {
    const f = (getSt(id).flags)||{};
    if(f.poster) poster++;
    if(f.boicotta) boicotta++;
    if(f.promo) promo++;
    if(f.info) info++;
  });
  document.getElementById("g_poster").textContent = String(poster);
  document.getElementById("g_boicotta").textContent = String(boicotta);
  document.getElementById("g_promo").textContent = String(promo);
  document.getElementById("g_info").textContent = String(info);

  // hint: quali file sono stati caricati
  const hint = document.getElementById("g_hint");
  if(hint && window.__loadedPaths){
    hint.textContent = `dati: ${window.__loadedPaths.farmacie.split("/")[0]}`;
  }
}
// click su grid: filtro stato
document.getElementById("g_statusGrid").addEventListener("click", (ev) => {
  const t = ev.target;
  if(!(t instanceof HTMLElement)) return;
  const card = t.closest("[data-state]");
  if(!card) return;
  const st = card.getAttribute("data-state");
  if(!st) return;
  setStateFilter(stateFilter === st ? null : st);
});

function aggiornaComuneSelezionato(){
  const grid = document.getElementById("comuneCounts");
  grid.innerHTML = "";
  if(!selectedComuneNome){
    selNomeEl.textContent = "‚Äî";
    grid.innerHTML =
      `<div class="stat"><div class="stat-title">Farmacie</div><div class="stat-value v-muted">‚Äî</div></div>
       <div class="stat"><div class="stat-title">Seleziona un comune</div><div class="stat-value v-muted">‚Äî</div></div>`;
    return;
  }
  selNomeEl.textContent = selectedComuneNome;

  const items = farmMarkers.filter(x => x.comune === selectedComuneNome);
  const total = items.length;
  const priv = items.filter(x => !x.isComunale).length;
  const comu = items.filter(x => x.isComunale).length;

  const mk = (title, value, cls="v-muted") => {
    const el=document.createElement("div");
    el.className="stat";
    el.innerHTML=`<div class="stat-title">${title}</div><div class="stat-value ${cls}">${value}</div>`;
    return el;
  };
  grid.appendChild(mk("Farmacie", total, "v-muted"));
  grid.appendChild(mk("Private / Comunali", `${priv} / ${comu}`, "v-muted"));

  for(const s of MAIN_STATES){
    const n = items.filter(x => getSt(x.id).state === s.key).length;
    grid.appendChild(mk(s.label, n, s.cls));
  }
}

/* ===============================
   Overlay statistiche mappa
   - Se un comune √® selezionato: mostra stats del comune
   - altrimenti: stats globali
================================ */
function aggiornaMapStats(){
  const title = document.getElementById("ms_title");
  const elA = document.getElementById("ms_aderisce");
  const elT = document.getElementById("ms_total");
  const elP = document.getElementById("ms_pct");
  const elB = document.getElementById("ms_bar");
  const elBnc = document.getElementById("ms_bar_nc");
  const elNC = document.getElementById("ms_nc");
  const elNCpct = document.getElementById("ms_nc_pct");
const elTr = document.getElementById("ms_trattativa");
  const elR = document.getElementById("ms_rifiuta");
  const elC = document.getElementById("ms_contattare");
  const elF = document.getElementById("ms_filter");

  let ids = farmMarkers.map(x=>x.id);
  if(selectedComuneNome){
    ids = farmMarkers.filter(x=>x.comune===selectedComuneNome).map(x=>x.id);
    title.textContent = `Comune di ${selectedComuneNome}`;
  } else {
    title.textContent = "Avanzamento campagna";
  }

  const { counts, total } = computeStats(ids);
  const pct = total ? Math.round((counts.aderisce/total)*100) : 0;

  elA.textContent = String(counts.aderisce);
  elT.textContent = String(total);
  elP.textContent = `${pct}%`;
  elB.style.width = `${pct}%`;

  const pctNc = total ? Math.round((counts.contattare/total)*100) : 0;
  if(elBnc) elBnc.style.width = `${pctNc}%`;
  if(elNC) elNC.textContent = String(counts.contattare);
  if(elNCpct) elNCpct.textContent = `${pctNc}%`;
elTr.textContent = String(counts.trattativa);
  elR.textContent = String(counts.rifiuta);
  elC.textContent = String(counts.contattare);

  if(stateFilter){
    elF.style.display = "";
    const label = MAIN_STATES.find(x=>x.key===stateFilter)?.label || stateFilter;
    elF.innerHTML = `Vista filtrata: <b>${esc(label)}</b> (solo evidenziazione)`;
  } else {
    elF.style.display = "none";
    elF.textContent = "";
  }
}

/* ===============================
   VISIBILIT√Ä MARKER (comune + filtro)
================================ */
function applyMarkerVisibility(){
  farmMarkers.forEach(f => {
    const st = getSt(f.id);
    const matchComune = (!selectedComuneNome) || (f.comune === selectedComuneNome);
    const matchState = (!stateFilter) || (st.state === stateFilter);

    let op = 1;
    if(selectedComuneNome && !matchComune) op = 0.18;
    if(stateFilter && matchComune && !matchState) op = selectedComuneNome ? 0.08 : 0.06;
    if(stateFilter && !matchComune && !matchState) op = 0.03;

    if(st.closed) op = op * 0.35;
    f.marker.setOpacity(op);
  });
}

/* ===============================
   SELEZIONE COMUNE
================================ */
function selezionaComune(layer, nome){
  selectedComuneLayer = layer;
  selectedComuneNome = nome;

  aggiornaStiliComuni();
  fitBoundsSmart(layer.getBounds());

  banner.style.display="block";
  banner.innerHTML = `‚Üë Comune di <b>${esc(nome)}</b>`;

  hudTitle.textContent = `Comune di ${nome}`;
  const nRef = hasRef(nome) ? (referentiComune[nome].length) : 0;
  hudSub.textContent = hasRef(nome) ? `Referenti presenti: ${nRef}` : `Referenti: 0`;

  aggiornaComuneSelezionato();
  aggiornaMapStats();
  if(refPanelVisible) renderReferentiPanel();

  applyMarkerVisibility();
}

function resetSelezione(){
  selectedComuneLayer = null;
  selectedComuneNome = null;
  banner.style.display="none";

  hudTitle.textContent="Provincia di Verona";
  hudSub.textContent="Vista generale";

  aggiornaStiliComuni();
  aggiornaComuneSelezionato();
  aggiornaMapStats();
  if(refPanelVisible) renderReferentiPanel();

  applyMarkerVisibility();
}

/* ===============================
   REFERENTI COMUNE UI
================================ */
const refPanel = document.getElementById("refPanel");
const refList = document.getElementById("refList");
let refPanelVisible = false;

function renderReferentiPanel(){
  if(!selectedComuneNome){
    refList.innerHTML = `<li><span>Seleziona un comune</span></li>`;
    return;
  }
  const list = referentiComune[selectedComuneNome] || [];
  refList.innerHTML = "";
  if(!list.length){
    const li=document.createElement("li");
    li.innerHTML = `<span style="color:#bdbdbd">Nessun referente inserito.</span><span></span>`;
    refList.appendChild(li);
    return;
  }
  list.forEach(name => {
    const li=document.createElement("li");
    li.innerHTML = `<span>${esc(name)}</span><span class="xbtn" title="Rimuovi" data-rm-ref="${encodeURIComponent(name)}">√ó</span>`;
    refList.appendChild(li);
  });
}

document.getElementById("btnAddRef").addEventListener("click", () => {
  if(!selectedComuneNome){ alert("Seleziona prima un comune."); return; }
  const n = prompt("Inserisci il nome del referente (visibile nella lista)");
  if(!n) return;
  if(!referentiComune[selectedComuneNome]) referentiComune[selectedComuneNome] = [];
  if(!referentiComune[selectedComuneNome].includes(n)) referentiComune[selectedComuneNome].push(n);

  saveRefStore(referentiComune);
  aggiornaStiliComuni();
  aggiornaHUD();
  aggiornaMapStats();
  if(refPanelVisible){
    refPanel.style.display="block";
    renderReferentiPanel();
  }
  hudSub.textContent = `Referenti presenti: ${referentiComune[selectedComuneNome].length}`;
});

document.getElementById("btnToggleRef").addEventListener("click", () => {
  if(!selectedComuneNome){ alert("Seleziona prima un comune."); return; }
  refPanelVisible = !refPanelVisible;
  refPanel.style.display = refPanelVisible ? "block" : "none";
  if(refPanelVisible) renderReferentiPanel();
  document.getElementById("btnToggleRef").textContent = refPanelVisible ? "Nascondi referenti" : "Vedi referenti";
});

refList.addEventListener("click", (ev) => {
  const t = ev.target;
  if(!(t instanceof HTMLElement)) return;
  const rmEnc = t.getAttribute("data-rm-ref");
  if(rmEnc && selectedComuneNome){
    ev.preventDefault(); ev.stopPropagation();
    let rm = rmEnc;
    try { rm = decodeURIComponent(rmEnc); } catch(e){}
    referentiComune[selectedComuneNome] = (referentiComune[selectedComuneNome] || []).filter(x => x !== rm);
    saveRefStore(referentiComune);

    aggiornaStiliComuni();
    aggiornaHUD();
    aggiornaMapStats();
    renderReferentiPanel();
    hudSub.textContent = hasRef(selectedComuneNome) ? `Referenti presenti: ${(referentiComune[selectedComuneNome]||[]).length}` : "Referenti: 0";
  }
});

/* ===============================
   LOAD COMUNI + FARMACIE
================================ */
async function loadAll(){
  try{
    const comuniRes = await fetchFirst(PATHS_COMUNI, "json");
    const csvRes = await fetchFirst(PATHS_FARMACIE, "text");
    window.__loadedPaths = { comuni: comuniRes.path, farmacie: csvRes.path };

    // comuni
    comuniLayer = L.geoJSON(comuniRes.data, {
      style: f => {
        const nome = nomeComuneFromFeature(f);
        comuneCanonByNorm[normKey(nome)] = nome;
        comuniCanon.add(nome);
        return styleComuneBase(nome);
      },
      onEachFeature: (f, layer) => {
        const nome = nomeComuneFromFeature(f);
        layer.on("click", () => selezionaComune(layer, nome));

        const center = layer.getBounds().getCenter();
        const label = L.marker(center, {
          interactive:false,
          icon: L.divIcon({ className:"label-comune", html: esc(nome), iconSize:[140,16] })
        });
        labels.push(label);
      }
    }).addTo(map);

    map.fitBounds(comuniLayer.getBounds());

    // labels on zoom
    map.on("zoomend", () => {
      const z = map.getZoom();
      const prev = (lastZoomLevel === null) ? z : lastZoomLevel;
      const zoomedOut = z < (prev - 1e-9);
      lastZoomLevel = z;

      // Se guardo un comune e faccio zoom-out: salva+chiudi popup, reset selezione, tornano i nomi
      if(selectedComuneNome && zoomedOut){
        farmMarkers.forEach(f => {
          const m = f.marker;
          if(m && m.isPopupOpen && m.isPopupOpen()){
            autoSavePopup(m, f.row, f.id, f.isComunale);
            m._skipAutosave = true;
            m.closePopup();
          }
        });
        resetSelezione();
      }

      const show = (!selectedComuneNome && z>=9 && z<=13);
      labels.forEach(l => { show ? map.addLayer(l) : map.removeLayer(l); });
    });

    aggiornaStiliComuni();

    // farmacie
    const parsed = Papa.parse(csvRes.data, { header:true, skipEmptyLines:true });
    window.__farmacieFields = (parsed.meta && parsed.meta.fields) ? parsed.meta.fields.slice() : [];
    const rows = parsed.data || [];

    rows.forEach(row => {
      const comuneRaw = (row.comune || "").trim();
      if(!comuneRaw) return;
      const comune = canonComune(comuneRaw);

      const coord = parseCoordinateCell(row.coordinate);
      if(!coord) return;

      const farmaciaId =
        (row.farmacia_id || row.farmaciaId || row.id || "").toString().trim() ||
        stableId(`${row.maps_url||""}|${row.descrizione_farmacia||""}|${comune}`);

      if(!statusStore[farmaciaId]) setSt(farmaciaId, getSt(farmaciaId));

      const isComunale = isComunaleFromGestione(row.gestione);
      const st = getSt(farmaciaId);

      const marker = L.marker([coord.lat, coord.lon], {
        icon: iconFarmacia(st.state, st.closed, isComunale),
        opacity: st.closed ? 0.35 : 1
      });

      // Contenuto popup: viene rigenerato ad ogni apertura per riflettere SEMPRE lo stato salvato
      // (evita che i chip/nomi "spariscano" dopo Salva e ricompaiano solo dopo un refresh).
      marker.bindPopup(buildPopupHtml(row, farmaciaId), { maxWidth: 420, autoPan:true });
      marker.on("popupopen", () => {
        // rigenera contenuto dal data-store (localStorage)
        marker.setPopupContent(buildPopupHtml(row, farmaciaId));
        applyPopupAutoPan(marker.getPopup());
        // i listener vanno attaccati dopo che Leaflet ha inserito il DOM del popup
        setTimeout(() => attachPopupHandlers(marker, row, farmaciaId), 0);
      });
      marker.on("popupclose", () => handlePopupClose(marker, row, farmaciaId, isComunale));

      marker.addTo(farmLayer);

      farmMarkers.push({ id: farmaciaId, comune, gestione: (row.gestione||""), isComunale, marker, row });

      applyStatusToMarker(marker, farmaciaId, row, isComunale);
    });

    aggiornaHUD();
    aggiornaComuneSelezionato();
    aggiornaMapStats();
    applyMarkerVisibility();

    // labels iniziali
    const z = map.getZoom();
    const show = (!selectedComuneNome && z>=9 && z<=13);
    labels.forEach(l => { show ? map.addLayer(l) : map.removeLayer(l); });

  }catch(e){
    console.error(e);
    alert("Errore nel caricamento dati (controlla cartelle DATA/data e i file).");
  }
}


/* ===============================
   EXPORT / PRINT (Excel/CSV + stampa)
================================ */
function getExportScope(){
  // se un comune √® selezionato, proponi export locale (utile sul campo)
  if(selectedComuneNome){
    try{
      return confirm(`Esportare SOLO il comune selezionato (‚Äú${selectedComuneNome}‚Äù)?\n\nOK = solo comune\nAnnulla = tutta la provincia`) ? selectedComuneNome : null;
    }catch(e){
      return null;
    }
  }
  return null;
}

function buildExportRows(scopeComune=null){
  const rows = farmMarkers
    .filter(f => !scopeComune || f.comune === scopeComune)
    .map(f => {
      const st = getSt(f.id) || defaultStatus();
      const base = { ...(f.row || {}) };

      // campi "campagna" + utilit√†
      base.__id = f.id;
      base.comune_canon = f.comune;
      base.stato_campagna = st.state || "contattare";
      base.chiusa_temporaneamente = !!st.closed;
      base.incaricati = uniq(normalizeOwners(st.owners)).join("; ");
      base.note = st.note || "";
      const fl = st.flags || {};
      base.flag_poster = !!fl.poster;
      base.flag_boicotta = !!fl.boicotta;
      base.flag_promo = !!fl.promo;
      base.flag_info = !!fl.info;
      base.updatedAt = st.updatedAt || "";

      return base;
    });

  return rows;
}

function computeExportStats(scopeComune=null){
  const ids = farmMarkers.filter(f => !scopeComune || f.comune === scopeComune).map(f => f.id);
  const s = computeStats(ids);

  // flags tra gli "aderisce"
  let poster=0, boicotta=0, promo=0, info=0;
  ids.forEach(id => {
    const st = getSt(id);
    if((st.state||"contattare") !== "aderisce") return;
    const f = st.flags || {};
    if(f.poster) poster++;
    if(f.boicotta) boicotta++;
    if(f.promo) promo++;
    if(f.info) info++;
  });

  // comuni coperti/orfani (ridimensionati ma utili in export)
  let coperti=0;
  const comuniInScope = new Set();
  farmMarkers.forEach(f => { if(!scopeComune || f.comune === scopeComune) comuniInScope.add(f.comune); });
  comuniInScope.forEach(c => { if(hasRef(c)) coperti++; });
  const orfani = Math.max(0, comuniInScope.size - coperti);

  const aderisce = s.counts.aderisce;
  const pct = s.total ? Math.round((aderisce/s.total)*100) : 0;

  return {
    ambito: scopeComune ? scopeComune : "Provincia di Verona",
    data_export: new Date().toISOString(),
    totale: s.total,
    aderisce,
    aderisce_pct: pct,
    trattativa: s.counts.trattativa,
    rifiuta: s.counts.rifiuta,
    contattare: s.counts.contattare,
    private: s.priv,
    comunali: s.comu,
    comuni_coperti: coperti,
    comuni_orfani: orfani,
    flags: { poster, boicotta, promo, info }
  };
}

function groupRowsByState(rows){
  const g = { contattare:[], trattativa:[], aderisce:[], rifiuta:[] };
  rows.forEach(r => {
    const st = (r.stato_campagna || "contattare");
    if(g[st]) g[st].push(r);
    else g.contattare.push(r);
  });
  return g;
}

function downloadBlob(filename, mime, content){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

function csvEscape(v){
  const s = (v===null || v===undefined) ? "" : String(v);
  if(/[",\n\r;]/.test(s)){
    return '"' + s.replace(/"/g,'""') + '"';
  }
  return s;
}

function rowsToCSV(rows, cols){
  const header = cols.map(csvEscape).join(",");
  const lines = rows.map(r => cols.map(c => csvEscape(r[c])).join(","));
  return [header, ...lines].join("\n");
}

function getExportColumns(){
  const base = (window.__farmacieFields && window.__farmacieFields.length) ? window.__farmacieFields.slice() : [];
  // fallback: usa le chiavi del primo record
  if(base.length === 0 && farmMarkers[0] && farmMarkers[0].row){
    base.push(...Object.keys(farmMarkers[0].row));
  }

  // colonne "campagna" (in fondo)
  const extra = ["__id","comune_canon","stato_campagna","chiusa_temporaneamente","incaricati","note","flag_poster","flag_boicotta","flag_promo","flag_info","updatedAt"];
  const cols = [];
  base.forEach(c => { if(!cols.includes(c)) cols.push(c); });
  extra.forEach(c => { if(!cols.includes(c)) cols.push(c); });
  return cols;
}

function exportCSV(){
  if(!farmMarkers.length){ alert("Nessuna farmacia caricata."); return; }

  const scope = getExportScope();
  const stats = computeExportStats(scope);
  const rows = buildExportRows(scope);
  const grouped = groupRowsByState(rows);
  const cols = getExportColumns();

  // 1) CSV farmacie (tutte, con colonna stato_campagna)
  const csvFarm = rowsToCSV(rows, cols);
  const baseName = scope ? `export_${normKey(scope).replace(/\s+/g,'_')}` : "export_provincia_verona";
  downloadBlob(`${baseName}_farmacie.csv`, "text/csv;charset=utf-8", csvFarm);

  // 2) CSV statistiche (key-value)
  const statsRows = [
    { metrica:"Ambito", valore: stats.ambito },
    { metrica:"Data export", valore: stats.data_export },
    { metrica:"Totale farmacie", valore: stats.totale },
    { metrica:"Aderiscono", valore: stats.aderisce },
    { metrica:"Aderiscono (%)", valore: stats.aderisce_pct },
    { metrica:"Trattativa", valore: stats.trattativa },
    { metrica:"Non aderisce", valore: stats.rifiuta },
    { metrica:"Da contattare", valore: stats.contattare },
    { metrica:"Private", valore: stats.private },
    { metrica:"Comunali", valore: stats.comunali },
    { metrica:"Comuni coperti", valore: stats.comuni_coperti },
    { metrica:"Comuni orfani", valore: stats.comuni_orfani },
    { metrica:"Aderisce: Poster", valore: stats.flags.poster },
    { metrica:"Aderisce: Boicotta", valore: stats.flags.boicotta },
    { metrica:"Aderisce: Promo", valore: stats.flags.promo },
    { metrica:"Aderisce: Info", valore: stats.flags.info },
  ];
  const csvStats = rowsToCSV(statsRows, ["metrica","valore"]);
  downloadBlob(`${baseName}_statistiche.csv`, "text/csv;charset=utf-8", csvStats);

  // 3) opzionale: CSV divisi per stato (4 file)
  let wantSplit = false;
  try{
    wantSplit = confirm("Vuoi scaricare anche 4 CSV separati (uno per stato: Aderisce/Trattativa/Non aderisce/Da contattare)?");
  }catch(e){ wantSplit = false; }

  if(wantSplit){
    const order = [
      ["aderisce","aderisce"],
      ["trattativa","trattativa"],
      ["rifiuta","non_aderisce"],
      ["contattare","da_contattare"],
    ];
    order.forEach(([k, suffix]) => {
      const csv = rowsToCSV(grouped[k], cols);
      downloadBlob(`${baseName}_${suffix}.csv`, "text/csv;charset=utf-8", csv);
    });
  }
}

function exportXLSX(){
  if(!farmMarkers.length){ alert("Nessuna farmacia caricata."); return; }
  if(!window.XLSX){
    alert("Libreria Excel non caricata. Uso CSV.");
    exportCSV();
    return;
  }

  const scope = getExportScope();
  const stats = computeExportStats(scope);
  const rows = buildExportRows(scope);
  const grouped = groupRowsByState(rows);
  const cols = getExportColumns();

  // Statistiche (key-value)
  const statsAOA = [
    ["Ambito", stats.ambito],
    ["Data export", stats.data_export],
    ["Totale farmacie", stats.totale],
    ["Aderiscono", stats.aderisce],
    ["Aderiscono (%)", stats.aderisce_pct],
    ["Trattativa", stats.trattativa],
    ["Non aderisce", stats.rifiuta],
    ["Da contattare", stats.contattare],
    ["Private", stats.private],
    ["Comunali", stats.comunali],
    ["Comuni coperti", stats.comuni_coperti],
    ["Comuni orfani", stats.comuni_orfani],
    ["Aderisce: Poster", stats.flags.poster],
    ["Aderisce: Boicotta", stats.flags.boicotta],
    ["Aderisce: Promo", stats.flags.promo],
    ["Aderisce: Info", stats.flags.info],
  ];

  // Statistiche per comune (sempre utile, anche se scope=null)
  const comuniSet = new Set();
  farmMarkers.forEach(f => { if(!scope || f.comune === scope) comuniSet.add(f.comune); });
  const comuniArr = Array.from(comuniSet).sort((a,b)=>a.localeCompare(b));
  const comuniAOA = [["Comune","Totale","Aderisce","Aderisce (%)","Trattativa","Non aderisce","Da contattare","Private","Comunali","Referenti"]];
  comuniArr.forEach(c => {
    const ids = farmMarkers.filter(f => f.comune===c && (!scope || f.comune===scope)).map(f=>f.id);
    const s = computeStats(ids);
    const ader = s.counts.aderisce;
    const pct = s.total ? Math.round((ader/s.total)*100) : 0;
    const refs = (referentiComune[c] || []).join(", ");
    comuniAOA.push([c, s.total, ader, pct, s.counts.trattativa, s.counts.rifiuta, s.counts.contattare, s.priv, s.comu, refs]);
  });

  function sheetFromAOA(aoa){ return XLSX.utils.aoa_to_sheet(aoa); }
  function sheetFromRows(rs){
    const aoa = [cols];
    rs.forEach(r => aoa.push(cols.map(c => (r[c]===undefined? "" : r[c]))));
    return XLSX.utils.aoa_to_sheet(aoa);
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, sheetFromAOA(statsAOA), "Statistiche");
  XLSX.utils.book_append_sheet(wb, sheetFromAOA(comuniAOA), "Statistiche comuni");
  XLSX.utils.book_append_sheet(wb, sheetFromRows(rows), "Tutte");

  // divise per stato (sheet separati)
  XLSX.utils.book_append_sheet(wb, sheetFromRows(grouped.aderisce), "Aderisce");
  XLSX.utils.book_append_sheet(wb, sheetFromRows(grouped.trattativa), "Trattativa");
  XLSX.utils.book_append_sheet(wb, sheetFromRows(grouped.rifiuta), "Non aderisce");
  XLSX.utils.book_append_sheet(wb, sheetFromRows(grouped.contattare), "Da contattare");

  const file = scope ? `export_spg_${normKey(scope).replace(/\s+/g,'_')}.xlsx` : "export_spg_provincia_verona.xlsx";
  XLSX.writeFile(wb, file);
}


function exportSoloAderisce(){
  if(!farmMarkers.length){ alert("Nessuna farmacia caricata."); return; }

  const scope = getExportScope();
  const stats = computeExportStats(scope);
  const rows = buildExportRows(scope);
  const aderisceRows = rows.filter(r => (r.stato_campagna || "contattare") === "aderisce");

  // Se non c'√® XLSX => CSV
  if(!window.XLSX){
    const cols = getExportColumns();
    const csv = rowsToCSV(aderisceRows, cols);
    const baseName = scope ? `export_${normKey(scope).replace(/\s+/g,'_')}` : "export_provincia_verona";
    downloadBlob(`${baseName}_solo_aderisce.csv`, "text/csv;charset=utf-8", csv);
    return;
  }

  const wb = XLSX.utils.book_new();
  const statsAOA = [
    ["Campo","Valore"],
    ["Ambito", scope ? scope : "Provincia di Verona"],
    ["Data export", stats.data_export],
    ["Totale farmacie", stats.totale],
    ["Aderiscono", stats.aderisce],
    ["Aderiscono (%)", stats.aderisce_pct + "%"],
    ["Trattativa", stats.trattativa],
    ["Non aderisce", stats.rifiuta],
    ["Da contattare", stats.contattare],
  ];
  XLSX.utils.book_append_sheet(wb, sheetFromAOA(statsAOA), "Statistiche");
  XLSX.utils.book_append_sheet(wb, sheetFromRows(aderisceRows), "Aderisce");

  const file = scope ? `solo_aderisce_spg_${normKey(scope).replace(/\s+/g,'_')}.xlsx`
                     : "solo_aderisce_spg_provincia_verona.xlsx";
  XLSX.writeFile(wb, file);
}

function printSoloAderisce(){
  if(!farmMarkers.length){ alert("Nessuna farmacia caricata."); return; }

  const scope = getExportScope();
  const stats = computeExportStats(scope);
  const rows = buildExportRows(scope).filter(r => (r.stato_campagna || "contattare") === "aderisce");

  const cols = [
    { key:"descrizione_farmacia", label:"Farmacia" },
    { key:"gestione", label:"Gestione" },
    { key:"indirizzo_full", label:"Indirizzo" },
    { key:"cap", label:"CAP" },
    { key:"comune", label:"Comune" },
    { key:"telefono", label:"Telefono" },
    { key:"email", label:"Email" },
    { key:"maps_url", label:"Maps" },
    { key:"incaricati", label:"Incaricati" },
    { key:"note", label:"Note" },
  ];

  const header = cols.map(c => `<th>${esc(c.label)}</th>`).join("");
  const body = rows.map(r => `<tr>${cols.map(c => {
    let v = r[c.key] ?? "";
    if(c.key==="maps_url" && v) return `<td><a href="${esc(String(v))}" target="_blank" rel="noopener">Apri</a></td>`;
    return `<td>${esc(String(v))}</td>`;
  }).join("")}</tr>`).join("");

  const title = scope ? `Solo aderisce ‚Äî ${scope}` : "Solo aderisce ‚Äî Provincia di Verona";

  const html = `<!DOCTYPE html><html lang="it"><head><meta charset="utf-8"/>
  <title>${esc(title)}</title>
  <style>
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:18px; }
    h1{ margin:0 0 6px; font-size:20px; }
    .meta{ color:#333; font-size:12px; margin:0 0 14px; }
    .pill{ display:inline-block; background:#00ff9c; color:#111; padding:2px 10px; border-radius:999px; font-weight:900; }
    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th,td{ border:1px solid #ddd; padding:6px 8px; vertical-align:top; }
    th{ background:#f4f4f4; text-align:left; }
    a{ color:#111; font-weight:800; }
  </style></head><body>
    <h1>${esc(title)}</h1>
    <div class="meta">Export: ${esc(stats.data_export)} ¬∑ <span class="pill">Aderiscono: ${stats.aderisce}/${stats.totale} (${stats.aderisce_pct}%)</span></div>
    <table><thead><tr>${header}</tr></thead><tbody>${body}</tbody></table>
    <script>window.onload = () => setTimeout(()=>window.print(), 50);<\/script>
  </body></html>`;

  const w = window.open("", "_blank");
  if(!w){ alert("Popup bloccato dal browser."); return; }
  w.document.open(); w.document.write(html); w.document.close();
}

function printReport(){
  if(!farmMarkers.length){ alert("Nessuna farmacia caricata."); return; }

  const scope = getExportScope();
  const stats = computeExportStats(scope);
  const rows = buildExportRows(scope);
  const grouped = groupRowsByState(rows);

  const nice = {
    contattare: "Da contattare",
    trattativa: "Trattativa",
    aderisce: "Aderisce",
    rifiuta: "Non aderisce"
  };

  const cols = [
    "comune_canon","descrizione_farmacia","gestione","indirizzo_full","telefono",
    "stato_campagna","chiusa_temporaneamente","incaricati","note","flag_poster","flag_boicotta","flag_promo","flag_info","updatedAt","maps_url"
  ];

  function td(v){
    const s = (v===null||v===undefined) ? "" : String(v);
    return `<td>${esc(s)}</td>`;
  }
  function tableFor(list){
    const head = `<tr>${cols.map(c=>`<th>${esc(c)}</th>`).join("")}</tr>`;
    const body = list.map(r=>`<tr>${cols.map(c=>td(r[c])).join("")}</tr>`).join("");
    return `<table><thead>${head}</thead><tbody>${body}</tbody></table>`;
  }

  const html = `
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Report SpG - ${esc(stats.ambito)}</title>
<style>
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:18px; color:#111; }
  h1{ margin:0 0 8px; font-size:20px; }
  .meta{ color:#444; font-size:12px; margin-bottom:14px; }
  .cards{ display:grid; grid-template-columns:repeat(4,minmax(150px,1fr)); gap:10px; margin:12px 0 16px; }
  .card{ border:1px solid #ddd; border-radius:10px; padding:10px; }
  .card .k{ font-size:11px; text-transform:uppercase; letter-spacing:.08em; color:#666; }
  .card .v{ font-size:22px; font-weight:800; margin-top:2px; }
  .bar{ height:10px; border:1px solid #ddd; border-radius:999px; overflow:hidden; background:#f4f4f4; }
  .bar > div{ height:100%; width:${stats.aderisce_pct}%; background:#00c37a; }
  h2{ margin:18px 0 8px; font-size:16px; page-break-after: avoid; }
  table{ width:100%; border-collapse:collapse; font-size:11px; }
  th, td{ border:1px solid #e3e3e3; padding:6px 6px; vertical-align:top; }
  th{ background:#f5f5f5; text-align:left; }
  .pb{ page-break-before: always; }
  @media print{
    body{ margin:10mm; }
    .cards{ grid-template-columns:repeat(4,minmax(0,1fr)); }
    a{ color:inherit; text-decoration:none; }
  }
</style>
</head>
<body>
  <h1>Report campagna SpG ‚Äî ${esc(stats.ambito)}</h1>
  <div class="meta">Export: ${esc(stats.data_export)} ¬∑ Totale: ${stats.totale} ¬∑ Aderiscono: ${stats.aderisce} (${stats.aderisce_pct}%)</div>
  <div class="bar"><div></div></div>

  <div class="cards">
    <div class="card"><div class="k">Aderiscono</div><div class="v">${stats.aderisce}/${stats.totale}</div></div>
    <div class="card"><div class="k">Trattativa</div><div class="v">${stats.trattativa}</div></div>
    <div class="card"><div class="k">Non aderisce</div><div class="v">${stats.rifiuta}</div></div>
    <div class="card"><div class="k">Da contattare</div><div class="v">${stats.contattare}</div></div>
  </div>

  <div class="cards" style="grid-template-columns:repeat(4,minmax(150px,1fr)); margin-top:0">
    <div class="card"><div class="k">Private</div><div class="v">${stats.private}</div></div>
    <div class="card"><div class="k">Comunali</div><div class="v">${stats.comunali}</div></div>
    <div class="card"><div class="k">Comuni coperti</div><div class="v">${stats.comuni_coperti}</div></div>
    <div class="card"><div class="k">Comuni orfani</div><div class="v">${stats.comuni_orfani}</div></div>
  </div>

  <div class="cards" style="grid-template-columns:repeat(4,minmax(150px,1fr)); margin-top:0">
    <div class="card"><div class="k">Poster</div><div class="v">${stats.flags.poster}</div></div>
    <div class="card"><div class="k">Boicotta</div><div class="v">${stats.flags.boicotta}</div></div>
    <div class="card"><div class="k">Promo</div><div class="v">${stats.flags.promo}</div></div>
    <div class="card"><div class="k">Info</div><div class="v">${stats.flags.info}</div></div>
  </div>

  ${["aderisce","trattativa","rifiuta","contattare"].map((k, idx)=>`
    <h2 class="${idx? "pb":""}">${nice[k]} ‚Äî ${grouped[k].length}</h2>
    ${tableFor(grouped[k])}
  `).join("")}

  <script>window.onload = () => setTimeout(()=>window.print(), 50);<\/script>
</body>
</html>`;

  const w = window.open("", "_blank");
  if(!w){ alert("Popup bloccato dal browser."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// wiring bottoni
document.getElementById("btnExportXLSX")?.addEventListener("click", exportXLSX);
document.getElementById("btnExportCSV")?.addEventListener("click", exportCSV);
document.getElementById("btnPrintReport")?.addEventListener("click", printReport);
document.getElementById("btnExportAderisce")?.addEventListener("click", () => {
  const ok = confirm("SOLO ADERISCE\n\nOK = scarica file (Excel se disponibile, altrimenti CSV)\nAnnulla = stampa elenco");
  if(ok) exportSoloAderisce(); else printSoloAderisce();
});
// START
initUIMode();
loadAll();
</script>
</body>
</html>

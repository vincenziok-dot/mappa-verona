<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona – Farmacie e Medici</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map { position:absolute; inset:0; z-index:1; }

/* overlay */
#dark-overlay {
  position:absolute; inset:0;
  background: radial-gradient(circle,
    rgba(0,0,0,.15) 0%,
    rgba(0,0,0,.4) 55%,
    rgba(0,0,0,.6) 100%);
  pointer-events:none;
  z-index:2;
}

/* HUD */
#hud {
  position: fixed;
  top: 14px;
  left: 14px;
  z-index: 9999;
  width: 360px;
  padding: 14px;
  background: rgba(8,8,8,.95);
  border-left: 4px solid #00ff9c;
  box-shadow: 0 0 22px rgba(0,0,0,.8);
  color:#fff;
}

.hud-title { font-size:18px; font-weight:650; }
.hud-sub { font-size:13px; color:#bfbfbf; margin-top:6px; }

.section {
  margin-top:12px;
}
.section h4 {
  margin:0 0 6px;
  font-size:12px;
  color:#9ef5d9;
  letter-spacing:.8px;
  text-transform:uppercase;
}

/* elenco */
.list {
  max-height:180px;
  overflow-y:auto;
  background:#0f0f0f;
  padding:6px;
}
.item {
  padding:6px;
  border-bottom:1px solid rgba(255,255,255,.05);
  cursor:pointer;
}
.item:hover { background:#1a1a1a; }

.badge {
  display:inline-block;
  font-size:10px;
  padding:2px 6px;
  margin-left:6px;
}
.accetta { background:#00ff9c; color:#000; }
.in_trattativa { background:#4da6ff; }
.da_contattare { background:#ffaa00; color:#000; }
.rifiuta { background:#ff4d4d; }

.marker-dot {
  width:12px; height:12px;
  border-radius:50%;
  display:inline-block;
}
.marker-triangle {
  width:0; height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-bottom:12px solid;
  display:inline-block;
}
.private { border-color:transparent; }
.comunale { }

/* marker styles */
.farmacia-accetta { background:#00ff9c; border-bottom-color:#00ff9c; }
.farmacia-in_trattativa { background:#4da6ff; border-bottom-color:#4da6ff;}
.farmacia-da_contattare { background:#ffaa00; border-bottom-color:#ffaa00;}
.farmacia-rifiuta { background:#ff4d4d; border-bottom-color:#ff4d4d;}

.label-comune {
  color:#fff;
  font-size:11px;
  text-shadow:0 0 6px #000;
  pointer-events:none;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="dark-overlay"></div>

<div id="hud">
  <div class="hud-title" id="hud-title">Provincia di Verona</div>
  <div class="hud-sub">Seleziona un comune</div>

  <div class="section">
    <h4>Farmacie del comune</h4>
    <div id="farmacieList" class="list">—</div>
  </div>

  <div class="section">
    <h4>Medici di base / Studi</h4>
    <div id="mediciList" class="list">—</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== MOCK DATABASE ===== */
const farmacie = [
  { nome:"Farmacia Centrale", comune:"Verona", lat:45.438, lng:10.992, tipo:"privata", stato:"accetta", note:"Banco dedicato" },
  { nome:"Farmacia San Zeno", comune:"Verona", lat:45.443, lng:10.980, tipo:"comunale", stato:"in_trattativa" },
  { nome:"Farmacia Borgo Roma", comune:"Verona", lat:45.389, lng:10.982, tipo:"privata", stato:"da_contattare" }
];

const medici = [
  { nome:"Dr. Rossi", comune:"Verona", lat:45.441, lng:10.995 },
  { nome:"Studio Associato Borgo Trento", comune:"Verona", lat:45.447, lng:10.988 }
];

let farmaciLayers = L.layerGroup();
let mediciLayers = L.layerGroup();

const map=L.map('map',{attributionControl:false})
  .setView([45.43,10.99],11);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  {maxZoom:19}).addTo(map);

farmaciLayers.addTo(map);
mediciLayers.addTo(map);

function mostraFarmacie(comune){
  farmaciLayers.clearLayers();
  document.getElementById('farmacieList').innerHTML='';
  farmacie.filter(f=>f.comune===comune).forEach(f=>{
    const iconHTML = f.tipo==='privata'
      ? `<span class="marker-dot farmacia-${f.stato}"></span>`
      : `<span class="marker-triangle farmacia-${f.stato}"></span>`;

    const m=L.marker([f.lat,f.lng],{
      icon:L.divIcon({html:iconHTML,iconSize:[14,14],className:''})
    }).bindPopup(`<strong>${f.nome}</strong><br/>${f.tipo}<br/>${f.stato}`);
    farmaciLayers.addLayer(m);

    const row=document.createElement('div');
    row.className='item';
    row.innerHTML=`${iconHTML} ${f.nome}
      <span class="badge ${f.stato}">${f.stato}</span>`;
    row.onclick=()=>{
      map.setView([f.lat,f.lng],16);
      m.openPopup();
    };
    document.getElementById('farmacieList').appendChild(row);
  });
}

function mostraMedici(comune){
  mediciLayers.clearLayers();
  document.getElementById('mediciList').innerHTML='';
  medici.filter(m=>m.comune===comune).forEach(m=>{
    const marker=L.marker([m.lat,m.lng],{
      icon:L.divIcon({html:"⚕️",iconSize:[20,20],className:""})
    }).bindPopup(`<strong>${m.nome}</strong>`);
    mediciLayers.addLayer(marker);

    const row=document.createElement('div');
    row.className='item';
    row.textContent='⚕️ '+m.nome;
    row.onclick=()=>{
      map.setView([m.lat,m.lng],16);
      marker.openPopup();
    };
    document.getElementById('mediciList').appendChild(row);
  });
}

/* ==== COMUNI ==== */
fetch('data/comuni_verona.json')
.then(r=>r.json())
.then(data=>{
  L.geoJSON(data,{
    style:{color:'#00ff9c',weight:1,fillOpacity:0},
    onEachFeature:(f,l)=>{
      const nome=f.properties.nome||f.properties.DENOM_COM||'Comune';
      const c=l.getBounds().getCenter();
      L.marker(c,{
        icon:L.divIcon({className:'label-comune',html:nome}),
        interactive:false
      }).addTo(map);

      l.on('click',()=>{
        map.fitBounds(l.getBounds(),{padding:[40,40]});
        document.getElementById('hud-title').innerText='Comune di '+nome;
        mostraFarmacie(nome);
        mostraMedici(nome);
      });
    }
  }).addTo(map);
});
</script>

</body>
</html>

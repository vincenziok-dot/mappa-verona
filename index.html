<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Verona – SpG (Farmacie + Status RAM)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui, sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* Zoom controls top-right, avoid HUD overlap */
.leaflet-top.leaflet-right{ top:12px; right:12px; }

/* HUD */
#hud{
  position:fixed; top:12px; left:12px; z-index:9998;
  width:min(420px, calc(100vw - 24px));
  padding:14px 16px;
  background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c;
  box-shadow:0 0 20px rgba(0,0,0,.85);
  max-height: calc(100vh - 24px);
  overflow:auto;
  border-radius:6px;
}
.hud-title{ font-size:16px; font-weight:750; color:#fff; text-transform:uppercase; }
.hud-sub{ margin-top:6px; font-size:12px; color:#bdbdbd; }

.hud-chip{
  display:flex; align-items:center; justify-content:space-between;
  margin-top:12px;
  font-size:10px; letter-spacing:.16em; text-transform:uppercase;
  color:#9ef5d9; background:#0e0e0e;
  padding:8px 10px; border:1px solid #1f1f1f;
  border-radius:6px;
}
.hud-chip small{ letter-spacing:0; text-transform:none; color:#bdbdbd; }

#stats{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.stat{ background:#0e0e0e; padding:10px; border:1px solid #1f1f1f; border-radius:6px; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:22px; font-weight:800; margin-top:2px; }
.stat-ok .stat-value{ color:#00ff9c; }
.stat-warn .stat-value{ color:#ffaa00; }
.stat-info .stat-value{ color:#4da6ff; }
.stat-muted .stat-value{ color:#d0d0d0; }

#selBox{
  margin-top:14px; padding-top:12px; border-top:1px solid #222;
}
#selBox h4{
  margin:0 0 8px;
  font-size:10px; text-transform:uppercase; letter-spacing:.14em; color:#9ef5d9;
}
#selCounts{ font-size:12px; color:#e6e6e6; line-height:1.35; }

#legend{
  margin-top:14px; padding-top:12px; border-top:1px solid #222;
}
#legend h4{
  margin:0 0 8px;
  font-size:10px; text-transform:uppercase; letter-spacing:.14em; color:#cccccc;
}
.legend-row{
  display:flex; align-items:center; gap:10px;
  font-size:11px; margin-bottom:6px; color:#e6e6e6;
}

/* marker shapes (legend + divIcon) */
.dot{ width:12px; height:12px; border-radius:50%; }
.triangle{
  width:0; height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-bottom:12px solid;
}
.mrk { width:14px; height:14px; display:flex; align-items:center; justify-content:center; }
.mrk.dot { border-radius:50%; }

/* stati (colori) */
.st-non_contattata{ background:#ffaa00; border-bottom-color:#ffaa00; }
.st-in_carico{ background:#4da6ff; border-bottom-color:#4da6ff; }
.st-in_trattativa{ background:#4da6ff; border-bottom-color:#4da6ff; }
.st-fav_poster{ background:#00ff9c; border-bottom-color:#00ff9c; }
.st-fav_info{ background:#00ff9c; border-bottom-color:#00ff9c; }
.st-boicotta{ background:#00ff9c; border-bottom-color:#00ff9c; }
.st-non_aderisce{ background:#ff4d4d; border-bottom-color:#ff4d4d; }

/* chiusa temporaneamente */
.st-chiusa{ background:#9a9a9a; border-bottom-color:#9a9a9a; opacity:.35; }

/* strumenti */
#tools{
  margin-top:14px; padding-top:12px; border-top:1px solid #222;
}
#tools h4{
  margin:0 0 8px;
  font-size:10px; text-transform:uppercase; letter-spacing:.14em; color:#cccccc;
}
.hint{ font-size:11px; color:#bdbdbd; line-height:1.35; }

/* popup editor */
.popup-wrap{ font-size:12px; line-height:1.35; }
.popup-wrap .muted{ opacity:.85; }
.field{ margin-top:10px; }
label{ display:block; font-size:10px; letter-spacing:.10em; text-transform:uppercase; color:#bdbdbd; margin-bottom:4px; }
select, input, textarea{
  width:100%;
  background:#0e0e0e; border:1px solid #2a2a2a; color:#fff;
  border-radius:6px; padding:8px; font-size:12px;
}
textarea{ min-height:64px; resize:vertical; }
.btnrow{ display:flex; gap:8px; margin-top:10px; }
.btn{
  flex:1;
  background:#041812; border:1px solid #00ff9c; color:#eafff7;
  padding:8px 10px; border-radius:8px; cursor:pointer; font-size:12px;
}
.btn:hover{ background:#00ff9c; color:#00110b; }
.btn.secondary{ border-color:#4da6ff; background:#08131f; }
.btn.secondary:hover{ background:#4da6ff; color:#00110b; }
.pillbox{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
.pill{
  border:1px solid #2a2a2a; background:#0e0e0e; color:#e6e6e6;
  padding:4px 8px; border-radius:999px; font-size:12px; display:flex; gap:6px; align-items:center;
}
.pill button{
  background:transparent; border:0; color:#ff4d4d; cursor:pointer; font-weight:900;
}

@media (max-width: 560px){
  #hud{ left:8px; top:8px; width:calc(100vw - 16px); }
  .leaflet-top.leaflet-right{ top:8px; right:8px; }
}
</style>
</head>

<body>
<div id="map"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Farmacie – gestione campagna (status in RAM/localStorage)</div>

  <div class="hud-chip">
    <span>GLOBALI</span>
    <small id="smallInfo">—</small>
  </div>

  <div id="stats">
    <div class="stat stat-muted">
      <div class="stat-title">Farmacie totali</div>
      <div class="stat-value" id="cntTot">0</div>
    </div>
    <div class="stat stat-muted">
      <div class="stat-title">Private / Comunali</div>
      <div class="stat-value" id="cntGest">0 / 0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Non contattate</div>
      <div class="stat-value" id="cntNC">0</div>
    </div>
    <div class="stat stat-info">
      <div class="stat-title">In carico / trattativa</div>
      <div class="stat-value" id="cntWork">0 / 0</div>
    </div>
    <div class="stat stat-ok">
      <div class="stat-title">Favorevoli</div>
      <div class="stat-value" id="cntFav">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Boicotta</div>
      <div class="stat-value" id="cntBoi">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Non aderisce</div>
      <div class="stat-value" id="cntNo">0</div>
    </div>
    <div class="stat stat-muted">
      <div class="stat-title">Chiuse tempor.</div>
      <div class="stat-value" id="cntClosed">0</div>
    </div>
  </div>

  <div id="selBox">
    <h4>Comune selezionato</h4>
    <div id="selCounts">Clicca un comune sulla mappa per filtrare e vedere i conteggi.</div>
  </div>

  <div id="legend">
    <h4>Legenda farmacie</h4>
    <div class="legend-row"><span class="dot st-non_contattata"></span> Non contattata</div>
    <div class="legend-row"><span class="dot st-in_carico"></span> In carico</div>
    <div class="legend-row"><span class="dot st-in_trattativa"></span> In trattativa</div>
    <div class="legend-row"><span class="dot st-fav_poster"></span> Favorevole (poster/BDS/note)</div>
    <div class="legend-row"><span class="dot st-boicotta"></span> Favorevole (boicotta: stop fornitura)</div>
    <div class="legend-row"><span class="dot st-non_aderisce"></span> Non aderisce</div>
    <div class="legend-row"><span class="dot st-chiusa"></span> Chiusa temporaneamente</div>

    <h4 style="margin-top:12px">Forma marker</h4>
    <div class="legend-row"><span class="dot st-non_contattata"></span> Privata</div>
    <div class="legend-row"><span class="triangle st-non_contattata"></span> Comunale</div>
  </div>

  <div id="tools">
    <h4>Strumenti</h4>
    <div class="hint">
      • Clicca una farmacia per aprire il popup e impostare <b>stato</b>, <b>incaricati</b>, <b>note</b>.<br/>
      • “Chiusa temporaneamente” rende il marker semitrasparente; nel popup puoi riaprirla.
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===============================
   CONFIG
================================ */
const DATA_COMUNI_GEOJSON = 'data/comuni_verona.json';
const DATA_FARMACIE_CSV   = 'data/farmacie.csv';

const DEFAULT_STATUS = 'non_contattata'; // stato iniziale campagna

/* ===============================
   STORAGE (status in RAM + localStorage)
================================ */
const LS_KEY = 'spg_farmacie_status_v1';

function loadStatus(){
  try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }
  catch(e){ return {}; }
}
function saveStatus(obj){
  try { localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
  catch(e){}
}

let statusDB = loadStatus(); // farmacia_id -> { stato, incaricati[], note, chiusa:boolean, updatedAt }

/* ===============================
   MAPPA
================================ */
const map = L.map('map', { attributionControl:false, zoomControl:true }).setView([45.43,10.99],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

/* layers */
const comuniLayer = L.layerGroup().addTo(map);
const farmLayer   = L.layerGroup().addTo(map);

const markers = []; // { id, comune, gestione, marker, data }

/* comuni canonical */
let comuneCanonByNorm = {}; // norm -> canon
let comuniList = [];        // canon list
let selectedComune = null;
let selectedComuneLayer = null;

/* HUD refs */
const hudTitle = document.getElementById('hudTitle');
const hudSub   = document.getElementById('hudSub');
const smallInfo= document.getElementById('smallInfo');
const selCounts= document.getElementById('selCounts');

/* ===============================
   UTIL
================================ */
function normKey(s){
  return (s || '')
    .trim().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ');
}

function canonComune(raw){
  const k = normKey(raw);
  if(comuneCanonByNorm[k]) return comuneCanonByNorm[k];

  // fuzzy: "Negrar" -> "Negrar di Valpolicella" (o simili) se unico match
  const nk = k;
  const candidates = comuniList.filter(c => {
    const nc = normKey(c);
    return (nc.startsWith(nk + ' ') || nc.startsWith(nk + ' di ') || nc.includes(nk + ' di '));
  });
  if(candidates.length === 1) return candidates[0];

  return (raw || '').trim();
}

function parseFloatIT(x){
  if(x === null || x === undefined) return NaN;
  const s = String(x).trim().replace(',', '.');
  return parseFloat(s);
}

function parseCoordinateField(coordStr){
  if(!coordStr) return null;
  const s = String(coordStr).trim();
  const parts = s.split(/[;,]/).map(p => p.trim()).filter(Boolean);
  if(parts.length < 2) return null;
  const lat = parseFloatIT(parts[0]);
  const lon = parseFloatIT(parts[1]);
  if(!isFinite(lat) || !isFinite(lon)) return null;
  return { lat, lon };
}

function ensureHttp(url){
  const u = (url || '').toString().trim();
  if(!u) return '';
  if(/^https?:\/\//i.test(u)) return u;
  // maps.app.goo.gl/...
  if(/^maps\.app\.goo\.gl\//i.test(u)) return 'https://' + u;
  if(/^www\./i.test(u)) return 'https://' + u;
  if(/^google\./i.test(u) || /^goo\./i.test(u)) return 'https://' + u;
  return u; // last resort
}

function stableId(str){
  let h = 0;
  for (let i=0; i<str.length; i++){
    h = ((h<<5) - h) + str.charCodeAt(i);
    h |= 0;
  }
  return String(h);
}

/* ===============================
   ICONS
================================ */
function cssClassForStatus(st){
  switch(st){
    case 'non_contattata': return 'st-non_contattata';
    case 'in_carico': return 'st-in_carico';
    case 'in_trattativa': return 'st-in_trattativa';
    case 'favorevole_poster': return 'st-fav_poster';
    case 'favorevole_informativa': return 'st-fav_info';
    case 'boicotta': return 'st-boicotta';
    case 'non_aderisce': return 'st-non_aderisce';
    default: return 'st-non_contattata';
  }
}

function iconFarmacia(gestione, stato, chiusa){
  const cls = chiusa ? 'st-chiusa' : cssClassForStatus(stato);
  const isComunale = (gestione || '').toString().toLowerCase().includes('comun');
  if(isComunale){
    return L.divIcon({ className:'', html:`<div class="triangle ${cls}"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
  }
  return L.divIcon({ className:'', html:`<div class="mrk dot ${cls}"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
}

/* ===============================
   POPUP EDITOR
================================ */
function getRecord(id){
  const cur = statusDB[id] || {};
  return {
    stato: cur.stato || DEFAULT_STATUS,
    incaricati: Array.isArray(cur.incaricati) ? cur.incaricati : [],
    note: cur.note || '',
    chiusa: !!cur.chiusa,
    updatedAt: cur.updatedAt || null
  };
}

function setRecord(id, patch){
  const cur = getRecord(id);
  const next = { ...cur, ...patch, updatedAt: new Date().toISOString() };
  statusDB[id] = next;
  saveStatus(statusDB);
}

function buildPopupHTML(ph){
  const rec = getRecord(ph.id);
  const mapsUrl = ensureHttp(ph.maps_url) || '';
  const addr = [ph.indirizzo_full, ph.cap, ph.comune].filter(Boolean).join(', ');
  const gestione = ph.gestione || '';

  const incaricatiList = rec.incaricati.map(n => `
    <span class="pill">
      ${escapeHtml(n)}
      <button data-act="rm" data-name="${encodeURIComponent(n)}" title="Rimuovi">×</button>
    </span>
  `).join('');

  return `
    <div class="popup-wrap" data-id="${escapeHtml(ph.id)}">
      <div><b>${escapeHtml(ph.descrizione_farmacia || 'Farmacia')}</b></div>
      <div class="muted">${escapeHtml(addr)}${gestione ? ' — ' + escapeHtml(gestione) : ''}</div>
      ${mapsUrl ? `<div style="margin-top:6px"><a href="${mapsUrl}" target="_blank" rel="noopener">Apri in Google Maps</a></div>` : ''}

      <div class="field">
        <label>Stato campagna</label>
        <select data-field="stato">
          ${opt('non_contattata','Non contattata', rec.stato)}
          ${opt('in_carico','In carico', rec.stato)}
          ${opt('in_trattativa','In trattativa', rec.stato)}
          ${opt('favorevole_poster','Favorevole (poster/BDS/note)', rec.stato)}
          ${opt('favorevole_informativa','Favorevole (solo informativa)', rec.stato)}
          ${opt('boicotta','Favorevole (boicotta: stop fornitura)', rec.stato)}
          ${opt('non_aderisce','Non aderisce', rec.stato)}
        </select>
      </div>

      <div class="field">
        <label>In carico a</label>
        <input data-field="incaricato_add" placeholder="Aggiungi nome e premi Invio" />
        <div class="pillbox" data-field="incaricati_box">
          ${incaricatiList || '<span class="muted">Nessun incaricato.</span>'}
        </div>
      </div>

      <div class="field">
        <label>Note</label>
        <textarea data-field="note" placeholder="Poster? BDS? dettagli...">${escapeHtml(rec.note)}</textarea>
      </div>

      <div class="field">
        <label>Chiusura temporanea</label>
        <select data-field="chiusa">
          ${optBool(false,'Aperta', rec.chiusa)}
          ${optBool(true,'Chiusa temporaneamente', rec.chiusa)}
        </select>
      </div>

      <div class="btnrow">
        <button class="btn" data-act="save">Salva</button>
        <button class="btn secondary" data-act="reset">Reset</button>
      </div>

      <div class="muted" style="margin-top:8px;font-size:11px">
        ${rec.updatedAt ? ('Ultimo aggiornamento: ' + escapeHtml(rec.updatedAt)) : 'Nessun aggiornamento salvato.'}
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return (s ?? '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
function opt(v, label, current){
  return `<option value="${v}" ${v===current?'selected':''}>${label}</option>`;
}
function optBool(v, label, currentBool){
  const cur = !!currentBool;
  const sel = (v===true ? cur : !cur);
  return `<option value="${v ? '1' : '0'}" ${sel?'selected':''}>${label}</option>`;
}

/* ===============================
   STATS
================================ */
function computeStats(filterComune=null){
  const subset = filterComune ? markers.filter(m => m.comune === filterComune) : markers;

  let tot=subset.length, priv=0, com=0;
  let nc=0, ic=0, it=0, fav=0, boi=0, no=0, closed=0;

  subset.forEach(m => {
    const rec = getRecord(m.id);
    const gestione = (m.gestione || '').toLowerCase();
    if(gestione.includes('comun')) com++; else priv++;

    if(rec.chiusa) closed++;

    switch(rec.stato){
      case 'non_contattata': nc++; break;
      case 'in_carico': ic++; break;
      case 'in_trattativa': it++; break;
      case 'favorevole_poster':
      case 'favorevole_informativa': fav++; break;
      case 'boicotta': boi++; break;
      case 'non_aderisce': no++; break;
      default: nc++; break;
    }
  });

  return { tot, priv, com, nc, ic, it, fav, boi, no, closed };
}

function refreshHUD(){
  const g = computeStats(null);
  document.getElementById('cntTot').textContent = g.tot;
  document.getElementById('cntGest').textContent = `${g.priv} / ${g.com}`;
  document.getElementById('cntNC').textContent = g.nc;
  document.getElementById('cntWork').textContent = `${g.ic} / ${g.it}`;
  document.getElementById('cntFav').textContent = g.fav;
  document.getElementById('cntBoi').textContent = g.boi;
  document.getElementById('cntNo').textContent  = g.no;
  document.getElementById('cntClosed').textContent = g.closed;

  smallInfo.textContent = `Farmacie caricate: ${g.tot} — comuni: ${comuniList.length || '—'}`;

  if(selectedComune){
    const s = computeStats(selectedComune);
    selCounts.innerHTML =
      `<b>${escapeHtml(selectedComune)}</b><br/>` +
      `Tot: <b>${s.tot}</b> (Private ${s.priv} / Comunali ${s.com})<br/>` +
      `Non contattate: <b>${s.nc}</b><br/>` +
      `In carico: <b>${s.ic}</b> — In trattativa: <b>${s.it}</b><br/>` +
      `Favorevoli: <b>${s.fav}</b> — Boicotta: <b>${s.boi}</b> — Non aderisce: <b>${s.no}</b><br/>` +
      `Chiuse tempor.: <b>${s.closed}</b>`;
  } else {
    selCounts.textContent = 'Clicca un comune sulla mappa per filtrare e vedere i conteggi.';
  }
}

/* ===============================
   COMUNI (GEOJSON)
================================ */
function styleComune(nome, selected){
  return {
    color: selected ? '#ffffff' : '#00ff9c',
    weight: selected ? 3 : 1,
    fillColor: '#00ff9c',
    fillOpacity: selected ? 0 : 0.05
  };
}

fetch(DATA_COMUNI_GEOJSON)
  .then(r => r.json())
  .then(data => {
    const geo = L.geoJSON(data, {
      style: f => {
        const nome = (f.properties && (f.properties.nome || f.properties.DENOM_COM || f.properties.name)) || 'Comune';
        return styleComune(nome, false);
      },
      onEachFeature: (f, layer) => {
        const nome = (f.properties && (f.properties.nome || f.properties.DENOM_COM || f.properties.name)) || 'Comune';
        const canon = nome.toString().trim();
        const nk = normKey(canon);
        comuneCanonByNorm[nk] = canon;
        comuniList.push(canon);

        layer.on('click', () => selectComune(layer, canon));
      }
    }).addTo(comuniLayer);

    map.fitBounds(geo.getBounds());
    loadFarmacie();
  })
  .catch(() => {
    // Se manca il GeoJSON, carichiamo comunque le farmacie senza filtro per comune
    comuniList = [];
    loadFarmacie();
  });

function selectComune(layer, nome){
  selectedComune = nome;
  if(selectedComuneLayer && comuniLayer.hasLayer(selectedComuneLayer)){
    selectedComuneLayer.setStyle(styleComune(selectedComune, false));
  }
  selectedComuneLayer = layer;
  layer.setStyle(styleComune(nome, true));

  map.fitBounds(layer.getBounds(), { padding:[30,30] });

  // dim markers outside comune
  markers.forEach(m => m.marker.setOpacity(m.comune === nome ? 1 : 0.18));

  refreshHUD();
}

/* click empty map to reset selection */
map.on('click', (e) => {
  // ignore if click is on a marker (Leaflet sends click on both sometimes)
  if(e.originalEvent && e.originalEvent.target && e.originalEvent.target.classList && e.originalEvent.target.classList.contains('leaflet-marker-icon')) return;

  if(selectedComune){
    markers.forEach(m => m.marker.setOpacity(1));
    if(selectedComuneLayer){
      selectedComuneLayer.setStyle(styleComune(selectedComune, false));
      selectedComuneLayer = null;
    }
    selectedComune = null;
    refreshHUD();
  }
});

/* ===============================
   FARMACIE (CSV)
   HEADER definitivo: coordinate, maps_url
================================ */
function normalizeFarmRow(row){
  const comuneRaw = (row.comune || row.COMUNE || row.Comune || '').toString().trim();
  const comune = canonComune(comuneRaw);

  const id = (row.farmacia_id || row.id || '').toString().trim() ||
             stableId(`${row.descrizione_farmacia||''}|${row.indirizzo_full||''}|${comune}`);

  const coord = parseCoordinateField(row.coordinate || row.coordinate || row.coords || row.COORDINATE || row.COORDINATE) ||
                parseCoordinateField(row['coordinate']);

  const maps = ensureHttp(row.maps_url || row.MAPS_URL || row.maps || '');

  return {
    id,
    comune,
    gestione: (row.gestione || '').toString().trim(),
    descrizione_farmacia: (row.descrizione_farmacia || row.nome || row.denominazione || '').toString().trim(),
    indirizzo_full: (row.indirizzo_full || row.indirizzo || '').toString().trim(),
    cap: (row.cap || '').toString().trim(),
    stato_attivita: (row.stato_attivita || '').toString().trim(),
    coordinate: coord,
    maps_url: maps
  };
}

function loadFarmacie(){
  Papa.parse(DATA_FARMACIE_CSV, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete: (res) => {
      const rows = res.data || [];
      let added=0, skipped=0, comuneMismatch=0;

      rows.forEach(row => {
        const ph = normalizeFarmRow(row);
        if(!ph.coordinate){ skipped++; return; }

        // detect mismatch for debug (optional)
        if(comuniList.length){
          const k = normKey((row.comune||'').toString());
          if(!comuneCanonByNorm[k]){
            // maybe fuzzy would fix
            const canon = canonComune(row.comune);
            if(canon === (row.comune||'').toString().trim()) comuneMismatch++;
          }
        }

        const rec = getRecord(ph.id);
        const marker = L.marker([ph.coordinate.lat, ph.coordinate.lon], {
          icon: iconFarmacia(ph.gestione, rec.stato, rec.chiusa)
        });

        marker.on('click', () => {
          marker.bindPopup(buildPopupHTML(ph), { maxWidth: 360 }).openPopup();
        });

        marker.addTo(farmLayer);
        markers.push({ id: ph.id, comune: ph.comune, gestione: ph.gestione, marker, data: ph });
        added++;
      });

      refreshHUD();

      // show a concise info (hide scary warnings on production)
      if(comuneMismatch){
        smallInfo.textContent += ` — comuni “non riconosciuti”: ${comuneMismatch}`;
      }
    }
  });
}

/* ===============================
   POPUP EVENTS (save/reset, incaricati add/remove)
================================ */
map.on('popupopen', (e) => {
  const el = e.popup.getElement();
  if(!el) return;
  const wrap = el.querySelector('.popup-wrap');
  if(!wrap) return;

  const id = wrap.getAttribute('data-id');
  const m = markers.find(x => x.id === id);
  if(!m) return;

  const statoSel = wrap.querySelector('select[data-field="stato"]');
  const chiusaSel= wrap.querySelector('select[data-field="chiusa"]');
  const noteTa   = wrap.querySelector('textarea[data-field="note"]');
  const inpAdd   = wrap.querySelector('input[data-field="incaricato_add"]');
  const pillsBox = wrap.querySelector('[data-field="incaricati_box"]');

  // add incaricato on Enter
  inpAdd.addEventListener('keydown', (ev) => {
    if(ev.key !== 'Enter') return;
    ev.preventDefault();
    const name = (inpAdd.value || '').trim();
    if(!name) return;
    const rec = getRecord(id);
    if(!rec.incaricati.includes(name)){
      rec.incaricati.push(name);
      setRecord(id, { incaricati: rec.incaricati });
      // rebuild popup quickly
      m.marker.setPopupContent(buildPopupHTML(m.data));
      m.marker.openPopup();
      refreshHUD();
    }
  });

  // remove incaricato
  pillsBox.addEventListener('click', (ev) => {
    const btn = ev.target.closest('button[data-act="rm"]');
    if(!btn) return;
    const name = decodeURIComponent(btn.getAttribute('data-name') || '');
    const rec = getRecord(id);
    const next = rec.incaricati.filter(x => x !== name);
    setRecord(id, { incaricati: next });
    m.marker.setPopupContent(buildPopupHTML(m.data));
    m.marker.openPopup();
    refreshHUD();
  });

  // save/reset
  wrap.addEventListener('click', (ev) => {
    const actEl = ev.target.closest('[data-act]');
    if(!actEl) return;
    const act = actEl.getAttribute('data-act');

    if(act === 'save'){
      const stato = statoSel.value;
      const chiusa = (chiusaSel.value === '1');
      const note = noteTa.value || '';
      const rec = getRecord(id);
      setRecord(id, { stato, chiusa, note, incaricati: rec.incaricati });

      // update icon
      m.marker.setIcon(iconFarmacia(m.gestione, stato, chiusa));

      // if a comune is selected, keep opacity filtering
      if(selectedComune){
        m.marker.setOpacity(m.comune === selectedComune ? 1 : 0.18);
      }

      refreshHUD();
      m.marker.closePopup();
      return;
    }

    if(act === 'reset'){
      delete statusDB[id];
      saveStatus(statusDB);
      // reset icon + close
      m.marker.setIcon(iconFarmacia(m.gestione, DEFAULT_STATUS, false));
      refreshHUD();
      m.marker.closePopup();
      return;
    }
  });
});
</script>
</body>
</html>

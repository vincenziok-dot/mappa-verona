<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mappa Verona – SpG</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui, sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* BANNER ALTO */
#banner{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.86);
  padding:8px 18px;
  border-bottom:3px solid #00ff9c;
  color:#fff; font-size:13px;
  display:none; z-index:9999;
}

/* HUD COLONNA SINISTRA */
#hud{
  position:fixed; top:18px; left:18px; z-index:9998;
  padding:14px 16px;
  background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c;
  min-width:340px; max-width:380px;
  box-shadow:0 0 20px rgba(0,0,0,.85);
}
.hud-title{ font-size:18px; font-weight:650; color:#fff; text-transform:uppercase; }
.hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

/* Contatori globali */
#stats{ margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat{ background:#0e0e0e; padding:8px; border:1px solid #141414; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:26px; font-weight:800; line-height:1; margin-top:4px; }
.stat-ok .stat-value{ color:#00ff9c; }
.stat-warn .stat-value{ color:#ffaa00; }
.stat-note{ margin-top:6px; font-size:11px; color:#8f8f8f; }

/* Box selezione */
#sel-box{ margin-top:14px; padding-top:10px; border-top:1px solid #222; }
#sel-box h4{
  margin:0 0 6px; font-size:11px; text-transform:uppercase;
  letter-spacing:.12em; color:#9ef5d9;
}
.small{ font-size:12px; color:#d0d0d0; }

/* Bottoni referenti */
.hud-buttons{ margin-top:10px; display:flex; gap:6px; flex-wrap:wrap; }
.hud-btn{
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:11px;
  padding:4px 8px;
  cursor:pointer;
}
.hud-btn:hover{ background:#00ff9c; color:#00110b; }
.hud-btn:disabled{ opacity:.45; cursor:not-allowed; }

/* Pannello referenti */
.hud-section{ margin-top:10px; border-top:1px solid #222; padding-top:6px; display:none; }
.hud-section ul{ margin:0; padding-left:16px; }
.hud-section li{ font-size:12px; color:#fff; margin:2px 0; }

/* Box conteggi nel comune */
#counts-box{ margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.pill{ background:#0e0e0e; border:1px solid #141414; padding:8px; }
.pill .k{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.pill .v{ font-size:18px; font-weight:750; color:#fff; margin-top:4px; }

/* LEGENDA */
#legend-box{ margin-top:12px; padding-top:10px; border-top:1px solid #222; }
#legend-box h4{
  margin:6px 0 4px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.12em;
  color:#cccccc;
}
.legend-row{ display:flex; align-items:center; gap:8px; font-size:11px; margin:4px 0; color:#e6e6e6; }

/* simboli base */
.dot{ width:12px; height:12px; border-radius:50%; }
.triangle{
  width:0; height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-bottom:12px solid;
}
.square{ width:12px; height:12px; border-radius:2px; }

/* colori stato */
.partecipa { background:#00ff9c; border-bottom-color:#00ff9c; color:#00ff9c; }
.trattativa{ background:#4da6ff; border-bottom-color:#4da6ff; color:#4da6ff; }
.contattare{ background:#ffaa00; border-bottom-color:#ffaa00; color:#ffaa00; }
.rifiuta   { background:#ff4d4d; border-bottom-color:#ff4d4d; color:#ff4d4d; }

/* colori comuni */
.leg-coperto{ background:#00ff9c; }
.leg-orfano { background:#ffaa00; }

/* Label comuni */
.label-comune{
  color:#fff;
  font-size:11px;
  text-shadow:0 0 6px rgba(0,0,0,.95);
  pointer-events:none;
}

/* MARKER FARMACIA (più leggibile) */
.pharm{
  width:16px; height:16px; border-radius:50%;
  box-shadow:0 0 10px rgba(0,0,0,.75);
  border:2px solid rgba(0,0,0,.65);
}
.pharm.triangle{
  width:0; height:0;
  border-left:9px solid transparent;
  border-right:9px solid transparent;
  border-bottom:16px solid;
  filter: drop-shadow(0 0 8px rgba(0,0,0,.8));
}

/* MARKER MMG: PIN con bastone di Esculapio (⚕) */
.mmg-pin{
  position:relative;
  width:26px; height:26px;
  border-radius:50%;
  border:2px solid rgba(0,0,0,.65);
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 0 14px rgba(0,0,0,.8);
}
.mmg-pin::after{
  content:"";
  position:absolute;
  bottom:-10px; left:50%;
  transform:translateX(-50%);
  width:0; height:0;
  border-left:8px solid transparent;
  border-right:8px solid transparent;
  border-top:12px solid rgba(0,0,0,.65);
}
.mmg-pin::before{
  content:"";
  position:absolute;
  bottom:-9px; left:50%;
  transform:translateX(-50%);
  width:0; height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-top:10px solid;
}
.mmg-icon{
  font-weight:900;
  font-size:16px;
  line-height:1;
  color:#07110d;
  text-shadow:0 0 6px rgba(255,255,255,.20);
}
.mmg-pin.partecipa{ background:#00ff9c; }
.mmg-pin.trattativa{ background:#4da6ff; }
.mmg-pin.contattare{ background:#ffaa00; }
.mmg-pin.rifiuta{ background:#ff4d4d; }
.mmg-pin.partecipa::before{ border-top-color:#00ff9c; }
.mmg-pin.trattativa::before{ border-top-color:#4da6ff; }
.mmg-pin.contattare::before{ border-top-color:#ffaa00; }
.mmg-pin.rifiuta::before{ border-top-color:#ff4d4d; }

/* Mobile */
@media (max-width: 520px){
  #hud{ left:10px; right:10px; width:auto; min-width:unset; max-width:unset; }
  #stats{ grid-template-columns:1fr 1fr; }
}

.leaflet-interactive{ cursor:pointer; }
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
  </div>
  <div class="stat-note">Questi contatori sono <b>globali</b> (provincia intera).</div>

  <div id="sel-box">
    <h4>Comune selezionato</h4>
    <div class="small" id="selName">—</div>
    <div class="small" id="selRefs">Referenti: —</div>

    <div id="counts-box">
      <div class="pill">
        <div class="k">Farmacie nel comune</div>
        <div class="v" id="cntFarmComune">—</div>
      </div>
      <div class="pill">
        <div class="k">Studi/MMG nel comune</div>
        <div class="v" id="cntMmgComune">—</div>
      </div>
    </div>

    <div class="hud-buttons">
      <button class="hud-btn" id="btnAdd" disabled>Aggiungi referente</button>
      <button class="hud-btn" id="btnToggle" disabled>Vedi referenti</button>
    </div>

    <div class="hud-section" id="refPanel">
      <ul id="refList"></ul>
    </div>
  </div>

  <div id="legend-box">
    <h4>Legenda comuni</h4>
    <div class="legend-row"><span class="square leg-coperto"></span> Comune con referenti</div>
    <div class="legend-row"><span class="square leg-orfano"></span> Comune orfano</div>

    <h4>Legenda stato</h4>
    <div class="legend-row"><span class="dot partecipa"></span> Aderisce / partecipa</div>
    <div class="legend-row"><span class="dot trattativa"></span> In trattativa</div>
    <div class="legend-row"><span class="dot contattare"></span> Da contattare</div>
    <div class="legend-row"><span class="dot rifiuta"></span> Non aderisce / rifiuta</div>

    <h4>Legenda farmacie</h4>
    <div class="legend-row"><span class="dot partecipa"></span> Privata</div>
    <div class="legend-row"><span class="triangle partecipa"></span> Comunale</div>

    <h4>Legenda studi/MMG</h4>
    <div class="legend-row">
      <span class="mmg-pin partecipa" style="width:18px;height:18px;border-width:1px; display:inline-flex; align-items:center; justify-content:center;">
        <span class="mmg-icon" style="font-size:12px;">⚕</span>
      </span>
      Studio/MMG (pin con ⚕)
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm";

/* MAPPA */
const map = L.map('map', { attributionControl:false }).setView([45.43,10.99],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

const farmLayer = L.layerGroup().addTo(map);
const mmgLayer  = L.layerGroup().addTo(map);

/* RAM */
const referenti = { "Verona": ["Vincenzo R."] };
const status = {}; // RAM: es status["pharm|ID"]= "partecipa"

/* HUD refs */
const hudTitle = document.getElementById('hudTitle');
const hudSub   = document.getElementById('hudSub');
const banner   = document.getElementById('banner');

const selNameEl = document.getElementById('selName');
const selRefsEl = document.getElementById('selRefs');
const cntFarmComuneEl = document.getElementById('cntFarmComune');
const cntMmgComuneEl  = document.getElementById('cntMmgComune');

const btnAdd    = document.getElementById('btnAdd');
const btnToggle = document.getElementById('btnToggle');
const refPanel  = document.getElementById('refPanel');
const refList   = document.getElementById('refList');

const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
const hasRef = n => (referenti[n] && referenti[n].length > 0);

function encodeQ(q){ return encodeURIComponent(String(q || "").trim()); }
function mapsSearchUrl(label, comune, indirizzo){
  const q = [label, indirizzo, comune, "VR"].filter(Boolean).join(" ");
  return "https://www.google.com/maps/search/?api=1&query=" + encodeQ(q);
}
function getStatus(kind, id){ return status[`${kind}|${id}`] || "contattare"; }
function setStatus(kind, id, value){ status[`${kind}|${id}`] = value; }

/* CSV parser */
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const next = text[i+1];
    if(ch === '"'){
      if(inQ && next === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if(ch === ',' && !inQ){
      row.push(cur); cur = "";
    } else if((ch === '\n' || ch === '\r') && !inQ){
      if(ch === '\r' && next === '\n') i++;
      row.push(cur);
      if(row.length > 1 || row[0].trim() !== "") rows.push(row);
      row = []; cur = "";
    } else {
      cur += ch;
    }
  }
  row.push(cur);
  if(row.length > 1 || row[0].trim() !== "") rows.push(row);

  const headers = rows.shift().map(h => h.trim());
  return rows.map(r => {
    const obj = {};
    headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
    return obj;
  });
}

/* Stato comuni */
let comuni = [];
let labels = [];
let selectedLayer = null;
let selectedNome  = null;
const layersByNome = {};

/* stile comune */
function styleComune(nome){
  const ref = hasRef(nome);
  return {
    color: ref ? '#00ff9c' : '#ffaa00',
    weight: 1,
    fillColor: ref ? '#00ff9c' : '#000000',
    fillOpacity: ref ? 0.10 : 0
  };
}
function aggiornaStiliComuni(){
  Object.keys(layersByNome).forEach(n => {
    const layer = layersByNome[n];
    const base = styleComune(n);
    if(selectedLayer && layer === selectedLayer){
      layer.setStyle({ ...base, color:'#ffffff', weight:3, fillOpacity:0 });
      layer.bringToFront();
    } else {
      layer.setStyle(base);
    }
  });
}
function aggiornaContatoriGlobali(){
  const coperti = comuni.filter(n => hasRef(n)).length;
  document.getElementById('cntOk').innerText = String(coperti);
  document.getElementById('cntOrfani').innerText = String(comuni.length - coperti);
}
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    if(!selectedLayer && z >= 9 && z <= 13){
      if(!map.hasLayer(l)) map.addLayer(l);
    } else {
      if(map.hasLayer(l)) map.removeLayer(l);
    }
  });
}
function resetSelezione(){
  selectedLayer = null;
  selectedNome  = null;

  hudTitle.textContent = "Provincia di Verona";
  hudSub.textContent   = "Vista generale";
  banner.style.display = "none";

  selNameEl.textContent = "—";
  selRefsEl.textContent = "Referenti: —";
  cntFarmComuneEl.textContent = "—";
  cntMmgComuneEl.textContent  = "—";

  btnAdd.disabled = true;
  btnToggle.disabled = true;
  refPanel.style.display = "none";
  btnToggle.textContent = "Vedi referenti";

  farmLayer.clearLayers();
  mmgLayer.clearLayers();

  aggiornaStiliComuni();
  aggiornaContatoriGlobali();
  aggiornaLabels();
}
function selezionaComune(layer, nome){
  selectedLayer = layer;
  selectedNome = nome;

  btnAdd.disabled = false;
  btnToggle.disabled = false;

  aggiornaStiliComuni();
  map.fitBounds(layer.getBounds(), { padding:[40,40] });

  hudTitle.textContent = "Comune di " + nome;
  hudSub.textContent = hasRef(nome) ? ("Referenti presenti: " + referenti[nome].length) : "⚠ Comune orfano";

  selNameEl.textContent = nome;
  selRefsEl.textContent = "Referenti: " + (referenti[nome]?.length || 0);

  banner.style.display = "block";
  banner.innerHTML = "↑ Comune di <b>" + nome + "</b> – Referenti: " + (referenti[nome]?.length || 0);

  labels.forEach(l => { if(map.hasLayer(l)) map.removeLayer(l); });

  if(refPanel.style.display === "block") renderReferenti(nome);
  mostraFarmacie(nome);
  mostraMMG(nome);
}

/* Referenti */
function renderReferenti(nome){
  refList.innerHTML = "";
  const lista = referenti[nome] || [];
  lista.forEach(r => {
    const li = document.createElement("li");
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = lista.length ? "block" : "block"; // mostra anche se vuoto (così capisci)
}
btnAdd.onclick = () => {
  if(!selectedNome) return alert("Seleziona prima un comune sulla mappa");
  const n = prompt("Inserisci il tuo nome (comparirà come referente)");
  if(!n) return;

  if(!referenti[selectedNome]) referenti[selectedNome] = [];
  referenti[selectedNome].push(n);

  hudSub.textContent = "Referenti presenti: " + referenti[selectedNome].length;
  selRefsEl.textContent = "Referenti: " + referenti[selectedNome].length;
  banner.innerHTML = "↑ Comune di <b>" + selectedNome + "</b> – Referenti: " + referenti[selectedNome].length;

  aggiornaStiliComuni();
  aggiornaContatoriGlobali();

  if(refPanel.style.display === "block") renderReferenti(selectedNome);
};
btnToggle.onclick = () => {
  if(!selectedNome) return alert("Seleziona prima un comune sulla mappa");
  const isOpen = (refPanel.style.display === "block");
  refPanel.style.display = isOpen ? "none" : "block";
  btnToggle.textContent = isOpen ? "Vedi referenti" : "Nascondi referenti";
  if(!isOpen) renderReferenti(selectedNome);
};

/* Farmacie */
let farmacieData = [];
async function loadFarmacie(){
  const res = await fetch("data/farmacie.csv", { cache:"no-store" });
  const txt = await res.text();
  const rows = parseCSV(txt);

  farmacieData = rows.map(r => {
    const nome = r["descrizione_farmacia"] || r["nome"] || "";
    const comune = r["comune"] || "";
    const indirizzo = r["indirizzo"] || "";
    const lat = parseFloat(r["latitudine"] || "");
    const lon = parseFloat(r["longitudine"] || "");
    const categoria = (r["categoria"] || "Privata").toLowerCase();
    const tipo = categoria.includes("comun") ? "comunale" : "privata";
    const id = (nome + "|" + comune).toUpperCase();

    return {
      id, nome, comune, indirizzo, lat, lon, tipo,
      tel: r["tel"] || r["telefono"] || "",
      email: r["email"] || "",
      maps_url: r["maps_url"] || mapsSearchUrl(nome, comune, indirizzo)
    };
  }).filter(x => Number.isFinite(x.lat) && Number.isFinite(x.lon) && x.nome);

  return farmacieData;
}
function farmaciaIcon(tipo, stato){
  if(tipo === "comunale"){
    return L.divIcon({
      className:"",
      html:`<div class="pharm triangle ${stato}"></div>`,
      iconSize:[22,22],
      iconAnchor:[11,16],
      popupAnchor:[0,-14]
    });
  }
  return L.divIcon({
    className:"",
    html:`<div class="pharm ${stato}"></div>`,
    iconSize:[20,20],
    iconAnchor:[10,10],
    popupAnchor:[0,-10]
  });
}
function mostraFarmacie(comune){
  farmLayer.clearLayers();
  if(!comune){ cntFarmComuneEl.textContent = "—"; return; }

  const vis = farmacieData.filter(f => (f.comune || "").toLowerCase() === comune.toLowerCase());
  cntFarmComuneEl.textContent = String(vis.length);

  vis.forEach(f => {
    const st = getStatus("pharm", f.id);
    const popup = `
      <strong>${f.nome}</strong><br/>
      ${f.indirizzo}<br/>
      ${f.tel ? ("Tel: " + f.tel + "<br/>") : ""}
      ${f.email ? ("Email: " + f.email + "<br/>") : ""}
      <a href="${f.maps_url}" target="_blank" rel="noopener">Apri in Google Maps</a><br/>
      <a href="${DRIVE_MATERIALI}" target="_blank" rel="noopener">Materiali campagna (Drive)</a><br/><br/>
      <label style="font-size:12px;color:#ddd;">Stato:</label>
      <select data-kind="pharm" data-id="${f.id}" style="width:100%;margin-top:4px;">
        <option value="partecipa" ${st==="partecipa"?"selected":""}>Aderisce / partecipa</option>
        <option value="trattativa" ${st==="trattativa"?"selected":""}>In trattativa</option>
        <option value="contattare" ${st==="contattare"?"selected":""}>Da contattare</option>
        <option value="rifiuta" ${st==="rifiuta"?"selected":""}>Non aderisce / rifiuta</option>
      </select>
    `;

    const m = L.marker([f.lat, f.lon], { icon: farmaciaIcon(f.tipo, st) }).bindPopup(popup);

    m.on("popupopen", (e) => {
      const sel = e.popup.getElement().querySelector(`select[data-kind="pharm"][data-id="${f.id}"]`);
      if(sel){
        sel.addEventListener("change", () => {
          setStatus("pharm", f.id, sel.value);
          m.setIcon(farmaciaIcon(f.tipo, sel.value));
        });
      }
    });

    farmLayer.addLayer(m);
  });
}

/* MMG / Studi */
let mmgData = [];
const GEO_CACHE_KEY = "spg_geo_cache_mmg_v1";

function loadGeoCache(){
  try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveGeoCache(cache){
  try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); } catch(e){}
}
let geoCache = loadGeoCache();

async function loadMMG(){
  const res = await fetch("data/mmg2025.csv", { cache:"no-store" });
  const txt = await res.text();
  const rows = parseCSV(txt);

  mmgData = rows.map(r => {
    const comune = r["comune"] || "";
    const indirizzo = r["indirizzo"] || "";
    const ambito = r["ambito"] || "";
    const distretto = r["distretto"] || "";
    const tipo_studio = r["tipo_studio"] || "";
    const nomi_medici = r["nomi_medici"] || "";
    const telefoni = r["telefoni"] || "";
    const orari = r["orari"] || "";
    const id = (comune + "|" + indirizzo + "|" + ambito).toUpperCase();
    const maps_url = r["maps_url"] || mapsSearchUrl("Studio MMG", comune, indirizzo);

    const cached = geoCache[id];
    const lat = cached ? cached.lat : null;
    const lon = cached ? cached.lon : null;

    return { id, comune, indirizzo, ambito, distretto, tipo_studio, nomi_medici, telefoni, orari, maps_url, lat, lon };
  }).filter(x => x.comune && x.indirizzo);

  return mmgData;
}

function mmgIcon(stato){
  return L.divIcon({
    className:"",
    html:`<div class="mmg-pin ${stato}"><div class="mmg-icon">⚕</div></div>`,
    iconSize:[26,38],
    iconAnchor:[13,34],
    popupAnchor:[0,-30]
  });
}

async function geocodeOne(query){
  const url = "https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=" + encodeQ(query);
  const res = await fetch(url, { headers: { "Accept":"application/json" }});
  if(!res.ok) return null;
  const data = await res.json();
  if(!data || !data.length) return null;
  return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
}

async function ensureCoordsForComune(comune){
  const items = mmgData.filter(x => x.comune.toLowerCase() === comune.toLowerCase() && (!x.lat || !x.lon));
  if(items.length === 0) return;

  const MAX = 12;
  const todo = items.slice(0, MAX);

  const oldSub = hudSub.textContent;
  hudSub.textContent = `Geocodifica studi: 0/${todo.length} (solo quando serve)`;

  for(let i=0; i<todo.length; i++){
    const it = todo[i];
    const q = `${it.indirizzo}, ${it.comune}, Verona, Italia`;
    try{
      const pt = await geocodeOne(q);
      if(pt && Number.isFinite(pt.lat) && Number.isFinite(pt.lon)){
        it.lat = pt.lat; it.lon = pt.lon;
        geoCache[it.id] = { lat: pt.lat, lon: pt.lon };
        saveGeoCache(geoCache);
      }
    }catch(e){}
    hudSub.textContent = `Geocodifica studi: ${i+1}/${todo.length}`;
    await new Promise(r => setTimeout(r, 900));
  }

  hudSub.textContent = oldSub;
}

function mostraMMG(comune){
  mmgLayer.clearLayers();
  if(!comune){ cntMmgComuneEl.textContent = "—"; return; }

  const vis = mmgData.filter(m => m.comune.toLowerCase() === comune.toLowerCase());
  cntMmgComuneEl.textContent = String(vis.length);

  ensureCoordsForComune(comune).then(() => drawMMGMarkers(comune));
  drawMMGMarkers(comune);
}

function drawMMGMarkers(comune){
  mmgLayer.clearLayers();
  const vis = mmgData.filter(m => m.comune.toLowerCase() === comune.toLowerCase());

  vis.forEach(m => {
    const st = getStatus("mmg", m.id);
    if(!m.lat || !m.lon) return;

    const popup = `
      <strong>Studio MMG</strong><br/>
      ${m.indirizzo}<br/>
      <span style="color:#bbb">${m.tipo_studio || ""}</span><br/>
      <b>Medici:</b> ${m.nomi_medici || "—"}<br/>
      ${m.telefoni ? ("<b>Tel:</b> " + m.telefoni + "<br/>") : ""}
      ${m.orari ? ("<b>Orari:</b><br/><span style='white-space:pre-wrap'>"+m.orari+"</span><br/>") : ""}
      <a href="${m.maps_url}" target="_blank" rel="noopener">Apri in Google Maps</a><br/>
      <a href="${DRIVE_MATERIALI}" target="_blank" rel="noopener">Materiali campagna (Drive)</a><br/><br/>
      <label style="font-size:12px;color:#ddd;">Stato:</label>
      <select data-kind="mmg" data-id="${m.id}" style="width:100%;margin-top:4px;">
        <option value="partecipa" ${st==="partecipa"?"selected":""}>Aderisce / partecipa</option>
        <option value="trattativa" ${st==="trattativa"?"selected":""}>In trattativa</option>
        <option value="contattare" ${st==="contattare"?"selected":""}>Da contattare</option>
        <option value="rifiuta" ${st==="rifiuta"?"selected":""}>Non aderisce / rifiuta</option>
      </select>
    `;

    const marker = L.marker([m.lat, m.lon], { icon: mmgIcon(st) }).bindPopup(popup);
    marker.on("popupopen", (e) => {
      const sel = e.popup.getElement().querySelector(`select[data-kind="mmg"][data-id="${m.id}"]`);
      if(sel){
        sel.addEventListener("change", () => {
          setStatus("mmg", m.id, sel.value);
          marker.setIcon(mmgIcon(sel.value));
        });
      }
    });

    mmgLayer.addLayer(marker);
  });
}

/* COMUNI */
fetch("data/comuni_verona.json", { cache:"no-store" })
  .then(r => r.json())
  .then(data => {
    const geo = L.geoJSON(data, {
      style: f => {
        const n = nomeComune(f.properties);
        if(!comuni.includes(n)) comuni.push(n);
        return styleComune(n);
      },
      onEachFeature: (f, layer) => {
        const n = nomeComune(f.properties);
        layersByNome[n] = layer;

        const center = layer.getBounds().getCenter();
        const label = L.marker(center, {
          icon: L.divIcon({ className:"label-comune", html:n, iconSize:[120,16] }),
          interactive:false
        }).addTo(map);
        labels.push(label);

        layer.on("click", () => selezionaComune(layer, n));
      }
    }).addTo(map);

    map.fitBounds(geo.getBounds());
    aggiornaContatoriGlobali();
    aggiornaStiliComuni();
    aggiornaLabels();

    map.on("zoomend", () => {
      const z = map.getZoom();
      if(selectedLayer && z <= 12.3){
        resetSelezione();
      } else {
        aggiornaLabels();
      }
    });
  });

/* INIT */
(async function init(){
  await loadFarmacie();
  await loadMMG();
  resetSelezione();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona – SpG</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map { position:absolute; inset:0; background:#050505; }

/* HUD */
#hud {
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 9999;
  padding: 14px 16px;
  background: rgba(5,5,5,.94);
  border-left: 4px solid #00ff9c;
  min-width: 360px;
  box-shadow: 0 0 20px rgba(0,0,0,.85);
}

.hud-title { font-size:18px; font-weight:650; color:#fff; text-transform:uppercase }
.hud-sub { margin-top:6px; font-size:13px; color:#bdbdbd }

/* CONTATORI */
#stats {
  margin-top:12px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.stat { background:#0e0e0e; padding:8px }
.stat-title { font-size:10px; text-transform:uppercase; letter-spacing:.12em }
.stat-value { font-size:26px; font-weight:700 }
.stat-ok .stat-value { color:#00ff9c }
.stat-warn .stat-value { color:#ffaa00 }

/* BOTTONI */
.hud-buttons {
  margin-top:12px;
  display:flex;
  gap:6px;
}
.hud-btn {
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:11px;
  padding:5px 9px;
  cursor:pointer;
}
.hud-btn:hover {
  background:#00ff9c;
  color:#00110b;
}

/* REFERENTI */
.hud-section {
  margin-top:10px;
  border-top:1px solid #222;
  padding-top:6px;
  display:none;
}
.hud-section li {
  font-size:12px;
  color:#fff;
}

/* LABEL COMUNI */
.label-comune {
  color:#ffffff;
  font-size:11px;
  text-shadow:0 0 6px rgba(0,0,0,.9);
  pointer-events:none;
}

.leaflet-interactive { cursor:pointer }
</style>
</head>

<body>

<div id="map"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAdd">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggle">Vedi referenti</button>
  </div>

  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map',{ attributionControl:false }).setView([45.43,10.99],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map);

/* DATI */
const referenti = { "Verona": ["Vincenzo R."] };

let comuni = [];
let labelsGroup = L.layerGroup().addTo(map);
let selectedLayer = null;
let refVisibili = false;

const hudTitle = document.getElementById('hudTitle');
const hudSub = document.getElementById('hudSub');
const refPanel = document.getElementById('refPanel');
const refList = document.getElementById('refList');

const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
const hasRef = n => referenti[n] && referenti[n].length > 0;

/* COMUNI */
fetch('data/comuni_verona.json')
.then(r => r.json())
.then(data => {
  const layer = L.geoJSON(data, {
    style: f => {
      const n = nomeComune(f.properties);
      comuni.push(n);
      return {
        color: hasRef(n) ? '#00ff9c' : '#ffaa00',
        weight: 1,
        fillOpacity: 0
      };
    },
    onEachFeature: (f, l) => {
      const nome = nomeComune(f.properties);

      const label = L.marker(l.getBounds().getCenter(), {
        icon: L.divIcon({ className:'label-comune', html:nome }),
        interactive: false
      });
      labelsGroup.addLayer(label);

      l.on('click', () => selezionaComune(l, nome));
    }
  }).addTo(map);

  map.fitBounds(layer.getBounds());
  aggiornaContatori();
  map.on('zoomend', gestisciZoom);
  gestisciZoom();
});

/* ZOOM + LABEL */
function gestisciZoom(){
  const z = map.getZoom();

  if (z <= 10 && selectedLayer) {
    const prev = nomeComune(selectedLayer.feature.properties);
    selectedLayer.setStyle({
      color: hasRef(prev) ? '#00ff9c' : '#ffaa00',
      weight:1
    });
    selectedLayer = null;
    hudTitle.innerText = "Provincia di Verona";
    hudSub.innerText = "Vista generale";
  }

  if (!selectedLayer && z <= 12) {
    labelsGroup.eachLayer(l => l.setOpacity(1));
  } else {
    labelsGroup.eachLayer(l => l.setOpacity(0));
  }
}

/* SELEZIONE COMUNE */
function selezionaComune(layer, nome){
  if (selectedLayer) {
    const prev = nomeComune(selectedLayer.feature.properties);
    selectedLayer.setStyle({
      color: hasRef(prev) ? '#00ff9c' : '#ffaa00',
      weight:1
    });
  }

  selectedLayer = layer;
  layer.setStyle({ color:'#fff', weight:3 });
  map.fitBounds(layer.getBounds(), { padding:[40,40] });

  hudTitle.innerText = "Comune di " + nome;
  hudSub.innerText = hasRef(nome)
    ? "Referenti: " + referenti[nome].length
    : "⚠ Comune orfano";

  gestisciZoom();
}

/* CONTATORI */
function aggiornaContatori(){
  const ok = comuni.filter(n => hasRef(n)).length;
  document.getElementById('cntOk').innerText = ok;
  document.getElementById('cntOrfani').innerText = comuni.length - ok;
}

/* PULSANTI REFERENTI */
document.getElementById('btnAdd').onclick = () => {
  if (!selectedLayer) return alert("Seleziona un comune");
  const nome = hudTitle.innerText.replace("Comune di ","");
  const n = prompt("Inserisci nome referente");
  if (!n) return;

  if (!referenti[nome]) referenti[nome] = [];
  referenti[nome].push(n);

  hudSub.innerText = "Referenti: " + referenti[nome].length;
  aggiornaContatori();

  if (refVisibili) mostraReferenti(nome);
};

document.getElementById('btnToggle').onclick = () => {
  refVisibili = !refVisibili;
  document.getElementById('btnToggle').innerText =
    refVisibili ? "Nascondi referenti" : "Vedi referenti";

  if (refVisibili && selectedLayer) {
    mostraReferenti(hudTitle.innerText.replace("Comune di ",""));
  } else {
    refPanel.style.display = "none";
  }
};

function mostraReferenti(nome){
  refList.innerHTML = "";
  (referenti[nome] || []).forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = "block";
}
</script>

</body>
</html>

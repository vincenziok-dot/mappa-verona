<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Verona – SpG (farmacie test)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui, sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* BANNER ALTO COMUNE SELEZIONATO */
#banner{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  padding:8px 18px;
  border-bottom:3px solid #00ff9c;
  color:#fff; font-size:13px;
  display:none; z-index:9999;
  max-width: calc(100% - 24px);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* HUD COLONNA SINISTRA */
#hud{
  position:fixed; top:18px; left:18px; z-index:9998;
  padding:14px 16px;
  background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c;
  min-width:340px; max-width:420px;
  box-shadow:0 0 20px rgba(0,0,0,.85);
  max-height: calc(100vh - 36px);
  overflow:auto;
}

.hud-title{ font-size:18px; font-weight:650; color:#fff; text-transform:uppercase; }
.hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

.hud-chip{
  display:inline-block; margin-top:10px;
  font-size:10px; letter-spacing:.14em; text-transform:uppercase;
  color:#9ef5d9; background:#0e0e0e;
  padding:6px 8px; border:1px solid #1f1f1f;
}

/* contatori globali */
#stats{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:26px; font-weight:750; }
.stat-ok .stat-value{ color:#00ff9c; }
.stat-warn .stat-value{ color:#ffaa00; }
.stat-muted .stat-value{ color:#d0d0d0; }

#loadInfo{ margin-top:8px; font-size:11px; color:#bdbdbd; }

/* stats comune selezionato */
#farm-box{
  margin-top:14px; padding-top:10px;
  border-top:1px solid #222;
}
#farm-box h4{
  margin:0 0 6px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#9ef5d9;
}
#farm-count{ font-size:12px; margin-bottom:0; color:#e6e6e6; }

/* LEGENDA */
#legend-box{
  margin-top:10px; padding-top:8px;
  border-top:1px solid #222;
}
#legend-box h4{
  margin:8px 0 6px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#cccccc;
}
.legend-row{
  display:flex; align-items:center; gap:8px;
  font-size:11px; margin-bottom:4px;
  color:#e6e6e6;
}
.dot{ width:12px; height:12px; border-radius:50%; }
.triangle{
  width:0; height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-bottom:12px solid;
}
.square{ width:12px; height:12px; border-radius:2px; }

.aderisce{ background:#00ff9c; border-bottom-color:#00ff9c; color:#00ff9c; }
.trattativa{ background:#4da6ff; border-bottom-color:#4da6ff; color:#4da6ff; }
.contattare{ background:#ffaa00; border-bottom-color:#ffaa00; color:#ffaa00; }
.rifiuta{ background:#ff4d4d; border-bottom-color:#ff4d4d; color:#ff4d4d; }

.leg-coperto{ background:#00ff9c; }
.leg-orfano{ background:#ffaa00; }

/* marker farmacia */
.mrk{ width:14px; height:14px; display:flex; align-items:center; justify-content:center; }
.mrk.dot{ border-radius:50%; }

/* buttons referenti (sticky in basso nel HUD) */
.hud-buttons{
  margin-top:12px;
  display:flex; gap:6px; flex-wrap:wrap;
  position:sticky; bottom:0;
  padding-top:10px;
  background: rgba(5,5,5,.96);
  border-top: 1px solid #222;
}
.hud-btn{
  border:1px solid #00ff9c;
  background:#041812; color:#eafff7;
  font-size:11px; padding:8px 10px; cursor:pointer;
}
.hud-btn:hover{ background:#00ff9c; color:#00110b; }

.hud-section{
  margin-top:8px;
  display:none;
  padding: 6px 0 0;
}
.hud-section li{ font-size:12px; color:#fff; }
.hud-empty{ font-size:12px; color:#bdbdbd; padding: 6px 0 2px; }

/* label comuni */
.label-comune{
  color:#ffffff; font-size:11px;
  text-shadow:0 0 6px rgba(0,0,0,.9);
  pointer-events:none;
}
.leaflet-interactive{ cursor:pointer; }
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div class="hud-chip">GLOBALI</div>

  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
    <div class="stat stat-muted">
      <div class="stat-title">Farmacie</div>
      <div class="stat-value" id="cntFarm">0</div>
    </div>
    <div class="stat stat-muted">
      <div class="stat-title">Farmacie chiuse</div>
      <div class="stat-value" id="cntFarmClosed">0</div>
    </div>
  </div>

  <div id="loadInfo"></div>

  <div id="farm-box">
    <h4>Comune selezionato</h4>
    <div id="farm-count">Farmacie: —</div>
  </div>

  <div id="legend-box">
    <h4>Legenda comuni</h4>
    <div class="legend-row"><span class="square leg-coperto"></span> Comune con referenti (bordo pieno)</div>
    <div class="legend-row"><span class="square leg-orfano"></span> Comune orfano (bordo tratteggiato)</div>

    <h4>Legenda farmacie</h4>
    <div class="legend-row"><span class="dot aderisce"></span> Privata – aderisce</div>
    <div class="legend-row"><span class="dot trattativa"></span> Privata – in trattativa</div>
    <div class="legend-row"><span class="dot contattare"></span> Privata – da contattare</div>
    <div class="legend-row"><span class="dot rifiuta"></span> Privata – rifiuta</div>
    <div class="legend-row"><span class="triangle aderisce"></span> Comunale – aderisce</div>
    <div class="legend-row"><span class="triangle trattativa"></span> Comunale – in trattativa</div>
    <div class="legend-row"><span class="triangle contattare"></span> Comunale – da contattare</div>
    <div class="legend-row"><span class="triangle rifiuta"></span> Comunale – rifiuta</div>

    <h4>Nota</h4>
    <div class="legend-row" style="opacity:.85">Per ora lo stato “aderisce/trattativa/…” è <b>placeholder</b> (futuro status.csv).</div>
    <div class="legend-row" style="opacity:.85">Le farmacie con <b>stato_attivita=chiusa_temporaneamente</b> sono semi-trasparenti.</div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAdd">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggle">Vedi referenti</button>
  </div>

  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
    <div id="refEmpty" class="hud-empty" style="display:none">Nessun referente inserito.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===============================
   CONFIG
================================ */
const DATA_FARMACIE = 'data/farmacie.csv';
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm";

/* status VOLATILE (RAM) – per ora NON scrive file */
const statusRAM = {};

/* REFERENTI (RAM) */
const referenti = { "Verona": ["Vincenzo R."] };

/* ===============================
   MAPPA BASE
================================ */
const map = L.map('map',{ attributionControl:false }).setView([45.43,10.99],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

const banner      = document.getElementById('banner');
const hudTitle    = document.getElementById('hudTitle');
const hudSub      = document.getElementById('hudSub');
const refPanel    = document.getElementById('refPanel');
const refList     = document.getElementById('refList');
const refEmpty    = document.getElementById('refEmpty');
const btnToggle   = document.getElementById('btnToggle');
const farmCountEl = document.getElementById('farm-count');
const loadInfo    = document.getElementById('loadInfo');

const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
const hasRef     = n => referenti[n] && referenti[n].length > 0;

let labels = [];
let comuniSet = new Set();
let layersByNome = {};
let comuneCanonByNorm = {}; // norm -> canon
let selectedLayer = null;
let selectedNome = null;
let refVisibili = false;
let selectedZoomRef = null;

/* layer markers */
const farmLayer = L.layerGroup().addTo(map);
const farmMarkers = [];   // {marker, comune, closed}

/* ===============================
   UTIL: normalizzazione comune
================================ */
function normKey(s){
  return (s || '')
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ');
}
function canonComune(raw){
  const k = normKey(raw);
  return comuneCanonByNorm[k] || (raw || '').trim();
}

/* ===============================
   CONTATORI GLOBALI
================================ */
function aggiornaContatoriGlobali(){
  const comuni = Array.from(comuniSet);
  const coperti = comuni.filter(n => hasRef(n)).length;
  const orfani = comuni.length - coperti;

  const totFarm = farmMarkers.length;
  const closed = farmMarkers.filter(x => x.closed).length;

  document.getElementById('cntOk').innerText = coperti;
  document.getElementById('cntOrfani').innerText = orfani;
  document.getElementById('cntFarm').innerText = totFarm;
  document.getElementById('cntFarmClosed').innerText = closed;
}

/* ===============================
   STILI COMUNI
================================ */
function styleComuneBase(nome){
  const ref = hasRef(nome);
  return {
    color: ref ? '#00ff9c' : '#ffaa00',
    weight: ref ? 2 : 1,
    dashArray: ref ? null : '5 5',
    fillColor: '#00ff9c',
    fillOpacity: ref ? 0.10 : 0
  };
}
function aggiornaStiliComuni(){
  Object.keys(layersByNome).forEach(n => {
    const layer = layersByNome[n];
    let st = styleComuneBase(n);
    if (selectedLayer && layer === selectedLayer){
      st = { ...st, color:'#ffffff', weight:3, dashArray:null, fillOpacity:0 };
    }
    layer.setStyle(st);
  });
}

/* ===============================
   LABEL COMUNI ON/OFF
================================ */
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    const show = (!selectedNome && z >= 9 && z <= 13);
    if(show){ if(!map.hasLayer(l)) map.addLayer(l); }
    else { if(map.hasLayer(l)) map.removeLayer(l); }
  });
}

/* ===============================
   RESET SELEZIONE
================================ */
function resetSelezione(){
  selectedLayer = null;
  selectedNome = null;
  selectedZoomRef = null;

  hudTitle.innerText = 'Provincia di Verona';
  hudSub.innerText   = 'Vista generale';
  banner.style.display = 'none';

  farmCountEl.innerText = 'Farmacie: —';

  farmMarkers.forEach(x => x.marker.setOpacity(x.closed ? 0.35 : 1));

  refPanel.style.display = 'none';
  refVisibili = false;
  btnToggle.innerText = 'Vedi referenti';

  aggiornaStiliComuni();
  aggiornaLabels();
}

/* ===============================
   SELEZIONE COMUNE
================================ */
function selezionaComune(layer, nome){
  selectedLayer = layer;
  selectedNome = nome;

  aggiornaStiliComuni();

  map.fitBounds(layer.getBounds(), { padding:[40,40] });
  map.once('moveend', () => { selectedZoomRef = map.getZoom(); });

  const nRef = (referenti[nome] ? referenti[nome].length : 0);
  hudTitle.innerText = 'Comune di ' + nome;
  hudSub.innerText = hasRef(nome) ? ('Referenti presenti: ' + nRef) : '⚠ Comune orfano';

  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + nome + '</b> – Referenti: ' + nRef;

  aggiornaLabels();

  // opacità: comune selezionato 1 (o 0.35 se chiusa), altri dim
  farmMarkers.forEach(x => {
    const base = x.closed ? 0.35 : 1;
    x.marker.setOpacity(x.comune === nome ? base : 0.18);
  });

  const nFarm = farmMarkers.filter(x => x.comune === nome).length;
  farmCountEl.innerText = 'Farmacie: ' + nFarm;

  if(refVisibili) mostraReferenti(nome);
}

/* ===============================
   REFERENTI
================================ */
function mostraReferenti(nome){
  refList.innerHTML = '';
  const lista = referenti[nome] || [];
  if(!lista.length){
    refEmpty.style.display = 'block';
    refPanel.style.display = 'block';
    return;
  }
  refEmpty.style.display = 'none';
  lista.forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = 'block';
}

document.getElementById('btnAdd').onclick = () => {
  if(!selectedNome){ alert('Seleziona prima un comune sulla mappa'); return; }
  const n = prompt('Inserisci il tuo nome (comparirà come referente)');
  if(!n) return;

  if(!referenti[selectedNome]) referenti[selectedNome] = [];
  referenti[selectedNome].push(n);

  const nRef = referenti[selectedNome].length;
  hudSub.innerText = 'Referenti presenti: ' + nRef;
  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + selectedNome + '</b> – Referenti: ' + nRef;

  aggiornaStiliComuni();
  aggiornaContatoriGlobali();

  if(refVisibili) mostraReferenti(selectedNome);
};

document.getElementById('btnToggle').onclick = () => {
  if(!selectedNome){ alert('Seleziona prima un comune sulla mappa'); return; }
  refVisibili = !refVisibili;
  btnToggle.innerText = refVisibili ? 'Nascondi referenti' : 'Vedi referenti';
  if(refVisibili) mostraReferenti(selectedNome);
  else refPanel.style.display = 'none';
};

/* ===============================
   UTIL: parse coordinate "lat, lon" (UNICA colonna)
   - accetta: "45.123, 10.456"
   - accetta anche ; come separatore
   - supporta virgola decimale (sostituisce la prima virgola decimale con punto se necessario)
================================ */
function parseCoordPair(s){
  if(!s) return null;
  const raw = String(s).trim();
  if(!raw) return null;

  // normalizza separatore
  let t = raw.replace(';', ',');
  // split "lat, lon" (prima virgola come separatore)
  const parts = t.split(',');
  if(parts.length < 2) return null;

  // attenzione: se ci sono virgole decimali (italiano), spesso è "45,123 10,456" -> qui sarebbe ingestibile.
  // Nel tuo caso (da Google Maps) è con punto decimale. Gestiamo comunque il caso "45,123; 10,456" trasformando le virgole decimali in punti
  const a0 = parts[0].trim().replace(',', '.');
  const b0 = parts.slice(1).join(',').trim().replace(',', '.'); // in caso di virgole extra

  const lat = parseFloat(a0);
  const lon = parseFloat(b0);
  if(!isFinite(lat) || !isFinite(lon)) return null;

  return { lat, lon };
}

/* ===============================
   MARKER ICONS
   (placeholder stato adesione: default 'contattare')
================================ */
function iconFarmacia(tipo, stato){
  const cls = (stato || 'contattare');
  if((tipo || '').toLowerCase().includes('comunal')){
    return L.divIcon({ className:'', html:`<div class="triangle ${cls}"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
  }
  return L.divIcon({ className:'', html:`<div class="mrk dot ${cls}"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
}

/* ===============================
   CARICAMENTO COMUNI (GEOJSON)
================================ */
fetch('data/comuni_verona.json')
  .then(r => r.json())
  .then(data => {
    const geo = L.geoJSON(data, {
      style: f => {
        const n = nomeComune(f.properties);
        comuniSet.add(n);
        return styleComuneBase(n);
      },
      onEachFeature: (f, layer) => {
        const nome = nomeComune(f.properties);
        layersByNome[nome] = layer;
        comuneCanonByNorm[normKey(nome)] = nome;

        const center = layer.getBounds().getCenter();
        const label = L.marker(center,{
          icon: L.divIcon({ className:'label-comune', html: nome, iconSize:[140,16] }),
          interactive:false
        }).addTo(map);
        labels.push(label);

        layer.on('click', () => selezionaComune(layer, nome));
      }
    }).addTo(map);

    map.fitBounds(geo.getBounds());
    aggiornaStiliComuni();
    aggiornaLabels();
    aggiornaContatoriGlobali();

    map.on('zoomend', () => {
      const z = map.getZoom();
      if(selectedNome && selectedZoomRef !== null && z <= (selectedZoomRef - 0.6)){ resetSelezione(); return; }
      if(selectedNome && z < 9.5){ resetSelezione(); return; }
      aggiornaLabels();
    });

    caricaFarmacieCSV();
  });

/* ===============================
   CARICA FARMACIE (CSV)
   REGOLE (come da tua richiesta):
   - POSIZIONE: usa SOLO "coordinate" (lat, lon) -> nessuna geocodifica
   - POPUP: usa SOLO "maps_url" (link diretto al POI in Maps)
================================ */
function caricaFarmacieCSV(){
  Papa.parse(DATA_FARMACIE, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      const rows = res.data || [];
      let added = 0, skipped = 0, noComuneMatch = 0, closed = 0;

      rows.forEach(row => {
        // campi “umani” (se ci sono)
        const nome = String(row.descrizione_farmacia || row.nome || row.denominazione || 'Farmacia').trim();
        const comuneRaw = String(row.comune || '').trim();
        if(!comuneRaw){ skipped++; return; }
        const comune = canonComune(comuneRaw);
        if(!comuneCanonByNorm[normKey(comuneRaw)]) noComuneMatch++;

        // pos (OBBLIGATORIA)
        const c = parseCoordPair(row.coordinate);
        if(!c){ skipped++; return; }

        // link Maps (OBBLIGATORIO)
        const mapsUrl = String(row.maps_url || '').trim();
        if(!mapsUrl){ skipped++; return; }

        const indirizzo = String(row.indirizzo_full || row.indirizzo || '').trim();
        const cap = String(row.cap || '').trim();
        const gestione = String(row.gestione || '').trim(); // "privata"/"comunale" se presente
        const tipo = gestione || 'privata';

        const statoAtt = String(row.stato_attivita || '').trim(); // es: chiusa_temporaneamente
        const isClosed = (statoAtt === 'chiusa_temporaneamente');

        // stato adesione (placeholder per ora)
        const st = 'contattare';

        const popupHtml = `
          <strong>${nome}</strong><br/>
          <div style="opacity:.9">
            ${indirizzo ? indirizzo : ''}${cap ? (indirizzo ? ', ' : '') + cap : ''}${(indirizzo||cap) ? ' – ' : ''}${comune}<br/>
            ${gestione ? ('Gestione: ' + gestione) : ''}
          </div>
          ${isClosed ? `<div style="margin-top:8px;color:#ffaa00;font-size:12px"><b>⚠ Chiusa temporaneamente</b></div>` : ''}
          <div style="margin-top:8px">
            <a href="${mapsUrl}" target="_blank" rel="noopener">Apri in Google Maps</a><br/>
            <a href="${DRIVE_MATERIALI}" target="_blank" rel="noopener">Materiali campagna</a>
          </div>
        `;

        const marker = L.marker([c.lat, c.lon], { icon: iconFarmacia(tipo, st) })
          .bindPopup(popupHtml);

        marker.setOpacity(isClosed ? 0.35 : 1);

        marker.addTo(farmLayer);
        farmMarkers.push({ marker, comune, closed: isClosed });

        added++;
        if(isClosed) closed++;
      });

      aggiornaContatoriGlobali();

      if(selectedNome){
        farmMarkers.forEach(x => {
          const base = x.closed ? 0.35 : 1;
          x.marker.setOpacity(x.comune === selectedNome ? base : 0.18);
        });
        farmCountEl.innerText = 'Farmacie: ' + farmMarkers.filter(x => x.comune === selectedNome).length;
      }

      loadInfo.innerHTML =
        `Farmacie caricate: <b>${added}</b> (saltate: ${skipped})` +
        (noComuneMatch ? `<br/><span style="color:#ffaa00">⚠ Comune non riconosciuto (nome diverso dal GeoJSON): ${noComuneMatch}</span>` : '') +
        (closed ? `<br/>Chiuse temporaneamente: <b>${closed}</b>` : '');
    }
  });
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mappa Verona – SpG (Farmacie + Stato)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { margin:0; height:100%; background:#000; font-family:system-ui, sans-serif; }
    #map { position:absolute; inset:0; background:#050505; }

    /* Banner comune selezionato */
    #banner{
      position:fixed; top:0; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      padding:8px 18px;
      border-bottom:3px solid #00ff9c;
      color:#fff; font-size:13px;
      display:none; z-index:9999;
      max-width: calc(100% - 24px);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* HUD */
    #hud{
      position:fixed; top:18px; left:18px; z-index:9998;
      padding:14px 16px;
      background:rgba(5,5,5,.94);
      border-left:4px solid #00ff9c;
      width:360px; max-width: min(440px, calc(100vw - 36px));
      box-shadow:0 0 20px rgba(0,0,0,.85);
      max-height: calc(100vh - 36px);
      overflow:auto;
      border-radius:8px;
    }

    .hud-title{ font-size:18px; font-weight:650; color:#fff; text-transform:uppercase; }
    .hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

    /* chips/sezioni */
    .chip{
      display:flex; align-items:center; justify-content:space-between;
      margin-top:12px;
      font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      color:#9ef5d9;
      background:#0e0e0e;
      padding:8px 10px;
      border:1px solid #1f1f1f;
      border-radius:8px;
    }
    .chip small{ letter-spacing:0; text-transform:none; color:#bdbdbd; font-size:11px; }

    /* stats */
    .grid2{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; border-radius:8px; }
    .stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
    .stat-value{ font-size:24px; font-weight:800; }
    .ok{ color:#00ff9c; }
    .warn{ color:#ffaa00; }
    .info{ color:#4da6ff; }
    .muted{ color:#d0d0d0; }

    /* lista stati più densa */
    .miniGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px 10px;
      font-size:12px;
      color:#e6e6e6;
    }
    .miniRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .miniRow .k{ display:flex; align-items:center; gap:8px; min-width:0; }
    .miniRow .k span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .miniRow .v{ font-variant-numeric: tabular-nums; font-weight:750; }

    /* legenda */
    #legend-box{
      margin-top:12px; padding-top:10px;
      border-top:1px solid #222;
    }
    #legend-box h4{
      margin:10px 0 6px;
      font-size:11px; text-transform:uppercase; letter-spacing:.12em;
      color:#cccccc;
    }
    .legend-row{
      display:flex; align-items:center; gap:8px;
      font-size:11px; margin-bottom:6px;
      color:#e6e6e6;
    }

    /* simboli base */
    .dot{ width:12px; height:12px; border-radius:50%; }
    .triangle{
      width:0; height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-bottom:12px solid;
    }
    .square{ width:12px; height:12px; border-radius:2px; }

    /* colori “lavoro” (4 famiglie, poi testo spiega i dettagli) */
    .aderisce{ background:#00ff9c; border-bottom-color:#00ff9c; color:#00ff9c; }
    .trattativa{ background:#4da6ff; border-bottom-color:#4da6ff; color:#4da6ff; }
    .contattare{ background:#ffaa00; border-bottom-color:#ffaa00; color:#ffaa00; }
    .rifiuta{ background:#ff4d4d; border-bottom-color:#ff4d4d; color:#ff4d4d; }
    .chiusa { background:#8c8c8c; border-bottom-color:#8c8c8c; color:#8c8c8c; }

    /* marker farmacia (divIcon) */
    .mrk{ width:14px; height:14px; display:flex; align-items:center; justify-content:center; }
    .mrk.dot{ border-radius:50%; }

    /* label comuni */
    .label-comune{
      color:#ffffff; font-size:11px;
      text-shadow:0 0 6px rgba(0,0,0,.9);
      pointer-events:none;
    }

    /* pannello strumenti sticky */
    .tools{
      margin-top:12px;
      position:sticky;
      bottom:0;
      padding-top:12px;
      background:rgba(5,5,5,.96);
      border-top:1px solid #222;
    }
    .btnRow{ display:flex; gap:8px; flex-wrap:wrap; }
    button{
      border:1px solid #00ff9c;
      background:#041812;
      color:#eafff7;
      font-size:12px;
      padding:8px 10px;
      cursor:pointer;
      border-radius:8px;
    }
    button:hover{ background:#00ff9c; color:#00110b; }

    /* referenti list */
    #refPanel{ display:none; margin-top:8px; }
    #refPanel ul{ margin:0; padding-left:18px; }
    #refPanel li{ font-size:12px; color:#fff; }

    /* form popup */
    .pform label{ display:block; font-size:12px; margin-top:8px; }
    .pform select, .pform input, .pform textarea{
      width:100%; box-sizing:border-box;
      background:#0e0e0e; color:#fff;
      border:1px solid #333; border-radius:8px;
      padding:8px;
      font-size:13px;
    }
    .pform textarea{ min-height:70px; }
    .pform .hint{ font-size:11px; color:#bdbdbd; margin-top:6px; }
    .pform .row{ display:flex; gap:8px; margin-top:10px; }
    .pform .row button{ flex:1; }

    /* Leaflet tweaks */
    .leaflet-control-zoom a{ border-radius:8px !important; }
    .leaflet-top.leaflet-right{ margin-top:12px; margin-right:12px; }
    .leaflet-interactive{ cursor:pointer; }

    /* mobile */
    @media (max-width: 640px){
      #hud{
        left:10px; top:10px;
        width: calc(100vw - 20px);
        max-width: calc(100vw - 20px);
        max-height: calc(100vh - 20px);
      }
      .grid2{ grid-template-columns:1fr 1fr; }
      .stat-value{ font-size:22px; }
    }
  
/* popup pharmacy UI */
.popup{ min-width:240px; max-width:320px; color:#fff; font-family:system-ui,sans-serif; }
.popup-title{ font-weight:750; margin-bottom:4px; }
.popup-sub{ font-size:12px; color:#cfcfcf; line-height:1.25; }
.popup-row{ margin-top:10px; }
.popup-row label{ display:block; font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#9ef5d9; margin-bottom:4px; }
.popup select, .popup textarea, .popup input{ width:100%; background:#0e0e0e; color:#fff; border:1px solid #222; padding:6px 8px; border-radius:6px; font-size:12px; box-sizing:border-box; }
.popup textarea{ resize:vertical; }
.popup-actions{ display:flex; gap:8px; margin-top:10px; }
.btn{ background:#00ff9c; color:#00110b; border:1px solid #00ff9c; padding:7px 10px; border-radius:8px; font-weight:750; cursor:pointer; }
.btn:hover{ filter:brightness(1.05); }
.btn-ghost{ background:transparent; color:#eafff7; border:1px solid #2a2a2a; padding:7px 10px; border-radius:8px; cursor:pointer; }
.btn-mini{ width:38px; background:#041812; color:#eafff7; border:1px solid #00ff9c; border-radius:8px; cursor:pointer; font-weight:800; }
.btn-mini:hover{ background:#00ff9c; color:#00110b; }
.popup-links{ margin-top:10px; font-size:12px; display:flex; flex-direction:column; gap:6px; }
.popup-links a{ color:#9ef5d9; text-decoration:none; }
.popup-links a:hover{ text-decoration:underline; }
.badge{ margin-top:8px; display:inline-block; font-size:11px; padding:4px 8px; border-radius:999px; }
.badge-chiusa{ background:rgba(255,77,77,.18); border:1px solid rgba(255,77,77,.35); color:#ffb3b3; }
.chips{ display:flex; flex-wrap:wrap; gap:6px; }
.chip{ background:#0e0e0e; border:1px solid #222; padding:4px 6px; border-radius:999px; font-size:12px; display:inline-flex; align-items:center; gap:6px; }
.chip-x{ background:transparent; border:none; color:#ffb3b3; font-weight:900; cursor:pointer; line-height:1; }
.chip-add{ display:flex; gap:6px; margin-top:6px; }
.chip-add input{ flex:1; }
.muted{ color:#bdbdbd; font-size:12px; }

/* === Popup readability tweaks (rev2.1) === */
.popup .badge{ font-size:10px; padding:2px 6px; border-radius:999px; border:1px solid #2a2a2a; }
.badge-closed{ background:rgba(255,77,77,.15); color:#ffd1d1; border-color:rgba(255,77,77,.35); }
.badge-gest{ background:#121212; color:#eaeaea; }
.popup label{ color:#eaeaea; }
.popup select, .popup input, .popup textarea{ background:#0b0b0b; color:#f5f5f5; border:1px solid #2a2a2a; }
.popup .btn-link{ color:#9ef5d9; text-decoration:none; }
.popup .btn-link:hover{ text-decoration:underline; }
.state-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,.18); }
.state-dot.ok{ background:#00ff9c; }
.state-dot.warn{ background:#ffaa00; }
.state-dot.info{ background:#4da6ff; }
.state-dot.no{ background:#ff4d4d; }
.state-dot.muted{ background:#9b9b9b; }
.chips .chip{ background:#121212; border:1px solid #2a2a2a; color:#f0f0f0; }
.chips .chip-x{ color:#f0f0f0; }
.chk{ display:flex; align-items:center; gap:8px; color:#eaeaea; }

</style>
</head>

<body>
  <div id="map"></div>
  <div id="banner"></div>

  <div id="hud">
    <div class="hud-title" id="hudTitle">Provincia di Verona</div>
    <div class="hud-sub" id="hudSub">Vista generale</div>

    <div class="chip">
      <span>GLOBALI</span>
      <small id="globalHint">—</small>
    </div>

    <div class="grid2">
      <div class="stat">
        <div class="stat-title">Farmacie (tot)</div>
        <div class="stat-value muted" id="g_total">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Comuni</div>
        <div class="stat-value info" id="g_comuni">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Private</div>
        <div class="stat-value muted" id="g_private">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Comunali</div>
        <div class="stat-value muted" id="g_comunali">0</div>
      </div>
    </div>

    <div class="miniGrid" id="g_statusGrid"></div>

    <div class="chip" style="margin-top:14px">
      <span>COMUNE SELEZIONATO</span>
      <small id="comuneHint">—</small>
    </div>

    <div class="grid2">
      <div class="stat">
        <div class="stat-title">Farmacie</div>
        <div class="stat-value muted" id="c_total">—</div>
      </div>
      <div class="stat">
        <div class="stat-title">Chiuse temp.</div>
        <div class="stat-value warn" id="c_chiuse">—</div>
      </div>
    </div>

    <div class="miniGrid" id="c_statusGrid"></div>

    <div id="legend-box">
      <h4>Legenda marker</h4>
      <div class="legend-row"><span class="dot contattare"></span> Privata (colore = stato)</div>
      <div class="legend-row"><span class="triangle contattare"></span> Comunale (colore = stato)</div>
      <div class="legend-row"><span class="dot chiusa" style="opacity:.35"></span> Chiusa temporaneamente (semi-trasparente)</div>

      <h4>Legenda stati lavoro</h4>
      <div class="legend-row"><span class="dot contattare"></span> Non contattata</div>
      <div class="legend-row"><span class="dot trattativa"></span> In carico / In trattativa</div>
      <div class="legend-row"><span class="dot aderisce"></span> Favorevole (poster / informativa / boicotta)</div>
      <div class="legend-row"><span class="dot rifiuta"></span> Non aderisce</div>

      <h4 style="margin-top:12px">Debug</h4>
      <div class="legend-row" id="debugLine" style="display:none; color:#ffaa00"></div>
    </div>

    <div class="tools">
      <div class="chip" style="margin-top:0">
        <span>STRUMENTI</span>
        <small>referenti + stato</small>
      </div>

      <div class="btnRow" style="margin-top:10px">
        <button id="btnAddRef">Aggiungi referente</button>
        <button id="btnToggleRef">Vedi referenti</button>
      </div>

      <div id="refPanel">
        <ul id="refList"></ul>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* ===============================
       CONFIG
    ================================ */
    const FARMACIE_CSV_CANDIDATES = ['DATA/farmacie.csv','data/farmacie.csv','farmacie.csv'];

async function fetchTextFirstOk(paths){
  let lastErr = null;
  for(const p of paths){
    try{
      const r = await fetch(p, { cache:'no-store' });
      if(r && r.ok){
        const text = await r.text();
        return { path:p, text };
      }
    }catch(e){ lastErr = e; }
  }
  throw new Error('farmacie.csv non trovato. Provati: ' + paths.join(', ') + (lastErr ? ' — ' + lastErr : ''));
}

    const DATA_COMUNI_GEOJSON = 'data/comuni_verona.json';
    const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1oMqJ_6ZLthMK73FkpirBtvQ_Ycif4OYS";

    /* REFERENTI (RAM) */
    const referenti = { "Verona": ["Vincenzo Russo"] };

    /* ===============================
       STATUS (LocalStorage) – no file write
       key: farmacia_id -> { stato_lavoro, incaricati[], note, chiusa_temp_bool }
    ================================ */
    const STATUS_STORE_KEY = 'spg_status_farmacie_v1';
    function loadStatusStore(){
      try { return JSON.parse(localStorage.getItem(STATUS_STORE_KEY) || '{}'); }
      catch(e){ return {}; }
    }
    function saveStatusStore(obj){
      try { localStorage.setItem(STATUS_STORE_KEY, JSON.stringify(obj)); }
      catch(e){}
    }
    let statusStore = loadStatusStore();

    /* ===============================
       Stato lavoro (enum)
       - la UI lavora su questi
       - poi li mappiamo ai 4 colori
    ================================ */
    const WORK_STATES = [
      { key:'non_contattata', label:'Non contattata', family:'contattare' },
      { key:'in_carico', label:'In carico', family:'trattativa' },
      { key:'in_trattativa', label:'In trattativa', family:'trattativa' },
      { key:'fav_poster', label:'Favorevole + poster', family:'aderisce' },
      { key:'fav_informativa', label:'Favorevole + informativa', family:'aderisce' },
      { key:'boicotta', label:'Boicotta (cessa fornitura)', family:'aderisce' },
      { key:'non_aderisce', label:'Non aderisce', family:'rifiuta' }
    ];
    const WORK_STATE_BY_KEY = Object.fromEntries(WORK_STATES.map(x => [x.key, x]));

    function defaultWorkState(){ return 'non_contattata'; }

    /* ===============================
       UTIL: normalizzazione comune
    ================================ */
    function normKey(s){
      return (s || '')
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ');
    }

    /* canon mapping costruito dal GeoJSON */
    let comuneCanonByNorm = {};
    let canonNamesNorm = [];

    /* alias manuali (minimo) */
    const COMUNE_ALIAS = {
      'negrar': 'Negrar di Valpolicella'
    };

    function canonComune(raw){
      const rawTrim = (raw || '').trim();
      if(!rawTrim) return '';
      const k = normKey(rawTrim);

      // 1) match esatto
      if(comuneCanonByNorm[k]) return comuneCanonByNorm[k];

      // 2) alias manuale
      if(COMUNE_ALIAS[k]){
        const kk = normKey(COMUNE_ALIAS[k]);
        if(comuneCanonByNorm[kk]) return comuneCanonByNorm[kk];
        return COMUNE_ALIAS[k];
      }

      // 3) fuzzy: se il nome nel CSV è prefisso unico (es. "negrar" -> "negrar di valpolicella")
      const pref = k + ' ';
      const cands = canonNamesNorm.filter(x => x.startsWith(pref));
      if(cands.length === 1) return comuneCanonByNorm[cands[0]];

      // 4) fuzzy inverso: se il canon è prefisso unico del nome nel CSV (es. "negrar di valpolicella" -> "negrar")
      const cands2 = canonNamesNorm.filter(x => k.startsWith(x + ' '));
      if(cands2.length === 1) return comuneCanonByNorm[cands2[0]];

      return rawTrim;
    }

    /* ===============================
       MAPPA BASE
    ================================ */
    const map = L.map('map', { attributionControl:false, zoomControl:false }).setView([45.43,10.99],10);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);
    L.control.zoom({ position:'topright' }).addTo(map);

    const banner = document.getElementById('banner');
    const hudTitle = document.getElementById('hudTitle');
    const hudSub = document.getElementById('hudSub');
    const globalHint = document.getElementById('globalHint');
    const comuneHint = document.getElementById('comuneHint');

    const g_total = document.getElementById('g_total');
    const g_comuni = document.getElementById('g_comuni');
    const g_private = document.getElementById('g_private');
    const g_comunali = document.getElementById('g_comunali');
    const g_statusGrid = document.getElementById('g_statusGrid');

    const c_total = document.getElementById('c_total');
    const c_chiuse = document.getElementById('c_chiuse');
    const c_statusGrid = document.getElementById('c_statusGrid');

    const debugLine = document.getElementById('debugLine');

    const refPanel = document.getElementById('refPanel');
    const refList = document.getElementById('refList');
    const btnAddRef = document.getElementById('btnAddRef');
    const btnToggleRef = document.getElementById('btnToggleRef');

    /* layers */
    const farmLayer = L.layerGroup().addTo(map);
    let comuniLayer = null;

    /* runtime state */
    let selectedComune = null;
    let selectedComuneLayer = null;

    /* data */
    const farmMarkers = []; // { id, comune, gestione, marker, row }
    const comuniSet = new Set();

    function hasRef(nomeComune){
      return referenti[nomeComune] && referenti[nomeComune].length > 0;
    }

    /* ===============================
       STYLE COMUNI
    ================================ */
    function styleComuneBase(nome){
      const ref = hasRef(nome);
      return {
        color: ref ? '#00ff9c' : '#ffaa00',
        weight: ref ? 2 : 1,
        dashArray: ref ? null : '5 5',
        fillColor: '#00ff9c',
        fillOpacity: ref ? 0.10 : 0
      };
    }
    function aggiornaStiliComuni(){
      if(!comuniLayer) return;
      comuniLayer.eachLayer(layer => {
        const nome = layer?.feature?.properties ? (layer.feature.properties.nome || layer.feature.properties.DENOM_COM || layer.feature.properties.name || 'Comune') : 'Comune';
        let st = styleComuneBase(nome);
        if(selectedComuneLayer && layer === selectedComuneLayer){
          st = { ...st, color:'#ffffff', weight:3, dashArray:null, fillOpacity:0 };
        }
        layer.setStyle(st);
      });
    }

    /* ===============================
       ICONE FARMACIE
    ================================ */
    function workFamilyFor(id){
      const st = statusStore[id]?.stato_lavoro || defaultWorkState();
      const fam = (WORK_STATE_BY_KEY[st]?.family) || 'contattare';
      return fam;
    }
    function isChiusaTemp(row, id){
      const csvClosed = String(row.stato_attivita || '').toLowerCase().includes('chiusa');
      const st = statusStore[id] || {};
      if(csvClosed){
        return !st.force_open;
      }
      return !!st.chiusa_temp;
    }

    function iconFarmacia(gestione, family, chiusa){
      const isComunale = (gestione || '').toString().toLowerCase().includes('comunal');
      const cls = family || 'contattare';
      const opacity = chiusa ? 0.35 : 1;

      if(isComunale){
        return L.divIcon({
          className:'',
          html:`<div class="triangle ${chiusa ? 'chiusa' : cls}" style="opacity:${opacity}"></div>`,
          iconSize:[14,14],
          iconAnchor:[7,7]
        });
      }
      return L.divIcon({
        className:'',
        html:`<div class="mrk dot ${chiusa ? 'chiusa' : cls}" style="opacity:${opacity}"></div>`,
        iconSize:[14,14],
        iconAnchor:[7,7]
      });
    }

    /* ===============================
       UI HELPERS (stats)
    ================================ */
    function countBy(arr, fnKey){
      const m = {};
      for(const x of arr){
        const k = fnKey(x);
        m[k] = (m[k] || 0) + 1;
      }
      return m;
    }

    function renderStatusGrid(el, markers){
      // conta per stato_lavoro
      const m = countBy(markers, x => (statusStore[x.id]?.stato_lavoro || defaultWorkState()));
      el.innerHTML = '';
      for(const st of WORK_STATES){
        const n = m[st.key] || 0;
        const fam = st.family;
        el.insertAdjacentHTML('beforeend', `
          <div class="miniRow">
            <div class="k"><span class="dot ${fam}" style="width:10px;height:10px"></span><span>${st.label}</span></div>
            <div class="v">${n}</div>
          </div>
        `);
      }
      // chiuse temp
      const chiuse = markers.filter(x => isChiusaTemp(x.row, x.id)).length;
      el.insertAdjacentHTML('beforeend', `
        <div class="miniRow">
          <div class="k"><span class="dot chiusa" style="width:10px;height:10px;opacity:.35"></span><span>Chiuse temp.</span></div>
          <div class="v">${chiuse}</div>
        </div>
      `);
    }

    function aggiornaHUD(){
      const all = farmMarkers;

      const comuniCount = comuniSet.size;
      g_comuni.textContent = comuniCount;

      g_total.textContent = all.length;

      const priv = all.filter(x => !(x.gestione || '').toString().toLowerCase().includes('comunal')).length;
      const comu = all.length - priv;
      g_private.textContent = priv;
      g_comunali.textContent = comu;

      globalHint.textContent = `marker caricati: ${all.length}`;

      renderStatusGrid(g_statusGrid, all);

      if(selectedComune){
        const inComune = all.filter(x => sameComune(x.comune, selectedComune));
        comuneHint.textContent = selectedComune;
        c_total.textContent = inComune.length;
        c_chiuse.textContent = inComune.filter(x => isChiusaTemp(x.row, x.id)).length;
        renderStatusGrid(c_statusGrid, inComune);
      } else {
        comuneHint.textContent = '—';
        c_total.textContent = '—';
        c_chiuse.textContent = '—';
        c_statusGrid.innerHTML = '';
      }
    }

    /* ===============================
       REFERENTI UI
    ================================ */
    function mostraReferenti(nome){
      refList.innerHTML = '';
      const lista = referenti[nome] || [];
      lista.forEach(r => {
        const li = document.createElement('li');
        li.textContent = r;
        refList.appendChild(li);
      });
      refPanel.style.display = 'block';
    }

    btnAddRef.onclick = () => {
      if(!selectedComune){
        alert('Seleziona un comune');
        return;
      }
      const n = prompt('Nome referente');
      if(!n) return;
      if(!referenti[selectedComune]) referenti[selectedComune] = [];
      referenti[selectedComune].push(n);

      // update UI + stili confini
      hudSub.textContent = `Referenti presenti: ${referenti[selectedComune].length}`;
      banner.innerHTML = `↑ Comune di <b>${selectedComune}</b> – Referenti: ${referenti[selectedComune].length}`;
      aggiornaStiliComuni();
      mostraReferenti(selectedComune);
    };

    btnToggleRef.onclick = () => {
      if(!selectedComune){
        alert('Seleziona un comune');
        return;
      }
      if(refPanel.style.display === 'block'){
        refPanel.style.display = 'none';
      } else {
        mostraReferenti(selectedComune);
      }
    };

    /* ===============================
       SELEZIONE COMUNE
    ================================ */
    function resetSelezione(){
      selectedComune = null;
      selectedComuneLayer = null;

      hudTitle.textContent = 'Provincia di Verona';
      hudSub.textContent = 'Vista generale';
      banner.style.display = 'none';

      // marker full opacity
      farmMarkers.forEach(x => x.marker.setOpacity(1));

      refPanel.style.display = 'none';

      aggiornaStiliComuni();
      aggiornaHUD();
    }

    function selezionaComune(layer, nome){
      selectedComune = nome;
      selectedComuneLayer = layer;

      hudTitle.textContent = `Comune di ${nome}`;
      const nRef = (referenti[nome]?.length || 0);
      hudSub.textContent = nRef ? `Referenti presenti: ${nRef}` : 'Vista comune';
      banner.style.display = 'block';
      banner.innerHTML = `↑ Comune di <b>${nome}</b> – Referenti: ${nRef}`;

      aggiornaStiliComuni();

      // dim out-of-comune markers
      farmMarkers.forEach(x => x.marker.setOpacity(sameComune(x.comune, nome) ? 1 : 0.18));

      // zoom sul comune
      try { map.fitBounds(layer.getBounds(), { padding:[40,40] }); } catch(e){}

      aggiornaHUD();
    }

    /* ===============================
       POPUP UI + SAVE
    ================================ */
    function escapeHtml(s){
      return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function stableId(str){
      let h = 0;
      const s = String(str || '');
      for (let i=0; i<s.length; i++){
        h = ((h<<5) - h) + s.charCodeAt(i);
        h |= 0;
      }
      return String(h);
    }


    
    
function buildPopupHtml(row, id){
      const st = statusStore[id] || {};
      const stato = st.stato_lavoro || defaultWorkState();
      const incaricati = Array.isArray(st.incaricati) ? st.incaricati.filter(Boolean) : [];
      const note = (st.note || '').toString();

      const nome = escapeHtml(row.descrizione_farmacia || 'Farmacia');
      const comune = escapeHtml(row.comune || '');
      const indir = escapeHtml(row.indirizzo_full || '');
      const cap = escapeHtml(row.cap || '');
      const gestione = escapeHtml(row.gestione || '');
      const mapsUrl = (row.maps_url || '').toString().trim();

      const csvClosed = String(row.stato_attivita || '').toLowerCase().includes('chiusa');
      const isClosed = isChiusaTemp(row, id);

      const options = Object.entries(WORK_STATES).map(([k,v]) =>
        `<option value="${k}" ${k===stato ? 'selected' : ''}>${escapeHtml(v.label)}</option>`
      ).join('');

      const chipsHtml = incaricati.length
        ? incaricati.map(n => {
            const nn = escapeHtml(n);
            return `<span class="chip" data-name="${nn}">${nn}<button type="button" class="chip-x" title="Rimuovi">×</button></span>`;
          }).join(' ')
        : `<span class="muted">Nessun incaricato.</span>`;

      const closeToggle = csvClosed
        ? `<label class="chk"><input type="checkbox" id="forceopen-${id}" ${st.force_open ? 'checked' : ''}> Segna come <b>riaperta</b> (override)</label>
           <div class="muted" style="margin-top:4px">Nel CSV risulta “chiusa temporaneamente”.</div>`
        : `<label class="chk"><input type="checkbox" id="chiusa-${id}" ${st.chiusa_temp ? 'checked' : ''}> Segna <b>chiusa temporaneamente</b></label>`;

      return `
        <div class="popup" data-id="${id}">
          <div class="popup-head">
            <div class="popup-title">${nome}</div>
            ${isClosed ? `<span class="badge badge-closed">CHIUSA TEMP.</span>` : ``}
          </div>
          <div class="popup-sub">
            ${gestione ? `<span class="badge badge-gest">${gestione}</span>` : ``}
            ${cap || comune || indir ? `<span class="muted">${indir}${cap ? ' — ' + cap : ''}${comune ? ' — ' + comune : ''}</span>` : ``}
          </div>

          <div class="popup-grid">
            <div class="field">
              <label>Stato</label>
              <div class="row">
                <span class="state-dot ${WORK_STATES[stato]?.family || 'muted'}"></span>
                <select id="stato-${id}">${options}</select>
              </div>
            </div>

            <div class="field">
              <label>Incaricati</label>
              <div id="chips-${id}" class="chips">${chipsHtml}</div>
              <div class="row" style="margin-top:6px">
                <input id="inc-${id}" type="text" placeholder="Aggiungi nomi (virgola)" />
                <button id="addInc-${id}" class="btn btn-mini" type="button">+</button>
              </div>
            </div>

            <div class="field">
              <label>Note</label>
              <textarea id="note-${id}" rows="3" placeholder="Poster, BDS, boicotta, ecc…">${escapeHtml(note)}</textarea>
            </div>

            <div class="field">
              <label>Temporanea chiusura</label>
              ${closeToggle}
            </div>
          </div>

          <div class="popup-actions">
            <button id="save-${id}" class="btn btn-primary" type="button">Salva</button>
            ${mapsUrl ? `<a class="btn btn-link" href="${escapeHtml(mapsUrl)}" target="_blank" rel="noopener">Apri in Google Maps</a>` : ``}
            <a class="btn btn-link" href="${DRIVE_MATERIALI}" target="_blank" rel="noopener">Materiali campagna</a>
          </div>
        </div>
      `;
    }



    
function attachPopupHandlers(marker, row, id){
      const popupEl = marker.getPopup() && marker.getPopup().getElement();
      if(!popupEl) return;

      const root = popupEl.querySelector(`.popup[data-id="${id}"]`) || popupEl;

      const selStato = root.querySelector(`#stato-${id}`);
      const chipsBox = root.querySelector(`#chips-${id}`);
      const incInput = root.querySelector(`#inc-${id}`);
      const addBtn   = root.querySelector(`#addInc-${id}`);
      const noteEl   = root.querySelector(`#note-${id}`);
      const saveBtn  = root.querySelector(`#save-${id}`);

      if(!selStato || !chipsBox || !incInput || !addBtn || !noteEl || !saveBtn) return;

      // helper: read chips
      const readChips = () =>
        Array.from(chipsBox.querySelectorAll('.chip')).map(ch => (ch.getAttribute('data-name') || '').trim()).filter(Boolean);

      // helper: render chips
      const renderChips = (list) => {
        if(!list.length){
          chipsBox.innerHTML = `<span class="muted">Nessun incaricato.</span>`;
          return;
        }
        chipsBox.innerHTML = list.map(n => {
          const nn = escapeHtml(n);
          return `<span class="chip" data-name="${nn}">${nn}<button type="button" class="chip-x" title="Rimuovi">×</button></span>`;
        }).join(' ');
      };

      // remove chip (event delegation)
      chipsBox.addEventListener('click', (ev) => {
        const btn = ev.target.closest('.chip-x');
        if(!btn) return;
        const chip = btn.closest('.chip');
        if(!chip) return;
        const name = (chip.getAttribute('data-name') || '').trim();
        const list = readChips().filter(n => n !== name);
        renderChips(list);
      });

      // add chip(s)
      const addNames = () => {
        const raw = (incInput.value || '').trim();
        if(!raw) return;
        const toAdd = raw.split(',').map(s => s.trim()).filter(Boolean);
        const curr = readChips();
        const merged = Array.from(new Set([...curr, ...toAdd]));
        renderChips(merged);
        incInput.value = '';
      };

      addBtn.addEventListener('click', addNames);
      incInput.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter'){
          ev.preventDefault();
          addNames();
        }
      });

      saveBtn.addEventListener('click', () => {
        const st = statusStore[id] || {};

        const newStato = (selStato.value || defaultWorkState());
        const newIncar = readChips();
        const newNote  = (noteEl.value || '').toString().trim();

        const csvClosed = String(row.stato_attivita || '').toLowerCase().includes('chiusa');
        const forceOpenEl = root.querySelector(`#forceopen-${id}`);
        const chiusaEl = root.querySelector(`#chiusa-${id}`);

        const next = {
          ...st,
          stato_lavoro: newStato,
          incaricati: newIncar,
          note: newNote
        };

        if(csvClosed){
          next.force_open = !!(forceOpenEl && forceOpenEl.checked);
          // non tocchiamo chiusa_temp in questo caso
        } else {
          next.chiusa_temp = !!(chiusaEl && chiusaEl.checked);
          next.force_open = false;
        }

        statusStore[id] = next;
        saveStatusStore(statusStore);

        // aggiorna marker (icona e opacità chiusa)
        const fam = workFamilyFor(id);
        const chiusa = isChiusaTemp(row, id);
        marker.setIcon(iconFarmacia(gestioneKey(row.gestione), fam, chiusa));

        // aggiorna HUD / contatori
        aggiornaHUD();

        // rinfresca popup (mantenendo aperto)
        marker.setPopupContent(buildPopupHtml(row, id));
        setTimeout(() => attachPopupHandlers(marker, row, id), 0);
      });
    }


    /* ===============================
       CARICA FARMACIE CSV
       - marker: SEMPRE da `coordinate` (formato: "latitudine, longitudine") → NO geocodifica
       - popup link: usa SEMPRE `maps_url` (link POI definitivo)
    ================================ */
    function parseFloatIT(x){
      if(x === null || x === undefined) return NaN;
      const s = String(x).trim().replace(',', '.');
      return parseFloat(s);
    }

// Header definitivo CSV: `coordinate` = "latitudine, longitudine"
function parseCoordinateCell(cell){
  const s = (cell || '').toString();
  // Estrae i primi due numeri (supporta separatori vari e virgola decimale)
  const nums = s.match(/-?\d+(?:[\.,]\d+)?/g);
  if(!nums || nums.length < 2) return null;
  const a = parseFloat(nums[0].replace(',', '.'));
  const b = parseFloat(nums[1].replace(',', '.'));
  if(!isFinite(a) || !isFinite(b)) return null;
  // Qui assumiamo che il formato sia sempre lat,lon (come da tuo CSV definitivo).
  return { lat: a, lon: b };
}

function pickField(row, names){
  for (const n of names){
    if (row && row[n] !== undefined && row[n] !== null && String(row[n]).trim() !== '') return row[n];
  }
  const keys = row ? Object.keys(row) : [];
  for (const n of names){
    const low = String(n).toLowerCase();
    const k = keys.find(k => String(k).toLowerCase() === low);
    if (k && row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== '') return row[k];
  }
  return '';
}
function sameComune(a,b){
  return normKey(a) === normKey(b);
}



    async function caricaFarmacieCSV(){
      try{
        const loaded = await fetchTextFirstOk(FARMACIE_CSV_CANDIDATES);
        debugLine.textContent = 'Caricamento farmacie da: ' + loaded.path + ' …';

        Papa.parse(loaded.text, {
          header:true,
          skipEmptyLines:true,
          complete:(res)=>{
            const rows = res.data || [];
            farmLayer.clearLayers();
            farmMarkers.length = 0;

            let skipped = 0;
            rows.forEach(row => {
              const comuneRaw = (row.comune || '').toString().trim();
              if(!comuneRaw){ skipped++; return; }
              const comune = canonComune(comuneRaw);

              const coord = parseCoordinateCell(pickField(row, ['coordinate','coordinate']));
              if(!coord){ skipped++; return; }

              const nome = (row.descrizione_farmacia || row.nome || 'Farmacia').toString().trim();
              const indirizzo = (row.indirizzo_full || '').toString().trim();
              const id = (row.farmacia_id || stableId(nome + '|' + indirizzo + '|' + comune)).toString().trim();

              const statoLavoro = (statusStore[id]?.stato_lavoro) || defaultWorkState();
              const chiusa = isChiusaTemp(row, id);

              const marker = L.marker([coord.lat, coord.lon], { icon: iconFarmacia(row.gestione, workFamilyFor(id), chiusa) })
                .bindPopup(buildPopupHtml(row, id), { maxWidth: 360 });

              marker.addTo(farmLayer);
              farmMarkers.push({ marker, comune, id, row });

              marker.on('popupopen', () => {
          marker.setPopupContent(buildPopupHtml(row, id));
          setTimeout(() => attachPopupHandlers(marker, row, id), 0);
        });
            });

            aggiornaHUD();

            // se un comune è già selezionato, riapplica filtro opacità e conteggi
            if(selectedComune){
              farmMarkers.forEach(x => x.marker.setOpacity(sameComune(x.comune, selectedComune) ? 1 : 0.18));
              aggiornaHUD();
            }

            debugLine.innerHTML = `Farmacie caricate: <b>${farmMarkers.length}</b> — comuni nel GeoJSON: ${comuniSet.size}` +
              (skipped ? ` — saltate (coord invalide): ${skipped}` : '');
          },
          error:(err)=>{
            debugLine.textContent = 'Errore parsing farmacie.csv: ' + (err?.message || String(err));
          }
        });
      }catch(e){
        debugLine.textContent = 'Errore caricamento farmacie.csv: ' + (e?.message || String(e));
      }
    }

    /* ===============================
       CARICA COMUNI (GEOJSON) + AVVIO
    ================================ */
    fetch(DATA_COMUNI_GEOJSON)
      .then(r => r.json())
      .then(data => {
        comuniLayer = L.geoJSON(data, {
          style: f => {
            const nome = f.properties?.nome || f.properties?.DENOM_COM || f.properties?.name || 'Comune';
            const k = normKey(nome);
            comuneCanonByNorm[k] = nome;
            return styleComuneBase(nome);
          },
          onEachFeature: (f, layer) => {
            const nome = f.properties?.nome || f.properties?.DENOM_COM || f.properties?.name || 'Comune';
            comuniSet.add(nome);

            // salva canon list (per fuzzy)
            const k = normKey(nome);
            if(!canonNamesNorm.includes(k)) canonNamesNorm.push(k);

            // label
            const center = layer.getBounds().getCenter();
            L.marker(center, {
              icon: L.divIcon({ className:'label-comune', html: nome, iconSize:[150,16] }),
              interactive:false
            }).addTo(map);

            layer.on('click', () => selezionaComune(layer, nome));
          }
        }).addTo(map);

        try { map.fitBounds(comuniLayer.getBounds()); } catch(e){}

        // click vuoto = reset
        map.on('click', (e) => {
          // se clicco sullo sfondo (non su comune), reset
          // (Leaflet non distingue sempre: quindi reset solo se non ho appena selezionato)
        });

        // zoom out forte -> reset (utile su mobile)
        map.on('zoomend', () => {
          if(selectedComune && map.getZoom() < 9.5){
            resetSelezione();
          }
        });

        aggiornaStiliComuni();
        aggiornaHUD();

        // carica farmacie
        caricaFarmacieCSV();
      })
      .catch(err => {
        debugLine.style.display = 'block';
        debugLine.textContent = 'Errore caricamento GeoJSON comuni: ' + (err?.message || String(err));
      });
  </script>
</body>
</html>

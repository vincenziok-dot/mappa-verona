<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Verona – SpG (baseline stabile)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui,sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* BANNER ALTO COMUNE SELEZIONATO */
#banner{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.85); padding:8px 18px;
  border-bottom:3px solid #00ff9c; color:#fff; font-size:13px;
  display:none; z-index:9999; max-width:calc(100% - 24px);
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* HUD COLONNA SINISTRA */
#hud{
  position:fixed; top:18px; left:18px; z-index:9998;
  padding:14px 16px; background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c; min-width:340px; max-width:420px;
  box-shadow:0 0 20px rgba(0,0,0,.85);
}
.hud-title{ font-size:18px; font-weight:650; color:#fff; text-transform:uppercase; }
.hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

/* separatore GLOBALI */
.hud-chip{
  display:inline-block; margin-top:10px;
  font-size:10px; letter-spacing:.14em; text-transform:uppercase;
  color:#9ef5d9; background:#0e0e0e; padding:6px 8px;
  border:1px solid #1f1f1f;
}

/* contatori GLOBALI */
#stats{
  margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px;
}
.stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:26px; font-weight:750; }
.stat-ok .stat-value{ color:#00ff9c; }
.stat-warn .stat-value{ color:#ffaa00; }
.stat-info .stat-value{ color:#4da6ff; }
.stat-muted .stat-value{ color:#d0d0d0; }

/* info caricamento / warning */
#geoProgress{ margin-top:8px; font-size:11px; color:#bdbdbd; }

/* stats comune selezionato */
#farm-box{ margin-top:14px; padding-top:10px; border-top:1px solid #222; }
#farm-box h4{
  margin:0 0 6px; font-size:11px; text-transform:uppercase;
  letter-spacing:.12em; color:#9ef5d9;
}
#farm-count, #mmg-count{ font-size:12px; color:#e6e6e6; }

/* LEGENDA */
#legend-box{ margin-top:10px; padding-top:8px; border-top:1px solid #222; }
#legend-box h4{
  margin:8px 0 6px; font-size:11px; text-transform:uppercase;
  letter-spacing:.12em; color:#cccccc;
}
.legend-row{
  display:flex; align-items:center; gap:8px;
  font-size:11px; margin-bottom:4px; color:#e6e6e6;
}
.dot{ width:12px; height:12px; border-radius:50%; }
.triangle{
  width:0; height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-bottom:12px solid;
}
.square{ width:12px; height:12px; border-radius:2px; }

/* stati */
.aderisce{ background:#00ff9c; border-bottom-color:#00ff9c; color:#00ff9c; }
.trattativa{ background:#4da6ff; border-bottom-color:#4da6ff; color:#4da6ff; }
.contattare{ background:#ffaa00; border-bottom-color:#ffaa00; color:#ffaa00; }
.rifiuta{ background:#ff4d4d; border-bottom-color:#ff4d4d; color:#ff4d4d; }

/* legenda comuni */
.leg-coperto{ background:#00ff9c; }
.leg-orfano{ background:#ffaa00; }

/* simbolo medici (solo legenda) */
.med-simbolo{
  width:12px; height:12px; border-radius:2px; border:2px solid #fff; box-sizing:border-box;
}

/* buttons referenti */
.hud-buttons{ margin-top:12px; display:flex; gap:6px; flex-wrap:wrap; }
.hud-btn{
  border:1px solid #00ff9c; background:#041812; color:#eafff7;
  font-size:11px; padding:6px 10px; cursor:pointer;
}
.hud-btn:hover{ background:#00ff9c; color:#00110b; }

/* referenti panel */
.hud-section{ margin-top:10px; border-top:1px solid #222; padding-top:6px; display:none; }
.hud-section li{ font-size:12px; color:#fff; }
.hud-empty{ font-size:12px; color:#bdbdbd; padding:6px 0 2px; }

/* label comuni */
.label-comune{
  color:#fff; font-size:11px; text-shadow:0 0 6px rgba(0,0,0,.9); pointer-events:none;
}

/* marker farmacie */
.mrk{ width:14px; height:14px; display:flex; align-items:center; justify-content:center; }
.mrk.dot{ border-radius:50%; }
.mrk.associato{ box-shadow:0 0 0 2px rgba(255,255,255,.25), 0 0 10px rgba(0,255,156,.15); }
.mrk.nuovo2025{ box-shadow:0 0 12px rgba(77,166,255,.45); }

/* PIN bastoncino per studi MMG */
.pin{ width:18px; height:26px; position:relative; }
.pin-head{
  width:16px; height:16px; border-radius:3px; border:2px solid rgba(255,255,255,.92);
  box-sizing:border-box; display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:900; line-height:12px; color:rgba(255,255,255,.96);
}
.pin-stem{
  position:absolute; left:50%; top:16px; width:2px; height:10px; transform:translateX(-50%);
  background:rgba(255,255,255,.65); border-radius:2px;
}
.pin-shadow{
  position:absolute; left:50%; bottom:0; width:10px; height:4px; transform:translateX(-50%);
  background:rgba(0,0,0,.45); border-radius:50%;
}

.leaflet-interactive{ cursor:pointer; }
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div class="hud-chip">GLOBALI</div>

  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
    <div class="stat stat-muted">
      <div class="stat-title">Farmacie</div>
      <div class="stat-value" id="cntFarm">0</div>
    </div>
    <div class="stat stat-info">
      <div class="stat-title">Studi MMG</div>
      <div class="stat-value" id="cntStudi">0</div>
    </div>
  </div>

  <div id="geoProgress"></div>

  <div id="farm-box">
    <h4>Comune selezionato</h4>
    <div id="farm-count">Farmacie: —</div>
    <div id="mmg-count">Studi MMG: —</div>
  </div>

  <div id="legend-box">
    <h4>Legenda comuni</h4>
    <div class="legend-row"><span class="square leg-coperto"></span> Comune con referenti (bordo pieno)</div>
    <div class="legend-row"><span class="square leg-orfano"></span> Comune orfano (bordo tratteggiato)</div>

    <h4>Legenda farmacie</h4>
    <div class="legend-row"><span class="dot aderisce"></span> Privata – aderisce</div>
    <div class="legend-row"><span class="dot trattativa"></span> Privata – in trattativa</div>
    <div class="legend-row"><span class="dot contattare"></span> Privata – da contattare</div>
    <div class="legend-row"><span class="dot rifiuta"></span> Privata – rifiuta</div>
    <div class="legend-row"><span class="triangle aderisce"></span> Comunale – aderisce</div>
    <div class="legend-row"><span class="triangle trattativa"></span> Comunale – in trattativa</div>
    <div class="legend-row"><span class="triangle contattare"></span> Comunale – da contattare</div>
    <div class="legend-row"><span class="triangle rifiuta"></span> Comunale – rifiuta</div>

    <h4>Legenda studi MMG</h4>
    <div class="legend-row"><span class="med-simbolo aderisce"></span> Studio – aderisce</div>
    <div class="legend-row"><span class="med-simbolo trattativa"></span> Studio – in trattativa</div>
    <div class="legend-row"><span class="med-simbolo contattare"></span> Studio – da contattare</div>
    <div class="legend-row"><span class="med-simbolo rifiuta"></span> Studio – rifiuta</div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAdd">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggle">Vedi referenti</button>
  </div>

  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
    <div id="refEmpty" class="hud-empty" style="display:none">Nessun referente inserito.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm";

/* status VOLATILE (RAM) – per ora NON scrive file */
const statusRAM = {};

/* REFERENTI (RAM) */
const referenti = { "Verona": ["Vincenzo R."] };

const map = L.map('map',{ attributionControl:false }).setView([45.43,10.99],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

const banner      = document.getElementById('banner');
const hudTitle    = document.getElementById('hudTitle');
const hudSub      = document.getElementById('hudSub');
const refPanel    = document.getElementById('refPanel');
const refList     = document.getElementById('refList');
const refEmpty    = document.getElementById('refEmpty');
const btnToggle   = document.getElementById('btnToggle');
const farmCountEl = document.getElementById('farm-count');
const mmgCountEl  = document.getElementById('mmg-count');
const geoProgress = document.getElementById('geoProgress');

const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
const hasRef = n => referenti[n] && referenti[n].length > 0;

let labels = [];
let comuniSet = new Set();
let layersByNome = {};
let comuneCanonByNorm = {};
let selectedLayer = null;
let selectedNome = null;
let refVisibili = false;
let selectedZoomRef = null;

const farmLayer = L.layerGroup().addTo(map);
const studiLayer = L.layerGroup().addTo(map);

const farmMarkers = [];   // {marker, comune}
const studiMarkers = [];  // {marker, comune}

/* normalizza nomi comune per matching robusto */
function normKey(s){
  return (s||'').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ');
}
function canonComune(raw){
  const k = normKey(raw);
  return comuneCanonByNorm[k] || (raw||'').trim();
}

/* contatori GLOBALI */
function aggiornaContatoriGlobali(){
  const comuni = Array.from(comuniSet);
  const coperti = comuni.filter(n => hasRef(n)).length;
  const orfani = comuni.length - coperti;
  document.getElementById('cntOk').innerText = coperti;
  document.getElementById('cntOrfani').innerText = orfani;
  document.getElementById('cntFarm').innerText = farmMarkers.length;
  document.getElementById('cntStudi').innerText = studiMarkers.length;
}

/* stili comuni */
function styleComuneBase(nome){
  const ref = hasRef(nome);
  return {
    color: ref ? '#00ff9c' : '#ffaa00',
    weight: ref ? 2 : 1,
    dashArray: ref ? null : '5 5',
    fillColor: '#00ff9c',
    fillOpacity: ref ? 0.10 : 0
  };
}
function aggiornaStiliComuni(){
  Object.keys(layersByNome).forEach(n => {
    const layer = layersByNome[n];
    let st = styleComuneBase(n);
    if (selectedLayer && layer === selectedLayer){
      st = { ...st, color:'#ffffff', weight:3, dashArray:null, fillOpacity:0 };
    }
    layer.setStyle(st);
  });
}

/* labels comuni */
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    const show = (!selectedNome && z >= 9 && z <= 13);
    if(show){ if(!map.hasLayer(l)) map.addLayer(l); }
    else { if(map.hasLayer(l)) map.removeLayer(l); }
  });
}

/* reset selezione */
function resetSelezione(){
  selectedLayer = null; selectedNome = null; selectedZoomRef = null;

  hudTitle.innerText = 'Provincia di Verona';
  hudSub.innerText   = 'Vista generale';
  banner.style.display = 'none';

  farmCountEl.innerText = 'Farmacie: —';
  mmgCountEl.innerText  = 'Studi MMG: —';

  farmMarkers.forEach(x => x.marker.setOpacity(1));
  studiMarkers.forEach(x => x.marker.setOpacity(1));

  refPanel.style.display = 'none';
  refVisibili = false;
  btnToggle.innerText = 'Vedi referenti';

  aggiornaStiliComuni();
  aggiornaLabels();
}

/* selezione comune */
function selezionaComune(layer, nome){
  selectedLayer = layer;
  selectedNome = nome;

  aggiornaStiliComuni();

  map.fitBounds(layer.getBounds(), { padding:[40,40] });
  map.once('moveend', () => { selectedZoomRef = map.getZoom(); });

  const nRef = (referenti[nome] ? referenti[nome].length : 0);
  hudTitle.innerText = 'Comune di ' + nome;
  hudSub.innerText = hasRef(nome) ? ('Referenti presenti: ' + nRef) : '⚠ Comune orfano';

  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + nome + '</b> – Referenti: ' + nRef;

  aggiornaLabels();

  farmMarkers.forEach(x => x.marker.setOpacity(x.comune === nome ? 1 : 0.18));
  studiMarkers.forEach(x => x.marker.setOpacity(x.comune === nome ? 1 : 0.18));

  farmCountEl.innerText = 'Farmacie: ' + farmMarkers.filter(x => x.comune === nome).length;
  mmgCountEl.innerText  = 'Studi MMG: ' + studiMarkers.filter(x => x.comune === nome).length;

  if(refVisibili) mostraReferenti(nome);
}

/* referenti */
function mostraReferenti(nome){
  refList.innerHTML = '';
  const lista = referenti[nome] || [];
  if(!lista.length){
    refEmpty.style.display = 'block';
    refPanel.style.display = 'block';
    return;
  }
  refEmpty.style.display = 'none';
  lista.forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = 'block';
}

document.getElementById('btnAdd').onclick = () => {
  if(!selectedNome){ alert('Seleziona prima un comune sulla mappa'); return; }
  const n = prompt('Inserisci il tuo nome (comparirà come referente)');
  if(!n) return;

  if(!referenti[selectedNome]) referenti[selectedNome] = [];
  referenti[selectedNome].push(n);

  const nRef = referenti[selectedNome].length;
  hudSub.innerText = 'Referenti presenti: ' + nRef;
  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + selectedNome + '</b> – Referenti: ' + nRef;

  aggiornaStiliComuni();
  aggiornaContatoriGlobali();

  if(refVisibili) mostraReferenti(selectedNome);
};

document.getElementById('btnToggle').onclick = () => {
  if(!selectedNome){ alert('Seleziona prima un comune sulla mappa'); return; }
  refVisibili = !refVisibili;
  btnToggle.innerText = refVisibili ? 'Nascondi referenti' : 'Vedi referenti';
  if(refVisibili) mostraReferenti(selectedNome);
  else refPanel.style.display = 'none';
};

/* sanity check coordinate (swap + fuori range) */
function fixLatLng(lat, lon){
  let a = parseFloat(lat), b = parseFloat(lon);
  if(!isFinite(a) || !isFinite(b)) return { ok:false };

  const LAT_OK = x => x >= 44.7 && x <= 46.2;
  const LON_OK = x => x >= 9.8 && x <= 11.9;

  /* swap tipico */
  if(!LAT_OK(a) && !LON_OK(b) && LAT_OK(b) && LON_OK(a)){
    const tmp=a; a=b; b=tmp;
    return { ok:true, lat:a, lon:b, swapped:true };
  }
  if(!LAT_OK(a) || !LON_OK(b)) return { ok:true, lat:a, lon:b, outOfRange:true };
  return { ok:true, lat:a, lon:b };
}

function stableId(str){
  let h=0;
  for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; }
  return String(h);
}

/* marker icons */
function iconFarmacia(tipo, stato){
  const cls = (stato || 'contattare');
  if(tipo === 'comunale'){
    return L.divIcon({ className:'', html:`<div class="triangle ${cls}"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
  }
  return L.divIcon({ className:'', html:`<div class="mrk dot ${cls}"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
}
function iconStudio(stato, isAssociato, isNuovo2025){
  const cls = (stato || 'contattare');
  const extra = [isAssociato?'associato':'', isNuovo2025?'nuovo2025':''].join(' ');
  return L.divIcon({
    className:'',
    html:`<div class="pin ${extra}">
            <div class="pin-head ${cls}">✚</div>
            <div class="pin-stem"></div>
            <div class="pin-shadow"></div>
          </div>`,
    iconSize:[18,26],
    iconAnchor:[9,26]
  });
}

/* CSV helpers: farmacie */
function guessFarmNome(row){ return (row.denominazione || row.nome || row.descrizione_farmacia || row.farmacia || 'Farmacia').toString().trim(); }
function guessFarmTipo(row, nome){
  const raw = (row.tipo || row.tipologia || row.natura || row.categoria || row.tipologia_farmacia || '').toString().toLowerCase();
  const n = (nome || '').toString().toLowerCase();
  if(raw.includes('comunal') || n.includes('comunal')) return 'comunale';
  return 'privata';
}
function guessComune(row){ return (row.comune || row.COMUNE || row.Comune || '').toString().trim(); }
function guessIndirizzo(row){ return (row.indirizzo || row.INDIRIZZO || row.via || row.indirizzo_completo || '').toString().trim(); }
function guessTel(row){ return (row.telefono || row.tel || row.TELEFONO || '').toString().trim(); }
function guessMapsUrl(row){
  return (row.maps_url || row.maps || row.google_maps || row.url_maps || '').toString().trim();
}
function renderMultiline(text){ return (text || '').toString().trim().replace(/\n/g,'<br/>'); }

/* LOAD comuni then CSV */
fetch('data/comuni_verona.json')
  .then(r => r.json())
  .then(data => {
    const geo = L.geoJSON(data, {
      style: f => { const n = nomeComune(f.properties); comuniSet.add(n); return styleComuneBase(n); },
      onEachFeature: (f, layer) => {
        const nome = nomeComune(f.properties);
        layersByNome[nome] = layer;
        comuneCanonByNorm[normKey(nome)] = nome;

        const center = layer.getBounds().getCenter();
        const label = L.marker(center, {
          icon:L.divIcon({ className:'label-comune', html:nome, iconSize:[140,16] }),
          interactive:false
        }).addTo(map);
        labels.push(label);

        layer.on('click', () => selezionaComune(layer, nome));
      }
    }).addTo(map);

    map.fitBounds(geo.getBounds());
    aggiornaStiliComuni();
    aggiornaLabels();
    aggiornaContatoriGlobali();

    map.on('zoomend', () => {
      const z = map.getZoom();
      if(selectedNome && selectedZoomRef !== null && z <= (selectedZoomRef - 0.6)) { resetSelezione(); return; }
      if(selectedNome && z < 9.5) { resetSelezione(); return; }
      aggiornaLabels();
    });

    caricaFarmacieCSV();
    caricaStudiMMGCSV();
  });

function caricaFarmacieCSV(){
  Papa.parse('data/farmacie.csv', {
    download:true, header:true, skipEmptyLines:true,
    complete: (res) => {
      const rows = res.data || [];
      let added=0, skipped=0, swapped=0, outRange=0, noComuneMatch=0;

      rows.forEach(row => {
        const comuneRaw = guessComune(row);
        if(!comuneRaw){ skipped++; return; }
        const comune = canonComune(comuneRaw);
        if(!comuneCanonByNorm[normKey(comuneRaw)]) noComuneMatch++;

        const nome = guessFarmNome(row);
        const indirizzo = guessIndirizzo(row);
        const tel = guessTel(row);

        const lat = row.lat ?? row.latitudine ?? row.latitude ?? row.Lat ?? row.LAT;
        const lon = row.lon ?? row.long ?? row.lng ?? row.longitudine ?? row.longitude ?? row.Lon ?? row.LON;
        const fixed = fixLatLng(lat, lon);
        if(!fixed.ok){ skipped++; return; }
        if(fixed.swapped) swapped++;
        if(fixed.outOfRange) outRange++;

        const tipo = guessFarmTipo(row, nome);
        const id = stableId(`pharm|${nome}|${indirizzo}|${comune}|${fixed.lat}|${fixed.lon}`);
        const key = `pharm::${id}`;
        const st = (statusRAM[key]?.stato) || 'contattare';

        const mapsUrl = guessMapsUrl(row) || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nome + ' ' + comune)}`;

        const popupHtml = `
          <strong>${nome}</strong><br/>
          <div style="opacity:.9">${tipo} – ${indirizzo}${tel ? ' – Tel: '+tel : ''}<br/>${comune}</div>
          <div style="margin-top:6px">
            <a href="${mapsUrl}" target="_blank">Apri in Google Maps</a><br/>
            <a href="${DRIVE_MATERIALI}" target="_blank">Materiali campagna</a>
          </div>
          ${fixed.outOfRange ? `<div style="margin-top:8px;color:#ffaa00;font-size:11px">⚠ Coordinate fuori range: verifica (lat=${fixed.lat}, lon=${fixed.lon})</div>` : ''}
          ${fixed.swapped ? `<div style="margin-top:8px;color:#4da6ff;font-size:11px">ℹ Coordinate invertite: corrette automaticamente</div>` : ''}
        `;

        const marker = L.marker([fixed.lat, fixed.lon], { icon: iconFarmacia(tipo, st) }).bindPopup(popupHtml);
        marker.addTo(farmLayer);
        farmMarkers.push({ marker, comune });
        added++;
      });

      aggiornaContatoriGlobali();

      if(selectedNome){
        farmMarkers.forEach(x => x.marker.setOpacity(x.comune === selectedNome ? 1 : 0.18));
        farmCountEl.innerText = 'Farmacie: ' + farmMarkers.filter(x => x.comune === selectedNome).length;
      }

      geoProgress.innerHTML =
        `Farmacie caricate: <b>${added}</b> (saltate: ${skipped})` +
        (swapped ? ` — invertite corrette: ${swapped}` : '') +
        (outRange ? ` — fuori range: ${outRange}` : '') +
        (noComuneMatch ? `<br/><span style="color:#ffaa00">⚠ Comune non riconosciuto (nome diverso dal GeoJSON): ${noComuneMatch}</span>` : '');
    }
  });
}

function caricaStudiMMGCSV(){
  Papa.parse('data/mmg2025.csv', {
    download:true, header:true, skipEmptyLines:true,
    complete: (res) => {
      const rows = res.data || [];
      let added=0, skipped=0, swapped=0, outRange=0, noComuneMatch=0;

      rows.forEach(row => {
        const comuneRaw = (row.comune || '').toString().trim();
        if(!comuneRaw){ skipped++; return; }
        const comune = canonComune(comuneRaw);
        if(!comuneCanonByNorm[normKey(comuneRaw)]) noComuneMatch++;

        const indirizzo = (row.indirizzo || '').toString().trim();
        const studioId = (row.studio_id || '').toString().trim();
        const tipoStudio = (row.tipo_studio || '').toString().trim();
        const numeroMedici = parseInt((row.numero_medici || '0').toString(), 10) || 0;
        const isAssociato = (numeroMedici > 1) || (tipoStudio.toLowerCase().includes('associ'));
        const matchType = (row.match_type || '').toString().trim();
        const isNuovo2025 = (matchType === 'right_only');

        const nomiMedici = (row.nomi_medici || '').toString().trim();
        const telefoni = (row.telefoni || '').toString().trim();
        const orariPerMedico = (row.orari_per_medico || '').toString();

        const lat = row.lat ?? row.latitudine ?? row.latitude ?? row.Lat ?? row.LAT;
        const lon = row.lon ?? row.long ?? row.lng ?? row.longitudine ?? row.longitude ?? row.Lon ?? row.LON;
        const fixed = fixLatLng(lat, lon);
        if(!fixed.ok){ skipped++; return; }
        if(fixed.swapped) swapped++;
        if(fixed.outOfRange) outRange++;

        const id = studioId || stableId(`studio|${indirizzo}|${comune}|${nomiMedici}|${fixed.lat}|${fixed.lon}`);
        const key = `studio::${id}`;
        const st = (statusRAM[key]?.stato) || 'contattare';

        const mapsUrl = (row.maps_url || '').toString().trim() ||
          `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((indirizzo||'') + ' ' + comune)}`;

        const popupHtml = `
          <strong>Studio MMG</strong><br/>
          <div style="opacity:.9">${indirizzo ? indirizzo + ' – ' : ''}${comune}</div>
          <div style="margin-top:6px; font-size:12px; opacity:.95">
            ${tipoStudio ? `<b>Tipo:</b> ${tipoStudio}<br/>` : ''}
            <b>MMG:</b> ${numeroMedici || (nomiMedici ? nomiMedici.split('|').filter(Boolean).length : '—')}<br/>
            ${nomiMedici ? `<b>Medici:</b> ${nomiMedici.split('|').map(s=>s.trim()).filter(Boolean).join(', ')}<br/>` : ''}
            ${telefoni ? `<b>Tel:</b> ${telefoni.split('|').map(s=>s.trim()).filter(Boolean).join(' • ')}<br/>` : ''}
            ${orariPerMedico ? `<div style="margin-top:6px"><b>Orari per medico:</b><br/>${renderMultiline(orariPerMedico)}</div>` : ''}
            ${isAssociato ? `<div style="margin-top:6px;color:#9ef5d9"><b>Studio associato</b></div>` : ''}
            ${isNuovo2025 ? `<div style="margin-top:6px;color:#4da6ff"><b>Nuovo 2025</b></div>` : ''}
          </div>
          <div style="margin-top:8px">
            <a href="${mapsUrl}" target="_blank">Apri in Google Maps</a><br/>
            <a href="${DRIVE_MATERIALI}" target="_blank">Materiali campagna</a>
          </div>
          ${fixed.outOfRange ? `<div style="margin-top:8px;color:#ffaa00;font-size:11px">⚠ Coordinate fuori range: verifica (lat=${fixed.lat}, lon=${fixed.lon})</div>` : ''}
          ${fixed.swapped ? `<div style="margin-top:8px;color:#4da6ff;font-size:11px">ℹ Coordinate invertite: corrette automaticamente</div>` : ''}
        `;

        const marker = L.marker([fixed.lat, fixed.lon], { icon: iconStudio(st, isAssociato, isNuovo2025) }).bindPopup(popupHtml);
        marker.addTo(studiLayer);
        studiMarkers.push({ marker, comune });
        added++;
      });

      aggiornaContatoriGlobali();

      if(selectedNome){
        studiMarkers.forEach(x => x.marker.setOpacity(x.comune === selectedNome ? 1 : 0.18));
        mmgCountEl.innerText = 'Studi MMG: ' + studiMarkers.filter(x => x.comune === selectedNome).length;
      }

      geoProgress.innerHTML +=
        `<br/>Studi MMG caricati: <b>${added}</b> (saltati: ${skipped})` +
        (swapped ? ` — invertiti corretti: ${swapped}` : '') +
        (outRange ? ` — fuori range: ${outRange}` : '') +
        (noComuneMatch ? `<br/><span style="color:#ffaa00">⚠ Comune non riconosciuto (nome diverso dal GeoJSON): ${noComuneMatch}</span>` : '');
    }
  });
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona – SpG</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{margin:0;height:100%;background:#000;font-family:system-ui}
#map{position:absolute;inset:0}

/* HUD */
#hud{
 position:fixed;top:16px;left:16px;z-index:9999;
 width:380px;padding:14px;
 background:rgba(5,5,5,.94);
 border-left:4px solid #00ff9c;
 box-shadow:0 0 25px rgba(0,0,0,.85)
}
.hud-title{color:#fff;font-size:18px;font-weight:650;text-transform:uppercase}
.hud-sub{color:#bbb;font-size:13px}

/* contatori globali */
#stats{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
.stat{background:#0e0e0e;padding:8px}
.stat-title{font-size:10px;letter-spacing:.12em;text-transform:uppercase}
.stat-value{font-size:26px;font-weight:700}
.ok{color:#00ff9c}.warn{color:#ffaa00}

/* bottoni */
.buttons{margin-top:10px;display:flex;gap:6px}
button{background:#041812;border:1px solid #00ff9c;color:#eafff7;font-size:11px;
padding:4px 8px;cursor:pointer}
button:hover{background:#00ff9c;color:#00110b}

/* legenda */
.section{margin-top:12px;border-top:1px solid #222;padding-top:8px}
.legend h4{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:#9ef5d9;margin:6px 0}
.legend-row{display:flex;align-items:center;gap:8px;font-size:11px;color:#e6e6e6}

/* simboli */
.dot{width:12px;height:12px;border-radius:50%}
.triangle{width:0;height:0;border-left:7px solid transparent;
border-right:7px solid transparent;border-bottom:12px solid}
.square{width:12px;height:12px}

/* stati */
.partecipa{background:#00ff9c;border-bottom-color:#00ff9c}
.trattativa{background:#4da6ff;border-bottom-color:#4da6ff}
.contattare{background:#ffaa00;border-bottom-color:#ffaa00}
.rifiuta{background:#ff4d4d;border-bottom-color:#ff4d4d}

/* label comuni */
.label{color:#fff;font-size:11px;text-shadow:0 0 6px #000;pointer-events:none}
.leaflet-interactive{cursor:pointer}
</style>
</head>

<body>
<div id="map"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div id="stats">
    <div class="stat"><div class="stat-title">Comuni coperti</div><div id="cntOk" class="stat-value ok">0</div></div>
    <div class="stat"><div class="stat-title">Comuni orfani</div><div id="cntNo" class="stat-value warn">0</div></div>
  </div>

  <div class="buttons">
    <button id="btnAdd">Aggiungi referente</button>
    <button id="btnToggle">Vedi referenti</button>
  </div>

  <div id="refPanel" style="display:none"><ul id="refList"></ul></div>

  <div class="section legend">
    <h4>Legenda Comuni</h4>
    <div class="legend-row"><span class="square partecipa"></span> Comune coperto</div>
    <div class="legend-row"><span class="square contattare"></span> Comune orfano</div>

    <h4>Farmacie</h4>
    <div class="legend-row"><span class="dot partecipa"></span> Privata – favorevole</div>
    <div class="legend-row"><span class="triangle trattativa"></span> Comunale – trattativa</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ========== UTIL ========== */
const keyComune = n => n.trim().toLowerCase();

/* ========== MAP ========== */
const map=L.map('map',{attributionControl:false}).setView([45.43,10.99],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map);

/* ========== STATO ========== */
const referenti = { "verona":["Vincenzo R."] };
const farmacie = [
 {nome:"Farmacia Centrale",comune:"verona",lat:45.438,lng:10.992,tipo:"privata",stato:"partecipa",
 maps:"https://www.google.com/maps/search/?api=1&query=Farmacia+Centrale+Verona"},
 {nome:"Farmacia San Zeno",comune:"verona",lat:45.443,lng:10.98,tipo:"comunale",stato:"trattativa",
 maps:"https://www.google.com/maps/search/?api=1&query=Farmacia+San+Zeno+Verona"}
];

let layers={},labels=[],selectedKey=null;
const farmLayer=L.layerGroup().addTo(map);

/* ========== HUD refs ========== */
const hudTitle=hudTitle=document.getElementById('hudTitle');
const hudSub=document.getElementById('hudSub');
const cntOk=document.getElementById('cntOk');
const cntNo=document.getElementById('cntNo');
const refPanel=document.getElementById('refPanel');
const refList=document.getElementById('refList');

/* ========== CONTATORI ========== */
function updateGlobal(){
 const keys=Object.keys(layers);
 const ok=keys.filter(k=>referenti[k]?.length>0).length;
 cntOk.textContent=ok;
 cntNo.textContent=keys.length-ok;
}

/* ========== COMUNI ========== */
fetch('data/comuni_verona.json').then(r=>r.json()).then(data=>{
 L.geoJSON(data,{
  style:f=>{
   const k=keyComune(f.properties.nome||f.properties.DENOM_COM);
   return{
    color:referenti[k]?'#00ff9c':'#ffaa00',
    fillColor:'#00ff9c',
    fillOpacity:referenti[k]?0.15:0,
    weight:1
   }
  },
  onEachFeature:(f,l)=>{
   const name=f.properties.nome||f.properties.DENOM_COM;
   const k=keyComune(name);
   layers[k]=l;

   const lab=L.marker(l.getBounds().getCenter(),{
    icon:L.divIcon({className:'label',html:name})
   }).addTo(map);
   labels.push(lab);

   l.on('click',()=>{
    selectedKey=k;
    Object.values(layers).forEach(x=>x.setStyle({weight:1,color:referenti[k]?'#00ff9c':'#ffaa00'}));
    l.setStyle({color:'#fff',weight:3});
    map.fitBounds(l.getBounds(),{padding:[40,40]});
    labels.forEach(x=>map.removeLayer(x));
    hudTitle.textContent='Comune di '+name;
    hudSub.textContent='Referenti: '+(referenti[k]?.length||0);
    mostraFarmacie(k);
   });
  }
 }).addTo(map);

 updateGlobal();
});

/* ========== ZOOM labels ========== */
map.on('zoomend',()=>{
 if(map.getZoom()<12){
  selectedKey=null;
  hudTitle.textContent='Provincia di Verona';
  hudSub.textContent='Vista generale';
  labels.forEach(l=>map.addLayer(l));
  farmLayer.clearLayers();
 }
});

/* ========== FARMACIE ========== */
function mostraFarmacie(k){
 farmLayer.clearLayers();
 farmacie.filter(f=>f.comune===k).forEach(f=>{
  const icon=f.tipo==="privata"
   ?`<div class="dot ${f.stato}"></div>`
   :`<div class="triangle ${f.stato}"></div>`;
  L.marker([f.lat,f.lng],{icon:L.divIcon({html:icon,iconSize:[14,14]})})
   .bindPopup(`<b>${f.nome}</b><br><a href="${f.maps}" target="_blank">Apri Maps</a>`)
   .addTo(farmLayer);
 });
}

/* ========== REFERENTI ========== */
btnAdd.onclick=()=>{
 if(!selectedKey)return alert('Seleziona un comune');
 const nome=prompt('Nome referente');
 if(!nome)return;
 referenti[selectedKey]=referenti[selectedKey]||[];
 referenti[selectedKey].push(nome);
 layers[selectedKey].setStyle({color:'#00ff9c',fillOpacity:0.15});
 hudSub.textContent='Referenti: '+referenti[selectedKey].length;
 updateGlobal();
}

btnToggle.onclick=()=>{
 if(!selectedKey)return;
 refPanel.style.display=refPanel.style.display==='block'?'none':'block';
 refList.innerHTML='';
 (referenti[selectedKey]||[]).forEach(n=>{
  const li=document.createElement('li');li.textContent=n;refList.appendChild(li);
 });
}
</script>
</body>
</html>

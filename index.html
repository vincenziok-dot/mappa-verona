
.ref-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:4px 0; }
.ref-x{
  border:1px solid #2a2a2a;
  background:#0e0e0e;
  color:#d0d0d0;
  width:20px; height:20px;
  border-radius:10px;
  cursor:pointer;
  line-height:18px;
}
.ref-x:hover{ background:#ff4d4d; color:#000; border-color:#ff4d4d; }
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mappa Verona – SpG (Farmacie + Stato)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { margin:0; height:100%; background:#000; font-family:system-ui, sans-serif; }
    #map { position:absolute; inset:0; background:#050505; }

    /* Banner comune selezionato */
    #banner{
      position:fixed; top:0; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      padding:8px 18px;
      border-bottom:3px solid #00ff9c;
      color:#fff; font-size:13px;
      display:none; z-index:9999;
      max-width: calc(100% - 24px);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* HUD */
    #hud{
      position:fixed; top:18px; left:18px; z-index:9998;
      padding:14px 16px;
      background:rgba(5,5,5,.94);
      border-left:4px solid #00ff9c;
      width:360px; max-width: min(440px, calc(100vw - 36px));
      box-shadow:0 0 20px rgba(0,0,0,.85);
      max-height: calc(100vh - 36px);
      overflow:auto;
      border-radius:8px;
    }

    .hud-title{ font-size:18px; font-weight:650; color:#fff; text-transform:uppercase; }
    .hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

    /* chips/sezioni */
    .chip{
      display:flex; align-items:center; justify-content:space-between;
      margin-top:12px;
      font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      color:#9ef5d9;
      background:#0e0e0e;
      padding:8px 10px;
      border:1px solid #1f1f1f;
      border-radius:8px;
    }
    .chip small{ letter-spacing:0; text-transform:none; color:#bdbdbd; font-size:11px; }

    /* stats */
    .grid2{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; border-radius:8px; }
    .stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
    .stat-value{ font-size:24px; font-weight:800; }
    .ok{ color:#00ff9c; }
    .warn{ color:#ffaa00; }
    .info{ color:#4da6ff; }
    .muted{ color:#d0d0d0; }

    /* lista stati più densa */
    .miniGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px 10px;
      font-size:12px;
      color:#e6e6e6;
    }
    .miniRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .miniRow .k{ display:flex; align-items:center; gap:8px; min-width:0; }
    .miniRow .k span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .miniRow .v{ font-variant-numeric: tabular-nums; font-weight:750; }

    /* legenda */
    #legend-box{
      margin-top:12px; padding-top:10px;
      border-top:1px solid #222;
    }
    #legend-box h4{
      margin:10px 0 6px;
      font-size:11px; text-transform:uppercase; letter-spacing:.12em;
      color:#cccccc;
    }
    .legend-row{
      display:flex; align-items:center; gap:8px;
      font-size:11px; margin-bottom:6px;
      color:#e6e6e6;
    }

    /* simboli base */
    .dot{ width:12px; height:12px; border-radius:50%; }
    .triangle{
      width:0; height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-bottom:12px solid;
    }
    .square{ width:12px; height:12px; border-radius:2px; }

    /* colori “lavoro” (4 famiglie, poi testo spiega i dettagli) */
    .aderisce{ background:#00ff9c; border-bottom-color:#00ff9c; color:#00ff9c; }
    .trattativa{ background:#4da6ff; border-bottom-color:#4da6ff; color:#4da6ff; }
    .contattare{ background:#ffaa00; border-bottom-color:#ffaa00; color:#ffaa00; }
    .rifiuta{ background:#ff4d4d; border-bottom-color:#ff4d4d; color:#ff4d4d; }
    .chiusa { background:#8c8c8c; border-bottom-color:#8c8c8c; color:#8c8c8c; }

    /* marker farmacia (divIcon) */
    .mrk{ width:14px; height:14px; display:flex; align-items:center; justify-content:center; }
    .mrk.dot{ border-radius:50%; }

    /* label comuni */
    .label-comune{
      color:#ffffff; font-size:11px;
      text-shadow:0 0 6px rgba(0,0,0,.9);
      pointer-events:none;
    }

    /* pannello strumenti sticky */
    .tools{
      margin-top:12px;
      position:sticky;
      bottom:0;
      padding-top:12px;
      background:rgba(5,5,5,.96);
      border-top:1px solid #222;
    }
    .btnRow{ display:flex; gap:8px; flex-wrap:wrap; }
    button{
      border:1px solid #00ff9c;
      background:#041812;
      color:#eafff7;
      font-size:12px;
      padding:8px 10px;
      cursor:pointer;
      border-radius:8px;
    }
    button:hover{ background:#00ff9c; color:#00110b; }

    /* referenti list */
    #refPanel{ display:none; margin-top:8px; }
    #refPanel ul{ margin:0; padding-left:18px; }
    #refPanel li{ font-size:12px; color:#fff; }

    /* form popup */
    .pform label{ display:block; font-size:12px; margin-top:8px; }
    .pform select, .pform input, .pform textarea{
      width:100%; box-sizing:border-box;
      background:#0e0e0e; color:#fff;
      border:1px solid #333; border-radius:8px;
      padding:8px;
      font-size:13px;
    }
    .pform textarea{ min-height:70px; }
    .pform .hint{ font-size:11px; color:#bdbdbd; margin-top:6px; }
    .pform .row{ display:flex; gap:8px; margin-top:10px; }
    .pform .row button{ flex:1; }

    /* Leaflet tweaks */
    .leaflet-control-zoom a{ border-radius:8px !important; }
    .leaflet-top.leaflet-right{ margin-top:12px; margin-right:12px; }
    .leaflet-interactive{ cursor:pointer; }

    /* mobile */
    @media (max-width: 640px){
      #hud{
        left:10px; top:10px;
        width: calc(100vw - 20px);
        max-width: calc(100vw - 20px);
        max-height: calc(100vh - 20px);
      }
      .grid2{ grid-template-columns:1fr 1fr; }
      .stat-value{ font-size:22px; }
    }
  
/* popup farmacia */
.leaflet-popup-content-wrapper, .leaflet-popup-tip{
  background:#0b0b0b;
  color:#f1f1f1;
}
.leaflet-popup-content{ margin: 10px 12px; }
.pop{ min-width: 260px; max-width: 360px; font-size: 12px; }
.pop-head{ margin-bottom:8px; }
.pop-title{ font-size:14px; font-weight:800; color:#fff; }
.pop-sub{ margin-top:2px; color:#bdbdbd; font-size:11px; }
.pop-row{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.pop-col{ flex:1; min-width: 160px; }
.label{ font-size:10px; letter-spacing:.12em; text-transform:uppercase; color:#9ef5d9; margin-bottom:4px; }
.row-inline{ display:flex; gap:6px; align-items:center; }
.sel{ width:100%; background:#0e0e0e; border:1px solid #242424; color:#fff; padding:7px 8px; border-radius:6px; }
.inp{ flex:1; background:#0e0e0e; border:1px solid #242424; color:#fff; padding:7px 8px; border-radius:6px; }
.ta{ width:100%; min-height:74px; background:#0e0e0e; border:1px solid #242424; color:#fff; padding:7px 8px; border-radius:6px; resize:vertical; }
.checks{ display:flex; flex-direction:column; gap:4px; }
.chk{ display:flex; align-items:center; gap:6px; color:#e6e6e6; font-size:12px; }
.chips{ display:flex; flex-wrap:wrap; gap:6px; }
.chip{
  display:inline-flex; align-items:center; gap:6px;
  background:#0e0e0e; border:1px solid #242424;
  color:#eaeaea; padding:4px 8px; border-radius:999px;
}
.chip-x{
  border:none; background:transparent; color:#bdbdbd;
  width:18px; height:18px; border-radius:9px; cursor:pointer;
  line-height:16px; font-size:14px;
}
.chip-x:hover{ background:#ff4d4d; color:#000; }
.muted{ color:#888; }
.mini{
  border:1px solid #00ff9c; background:#041812; color:#eafff7;
  padding:7px 10px; border-radius:6px; cursor:pointer;
}
.mini:hover{ background:#00ff9c; color:#00110b; }
.save{
  border:1px solid #4da6ff; background:#0a1726; color:#eaf3ff;
  padding:7px 10px; border-radius:6px; cursor:pointer;
}
.save:hover{ background:#4da6ff; color:#001018; }
.lnk{ color:#4da6ff; text-decoration:none; font-weight:650; }
.lnk:hover{ text-decoration:underline; }
.pop-actions{ align-items:center; }
.spacer{ flex:1; }
.stbtn{
  border:1px solid #242424; background:#0e0e0e; color:#fff;
  padding:7px 10px; border-radius:999px; font-weight:800; cursor:default;
  white-space:nowrap;
}
.stbtn.aderisce{ border-color:#00ff9c; color:#00ff9c; }
.stbtn.trattativa{ border-color:#4da6ff; color:#4da6ff; }
.stbtn.contattare{ border-color:#ffaa00; color:#ffaa00; }
.stbtn.rifiuta{ border-color:#ff4d4d; color:#ff4d4d; }
</style>
</head>

<body>
  <div id="map"></div>
  <div id="banner"></div>

  <div id="hud">
    <div class="hud-title" id="hudTitle">Provincia di Verona</div>
    <div class="hud-sub" id="hudSub">Vista generale</div>

    <div class="chip">
      <span>GLOBALI</span>
      <small id="globalHint">—</small>
    </div>

    <div class="grid2">
      <div class="stat">
        <div class="stat-title">Farmacie (tot)</div>
        <div class="stat-value muted" id="g_total">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Comuni</div>
        <div class="stat-value info" id="g_comuni">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Private</div>
        <div class="stat-value muted" id="g_private">0</div>
      </div>
      <div class="stat">
        <div class="stat-title">Comunali</div>
        <div class="stat-value muted" id="g_comunali">0</div>
      </div>
    </div>

    <div class="miniGrid" id="g_statusGrid"></div>

    <div class="chip" style="margin-top:14px">
      <span>COMUNE SELEZIONATO</span>
      <small id="comuneHint">—</small>
    </div>

    <div class="grid2">
      <div class="stat">
        <div class="stat-title">Farmacie</div>
        <div class="stat-value muted" id="c_total">—</div>
      </div>
</div>

    <div class="miniGrid" id="c_statusGrid"></div>

    <div id="legend-box">
      <h4>Legenda marker</h4>
      <div class="legend-row"><span class="dot contattare"></span> Privata (colore = stato)</div>
      <div class="legend-row"><span class="triangle contattare"></span> Comunale (colore = stato)</div>
      <div class="legend-row"><span class="dot chiusa" style="opacity:.35"></span> Chiusa temporaneamente (semi-trasparente)</div>

      <h4>Legenda stati lavoro</h4>
      <div class="legend-row"><span class="dot contattare"></span> Non contattata</div>
      <div class="legend-row"><span class="dot trattativa"></span> In trattativa / In trattativa</div>
      <div class="legend-row"><span class="dot aderisce"></span> Favorevole (poster / informativa / boicotta)</div>
      <div class="legend-row"><span class="dot rifiuta"></span> Non aderisce</div>

      <h4 style="margin-top:12px">Debug</h4>
      <div class="legend-row" id="debugLine" style="display:none; color:#ffaa00"></div>
    </div>

    <div class="tools">
      <div class="chip" style="margin-top:0">
        <span>STRUMENTI</span>
        <small>referenti + stato</small>
      </div>

      <div class="btnRow" style="margin-top:10px">
        <button id="btnAddRef">Aggiungi referente</button>
        <button id="btnToggleRef">Vedi referenti</button>
      </div>

      <div id="refPanel">
        <ul id="refList"></ul>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* ===============================
       CONFIG
    ================================ */
    const DATA_FARMACIE_CSV = 'data/farmacie.csv';
    const DATA_COMUNI_GEOJSON = 'data/comuni_verona.json';
    const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1oMqJ_6ZLthMK73FkpirBtvQ_Ycif4OYS";

    /* REFERENTI (RAM) */
    const referenti = { "Verona": ["Vincenzo Russo"] };

    /* ===============================
       STATUS (LocalStorage) – no file write
       key: farmacia_id -> { stato_lavoro, incaricati[], note, chiusa_temp_bool }
    ================================ */
    const STATUS_STORE_KEY = 'spg_status_farmacie_v1';
    function normalizeStatusEntry(e){
  if(!e || typeof e !== 'object') return {};
  const out = { ...e };

  // legacy -> new
  const st = out.stato_lavoro;
  if(st === 'in_carico') out.stato_lavoro = 'in_trattativa';

  // legacy "fav_*" / "boicotta" -> aderisce + azioni
  if(st === 'fav_poster' || st === 'fav_informativa' || st === 'fav_pubblicita' || st === 'boicotta'){
    out.stato_lavoro = 'aderisce';
    out.azioni = out.azioni && typeof out.azioni === 'object' ? { ...out.azioni } : {};
    if(st === 'fav_poster') out.azioni.poster = true;
    if(st === 'fav_informativa') out.azioni.informativa = true;
    if(st === 'fav_pubblicita') out.azioni.pubblicita = true;
    if(st === 'boicotta') out.azioni.boicotta = true;
  }

  // ensure shapes
  if(!out.stato_lavoro) out.stato_lavoro = defaultWorkState();
  if(!Array.isArray(out.incaricati)) out.incaricati = (typeof out.incaricati === 'string' ? out.incaricati.split(',') : []).map(s=>String(s).trim()).filter(Boolean);
  if(typeof out.note !== 'string') out.note = out.note ? String(out.note) : '';
  if(typeof out.chiusa_temp !== 'boolean') out.chiusa_temp = false;
  if(!out.azioni || typeof out.azioni !== 'object') out.azioni = {};
  // normalize actions boolean
    ['poster','pubblicita','informativa','boicotta'].forEach(k => { out.azioni[k] = !!out.azioni[k]; });

  return out;
}

function loadStatusStore(){
  try{
    const raw = localStorage.getItem(STATUS_STORE_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    const out = {};
    for (const [k,v] of Object.entries(obj || {})){
      out[k] = normalizeStatusEntry(v);
    }
    return out;
  }catch(e){
    return {};
  }
}
    function saveStatusStore(obj){
      try { localStorage.setItem(STATUS_STORE_KEY, JSON.stringify(obj)); }
      catch(e){}
    }
    let statusStore = loadStatusStore();

    /* ===============================
       Stato lavoro (enum)
       - la UI lavora su questi
       - poi li mappiamo ai 4 colori
    ================================ */
    const WORK_STATES = [
  { key:'non_contattata', label:'Da contattare',  family:'contattare' },
  { key:'in_trattativa',  label:'In trattativa', family:'trattativa' },
  { key:'aderisce',       label:'Aderisce',      family:'aderisce' },
  { key:'non_aderisce',   label:'Non aderisce',  family:'rifiuta' }
];
    const WORK_STATE_BY_KEY = Object.fromEntries(WORK_STATES.map(x => [x.key, x]));

const ACTIONS = [
  { key:'poster',     label:'Poster/Cartello' },
  { key:'pubblicita', label:'Pubblicità campagna' },
  { key:'informativa',label:'Informativa ai clienti' },
  { key:'boicotta',   label:'Interrompe fornitura' }
];

    function defaultWorkState(){ return 'non_contattata'; }

    /* ===============================
       UTIL: normalizzazione comune
    ================================ */
    function normKey(s){
      return (s || '')
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,' ');
    }

    /* canon mapping costruito dal GeoJSON */
    let comuneCanonByNorm = {};
    let canonNamesNorm = [];

    /* alias manuali (minimo) */
    const COMUNE_ALIAS = {
      'negrar': 'Negrar di Valpolicella'
    };

    function canonComune(raw){
      const rawTrim = (raw || '').trim();
      if(!rawTrim) return '';
      const k = normKey(rawTrim);

      // 1) match esatto
      if(comuneCanonByNorm[k]) return comuneCanonByNorm[k];

      // 2) alias manuale
      if(COMUNE_ALIAS[k]){
        const kk = normKey(COMUNE_ALIAS[k]);
        if(comuneCanonByNorm[kk]) return comuneCanonByNorm[kk];
        return COMUNE_ALIAS[k];
      }

      // 3) fuzzy: se il nome nel CSV è prefisso unico (es. "negrar" -> "negrar di valpolicella")
      const pref = k + ' ';
      const cands = canonNamesNorm.filter(x => x.startsWith(pref));
      if(cands.length === 1) return comuneCanonByNorm[cands[0]];

      return rawTrim;
    }

    /* ===============================
       MAPPA BASE
    ================================ */
    const map = L.map('map', { attributionControl:false, zoomControl:false }).setView([45.43,10.99],10);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);
    L.control.zoom({ position:'topright' }).addTo(map);

    const banner = document.getElementById('banner');
    const hudTitle = document.getElementById('hudTitle');
    const hudSub = document.getElementById('hudSub');
    const globalHint = document.getElementById('globalHint');
    const comuneHint = document.getElementById('comuneHint');

    const g_total = document.getElementById('g_total');
    const g_comuni = document.getElementById('g_comuni');
    const g_private = document.getElementById('g_private');
    const g_comunali = document.getElementById('g_comunali');
    const g_statusGrid = document.getElementById('g_statusGrid');

    const c_total = document.getElementById('c_total');
    //
    const c_statusGrid = document.getElementById('c_statusGrid');

    const debugLine = document.getElementById('debugLine');

    const refPanel = document.getElementById('refPanel');
    const refList = document.getElementById('refList');
    const btnAddRef = document.getElementById('btnAddRef');
    const btnToggleRef = document.getElementById('btnToggleRef');

    /* layers */
    const farmLayer = L.layerGroup().addTo(map);
    let comuniLayer = null;

    /* runtime state */
    let selectedComune = null;
    let selectedComuneLayer = null;

    /* data */
    const farmMarkers = []; // { id, comune, gestione, marker, row }
    const comuniSet = new Set();

    function hasRef(nomeComune){
      return referenti[nomeComune] && referenti[nomeComune].length > 0;
    }

    /* ===============================
       STYLE COMUNI
    ================================ */
    function styleComuneBase(nome){
      const ref = hasRef(nome);
      return {
        color: ref ? '#00ff9c' : '#ffaa00',
        weight: ref ? 2 : 1,
        dashArray: ref ? null : '5 5',
        fillColor: '#00ff9c',
        fillOpacity: ref ? 0.10 : 0
      };
    }
    function aggiornaStiliComuni(){
      if(!comuniLayer) return;
      comuniLayer.eachLayer(layer => {
        const nome = layer?.feature?.properties ? (layer.feature.properties.nome || layer.feature.properties.DENOM_COM || layer.feature.properties.name || 'Comune') : 'Comune';
        let st = styleComuneBase(nome);
        if(selectedComuneLayer && layer === selectedComuneLayer){
          st = { ...st, color:'#ffffff', weight:3, dashArray:null, fillOpacity:0 };
        }
        layer.setStyle(st);
      });
    }

    /* ===============================
       ICONE FARMACIE
    ================================ */
    function workFamilyFor(id){
      const st = statusStore[id]?.stato_lavoro || defaultWorkState();
      const fam = (WORK_STATE_BY_KEY[st]?.family) || 'contattare';
      return fam;
    }
    function isChiusaTemp(row, id){
      // chiusura temporanea: o da CSV (stato_attivita) o da statusStore
      const csvClosed = ((row.stato_attivita || '').toString().toLowerCase().includes('chiusa'));
      const uiClosed = !!statusStore[id]?.chiusa_temp;
      return csvClosed || uiClosed;
    }

    function iconFarmacia(gestione, family, chiusa){
      const isComunale = (gestione || '').toString().toLowerCase().includes('comunal');
      const cls = family || 'contattare';
      const opacity = chiusa ? 0.35 : 1;

      if(isComunale){
        return L.divIcon({
          className:'',
          html:`<div class="triangle ${chiusa ? 'chiusa' : cls}" style="opacity:${opacity}"></div>`,
          iconSize:[14,14],
          iconAnchor:[7,7]
        });
      }
      return L.divIcon({
        className:'',
        html:`<div class="mrk dot ${chiusa ? 'chiusa' : cls}" style="opacity:${opacity}"></div>`,
        iconSize:[14,14],
        iconAnchor:[7,7]
      });
    }

    /* ===============================
       UI HELPERS (stats)
    ================================ */
    function countBy(arr, fnKey){
      const m = {};
      for(const x of arr){
        const k = fnKey(x);
        m[k] = (m[k] || 0) + 1;
      }
      return m;
    }

    function renderStatusGrid(el, rows){
  const counts = { contattare:0, trattativa:0, aderisce:0, rifiuta:0 };
  const gestione = { privata:0, comunale:0 };

  let poster=0, pubblicita=0, informativa=0, boicotta=0;

  (rows || []).forEach(x => {
    const id = x.id;
    const e = getStatusEntry(id);
    const st = e.stato_lavoro || defaultWorkState();
    const fam = WORK_STATE_BY_KEY[st]?.family || 'contattare';
    counts[fam] = (counts[fam]||0) + 1;

    const g = ((x.gestione || '').toString().toLowerCase().includes('comunal')) ? 'comunale' : 'privata';
    gestione[g]++;

    if(st === 'aderisce'){
      const az = e.azioni || {};
      if(az.poster) poster++;
      if(az.pubblicita) pubblicita++;
      if(az.informativa) informativa++;
      if(az.boicotta) boicotta++;
    }
  });

  el.innerHTML = `
    <div class="grid4">
      <div class="kpi"><div class="k">Da contattare</div><div class="v contattare">${counts.contattare||0}</div></div>
      <div class="kpi"><div class="k">In trattativa</div><div class="v trattativa">${counts.trattativa||0}</div></div>
      <div class="kpi"><div class="k">Aderisce</div><div class="v aderisce">${counts.aderisce||0}</div></div>
      <div class="kpi"><div class="k">Non aderisce</div><div class="v rifiuta">${counts.rifiuta||0}</div></div>
    </div>
    <div class="minirow">
      <span class="pill">Private: <b>${gestione.privata||0}</b></span>
      <span class="pill">Comunali: <b>${gestione.comunale||0}</b></span>
    </div>
    <div class="minirow">
      <span class="pill">Poster: <b>${poster}</b></span>
      <span class="pill">Pubblicità: <b>${pubblicita}</b></span>
      <span class="pill">Informativa: <b>${informativa}</b></span>
      <span class="pill">Boicotta: <b>${boicotta}</b></span>
    </div>
  `;
}

    function aggiornaHUD(){
      const all = farmMarkers;

      const comuniCount = comuniSet.size;
      g_comuni.textContent = comuniCount;

      g_total.textContent = all.length;

      const priv = all.filter(x => !(x.gestione || '').toString().toLowerCase().includes('comunal')).length;
      const comu = all.length - priv;
      g_private.textContent = priv;
      g_comunali.textContent = comu;

      globalHint.textContent = `marker caricati: ${all.length}`;

      renderStatusGrid(g_statusGrid, all);

      if(selectedComune){
        const inComune = all.filter(x => x.comune === selectedComune);
        comuneHint.textContent = selectedComune;
        c_total.textContent = inComune.length;
                renderStatusGrid(c_statusGrid, inComune);
      } else {
        comuneHint.textContent = '—';
        c_total.textContent = '—';
                c_statusGrid.innerHTML = '';
      }
    }

    /* ===============================
       REFERENTI UI
    ================================ */
    function mostraReferenti(nome){
  refList.innerHTML = '';
  const lista = referenti[nome] || [];
  if(!lista.length){
    refEmpty.style.display = 'block';
    refPanel.style.display = 'block';
    return;
  }
  refEmpty.style.display = 'none';
  lista.forEach((r, idx) => {
    const li = document.createElement('li');
    li.className = 'ref-item';
    const span = document.createElement('span');
    span.textContent = r;

    const x = document.createElement('button');
    x.className = 'ref-x';
    x.type = 'button';
    x.title = 'Rimuovi referente';
    x.textContent = '×';
    x.onclick = (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      referenti[nome].splice(idx,1);
      if(referenti[nome].length===0) delete referenti[nome];

      // aggiorna HUD / banner
      const nRef = referenti[nome] ? referenti[nome].length : 0;
      if(selectedNome === nome){
        hudSub.innerText = nRef ? ('Referenti presenti: ' + nRef) : '⚠ Comune orfano';
        banner.innerHTML = '↑ Comune di <b>' + nome + '</b> – Referenti: ' + nRef;
      }

      aggiornaStiliComuni();
      aggiornaContatoriGlobali();
      mostraReferenti(nome);
    };

    li.appendChild(span);
    li.appendChild(x);
    refList.appendChild(li);
  });
  refPanel.style.display = 'block';
}

    btnAddRef.onclick = () => {
      if(!selectedComune){
        alert('Seleziona un comune');
        return;
      }
      const n = prompt('Nome referente');
      if(!n) return;
      if(!referenti[selectedComune]) referenti[selectedComune] = [];
      referenti[selectedComune].push(n);

      // update UI + stili confini
      hudSub.textContent = `Referenti presenti: ${referenti[selectedComune].length}`;
      banner.innerHTML = `↑ Comune di <b>${selectedComune}</b> – Referenti: ${referenti[selectedComune].length}`;
      aggiornaStiliComuni();
      mostraReferenti(selectedComune);
    };

    btnToggleRef.onclick = () => {
      if(!selectedComune){
        alert('Seleziona un comune');
        return;
      }
      if(refPanel.style.display === 'block'){
        refPanel.style.display = 'none';
      } else {
        mostraReferenti(selectedComune);
      }
    };

    /* ===============================
       SELEZIONE COMUNE
    ================================ */
    function resetSelezione(){
      selectedComune = null;
      selectedComuneLayer = null;

      hudTitle.textContent = 'Provincia di Verona';
      hudSub.textContent = 'Vista generale';
      banner.style.display = 'none';

      // marker full opacity
      farmMarkers.forEach(x => x.marker.setOpacity(1));

      refPanel.style.display = 'none';

      aggiornaStiliComuni();
      aggiornaHUD();
    }

    function selezionaComune(layer, nome){
      selectedComune = nome;
      selectedComuneLayer = layer;

      hudTitle.textContent = `Comune di ${nome}`;
      const nRef = (referenti[nome]?.length || 0);
      hudSub.textContent = nRef ? `Referenti presenti: ${nRef}` : 'Vista comune';
      banner.style.display = 'block';
      banner.innerHTML = `↑ Comune di <b>${nome}</b> – Referenti: ${nRef}`;

      aggiornaStiliComuni();

      // dim out-of-comune markers
      farmMarkers.forEach(x => x.marker.setOpacity(x.comune === nome ? 1 : 0.18));

      // zoom sul comune
      try { map.fitBounds(layer.getBounds(), { padding:[40,40] }); } catch(e){}

      aggiornaHUD();
    }

    /* ===============================
       POPUP UI + SAVE
    ================================ */
    function escapeHtml(s){
      return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function buildPopupHtml(row, id){
  const e = getStatusEntry(id);
  const stato = e.stato_lavoro || defaultWorkState();
  const incaricati = Array.isArray(e.incaricati) ? e.incaricati : [];
  const note = (e.note || '').toString();
  const chiusa = !!e.chiusa_temp;
  const az = (e.azioni && typeof e.azioni === 'object') ? e.azioni : {};

  const statoBtnClass = WORK_STATE_BY_KEY[stato]?.family || 'contattare';

  const gestione = (row.gestione || '').toString().trim();
  const gestioneLabel = gestione ? gestione : '—';

  const indir = [row.indirizzo_full, row.cap, row.comune].filter(Boolean).join(' ');
  const mapsUrl = (row.maps_url || row.maps_share_url || row.maps_url_addr || '').toString().trim();

  const incaricatiChips = incaricati.length
    ? incaricati.map(n => `<span class="chip" data-name="${escapeHtml(n)}">${escapeHtml(n)}<button class="chip-x" title="Rimuovi">×</button></span>`).join(' ')
    : `<span class="muted">Nessuno</span>`;

  const azioniHtml = ACTIONS.map(a => {
    const checked = az[a.key] ? 'checked' : '';
    return `<label class="chk"><input type="checkbox" data-action="${a.key}" ${checked}/> ${a.label}</label>`;
  }).join('');

  return `
  <div class="pop" data-fid="${escapeAttr(id)}">
    <div class="pop-head">
      <div class="pop-title">${escapeHtml(row.descrizione_farmacia || 'Farmacia')}</div>
      <div class="pop-sub">${escapeHtml(gestioneLabel)} • ${escapeHtml(indir || (row.comune||''))}</div>
    </div>

    <div class="pop-row">
      <div class="pop-col">
        <div class="label">Stato</div>
        <div class="row-inline">
          <select class="sel" data-field="stato">
            ${WORK_STATES.map(s => `<option value="${s.key}" ${s.key===stato?'selected':''}>${s.label}</option>`).join('')}
          </select>
          <button class="stbtn ${statoBtnClass}" data-role="stateBadge" type="button" title="Stato attuale">${WORK_STATE_BY_KEY[stato]?.label || '—'}</button>
        </div>
      </div>
      <div class="pop-col">
        <div class="label">Azioni (se aderisce)</div>
        <div class="checks">${azioniHtml}</div>
      </div>
    </div>

    <div class="pop-row">
      <div class="pop-col">
        <div class="label">Incaricati</div>
        <div class="chips" data-role="chips">${incaricatiChips}</div>
        <div class="row-inline" style="margin-top:6px">
          <input class="inp" data-field="inc_new" placeholder="Aggiungi nome e premi + (puoi mettere anche virgole)" />
          <button class="mini" data-action="add_incar" type="button">+</button>
        </div>
      </div>
      <div class="pop-col">
        <div class="label">Note</div>
        <textarea class="ta" data-field="note" placeholder="Es: espone poster, fa informativa, contattare il titolare...">${escapeHtml(note)}</textarea>
      </div>
    </div>

    <div class="pop-row pop-actions">
      <label class="chk"><input type="checkbox" data-field="chiusa" ${chiusa?'checked':''}/> Chiusa temporaneamente</label>
      <div class="spacer"></div>
      ${mapsUrl ? `<a class="lnk" href="${escapeAttr(mapsUrl)}" target="_blank" rel="noopener">Apri in Google Maps</a>` : ''}
      <a class="lnk" href="${escapeAttr(DRIVE_MATERIALI)}" target="_blank" rel="noopener">Materiali campagna</a>
      <button class="save" data-action="save" type="button">Salva</button>
    </div>
  </div>`;
}

    function attachPopupHandlers(marker, row, id){
  marker.on('popupopen', () => {
    const popEl = marker.getPopup()?.getElement();
    if(!popEl) return;
    const root = popEl.querySelector('.pop');
    if(!root) return;

    const e = getStatusEntry(id);

    const sel = root.querySelector('select[data-field="stato"]');
    const badge = root.querySelector('[data-role="stateBadge"]');
    const noteTa = root.querySelector('textarea[data-field="note"]');
    const chkChiusa = root.querySelector('input[data-field="chiusa"]');
    const chipsBox = root.querySelector('[data-role="chips"]');
    const incInput = root.querySelector('input[data-field="inc_new"]');
    const btnAddInc = root.querySelector('button[data-action="add_incar"]');
    const btnSave = root.querySelector('button[data-action="save"]');

    function renderChips(){
      const incar = (getStatusEntry(id).incaricati || []).slice();
      if(!incar.length){
        chipsBox.innerHTML = '<span class="muted">Nessuno</span>';
        return;
      }
      chipsBox.innerHTML = incar.map(n => (
        `<span class="chip" data-name="${escapeHtml(n)}">${escapeHtml(n)}<button class="chip-x" title="Rimuovi">×</button></span>`
      )).join(' ');
    }

    // remove chip
    chipsBox.addEventListener('click', (ev) => {
      const btn = ev.target.closest('.chip-x');
      if(!btn) return;
      const chip = btn.closest('.chip');
      const name = chip?.getAttribute('data-name') || '';
      const entry = getStatusEntry(id);
      entry.incaricati = (entry.incaricati || []).filter(x => x !== name);
      statusStore[id] = entry;
      saveStatusStore();
      renderChips();
    });

    function addIncaricatiFromInput(){
      const raw = (incInput.value || '').trim();
      if(!raw) return;
      const names = raw.split(',').map(s => s.trim()).filter(Boolean);
      const entry = getStatusEntry(id);
      const cur = new Set(entry.incaricati || []);
      names.forEach(n => cur.add(n));
      entry.incaricati = Array.from(cur);
      statusStore[id] = entry;
      saveStatusStore();
      incInput.value = '';
      renderChips();
    }

    btnAddInc?.addEventListener('click', addIncaricatiFromInput);
    incInput?.addEventListener('keydown', (ev) => {
      if(ev.key === 'Enter'){ ev.preventDefault(); addIncaricatiFromInput(); }
    });

    // keep badge in sync while editing
    function syncBadge(){
      const st = sel.value;
      badge.textContent = WORK_STATE_BY_KEY[st]?.label || '—';
      badge.classList.remove('aderisce','trattativa','contattare','rifiuta');
      badge.classList.add(WORK_STATE_BY_KEY[st]?.family || 'contattare');
    }
    sel?.addEventListener('change', syncBadge);
    syncBadge();

    btnSave?.addEventListener('click', () => {
      const entry = getStatusEntry(id);

      // stato
      const stato = sel.value || defaultWorkState();
      entry.stato_lavoro = stato;

      // note
      entry.note = (noteTa.value || '').trim();

      // chiusa
      entry.chiusa_temp = !!chkChiusa.checked;

      // azioni
      entry.azioni = entry.azioni && typeof entry.azioni === 'object' ? entry.azioni : {};
      root.querySelectorAll('input[type="checkbox"][data-action]').forEach(cb => {
        const k = cb.getAttribute('data-action');
        if(k) entry.azioni[k] = !!cb.checked;
      });

      // incaricati already managed via chips; still allow comma list lingering in input
      if((incInput.value||'').trim()) addIncaricatiFromInput();

      statusStore[id] = normalizeStatusEntry(entry);
      saveStatusStore();

      // aggiorna marker
      const fam = WORK_STATE_BY_KEY[statusStore[id].stato_lavoro]?.family || 'contattare';
      marker.setIcon(iconFarmacia(row.gestione, fam, statusStore[id].chiusa_temp));

      // contatori
      aggiornaHUD();

      // feedback visivo
      badge.textContent = WORK_STATE_BY_KEY[stato]?.label || '—';
      badge.classList.remove('aderisce','trattativa','contattare','rifiuta');
      badge.classList.add(fam);

      const saveBtn = btnSave;
      saveBtn.textContent = 'Salvato ✓';
      setTimeout(() => { saveBtn.textContent = 'Salva'; }, 900);
    });

    // initial chips render
    renderChips();
  });
}

    /* ===============================
       CARICA FARMACIE CSV
       - marker: SEMPRE latitudine/longitudine (no geocode)
       - popup link: priorità maps_share_url > maps_url_addr
    ================================ */
    function parseFloatIT(x){
      if(x === null || x === undefined) return NaN;
      const s = String(x).trim().replace(',', '.');
      return parseFloat(s);
    }

    function caricaFarmacieCSV(){
      Papa.parse(DATA_FARMACIE_CSV, {
        download:true,
        header:true,
        skipEmptyLines:true,
        complete: (res) => {
          const rows = res.data || [];
          farmLayer.clearLayers();
          farmMarkers.length = 0;

          let skipped = 0;
          let unmatched = 0;

          for(const row of rows){
            const rawComune = (row.comune || '').toString().trim();
            const comune = canonComune(rawComune);
            if(!rawComune) { skipped++; continue; }
            if(!comuneCanonByNorm[normKey(rawComune)]) unmatched++;

            const lat = parseFloatIT(row.latitudine);
            const lon = parseFloatIT(row.longitudine);
            if(!isFinite(lat) || !isFinite(lon)) { skipped++; continue; }

            const id = (row.farmacia_id || '').toString().trim() || (row.descrizione_farmacia ? ('auto_' + normKey(row.descrizione_farmacia) + '_' + lat + '_' + lon) : ('auto_' + lat + '_' + lon));

            const family = workFamilyFor(id);
            const chiusa = isChiusaTemp(row, id);

            const marker = L.marker([lat, lon], {
              icon: iconFarmacia(row.gestione, family, chiusa),
              interactive:true
            });

            const popupHtml = buildPopupHtml(row, id);
            marker.bindPopup(popupHtml, { maxWidth: 360, closeButton:true });

            attachPopupHandlers(marker, row, id);

            marker.addTo(farmLayer);

            farmMarkers.push({ id, comune, gestione: row.gestione || '', marker, row });
            comuniSet.add(comune);
          }

          // debug line: molto discreta
          if(unmatched > 0){
            debugLine.style.display = 'block';
            debugLine.textContent = `⚠ Comune non riconosciuto rispetto al GeoJSON: ${unmatched} (es. "Negrar" vs "Negrar di Valpolicella").`;
          } else {
            debugLine.style.display = 'none';
          }

          // se stavo già su un comune, riapplico filtro
          if(selectedComune){
            farmMarkers.forEach(x => x.marker.setOpacity(x.comune === selectedComune ? 1 : 0.18));
          }

          aggiornaHUD();
        },
        error: (err) => {
          debugLine.style.display = 'block';
          debugLine.textContent = 'Errore nel caricamento CSV farmacie: ' + (err?.message || String(err));
        }
      });
    }

    /* ===============================
       CARICA COMUNI (GEOJSON) + AVVIO
    ================================ */
    fetch(DATA_COMUNI_GEOJSON)
      .then(r => r.json())
      .then(data => {
        comuniLayer = L.geoJSON(data, {
          style: f => {
            const nome = f.properties?.nome || f.properties?.DENOM_COM || f.properties?.name || 'Comune';
            const k = normKey(nome);
            comuneCanonByNorm[k] = nome;
            return styleComuneBase(nome);
          },
          onEachFeature: (f, layer) => {
            const nome = f.properties?.nome || f.properties?.DENOM_COM || f.properties?.name || 'Comune';
            comuniSet.add(nome);

            // salva canon list (per fuzzy)
            const k = normKey(nome);
            if(!canonNamesNorm.includes(k)) canonNamesNorm.push(k);

            // label
            const center = layer.getBounds().getCenter();
            L.marker(center, {
              icon: L.divIcon({ className:'label-comune', html: nome, iconSize:[150,16] }),
              interactive:false
            }).addTo(map);

            layer.on('click', () => selezionaComune(layer, nome));
          }
        }).addTo(map);

        try { map.fitBounds(comuniLayer.getBounds()); } catch(e){}

        // click vuoto = reset
        map.on('click', (e) => {
          // se clicco sullo sfondo (non su comune), reset
          // (Leaflet non distingue sempre: quindi reset solo se non ho appena selezionato)
        });

        // zoom out forte -> reset (utile su mobile)
        map.on('zoomend', () => {
          if(selectedComune && map.getZoom() < 9.5){
            resetSelezione();
          }
        });

        aggiornaStiliComuni();
        aggiornaHUD();

        // carica farmacie
        caricaFarmacieCSV();
      })
      .catch(err => {
        debugLine.style.display = 'block';
        debugLine.textContent = 'Errore caricamento GeoJSON comuni: ' + (err?.message || String(err));
      });
  </script>
</body>
</html>

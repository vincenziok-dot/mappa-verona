<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Verona – SpG</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map { position:absolute; inset:0; background:#050505; }

/* BANNER ALTO COMUNE SELEZIONATO */
#banner{
  position:fixed;
  top:0;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  padding:8px 18px;
  border-bottom:3px solid #00ff9c;
  color:#fff;
  font-size:13px;
  display:none;
  z-index:9999;
  max-width: calc(100% - 24px);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* HUD COLONNA SINISTRA */
#hud {
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 9998;
  padding: 14px 16px;
  background: rgba(5,5,5,.94);
  border-left: 4px solid #00ff9c;
  min-width: 340px;
  max-width: 420px;
  box-shadow: 0 0 20px rgba(0,0,0,.85);
}

.hud-title {
  font-size: 18px;
  font-weight: 650;
  color: #fff;
  text-transform: uppercase;
}
.hud-sub {
  margin-top: 6px;
  font-size: 13px;
  color: #bdbdbd;
}

/* separatore “GLOBALI” più chiaro */
.hud-chip {
  display:inline-block;
  margin-top: 10px;
  font-size: 10px;
  letter-spacing: .14em;
  text-transform: uppercase;
  color:#9ef5d9;
  background:#0e0e0e;
  padding: 6px 8px;
  border: 1px solid #1f1f1f;
}

/* contatori comuni (GLOBALI) */
#stats {
  margin-top: 10px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.stat {
  background: #0e0e0e;
  padding: 8px;
  border: 1px solid #1f1f1f;
}
.stat-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color:#bdbdbd;
}
.stat-value {
  font-size: 26px;
  font-weight: 750;
}
.stat-ok .stat-value { color:#00ff9c; }
.stat-warn .stat-value { color:#ffaa00; }
.stat-info .stat-value { color:#4da6ff; }
.stat-muted .stat-value { color:#d0d0d0; }

/* progress geocoding */
#geoProgress {
  margin-top: 8px;
  font-size: 11px;
  color:#bdbdbd;
}

/* farmacie (per comune selezionato) */
#farm-box {
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid #222;
}
#farm-box h4 {
  margin: 0 0 6px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #9ef5d9;
}
#farm-count {
  font-size: 12px;
  margin-bottom: 6px;
  color:#e6e6e6;
}
#mmg-count {
  font-size: 12px;
  margin-bottom: 0px;
  color:#e6e6e6;
}

/* LEGENDA COMPLETA */
#legend-box {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #222;
}
#legend-box h4 {
  margin: 8px 0 6px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #cccccc;
}

.legend-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 11px;
  margin-bottom: 4px;
  color:#e6e6e6;
}

.dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}
.triangle {
  width: 0; height: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-bottom: 12px solid;
}
.square {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

/* colori stato strutture */
.aderisce { background:#00ff9c; border-bottom-color:#00ff9c; color:#00ff9c; }
.trattativa { background:#4da6ff; border-bottom-color:#4da6ff; color:#4da6ff; }
.contattare { background:#ffaa00; border-bottom-color:#ffaa00; color:#ffaa00; }
.rifiuta { background:#ff4d4d; border-bottom-color:#ff4d4d; color:#ff4d4d; }

/* colori legenda comuni */
.leg-coperto { background:#00ff9c; }
.leg-orfano { background:#ffaa00; }

/* simbolo medici / studi */
.med-simbolo {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  border: 2px solid #ffffff;
  box-sizing: border-box;
}

/* buttons referenti */
.hud-buttons {
  margin-top: 12px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.hud-btn {
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:11px;
  padding:6px 10px;
  cursor:pointer;
}
.hud-btn:hover {
  background:#00ff9c;
  color:#00110b;
}

/* pannello referenti */
.hud-section {
  margin-top: 10px;
  border-top: 1px solid #222;
  padding-top: 6px;
  display: none;
}
.hud-section li {
  font-size: 12px;
  color: #fff;
}

/* label comuni */
.label-comune {
  color: #ffffff;
  font-size: 11px;
  text-shadow: 0 0 6px rgba(0,0,0,.9);
  pointer-events: none;
}

/* marker CSS (divIcon) */
.mrk { width:14px; height:14px; display:flex; align-items:center; justify-content:center; }
.mrk.dot { border-radius:50%; }
.mrk.med {
  width:14px;height:14px;border-radius:2px;
  border:2px solid rgba(255,255,255,.95);
  box-sizing:border-box;
  font-size:12px; font-weight:900;
  line-height:12px;
}
.mrk.associato { box-shadow: 0 0 0 2px rgba(255,255,255,.25), 0 0 10px rgba(0,255,156,.15); }
.mrk.nuovo2025 { box-shadow: 0 0 12px rgba(77,166,255,.45); }

/* per rendere i comuni “coperti” molto riconoscibili */
.comune-coperto-hint {
  filter: drop-shadow(0 0 6px rgba(0,255,156,.20));
}

.leaflet-interactive { cursor:pointer }
</style>
</head>

<body>

<div id="map"></div>
<div id="banner"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div class="hud-chip">GLOBALI</div>

  <!-- CONTATORI GLOBALI -->
  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
    <div class="stat stat-muted">
      <div class="stat-title">Farmacie</div>
      <div class="stat-value" id="cntFarm">0</div>
    </div>
    <div class="stat stat-info">
      <div class="stat-title">Studi MMG</div>
      <div class="stat-value" id="cntStudi">0</div>
    </div>
  </div>

  <div id="geoProgress"></div>

  <!-- STATS COMUNE SELEZIONATO -->
  <div id="farm-box">
    <h4>Comune selezionato</h4>
    <div id="farm-count">Farmacie: —</div>
    <div id="mmg-count">Studi MMG: —</div>
  </div>

  <!-- LEGENDA COMPLETA -->
  <div id="legend-box">
    <h4>Legenda comuni</h4>
    <div class="legend-row">
      <span class="square leg-coperto"></span> Comune con referenti (bordo pieno)
    </div>
    <div class="legend-row">
      <span class="square leg-orfano"></span> Comune orfano (bordo tratteggiato)
    </div>

    <h4>Legenda farmacie</h4>
    <div class="legend-row"><span class="dot aderisce"></span> Privata – aderisce</div>
    <div class="legend-row"><span class="dot trattativa"></span> Privata – in trattativa</div>
    <div class="legend-row"><span class="dot contattare"></span> Privata – da contattare</div>
    <div class="legend-row"><span class="dot rifiuta"></span> Privata – rifiuta</div>
    <div class="legend-row"><span class="triangle aderisce"></span> Comunale – aderisce</div>
    <div class="legend-row"><span class="triangle trattativa"></span> Comunale – in trattativa</div>
    <div class="legend-row"><span class="triangle contattare"></span> Comunale – da contattare</div>
    <div class="legend-row"><span class="triangle rifiuta"></span> Comunale – rifiuta</div>

    <h4>Legenda studi MMG</h4>
    <div class="legend-row"><span class="med-simbolo aderisce"></span> Studio – aderisce</div>
    <div class="legend-row"><span class="med-simbolo trattativa"></span> Studio – in trattativa</div>
    <div class="legend-row"><span class="med-simbolo contattare"></span> Studio – da contattare</div>
    <div class="legend-row"><span class="med-simbolo rifiuta"></span> Studio – rifiuta</div>

    <h4>Note marker</h4>
    <div class="legend-row"><span class="med-simbolo trattativa" style="border-color:#fff"></span> “Associato” = più MMG</div>
    <div class="legend-row"><span class="med-simbolo aderisce" style="box-shadow:0 0 12px rgba(77,166,255,.45)"></span> “Nuovo 2025” = match_type right_only</div>
  </div>

  <!-- PULSANTI REFERENTI -->
  <div class="hud-buttons">
    <button class="hud-btn" id="btnAdd">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggle">Vedi referenti</button>
  </div>

  <!-- LISTA REFERENTI COMUNE SELEZIONATO -->
  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===============================
   CONFIG
================================ */
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm";

/* status VOLATILE (RAM) – per ora NON scrive file */
const statusRAM = {
  // id -> { stato, note, incaricato, extra... }
  // esempio: "pharm::<id>" oppure "studio::<id>" oppure "comune::<nome>"
};

/* REFERENTI (RAM, come ora) */
const referenti = { "Verona": ["Vincenzo R."] };

/* ===============================
   MAPPA BASE
================================ */
const map = L.map('map',{ attributionControl:false }).setView([45.43,10.99],10);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

const banner      = document.getElementById('banner');
const hudTitle    = document.getElementById('hudTitle');
const hudSub      = document.getElementById('hudSub');
const refPanel    = document.getElementById('refPanel');
const refList     = document.getElementById('refList');
const btnToggle   = document.getElementById('btnToggle');
const farmCountEl = document.getElementById('farm-count');
const mmgCountEl  = document.getElementById('mmg-count');
const geoProgress = document.getElementById('geoProgress');

const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
const hasRef     = n => referenti[n] && referenti[n].length > 0;

let labels = [];
let comuniSet = new Set();
let layersByNome = {};
let selectedLayer = null;
let selectedNome = null;
let refVisibili = false;
let selectedZoomRef = null;

/* layer markers */
const farmLayer = L.layerGroup().addTo(map);
const studiLayer = L.layerGroup().addTo(map);

const farmMarkers = [];   // {marker, comune}
const studiMarkers = [];  // {marker, comune}

/* centri comuni (fallback geocoding) */
const centriComuni = {}; // nome -> LatLng

/* ===============================
   CONTATORI GLOBALI
================================ */
function aggiornaContatoriGlobali(){
  const comuni = Array.from(comuniSet);
  const coperti = comuni.filter(n => hasRef(n)).length;
  const orfani = comuni.length - coperti;
  document.getElementById('cntOk').innerText = coperti;
  document.getElementById('cntOrfani').innerText = orfani;
  document.getElementById('cntFarm').innerText = farmMarkers.length;
  document.getElementById('cntStudi').innerText = studiMarkers.length;
}

/* ===============================
   STILI COMUNI
   - coperti: verde, bordo pieno, fill leggero
   - orfani: arancio, bordo tratteggiato, fill 0
   - selezionato: bordo bianco, NO fill verde
================================ */
function styleComuneBase(nome){
  const ref = hasRef(nome);
  return {
    color: ref ? '#00ff9c' : '#ffaa00',
    weight: ref ? 2 : 1,
    dashArray: ref ? null : '5 5',
    fillColor: '#00ff9c',
    fillOpacity: ref ? 0.10 : 0
  };
}

function aggiornaStiliComuni(){
  Object.keys(layersByNome).forEach(n => {
    const layer = layersByNome[n];
    let st = styleComuneBase(n);

    if (selectedLayer && layer === selectedLayer){
      st = {
        ...st,
        color:'#ffffff',
        weight:3,
        dashArray: null,
        fillOpacity: 0  // niente riempimento quando selezionato
      };
    }

    layer.setStyle(st);
  });
}

/* ===============================
   LABEL COMUNI ON/OFF
   - appaiono in vista generale (non selezionato) tra zoom 9 e 13
================================ */
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    const show = (!selectedNome && z >= 9 && z <= 13);
    if(show){
      if(!map.hasLayer(l)) map.addLayer(l);
    } else {
      if(map.hasLayer(l)) map.removeLayer(l);
    }
  });
}

/* ===============================
   RESET SELEZIONE
================================ */
function resetSelezione(){
  selectedLayer = null;
  selectedNome = null;
  selectedZoomRef = null;

  hudTitle.innerText = 'Provincia di Verona';
  hudSub.innerText   = 'Vista generale';

  banner.style.display = 'none';

  farmCountEl.innerText = 'Farmacie: —';
  mmgCountEl.innerText  = 'Studi MMG: —';

  // ripristina opacità marker
  farmMarkers.forEach(x => x.marker.setOpacity(1));
  studiMarkers.forEach(x => x.marker.setOpacity(1));

  // pannello referenti
  refPanel.style.display = 'none';
  refVisibili = false;
  btnToggle.innerText = 'Vedi referenti';

  aggiornaStiliComuni();
  aggiornaLabels();
}

/* ===============================
   SELEZIONE COMUNE
================================ */
function selezionaComune(layer, nome){
  selectedLayer = layer;
  selectedNome = nome;

  aggiornaStiliComuni();

  // zoom sul comune
  map.fitBounds(layer.getBounds(), { padding:[40,40] });
  map.once('moveend', () => { selectedZoomRef = map.getZoom(); });

  // HUD
  hudTitle.innerText = 'Comune di ' + nome;
  const nRef = (referenti[nome] ? referenti[nome].length : 0);
  hudSub.innerText = hasRef(nome) ? ('Referenti presenti: ' + nRef) : '⚠ Comune orfano';

  // banner
  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + nome + '</b> – Referenti: ' + nRef;

  // label off
  aggiornaLabels();

  // evidenzia marker del comune (altri “dim”)
  farmMarkers.forEach(x => x.marker.setOpacity(x.comune === nome ? 1 : 0.18));
  studiMarkers.forEach(x => x.marker.setOpacity(x.comune === nome ? 1 : 0.18));

  // contatori comune
  const nFarm = farmMarkers.filter(x => x.comune === nome).length;
  const nStudi = studiMarkers.filter(x => x.comune === nome).length;
  farmCountEl.innerText = 'Farmacie: ' + nFarm;
  mmgCountEl.innerText  = 'Studi MMG: ' + nStudi;

  // se pannello referenti era aperto, mantieni aperto e aggiorna
  if(refVisibili) mostraReferenti(nome);
}

/* ===============================
   REFERENTI
================================ */
function mostraReferenti(nome){
  refList.innerHTML = '';
  const lista = referenti[nome] || [];
  lista.forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = 'block';
}

document.getElementById('btnAdd').onclick = () => {
  if(!selectedNome){
    alert('Seleziona prima un comune sulla mappa');
    return;
  }
  const n = prompt('Inserisci il tuo nome (comparirà come referente)');
  if(!n) return;

  if(!referenti[selectedNome]) referenti[selectedNome] = [];
  referenti[selectedNome].push(n);

  // aggiorna HUD + banner
  const nRef = referenti[selectedNome].length;
  hudSub.innerText = 'Referenti presenti: ' + nRef;
  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + selectedNome + '</b> – Referenti: ' + nRef;

  // IMPORTANTI: aggiorna stili + contatori globali
  aggiornaStiliComuni();
  aggiornaContatoriGlobali();

  if(refVisibili) mostraReferenti(selectedNome);
};

document.getElementById('btnToggle').onclick = () => {
  if(!selectedNome){
    alert('Seleziona prima un comune sulla mappa');
    return;
  }
  refVisibili = !refVisibili;
  btnToggle.innerText = refVisibili ? 'Nascondi referenti' : 'Vedi referenti';

  if(refVisibili){
    mostraReferenti(selectedNome);
  } else {
    refPanel.style.display = 'none';
  }
};

/* ===============================
   UTIL: ID STABILE
================================ */
function stableId(str){
  // hash semplice e stabile (no crypto) – va bene per id locali
  let h = 0;
  for (let i=0; i<str.length; i++){
    h = ((h<<5) - h) + str.charCodeAt(i);
    h |= 0;
  }
  return String(h);
}

/* ===============================
   UTIL: LINK GOOGLE MAPS
================================ */
function mapsLinkFromLatLng(lat,lng, label){
  const q = encodeURIComponent((label ? label + ' ' : '') + lat + ',' + lng);
  return `https://www.google.com/maps/search/?api=1&query=${q}`;
}
function mapsLinkFromAddress(addr){
  const q = encodeURIComponent(addr);
  return `https://www.google.com/maps/search/?api=1&query=${q}`;
}

/* ===============================
   MARKER ICONS
================================ */
function iconFarmacia(tipo, stato){
  const cls = (stato || 'contattare');
  if(tipo === 'comunale'){
    // triangolo via CSS border-bottom-color
    return L.divIcon({
      className:'',
      html:`<div class="triangle ${cls}"></div>`,
      iconSize:[14,14],
      iconAnchor:[7,7]
    });
  }
  return L.divIcon({
    className:'',
    html:`<div class="mrk dot ${cls}"></div>`,
    iconSize:[14,14],
    iconAnchor:[7,7]
  });
}

function iconStudio(stato, isAssociato, isNuovo2025){
  const cls = (stato || 'contattare');
  const extra = [
    isAssociato ? 'associato' : '',
    isNuovo2025 ? 'nuovo2025' : ''
  ].join(' ');
  return L.divIcon({
    className:'',
    html:`<div class="mrk med ${cls} ${extra}">✚</div>`,
    iconSize:[16,16],
    iconAnchor:[8,8]
  });
}

/* ===============================
   CARICAMENTO COMUNI (GEOJSON)
================================ */
fetch('data/comuni_verona.json')
  .then(r => r.json())
  .then(data => {

    const geo = L.geoJSON(data, {
      style: f => {
        const n = nomeComune(f.properties);
        comuniSet.add(n);
        return styleComuneBase(n);
      },
      onEachFeature: (f, layer) => {
        const nome = nomeComune(f.properties);
        layersByNome[nome] = layer;

        // centro comune (fallback geocoding)
        centriComuni[nome] = layer.getBounds().getCenter();

        // label
        const center = layer.getBounds().getCenter();
        const label = L.marker(center,{
          icon: L.divIcon({ className:'label-comune', html: nome, iconSize:[140,16] }),
          interactive:false
        }).addTo(map);
        labels.push(label);

        layer.on('click', () => selezionaComune(layer, nome));
      }
    }).addTo(map);

    map.fitBounds(geo.getBounds());
    aggiornaStiliComuni();
    aggiornaLabels();
    aggiornaContatoriGlobali();

    map.on('zoomend', () => {
      const z = map.getZoom();

      // se sono in dettaglio e faccio anche solo “un po’” zoom-out -> ritorno alla vista generale
      if(selectedNome && selectedZoomRef !== null && z <= (selectedZoomRef - 0.6)){
        resetSelezione();
        return;
      }

      // se zoomo molto fuori comunque reset
      if(selectedNome && z < 9.5){
        resetSelezione();
        return;
      }

      aggiornaLabels();
    });

    // appena comuni pronti, carico punti
    caricaFarmacieCSV();
    caricaStudiMMGCSV();
  });

/* ===============================
   CARICA FARMACIE (CSV con coordinate)
================================ */
function caricaFarmacieCSV(){
  Papa.parse('data/farmacie.csv', {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      const rows = res.data || [];
      rows.forEach(row => {
        const comune = (row.comune || '').trim();
        if(!comune) return;

        const lat = parseFloat(row.latitudine);
        const lng = parseFloat(row.longitudine);
        if(!isFinite(lat) || !isFinite(lng)) return;

        const nome = (row.descrizione_farmacia || 'Farmacia').trim();
        const indirizzo = (row.indirizzo || '').trim();
        const cap = (row.cap || '').trim();

        // tipo: proviamo a dedurre (molti dataset mettono "COMUNALE" nel nome)
        let tipo = 'privata';
        const cat = (row.categoria || '').toLowerCase();
        if(nome.toUpperCase().includes('COMUNALE') || cat.includes('comunal')) tipo = 'comunale';

        const id = stableId(`pharm|${nome}|${indirizzo}|${comune}|${lat}|${lng}`);
        const key = `pharm::${id}`;

        // stato volatile (se non presente, default = contattare)
        const st = (statusRAM[key]?.stato) || 'contattare';

        const popupHtml = `
          <strong>${nome}</strong><br/>
          <div style="opacity:.9">${tipo} – ${indirizzo}${cap ? ', ' + cap : ''} – ${comune}</div>
          <div style="margin-top:6px">
            <a href="${mapsLinkFromLatLng(lat,lng,nome)}" target="_blank">Apri in Google Maps</a><br/>
            <a href="${DRIVE_MATERIALI}" target="_blank">Materiali campagna</a>
          </div>
        `;

        const marker = L.marker([lat,lng], { icon: iconFarmacia(tipo, st) })
          .bindPopup(popupHtml);

        marker.addTo(farmLayer);
        farmMarkers.push({ marker, comune });

      });

      aggiornaContatoriGlobali();

      // se un comune è già selezionato, applico “dim”
      if(selectedNome){
        farmMarkers.forEach(x => x.marker.setOpacity(x.comune === selectedNome ? 1 : 0.18));
      }
    }
  });
}

/* ===============================
   CARICA STUDI MMG (CSV con indirizzi → geocode)
   - 1 riga = 1 studio attivo
   - geocodifica: indirizzo + comune (cache in localStorage)
================================ */
const GEO_CACHE_KEY = 'spg_geocode_cache_v1';
function loadGeoCache(){
  try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}'); }
  catch(e){ return {}; }
}
function saveGeoCache(obj){
  try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(obj)); }
  catch(e){}
}
const geoCache = loadGeoCache();

function geocodeNominatim(query){
  const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=${encodeURIComponent(query)}`;
  return fetch(url, { headers: { 'Accept':'application/json' } })
    .then(r => r.json())
    .then(arr => (arr && arr.length ? arr[0] : null))
    .catch(() => null);
}

function caricaStudiMMGCSV(){
  Papa.parse('data/mmg2025.csv', {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: async (res) => {
      const rows = res.data || [];
      let done = 0;
      const total = rows.length;

      geoProgress.textContent = `Geocodifica studi MMG: 0 / ${total}…`;

      // throttle 1 req/sec per non fare casino
      for (const row of rows){
        const comune = (row.comune || '').trim();
        const indirizzo = (row.indirizzo || '').trim();
        if(!comune || !indirizzo){
          done++;
          geoProgress.textContent = `Geocodifica studi MMG: ${done} / ${total}`;
          continue;
        }

        const tipoStudio = (row.tipo_studio || '').trim();
        const numeroMedici = parseInt(row.numero_medici || '0', 10) || 0;
        const nomiMedici = (row.nomi_medici || '').trim();
        const telefoni = (row.telefoni || '').trim();
        const orari = (row.orari || '').trim();
        const matchType = (row.match_type || '').trim(); // es: right_only
        const isNuovo2025 = (matchType === 'right_only');
        const isAssociato = (numeroMedici > 1);

        const studioLabel = (tipoStudio ? tipoStudio : 'Studio MMG');

        const id = stableId(`studio|${indirizzo}|${comune}|${numeroMedici}|${nomiMedici}`);
        const key = `studio::${id}`;

        const st = (statusRAM[key]?.stato) || 'contattare';

        // geocode cache key (indirizzo+comune)
        const q = `${indirizzo}, ${comune}, Verona, Italia`;
        let latlng = geoCache[q];

        if(!latlng){
          const hit = await geocodeNominatim(q);
          if(hit && hit.lat && hit.lon){
            latlng = { lat: parseFloat(hit.lat), lng: parseFloat(hit.lon) };
            geoCache[q] = latlng;
            saveGeoCache(geoCache);
          } else {
            // fallback: centro comune
            const c = centriComuni[comune];
            if(c) latlng = { lat: c.lat, lng: c.lng };
          }

          // throttle
          await new Promise(r => setTimeout(r, 1000));
        }

        if(latlng && isFinite(latlng.lat) && isFinite(latlng.lng)){
          const mediciList = nomiMedici
            ? nomiMedici.split('|').map(s => s.trim()).filter(Boolean)
            : [];

          const popupHtml = `
            <strong>${studioLabel}</strong><br/>
            <div style="opacity:.9">${indirizzo} – ${comune}</div>
            <div style="margin-top:6px; font-size:12px; opacity:.95">
              <b>MMG:</b> ${numeroMedici || mediciList.length || '—'}<br/>
              ${isAssociato ? '<b>Tipo:</b> studio associato<br/>' : ''}
              ${isNuovo2025 ? '<b>Nuovo 2025:</b> sì<br/>' : ''}
              ${telefoni ? `<b>Tel:</b> ${telefoni}<br/>` : ''}
              ${orari ? `<div style="margin-top:6px"><b>Orari:</b><br/>${orari}</div>` : ''}
            </div>
            ${mediciList.length ? `
              <div style="margin-top:8px; font-size:12px">
                <b>Medici:</b><br/>
                ${mediciList.map(m => '• ' + m).join('<br/>')}
              </div>
            ` : ''}
            <div style="margin-top:8px">
              <a href="${mapsLinkFromLatLng(latlng.lat, latlng.lng, studioLabel)}" target="_blank">Apri in Google Maps</a><br/>
              <a href="${DRIVE_MATERIALI}" target="_blank">Materiali campagna</a>
            </div>
          `;

          const marker = L.marker([latlng.lat, latlng.lng], {
            icon: iconStudio(st, isAssociato, isNuovo2025)
          }).bindPopup(popupHtml);

          marker.addTo(studiLayer);
          studiMarkers.push({ marker, comune });

          // se sono in comune selezionato, opacità piena; altrimenti dim
          if(selectedNome){
            marker.setOpacity(comune === selectedNome ? 1 : 0.18);
          }
        }

        done++;
        geoProgress.textContent = `Geocodifica studi MMG: ${done} / ${total}`;
        document.getElementById('cntStudi').innerText = studiMarkers.length;
      }

      geoProgress.textContent = `Geocodifica studi MMG completata: ${done} / ${total}. (Cache salvata nel browser)`;
      aggiornaContatoriGlobali();
    }
  });
}
</script>

</body>
</html>

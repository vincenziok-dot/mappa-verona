<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Verona – SpG (Farmacie)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui, sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* MODE PICKER */
#modePicker{
  position:fixed; inset:0; z-index:10000;
  display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.72);
}
#modeCard{
  width:min(520px, calc(100% - 32px));
  background:rgba(5,5,5,.96);
  border:1px solid #1f1f1f;
  border-left:4px solid #00ff9c;
  box-shadow:0 0 30px rgba(0,0,0,.85);
  padding:16px;
  color:#fff;
}
#modeCard h3{ margin:0 0 6px; font-size:16px; text-transform:uppercase; letter-spacing:.08em; }
#modeCard p{ margin:0 0 12px; color:#bdbdbd; font-size:13px; line-height:1.35; }
.modeBtns{ display:flex; gap:10px; flex-wrap:wrap; }
.modeBtn{
  flex:1;
  min-width:150px;
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:13px;
  padding:10px 12px;
  cursor:pointer;
}
.modeBtn:hover{ background:#00ff9c; color:#00110b; }

/* BANNER ALTO COMUNE SELEZIONATO */
#banner{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  padding:8px 18px;
  border-bottom:3px solid #00ff9c;
  color:#fff; font-size:13px;
  display:none; z-index:9999;
  max-width: calc(100% - 24px);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* HUD */
#hud{
  position:fixed; top:18px; left:18px; z-index:9998;
  padding:14px 16px;
  background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c;
  min-width:340px; max-width:440px;
  box-shadow:0 0 20px rgba(0,0,0,.85);
  max-height: calc(100vh - 36px);
  overflow:auto;
}

.hud-title{ font-size:18px; font-weight:650; color:#fff; text-transform:uppercase; }
.hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

.hud-chip{
  display:inline-block; margin-top:10px;
  font-size:10px; letter-spacing:.14em; text-transform:uppercase;
  color:#9ef5d9; background:#0e0e0e;
  padding:6px 8px; border:1px solid #1f1f1f;
}

/* stat grid */
#stats{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:22px; font-weight:800; line-height:1.05; }
.stat-ok .stat-value{ color:#00ff9c; }
.stat-warn .stat-value{ color:#ffaa00; }
.stat-info .stat-value{ color:#4da6ff; }
.stat-bad .stat-value{ color:#ff4d4d; }
.stat-muted .stat-value{ color:#d0d0d0; }

.small-note{ margin-top:8px; font-size:11px; color:#bdbdbd; line-height:1.35; }
.small-note b{ color:#e6e6e6; }

#qualityBox{
  margin-top:10px; padding-top:8px;
  border-top:1px solid #222;
}

/* comune box */
#comuneBox{
  margin-top:14px; padding-top:10px;
  border-top:1px solid #222;
}
#comuneBox h4{
  margin:0 0 6px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#9ef5d9;
}
#farm-count{ font-size:12px; margin-bottom:0; color:#e6e6e6; }
#comuneStats{
  margin-top:8px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}

/* tools */
#toolsBox{
  margin-top:14px; padding-top:10px;
  border-top:1px solid #222;
}
#toolsBox h4{
  margin:0 0 6px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#9ef5d9;
}
.toolRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0; }
.toolBtn{
  border:1px solid #00ff9c;
  background:#041812; color:#eafff7;
  font-size:11px; padding:8px 10px; cursor:pointer;
}
.toolBtn:hover{ background:#00ff9c; color:#00110b; }
.toolBtn.danger{ border-color:#ff4d4d; }
.toolBtn.danger:hover{ background:#ff4d4d; color:#000; }
.toolHint{ font-size:11px; color:#bdbdbd; }
.toolLabel{ font-size:12px; color:#fff; }
#activePharm{ color:#e6e6e6; font-size:12px; margin-top:6px; }

/* legend */
#legend-box{
  margin-top:10px; padding-top:8px;
  border-top:1px solid #222;
}
#legend-box h4{
  margin:8px 0 6px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#cccccc;
}
.legend-row{
  display:flex; align-items:center; gap:8px;
  font-size:11px; margin-bottom:4px;
  color:#e6e6e6;
}
.dot{ width:12px; height:12px; border-radius:50%; }
.triangle{
  width:0; height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-bottom:12px solid;
}
.square{ width:12px; height:12px; border-radius:2px; }
.leg-coperto{ background:#00ff9c; }
.leg-orfano{ background:#ffaa00; }

/* workflow colors */
.st-non_contattata{ background:#ffaa00; border-bottom-color:#ffaa00; }
.st-in_trattativa{ background:#4da6ff; border-bottom-color:#4da6ff; }
.st-aderisce_informativa{ background:#00ff9c; border-bottom-color:#00ff9c; }
.st-aderisce_poster{ background:#00ff9c; border-bottom-color:#00ff9c; }
.st-aderisce_boicotta{ background:#00ff9c; border-bottom-color:#00ff9c; }
.st-non_aderisce{ background:#ff4d4d; border-bottom-color:#ff4d4d; }

/* markers */
.mrk-wrap{ position:relative; width:16px; height:16px; }
.mrk-dot{
  width:16px; height:16px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  color:#00110b; font-weight:900; font-size:10px;
}
.mrk-dot.darkText{ color:#00110b; }
.mrk-dot.lightText{ color:#ffffff; }

.mrk-tri{
  width:0; height:0;
  border-left:9px solid transparent;
  border-right:9px solid transparent;
  border-bottom:16px solid;
}
.mrk-tri-label{
  position:absolute; left:50%; top:1px;
  transform:translateX(-50%);
  font-weight:900; font-size:10px;
  color:#00110b;
}
.mrk-closed{
  opacity:.25;
  filter: grayscale(50%);
}

/* label comuni */
.label-comune{
  color:#ffffff; font-size:11px;
  text-shadow:0 0 6px rgba(0,0,0,.9);
  pointer-events:none;
}
.leaflet-interactive{ cursor:pointer; }

/* popup inputs */
.popupBox{ font-size:12px; line-height:1.35; }
.popupBox .meta{ opacity:.9; }
.popupBox .row{ margin-top:8px; }
.popupBox label{ display:block; font-size:11px; color:#bdbdbd; margin-bottom:4px; letter-spacing:.04em; text-transform:uppercase; }
.popupBox input, .popupBox select, .popupBox textarea{
  width:100%;
  box-sizing:border-box;
  background:#0e0e0e;
  border:1px solid #1f1f1f;
  color:#fff;
  padding:8px;
  border-radius:6px;
  font-size:13px;
}
.popupBox textarea{ min-height:70px; resize:vertical; }
.popupBox .btnRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
.popupBox button{
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:12px;
  padding:8px 10px;
  cursor:pointer;
  border-radius:8px;
}
.popupBox button:hover{ background:#00ff9c; color:#00110b; }
.popupBox button.danger{ border-color:#ff4d4d; }
.popupBox button.danger:hover{ background:#ff4d4d; color:#000; }

/* MOBILE LAYOUT */
body.mobile #hud{
  top:auto; left:12px; right:12px; bottom:12px;
  min-width:unset; max-width:unset;
  max-height:55vh;
  border-left:none;
  border-top:3px solid #00ff9c;
}
body.mobile .hud-title{ font-size:16px; }
body.mobile .stat-value{ font-size:20px; }
body.mobile #stats{ grid-template-columns:1fr 1fr; }
body.mobile #banner{ font-size:12px; padding:8px 12px; }
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>

<!-- Picker iniziale -->
<div id="modePicker" style="display:none">
  <div id="modeCard">
    <h3>Modalità interfaccia</h3>
    <p>Scegli una modalità. Puoi cambiarla quando vuoi (Reset UI) nel pannello “Strumenti”.</p>
    <div class="modeBtns">
      <button class="modeBtn" id="modeDesktop">DESKTOP</button>
      <button class="modeBtn" id="modeMobile">SMARTPHONE</button>
    </div>
  </div>
</div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div class="hud-chip">GLOBALI</div>
  <div id="stats">
    <div class="stat stat-muted">
      <div class="stat-title">Farmacie totali</div>
      <div class="stat-value" id="cntFarm">0</div>
    </div>
    <div class="stat stat-info">
      <div class="stat-title">Privata / Comunale</div>
      <div class="stat-value" id="cntGest">0 / 0</div>
    </div>

    <div class="stat stat-warn">
      <div class="stat-title">Non contattate</div>
      <div class="stat-value" id="cntNC">0</div>
    </div>
    <div class="stat stat-info">
      <div class="stat-title">In trattativa</div>
      <div class="stat-value" id="cntTR">0</div>
    </div>

    <div class="stat stat-ok">
      <div class="stat-title">Aderisce</div>
      <div class="stat-value" id="cntAD">0</div>
    </div>
    <div class="stat stat-bad">
      <div class="stat-title">Non aderisce</div>
      <div class="stat-value" id="cntNA">0</div>
    </div>
  </div>

  <div id="qualityBox" class="small-note">
    <div id="qLine">Caricamento…</div>
    <div id="qMismatch" style="display:none; margin-top:6px; color:#ffaa00"></div>
  </div>

  <div id="comuneBox">
    <h4>Comune selezionato</h4>
    <div id="farm-count">Farmacie: —</div>
    <div id="comuneStats">
      <div class="stat stat-warn"><div class="stat-title">Non contattate</div><div class="stat-value" id="cNC">—</div></div>
      <div class="stat stat-info"><div class="stat-title">In trattativa</div><div class="stat-value" id="cTR">—</div></div>
      <div class="stat stat-ok"><div class="stat-title">Aderisce</div><div class="stat-value" id="cAD">—</div></div>
      <div class="stat stat-bad"><div class="stat-title">Non aderisce</div><div class="stat-value" id="cNA">—</div></div>
    </div>
    <div class="small-note" style="margin-top:10px">
      <b>Tip:</b> clicca un comune per “mettere a fuoco” i marker (gli altri diventano trasparenti).
    </div>
  </div>

  <div id="toolsBox">
    <h4>Strumenti</h4>
    <div class="toolRow">
      <button class="toolBtn" id="btnResetSel">Reset selezione</button>
      <button class="toolBtn" id="btnResetUI">Reset UI</button>
    </div>

    <div id="activePharm">Farmacia selezionata: <b>nessuna</b></div>
    <div class="toolRow">
      <button class="toolBtn danger" id="btnToggleClosed" disabled>Segna chiusa temporaneamente</button>
      <span class="toolHint">Quando è “chiusa”, l’unica azione è “Segna riaperta”.</span>
    </div>
  </div>

  <div id="legend-box">
    <h4>Legenda gestione</h4>
    <div class="legend-row"><span class="dot st-non_contattata"></span> Privata (cerchio)</div>
    <div class="legend-row"><span class="triangle st-non_contattata"></span> Comunale (triangolo)</div>

    <h4>Legenda avanzamento</h4>
    <div class="legend-row"><span class="dot st-non_contattata"></span> Non contattata</div>
    <div class="legend-row"><span class="dot st-in_trattativa"></span> In trattativa</div>
    <div class="legend-row"><span class="dot st-aderisce_informativa"></span> Aderisce – informativa</div>
    <div class="legend-row"><span class="dot st-aderisce_poster"></span> Aderisce – poster/visibile</div>
    <div class="legend-row"><span class="dot st-aderisce_boicotta"></span> Aderisce – boicotta (stop fornitura)</div>
    <div class="legend-row"><span class="dot st-non_aderisce"></span> Non aderisce</div>

    <h4>Note</h4>
    <div class="legend-row"><span class="dot st-non_contattata" style="opacity:.25"></span> Chiusa temporaneamente</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===============================
   CONFIG
================================ */
const PATH_COMUNI = "data/comuni_verona.json";
const PATH_FARMACIE = "data/farmacie.csv";
const PATH_STATS = "data/farmacie_stats_comune.csv";

const STATUS_STORAGE_KEY = "spg_status_farmacie_v1";
const UI_MODE_KEY = "spg_ui_mode_v1";

/* workflow status (dinamico) */
const WORKFLOW = [
  { key:"non_contattata", label:"Non contattata", glyph:"", cls:"st-non_contattata" },
  { key:"in_trattativa", label:"In trattativa", glyph:"", cls:"st-in_trattativa" },
  { key:"aderisce_informativa", label:"Aderisce – informativa", glyph:"i", cls:"st-aderisce_informativa" },
  { key:"aderisce_poster", label:"Aderisce – poster/visibile", glyph:"P", cls:"st-aderisce_poster" },
  { key:"aderisce_boicotta", label:"Aderisce – boicotta", glyph:"B", cls:"st-aderisce_boicotta" },
  { key:"non_aderisce", label:"Non aderisce", glyph:"X", cls:"st-non_aderisce" },
];

/* ===============================
   UI MODE
================================ */
function applyMode(mode){
  document.body.classList.toggle("mobile", mode === "mobile");
  localStorage.setItem(UI_MODE_KEY, mode);
}
function showModePicker(){
  document.getElementById("modePicker").style.display = "flex";
}
function hideModePicker(){
  document.getElementById("modePicker").style.display = "none";
}
(function initMode(){
  const saved = localStorage.getItem(UI_MODE_KEY);
  if(saved === "desktop" || saved === "mobile"){
    applyMode(saved);
    return;
  }
  showModePicker();
  document.getElementById("modeDesktop").onclick = () => { applyMode("desktop"); hideModePicker(); };
  document.getElementById("modeMobile").onclick = () => { applyMode("mobile"); hideModePicker(); };
})();

/* ===============================
   MAPPA BASE
================================ */
const map = L.map('map',{ attributionControl:false }).setView([45.43,10.99],10);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

const banner = document.getElementById('banner');
const hudTitle = document.getElementById('hudTitle');
const hudSub = document.getElementById('hudSub');

const qLine = document.getElementById('qLine');
const qMismatch = document.getElementById('qMismatch');

/* ===============================
   DATI / STATO (LOCALSTORAGE)
================================ */
function loadStatus(){
  try { return JSON.parse(localStorage.getItem(STATUS_STORAGE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveStatus(obj){
  try { localStorage.setItem(STATUS_STORAGE_KEY, JSON.stringify(obj)); }
  catch(e){ alert("Impossibile salvare nel browser (localStorage)."); }
}
let statusDB = loadStatus(); // farmacia_id -> { workflow, incaricato, note, closed_override, updated_at }

/* ===============================
   COMUNI (GEOJSON)
================================ */
const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
function normKey(s){
  return (s || '')
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ');
}
const comuneCanonByNorm = {};
const layersByNome = {};
let selectedLayer = null;
let selectedComune = null;
let selectedZoomRef = null;

const labels = [];
const comuniSet = new Set();

/* ===============================
   FARMACIE (MARKERS)
================================ */
const farmLayer = L.layerGroup().addTo(map);
const farmMarkers = []; // { marker, comune, gestione, farmacia_id, row }

function parseCoord(x){
  if(x === null || x === undefined) return NaN;
  const s = String(x).trim().replace(",", ".");
  return parseFloat(s);
}
function inProvinceLatLon(lat, lon){
  return lat >= 44.7 && lat <= 46.2 && lon >= 9.8 && lon <= 11.9;
}

function getWorkflowRec(farmacia_id){
  if(!statusDB[farmacia_id]){
    statusDB[farmacia_id] = {
      workflow: "non_contattata",
      incaricato: "",
      note: "",
      closed_override: null, // true/false/null
      updated_at: null
    };
    saveStatus(statusDB);
  }
  return statusDB[farmacia_id];
}

function effectiveClosed(row, rec){
  const baseClosed = String(row.stato_attivita || "").toLowerCase().trim() === "chiusa_temporaneamente";
  if(rec.closed_override === true) return true;
  if(rec.closed_override === false) return false;
  return baseClosed;
}

function wfMeta(key){
  return WORKFLOW.find(x => x.key === key) || WORKFLOW[0];
}

function mapsUrl(row){
  const s = (row.maps_share_url || "").toString().trim();
  if(s) return s;
  const a = (row.maps_url_addr || "").toString().trim();
  if(a) return a;
  return (row.maps_url_coords || "").toString().trim();
}

/* marker icon */
function farmaciaIcon(row, rec){
  const gestione = (row.gestione || "").toString().toLowerCase().trim();
  const wf = wfMeta(rec.workflow);
  const closed = effectiveClosed(row, rec);

  const glyph = wf.glyph || "";
  const isLightText = (wf.key === "non_aderisce");
  const textCls = isLightText ? "lightText" : "darkText";

  if(gestione === "comunale"){
    const html = `
      <div class="mrk-wrap ${closed ? "mrk-closed":""}">
        <div class="mrk-tri ${wf.cls}"></div>
        <div class="mrk-tri-label">${glyph}</div>
      </div>
    `;
    return L.divIcon({ className:"", html: html, iconSize:[18,18], iconAnchor:[9,18] });
  }

  const html = `<div class="mrk-dot ${wf.cls} ${textCls} ${closed ? "mrk-closed":""}">${glyph}</div>`;
  return L.divIcon({ className:"", html: html, iconSize:[16,16], iconAnchor:[8,8] });
}

function popupHtml(row, rec){
  const nome = (row.descrizione_farmacia || row.nome || "Farmacia").toString().trim();
  const comune = (row.comune || "").toString().trim();
  const gestione = (row.gestione || "").toString().trim();
  const addr = (row.indirizzo_full || row.indirizzo || "").toString().trim();
  const cap = (row.cap || "").toString().trim();
  const url = mapsUrl(row);
  const stAtt = (row.stato_attivita || "").toString().trim();

  const closed = effectiveClosed(row, rec);

  const wf = wfMeta(rec.workflow);
  const wfOptions = WORKFLOW.map(w => `<option value="${w.key}" ${w.key===rec.workflow?"selected":""}>${w.label}</option>`).join("");

  const closedNote = closed
    ? `<div style="margin-top:8px; color:#ffaa00; font-size:12px"><b>⚠ Segnata come CHIUSA temporaneamente</b></div>`
    : "";

  const fixedClosed = (String(stAtt).toLowerCase() === "chiusa_temporaneamente")
    ? `<div style="margin-top:6px; color:#ffaa00; font-size:11px">Dato sorgente: stato_attivita = chiusa_temporaneamente</div>`
    : "";

  if(closed){
    return `
      <div class="popupBox" data-fid="${row.farmacia_id}">
        <div><strong>${nome}</strong></div>
        <div class="meta">${gestione}${addr ? " – " + addr : ""}${cap ? " – " + cap : ""}<br/>${comune}</div>
        ${closedNote}
        ${fixedClosed}
        <div class="row" style="margin-top:10px">
          <a href="${url}" target="_blank" rel="noopener">Apri in Google Maps</a>
        </div>
        <div class="btnRow">
          <button class="danger" data-action="reopen">Segna riaperta</button>
        </div>
      </div>
    `;
  }

  return `
    <div class="popupBox" data-fid="${row.farmacia_id}">
      <div><strong>${nome}</strong></div>
      <div class="meta">${gestione}${addr ? " – " + addr : ""}${cap ? " – " + cap : ""}<br/>${comune}</div>
      ${fixedClosed}
      <div class="row">
        <a href="${url}" target="_blank" rel="noopener">Apri in Google Maps</a>
      </div>

      <div class="row">
        <label>Avanzamento</label>
        <select data-field="workflow">${wfOptions}</select>
      </div>

      <div class="row">
        <label>Incaricato</label>
        <input data-field="incaricato" placeholder="Nome (chi se ne prende carico)" value="${(rec.incaricato||"").replace(/"/g,"&quot;")}">
      </div>

      <div class="row">
        <label>Note</label>
        <textarea data-field="note" placeholder="Poster? BDS? note operative…">${(rec.note||"").replace(/</g,"&lt;")}</textarea>
      </div>

      <div class="btnRow">
        <button data-action="save">Salva</button>
        <button class="danger" data-action="close">Segna chiusa temporaneamente</button>
      </div>
      <div class="small-note">Salvataggio: nel browser (localStorage). Niente file da aggiornare manualmente.</div>
    </div>
  `;
}

/* ===============================
   CONTATORI
================================ */
function allFarmRows(){
  return farmMarkers.map(x => x.row);
}
function countBy(filterFn){
  return farmMarkers.filter(filterFn).length;
}
function wfCounts(markers){
  const out = { non_contattata:0, in_trattativa:0, aderisce:0, non_aderisce:0 };
  markers.forEach(m => {
    const rec = getWorkflowRec(m.farmacia_id);
    const w = rec.workflow || "non_contattata";
    if(w === "non_aderisce") out.non_aderisce++;
    else if(w === "in_trattativa") out.in_trattativa++;
    else if(w === "non_contattata") out.non_contattata++;
    else out.aderisce++; // tutte le varianti aderisce_*
  });
  return out;
}
function updateGlobalCounters(){
  const tot = farmMarkers.length;
  const nPriv = countBy(m => (m.gestione||"").toLowerCase().trim() === "privata");
  const nCom = countBy(m => (m.gestione||"").toLowerCase().trim() === "comunale");

  const c = wfCounts(farmMarkers);
  document.getElementById("cntFarm").innerText = tot;
  document.getElementById("cntGest").innerText = `${nPriv} / ${nCom}`;
  document.getElementById("cntNC").innerText = c.non_contattata;
  document.getElementById("cntTR").innerText = c.in_trattativa;
  document.getElementById("cntAD").innerText = c.aderisce;
  document.getElementById("cntNA").innerText = c.non_aderisce;
}
function updateComuneCounters(){
  if(!selectedComune){
    document.getElementById("farm-count").innerText = "Farmacie: —";
    ["cNC","cTR","cAD","cNA"].forEach(id => document.getElementById(id).innerText = "—");
    return;
  }
  const subset = farmMarkers.filter(m => m.comune === selectedComune);
  document.getElementById("farm-count").innerText = "Farmacie: " + subset.length;
  const c = wfCounts(subset);
  document.getElementById("cNC").innerText = c.non_contattata;
  document.getElementById("cTR").innerText = c.in_trattativa;
  document.getElementById("cAD").innerText = c.aderisce;
  document.getElementById("cNA").innerText = c.non_aderisce;
}

/* ===============================
   COMUNI STILI + LABELS
   (manteniamo solo referenti per ora: se non c'è, tratteggiato)
================================ */
const referenti = { "Verona": ["Vincenzo R."] };
const hasRef = n => referenti[n] && referenti[n].length > 0;

function styleComuneBase(nome){
  const ref = hasRef(nome);
  return {
    color: ref ? '#00ff9c' : '#ffaa00',
    weight: ref ? 2 : 1,
    dashArray: ref ? null : '5 5',
    fillColor: '#00ff9c',
    fillOpacity: ref ? 0.08 : 0
  };
}
function aggiornaStiliComuni(){
  Object.keys(layersByNome).forEach(n => {
    const layer = layersByNome[n];
    let st = styleComuneBase(n);
    if(selectedLayer && layer === selectedLayer){
      st = { ...st, color:'#ffffff', weight:3, dashArray:null, fillOpacity:0 };
    }
    layer.setStyle(st);
  });
}
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    const show = (!selectedComune && z >= 9 && z <= 13);
    if(show){ if(!map.hasLayer(l)) map.addLayer(l); }
    else { if(map.hasLayer(l)) map.removeLayer(l); }
  });
}

/* ===============================
   SELEZIONE COMUNE
================================ */
function resetSelezione(){
  selectedLayer = null;
  selectedComune = null;
  selectedZoomRef = null;

  hudTitle.innerText = "Provincia di Verona";
  hudSub.innerText = "Vista generale";
  banner.style.display = "none";

  farmMarkers.forEach(x => x.marker.setOpacity(1));
  updateComuneCounters();
  aggiornaStiliComuni();
  aggiornaLabels();
}
function selezionaComune(layer, nome){
  selectedLayer = layer;
  selectedComune = nome;

  aggiornaStiliComuni();

  map.fitBounds(layer.getBounds(), { padding:[40,40] });
  map.once("moveend", () => { selectedZoomRef = map.getZoom(); });

  hudTitle.innerText = "Comune di " + nome;
  hudSub.innerText = hasRef(nome) ? ("Referenti: " + referenti[nome].length) : "⚠ Comune orfano";

  banner.style.display = "block";
  banner.innerHTML = "↑ Comune di <b>" + nome + "</b>";

  aggiornaLabels();

  farmMarkers.forEach(x => x.marker.setOpacity(x.comune === nome ? 1 : 0.18));
  updateComuneCounters();
}

/* ===============================
   POPUP WIRING
================================ */
let activeFarmaciaId = null;

function setActiveFarmacia(fid){
  activeFarmaciaId = fid;
  const label = document.querySelector("#activePharm b");
  if(!fid){
    label.textContent = "nessuna";
    const b = document.getElementById("btnToggleClosed");
    b.disabled = true;
    b.textContent = "Segna chiusa temporaneamente";
    return;
  }
  const m = farmMarkers.find(x => x.farmacia_id === fid);
  label.textContent = m ? (m.row.descrizione_farmacia || "Farmacia") : fid;

  const rec = getWorkflowRec(fid);
  const closed = m ? effectiveClosed(m.row, rec) : false;
  const b = document.getElementById("btnToggleClosed");
  b.disabled = false;
  b.textContent = closed ? "Segna riaperta" : "Segna chiusa temporaneamente";
  b.classList.toggle("danger", !closed);
}

function refreshMarkerIcon(fid){
  const m = farmMarkers.find(x => x.farmacia_id === fid);
  if(!m) return;
  const rec = getWorkflowRec(fid);
  m.marker.setIcon(farmaciaIcon(m.row, rec));
}

function attachPopupHandlers(popupEl){
  const fid = popupEl.getAttribute("data-fid");
  if(!fid) return;
  setActiveFarmacia(fid);

  popupEl.addEventListener("click", (ev) => {
    const btn = ev.target.closest("button");
    if(!btn) return;
    const action = btn.getAttribute("data-action");
    if(!action) return;

    const rec = getWorkflowRec(fid);
    const m = farmMarkers.find(x => x.farmacia_id === fid);
    if(!m) return;

    if(action === "reopen"){
      rec.closed_override = false;
      rec.updated_at = new Date().toISOString();
      statusDB[fid] = rec;
      saveStatus(statusDB);
      refreshMarkerIcon(fid);
      m.marker.setPopupContent(popupHtml(m.row, rec));
      updateGlobalCounters();
      updateComuneCounters();
      setActiveFarmacia(fid);
      return;
    }

    if(action === "close"){
      rec.closed_override = true;
      rec.updated_at = new Date().toISOString();
      statusDB[fid] = rec;
      saveStatus(statusDB);
      refreshMarkerIcon(fid);
      m.marker.setPopupContent(popupHtml(m.row, rec));
      updateGlobalCounters();
      updateComuneCounters();
      setActiveFarmacia(fid);
      return;
    }

    if(action === "save"){
      const wf = popupEl.querySelector('[data-field="workflow"]')?.value || "non_contattata";
      const inc = popupEl.querySelector('[data-field="incaricato"]')?.value || "";
      const note = popupEl.querySelector('[data-field="note"]')?.value || "";

      rec.workflow = wf;
      rec.incaricato = inc;
      rec.note = note;
      rec.updated_at = new Date().toISOString();

      statusDB[fid] = rec;
      saveStatus(statusDB);

      refreshMarkerIcon(fid);
      updateGlobalCounters();
      updateComuneCounters();

      // aggiorna header comune
      if(selectedComune){
        const nRef = hasRef(selectedComune) ? referenti[selectedComune].length : 0;
        hudSub.innerText = hasRef(selectedComune) ? ("Referenti: " + nRef) : "⚠ Comune orfano";
      }
      return;
    }
  });
}

/* ===============================
   STRUMENTI
================================ */
document.getElementById("btnResetSel").onclick = () => resetSelezione();
document.getElementById("btnResetUI").onclick = () => { localStorage.removeItem(UI_MODE_KEY); location.reload(); };

document.getElementById("btnToggleClosed").onclick = () => {
  if(!activeFarmaciaId) return;
  const m = farmMarkers.find(x => x.farmacia_id === activeFarmaciaId);
  if(!m) return;

  const rec = getWorkflowRec(activeFarmaciaId);
  const closed = effectiveClosed(m.row, rec);

  rec.closed_override = closed ? false : true;
  rec.updated_at = new Date().toISOString();
  statusDB[activeFarmaciaId] = rec;
  saveStatus(statusDB);

  refreshMarkerIcon(activeFarmaciaId);
  // aggiorna popup se aperto
  if(m.marker.isPopupOpen()){
    m.marker.setPopupContent(popupHtml(m.row, rec));
  }
  updateGlobalCounters();
  updateComuneCounters();
  setActiveFarmacia(activeFarmaciaId);
};

/* ===============================
   CARICAMENTO DATI
================================ */
async function loadStatsByComune(){
  return new Promise(resolve => {
    Papa.parse(PATH_STATS, {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete:(res)=>{
        const map = {};
        (res.data||[]).forEach(r=>{
          const comune = (r.comune||"").toString().trim();
          if(!comune) return;
          map[normKey(comune)] = {
            n_farmacie: parseInt(r.n_farmacie || r.n || "0", 10) || 0
          };
        });
        resolve(map);
      },
      error:()=> resolve({})
    });
  });
}

async function loadFarmacie(statsMap){
  return new Promise(resolve => {
    Papa.parse(PATH_FARMACIE, {
      download:true,
      header:true,
      skipEmptyLines:true,
      complete:(res)=>{
        const rows = res.data || [];
        let added = 0;
        let badCoords = 0;
        let comuneMismatch = 0;
        const perComuneLoaded = {};

        rows.forEach(row=>{
          const fid = (row.farmacia_id || "").toString().trim();
          if(!fid) return;

          const comuneRaw = (row.comune || "").toString().trim();
          if(!comuneRaw) return;
          const comune = comuneCanonByNorm[normKey(comuneRaw)] || comuneRaw;
          if(!comuneCanonByNorm[normKey(comuneRaw)]) comuneMismatch++;

          const lat = parseCoord(row.latitudine);
          const lon = parseCoord(row.longitudine);
          if(!isFinite(lat) || !isFinite(lon) || !inProvinceLatLon(lat, lon)){
            badCoords++;
            return; // in questa versione: salto se coordinate non valide
          }

          const gestione = (row.gestione || "").toString().trim();

          const rec = getWorkflowRec(fid);

          const marker = L.marker([lat, lon], { icon: farmaciaIcon(row, rec) });

          marker.on("popupopen", (e)=>{
            const el = e.popup.getElement()?.querySelector(".popupBox");
            if(el) attachPopupHandlers(el);
          });

          marker.on("click", ()=>{
            setActiveFarmacia(fid);
          });

          marker.bindPopup(popupHtml(row, rec), { maxWidth: 360 });

          marker.addTo(farmLayer);
          farmMarkers.push({ marker, comune, gestione, farmacia_id: fid, row });
          added++;

          perComuneLoaded[normKey(comune)] = (perComuneLoaded[normKey(comune)] || 0) + 1;
        });

        // quality line
        qLine.innerHTML = `Farmacie caricate: <b>${added}</b> — comuni nel GeoJSON: <b>${comuniSet.size}</b>` +
          (badCoords ? ` — <span style="color:#ffaa00">saltate (coord invalide): ${badCoords}</span>` : "") +
          (comuneMismatch ? ` — <span style="color:#ffaa00">comune non riconosciuto: ${comuneMismatch}</span>` : "");

        // mismatch check vs stats file (se presente)
        if(statsMap && Object.keys(statsMap).length){
          let mism = 0;
          let worst = null;
          Object.keys(statsMap).forEach(k=>{
            const exp = statsMap[k].n_farmacie || 0;
            const got = perComuneLoaded[k] || 0;
            if(exp !== got){
              mism++;
              if(!worst || Math.abs(exp-got) > Math.abs(worst.exp-worst.got)){
                worst = { k, exp, got };
              }
            }
          });
          if(mism){
            qMismatch.style.display = "block";
            const comuneName = comuneCanonByNorm[worst.k] || worst.k;
            qMismatch.textContent = `⚠ Mismatch stats (debug): ${mism} comuni differiscono. Esempio: ${comuneName} attese ${worst.exp}, caricate ${worst.got}.`;
          } else {
            qMismatch.style.display = "none";
          }
        }

        updateGlobalCounters();
        updateComuneCounters();
        resolve();
      }
    });
  });
}

async function loadComuniAndStart(){
  const statsMap = await loadStatsByComune();

  const data = await fetch(PATH_COMUNI).then(r => r.json());
  const geo = L.geoJSON(data, {
    style: f => {
      const n = nomeComune(f.properties);
      comuniSet.add(n);
      comuneCanonByNorm[normKey(n)] = n;
      return styleComuneBase(n);
    },
    onEachFeature: (f, layer) => {
      const nome = nomeComune(f.properties);
      layersByNome[nome] = layer;

      // label
      const center = layer.getBounds().getCenter();
      const label = L.marker(center,{
        icon: L.divIcon({ className:'label-comune', html: nome, iconSize:[140,16] }),
        interactive:false
      }).addTo(map);
      labels.push(label);

      layer.on("click", () => selezionaComune(layer, nome));
    }
  }).addTo(map);

  map.fitBounds(geo.getBounds());
  aggiornaStiliComuni();
  aggiornaLabels();

  map.on("zoomend", () => {
    const z = map.getZoom();
    if(selectedComune && selectedZoomRef !== null && z <= (selectedZoomRef - 0.6)){ resetSelezione(); return; }
    if(selectedComune && z < 9.5){ resetSelezione(); return; }
    aggiornaLabels();
  });

  await loadFarmacie(statsMap);
}

loadComuniAndStart();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona – SpG</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map { position:absolute; inset:0; background:#050505; }

/* BANNER ALTO COMUNE SELEZIONATO */
#banner{
  position:fixed;
  top:0;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  padding:8px 18px;
  border-bottom:3px solid #00ff9c;
  color:#fff;
  font-size:13px;
  display:none;
  z-index:9999;
}

/* HUD COLONNA SINISTRA */
#hud {
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 9998;
  padding: 14px 16px;
  background: rgba(5,5,5,.94);
  border-left: 4px solid #00ff9c;
  min-width: 340px;
  box-shadow: 0 0 20px rgba(0,0,0,.85);
}

.hud-title {
  font-size: 18px;
  font-weight: 650;
  color: #fff;
  text-transform: uppercase;
}
.hud-sub {
  margin-top: 6px;
  font-size: 13px;
  color: #bdbdbd;
}

/* contatori comuni (GLOBALI) */
#stats {
  margin-top: 12px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.stat {
  background: #0e0e0e;
  padding: 8px;
}
.stat-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .12em;
}
.stat-value {
  font-size: 26px;
  font-weight: 700;
}
.stat-ok .stat-value { color:#00ff9c; }
.stat-warn .stat-value { color:#ffaa00; }

/* farmacie (per comune selezionato) */
#farm-box {
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid #222;
}
#farm-box h4 {
  margin: 0 0 6px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #9ef5d9;
}
#farm-count {
  font-size: 12px;
  margin-bottom: 6px;
}

/* LEGENDA COMPLETA */
#legend-box {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid #222;
}
#legend-box h4 {
  margin: 6px 0 4px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #cccccc;
}

.legend-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  margin-bottom: 2px;
}

.dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}
.triangle {
  width: 0; height: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-bottom: 12px solid;
}
.square {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

/* colori stato strutture */
.accetta { background:#00ff9c; border-bottom-color:#00ff9c; }
.in_trattativa { background:#4da6ff; border-bottom-color:#4da6ff; }
.da_contattare { background:#ffaa00; border-bottom-color:#ffaa00; }
.rifiuta { background:#ff4d4d; border-bottom-color:#ff4d4d; }

/* colori legenda comuni */
.leg-coperto { background:#00ff9c; }
.leg-orfano { background:#ffaa00; }

/* simbolo medici / studi */
.med-simbolo {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  border: 2px solid #ffffff;
}

/* buttons referenti */
.hud-buttons {
  margin-top: 12px;
  display: flex;
  gap: 6px;
}
.hud-btn {
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:11px;
  padding:4px 8px;
  cursor:pointer;
}
.hud-btn:hover {
  background:#00ff9c;
  color:#00110b;
}

/* pannello referenti */
.hud-section {
  margin-top: 10px;
  border-top: 1px solid #222;
  padding-top: 6px;
  display: none;
}
.hud-section li {
  font-size: 12px;
  color: #fff;
}

/* label comuni */
.label-comune {
  color: #ffffff;
  font-size: 11px;
  text-shadow: 0 0 6px rgba(0,0,0,.9);
  pointer-events: none;
}

.leaflet-interactive { cursor:pointer }
</style>
</head>

<body>

<div id="map"></div>
<div id="banner"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <!-- CONTATORI GLOBALI -->
  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
  </div>

  <!-- FARMACIE (COMUNE SELEZIONATO) -->
  <div id="farm-box">
    <h4>Farmacie (comune selezionato)</h4>
    <div id="farm-count">0 farmacie</div>
  </div>

  <!-- LEGENDA COMPLETA -->
  <div id="legend-box">
    <h4>Legenda comuni</h4>
    <div class="legend-row">
      <span class="square leg-coperto"></span> Comune con referenti
    </div>
    <div class="legend-row">
      <span class="square leg-orfano"></span> Comune orfano
    </div>

    <h4>Legenda farmacie</h4>
    <div class="legend-row">
      <span class="dot accetta"></span> Privata – favorevole
    </div>
    <div class="legend-row">
      <span class="dot in_trattativa"></span> Privata – in trattativa
    </div>
    <div class="legend-row">
      <span class="dot da_contattare"></span> Privata – da contattare
    </div>
    <div class="legend-row">
      <span class="dot rifiuta"></span> Privata – contraria
    </div>
    <div class="legend-row">
      <span class="triangle accetta"></span> Comunale – favorevole
    </div>
    <div class="legend-row">
      <span class="triangle in_trattativa"></span> Comunale – in trattativa
    </div>
    <div class="legend-row">
      <span class="triangle da_contattare"></span> Comunale – da contattare
    </div>
    <div class="legend-row">
      <span class="triangle rifiuta"></span> Comunale – contraria
    </div>

    <h4>Legenda medici / studi</h4>
    <div class="legend-row">
      <span class="med-simbolo accetta"></span> Medico / studio – favorevole
    </div>
    <div class="legend-row">
      <span class="med-simbolo in_trattativa"></span> Medico / studio – in trattativa
    </div>
    <div class="legend-row">
      <span class="med-simbolo da_contattare"></span> Medico / studio – da contattare
    </div>
    <div class="legend-row">
      <span class="med-simbolo rifiuta"></span> Medico / studio – contrario
    </div>
  </div>

  <!-- PULSANTI REFERENTI -->
  <div class="hud-buttons">
    <button class="hud-btn" id="btnAdd">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggle">Vedi referenti</button>
  </div>

  <!-- LISTA REFERENTI COMUNE SELEZIONATO -->
  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* MAPPA BASE */
const map = L.map('map',{ attributionControl:false })
  .setView([45.43,10.99],10);

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  { maxZoom:18 }
).addTo(map);

/* DATI IN MEMORIA (provvisori) */
const referenti = {
  "Verona": ["Vincenzo R."]
};

const farmacie = [
  {
    nome:"Farmacia Centrale",
    comune:"Verona",
    lat:45.438,
    lng:10.992,
    tipo:"privata",
    stato:"accetta",
    indirizzo:"Via Roma 1",
    tel:"045 0000001",
    maps:"https://www.google.com/maps/search/?api=1&query=Farmacia+Centrale+Verona"
  },
  {
    nome:"Farmacia San Zeno",
    comune:"Verona",
    lat:45.443,
    lng:10.980,
    tipo:"comunale",
    stato:"in_trattativa",
    indirizzo:"Piazza Corrubbio",
    tel:"045 0000002",
    maps:"https://www.google.com/maps/search/?api=1&query=Farmacia+San+Zeno+Verona"
  },
  {
    nome:"Farmacia Borgo Roma",
    comune:"Verona",
    lat:45.389,
    lng:10.982,
    tipo:"privata",
    stato:"da_contattare",
    indirizzo:"Via Centro 12",
    tel:"045 0000003",
    maps:"https://www.google.com/maps/search/?api=1&query=Farmacia+Borgo+Roma+Verona"
  }
];

let labels       = [];
let comuni       = [];
let selectedLayer = null;
let refVisibili  = false;
const farmLayer  = L.layerGroup().addTo(map);
const layersByNome = {};

/* RIFERIMENTI HUD / BANNER */
const hudTitle    = document.getElementById('hudTitle');
const hudSub      = document.getElementById('hudSub');
const refPanel    = document.getElementById('refPanel');
const refList     = document.getElementById('refList');
const btnToggle   = document.getElementById('btnToggle');
const farmCountEl = document.getElementById('farm-count');
const banner      = document.getElementById('banner');

const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
const hasRef     = n => referenti[n] && referenti[n].length > 0;

/* CONTATORI GLOBALI */
function aggiornaContatori(){
  const tutti    = comuni;
  const coperti  = tutti.filter(n => hasRef(n)).length;
  const orfani   = tutti.length - coperti;
  document.getElementById('cntOk').innerText     = coperti;
  document.getElementById('cntOrfani').innerText = orfani;
}

/* STILI COMUNI (in base ai referenti e alla selezione) */
function aggiornaStiliComuni(){
  Object.keys(layersByNome).forEach(n => {
    const layer = layersByNome[n];
    const ref   = hasRef(n);
    let style = {
      color: ref ? '#00ff9c' : '#ffaa00',
      weight: 1,
      fillColor: ref ? '#00ff9c' : '#000000',
      fillOpacity: ref ? 0.18 : 0
    };
    if (selectedLayer && layer === selectedLayer){
      style.color       = '#ffffff';
      style.weight      = 3;
      style.fillOpacity = 0.28;
    }
    layer.setStyle(style);
  });
}

/* LABEL COMUNI ON/OFF IN BASE A ZOOM E SELEZIONE */
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    if(!selectedLayer && z >= 9 && z <= 13){
      if(!map.hasLayer(l)) map.addLayer(l);
    } else {
      if(map.hasLayer(l)) map.removeLayer(l);
    }
  });
}

/* RESET SELEZIONE */
function resetSelezione(){
  selectedLayer = null;
  hudTitle.innerText = 'Provincia di Verona';
  hudSub.innerText   = 'Vista generale';
  farmLayer.clearLayers();
  farmCountEl.innerText = '0 farmacie';
  refPanel.style.display = 'none';
  refVisibili = false;
  btnToggle.innerText = 'Vedi referenti';
  banner.style.display = 'none';
  aggiornaStiliComuni();
  aggiornaLabels();
}

/* COMUNI */
fetch('data/comuni_verona.json')
  .then(r => r.json())
  .then(data => {

    const layer = L.geoJSON(data,{
      style: f => {
        const n = nomeComune(f.properties);
        if(!comuni.includes(n)) comuni.push(n);
        const ref = hasRef(n);
        return {
          color: ref ? '#00ff9c' : '#ffaa00',
          weight: 1,
          fillColor: ref ? '#00ff9c' : '#000000',
          fillOpacity: ref ? 0.18 : 0
        };
      },
      onEachFeature:(f,layer) => {
        const nome = nomeComune(f.properties);
        layersByNome[nome] = layer;

        const center = layer.getBounds().getCenter();
        const label = L.marker(center,{
          icon: L.divIcon({
            className:'label-comune',
            html: nome,
            iconSize:[120,16]
          }),
          interactive:false
        });
        labels.push(label);
        label.addTo(map);

        layer.on('click', () => selezionaComune(layer,nome));
      }
    }).addTo(map);

    map.fitBounds(layer.getBounds());
    aggiornaContatori();
    aggiornaStiliComuni();
    aggiornaLabels();

    map.on('zoomend', () => {
      const z = map.getZoom();
      // appena fai un po' di zoom-out dal dettaglio, esci dalla selezione
      if(selectedLayer && z <= 12.3){
        resetSelezione();
      } else {
        aggiornaLabels();
      }
    });
  });

/* SELEZIONE COMUNE */
function selezionaComune(layer,nome){
  selectedLayer = layer;
  aggiornaStiliComuni();

  map.fitBounds(layer.getBounds(),{ padding:[40,40] });

  hudTitle.innerText = 'Comune di ' + nome;
  hudSub.innerText   = hasRef(nome)
    ? 'Referenti presenti: ' + referenti[nome].length
    : '⚠ Comune orfano';

  // nascondi labels quando lavoro sul singolo comune
  labels.forEach(l => { if(map.hasLayer(l)) map.removeLayer(l); });

  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + nome +
    '</b> – Referenti: ' + (referenti[nome] ? referenti[nome].length : 0);

  mostraFarmacie(nome);

  if(refVisibili){
    mostraReferenti(nome);
  }
}

/* FARMACIE PER COMUNE */
function mostraFarmacie(comune){
  farmLayer.clearLayers();
  const vis = farmacie.filter(f => f.comune === comune);
  farmCountEl.innerText = vis.length + ' farmacie';

  vis.forEach(f => {
    const simbolo = f.tipo === 'privata'
      ? `<div class="dot ${f.stato}"></div>`
      : `<div class="triangle ${f.stato}"></div>`;

    const popupHtml = `
      <strong>${f.nome}</strong><br/>
      ${f.tipo} – ${f.indirizzo}<br/>
      Tel: ${f.tel}<br/>
      <a href="${f.maps}" target="_blank">Apri in Maps</a><br/>
      <a href="https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm" target="_blank">
        Materiali campagna
      </a>
    `;

    const m = L.marker([f.lat,f.lng],{
      icon: L.divIcon({ html: simbolo, iconSize:[14,14], className:'' })
    }).bindPopup(popupHtml);

    farmLayer.addLayer(m);
  });
}

/* REFERENTI: MOSTRA LISTA */
function mostraReferenti(nome){
  refList.innerHTML = '';
  const lista = referenti[nome] || [];
  lista.forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = lista.length ? 'block' : 'none';
}

/* REFERENTI: AGGIUNGI */
document.getElementById('btnAdd').onclick = () => {
  if(!selectedLayer){
    alert('Seleziona prima un comune sulla mappa');
    return;
  }
  const nomeComuneSel = hudTitle.innerText.replace('Comune di ','');
  const n = prompt('Inserisci il tuo nome (comparirà come referente)');
  if(!n) return;
  if(!referenti[nomeComuneSel]) referenti[nomeComuneSel] = [];
  referenti[nomeComuneSel].push(n);

  hudSub.innerText = 'Referenti presenti: ' + referenti[nomeComuneSel].length;
  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + nomeComuneSel +
    '</b> – Referenti: ' + referenti[nomeComuneSel].length;

  aggiornaContatori();
  aggiornaStiliComuni();

  if(refVisibili){
    mostraReferenti(nomeComuneSel);
  }
};

/* REFERENTI: TOGGLE VEDI/NASCONDI */
document.getElementById('btnToggle').onclick = () => {
  if(!selectedLayer){
    alert('Seleziona prima un comune sulla mappa');
    return;
  }
  refVisibili = !refVisibili;
  btnToggle.innerText = refVisibili ? 'Nascondi referenti' : 'Vedi referenti';

  if(refVisibili){
    const nomeComuneSel = hudTitle.innerText.replace('Comune di ','');
    mostraReferenti(nomeComuneSel);
  } else {
    refPanel.style.display = 'none';
  }
};
</script>

</body>
</html>

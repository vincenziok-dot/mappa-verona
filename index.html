<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Verona – SpG (Farmacie + Status)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui, sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* Banner alto (comune selezionato) */
#banner{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  padding:8px 18px;
  border-bottom:3px solid #00ff9c;
  color:#fff; font-size:13px;
  display:none; z-index:9999;
  max-width: calc(100% - 24px);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* HUD colonna sinistra */
#hud{
  position:fixed; top:18px; left:18px; z-index:9998;
  padding:14px 16px;
  background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c;
  min-width:330px; max-width:420px;
  box-shadow:0 0 20px rgba(0,0,0,.85);
  max-height: calc(100vh - 36px);
  overflow:auto;
}
.hud-title{ font-size:18px; font-weight:650; color:#fff; text-transform:uppercase; }
.hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

/* Titoli sezione compatti ma più evidenti */
.section-title{
  margin-top:12px;
  display:flex; align-items:center; gap:10px;
}
.section-title .tag{
  font-size:10px; letter-spacing:.16em; text-transform:uppercase;
  color:#9ef5d9; background:#0e0e0e;
  padding:6px 8px; border:1px solid #1f1f1f;
  border-radius:6px;
}
.section-title .line{
  height:1px; flex:1;
  background:linear-gradient(90deg, rgba(158,245,217,.55), rgba(158,245,217,0));
}

/* Stats globali */
#stats{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; border-radius:10px; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:26px; font-weight:750; }
.stat-ok .stat-value{ color:#00ff9c; }
.stat-warn .stat-value{ color:#ffaa00; }
.stat-info .stat-value{ color:#4da6ff; }
.stat-muted .stat-value{ color:#d0d0d0; }

#loadInfo{ margin-top:10px; font-size:11px; color:#bdbdbd; line-height:1.25; }

/* Stats comune selezionato */
#comune-box{
  margin-top:12px; padding-top:10px;
  border-top:1px solid #222;
}
#comune-box h4{
  margin:0 0 6px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#9ef5d9;
}
#farm-count, #farm-private, #farm-comunal, #farm-closed, #farm-assigned {
  font-size:12px; margin:4px 0 0; color:#e6e6e6;
}

/* Legenda */
#legend-box{ margin-top:10px; padding-top:8px; border-top:1px solid #222; }
#legend-box h4{
  margin:8px 0 6px;
  font-size:11px; text-transform:uppercase; letter-spacing:.12em;
  color:#cccccc;
}
.legend-row{ display:flex; align-items:center; gap:8px; font-size:11px; margin-bottom:6px; color:#e6e6e6; }
.dot{ width:12px; height:12px; border-radius:50%; }
.triangle{
  width:0; height:0;
  border-left:7px solid transparent;
  border-right:7px solid transparent;
  border-bottom:12px solid;
}
.square{ width:12px; height:12px; border-radius:2px; }

/* colori stato (per ora: usiamo 4 classi base, e "chiusa" = opacità marker) */
.aderisce{ background:#00ff9c; border-bottom-color:#00ff9c; }
.trattativa{ background:#4da6ff; border-bottom-color:#4da6ff; }
.contattare{ background:#ffaa00; border-bottom-color:#ffaa00; }
.rifiuta{ background:#ff4d4d; border-bottom-color:#ff4d4d; }

.leg-coperto{ background:#00ff9c; }
.leg-orfano{ background:#ffaa00; }

/* pulsanti referenti (sticky in basso) */
.hud-buttons{
  margin-top:12px;
  display:flex; gap:6px; flex-wrap:wrap;
  position:sticky; bottom:0;
  padding-top:10px;
  background: rgba(5,5,5,.96);
  border-top: 1px solid #222;
}
.hud-btn{
  border:1px solid #00ff9c;
  background:#041812; color:#eafff7;
  font-size:11px; padding:8px 10px; cursor:pointer;
  border-radius:10px;
}
.hud-btn:hover{ background:#00ff9c; color:#00110b; }

.hud-section{ margin-top:8px; display:none; padding: 6px 0 0; }
.hud-section li{ font-size:12px; color:#fff; }
.hud-empty{ font-size:12px; color:#bdbdbd; padding: 6px 0 2px; }

/* label comuni */
.label-comune{
  color:#ffffff; font-size:11px;
  text-shadow:0 0 6px rgba(0,0,0,.9);
  pointer-events:none;
}

.leaflet-interactive{ cursor:pointer; }

/* Marker farmacia (divIcon) */
.mrk{ width:14px; height:14px; display:flex; align-items:center; justify-content:center; }
.mrk.dot{ border-radius:50%; }

/* Mobile: HUD come bottom sheet */
@media (max-width: 720px){
  #hud{
    left: 10px; right: 10px;
    top: auto; bottom: 10px;
    min-width: unset; max-width: unset;
    width: auto;
    max-height: 52vh;
    border-left: none;
    border-top: 3px solid #00ff9c;
    border-radius: 14px;
  }
  #banner{ top: 6px; }
}
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div class="section-title"><span class="tag">Globali</span><span class="line"></span></div>
  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
    <div class="stat stat-muted">
      <div class="stat-title">Farmacie</div>
      <div class="stat-value" id="cntFarm">0</div>
    </div>
    <div class="stat stat-info">
      <div class="stat-title">Chiuse temp.</div>
      <div class="stat-value" id="cntClosed">0</div>
    </div>
  </div>

  <div id="loadInfo"></div>

  <div class="section-title"><span class="tag">Comune selezionato</span><span class="line"></span></div>
  <div id="comune-box">
    <h4>Riepilogo</h4>
    <div id="farm-count">Farmacie: —</div>
    <div id="farm-private">Private: —</div>
    <div id="farm-comunal">Comunali: —</div>
    <div id="farm-closed">Chiuse temp.: —</div>
    <div id="farm-assigned">In carico: —</div>
  </div>

  <div class="section-title"><span class="tag">Legenda</span><span class="line"></span></div>
  <div id="legend-box">
    <h4>Comuni</h4>
    <div class="legend-row"><span class="square leg-coperto"></span> Comune con referenti (bordo pieno)</div>
    <div class="legend-row"><span class="square leg-orfano"></span> Comune orfano (bordo tratteggiato)</div>

    <h4>Farmacie</h4>
    <div class="legend-row"><span class="dot contattare"></span> Privata</div>
    <div class="legend-row"><span class="triangle contattare"></span> Comunale</div>
    <div class="legend-row"><span class="dot contattare" style="opacity:.35"></span> Chiusa temporaneamente (marker semitrasparente)</div>

    <h4>Strumenti</h4>
    <div class="legend-row" style="opacity:.9">Clicca una farmacia → modifica “In carico a” e stato “Chiusa temporaneamente”.</div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAddRef">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggleRef">Vedi referenti</button>
  </div>

  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
    <div id="refEmpty" class="hud-empty" style="display:none">Nessun referente inserito.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===============================
   CONFIG
================================ */
const DATA_FARMACIE = 'data/farmacie.csv';               // header atteso: ['farmacia_id', 'descrizione_farmacia', 'gestione', 'indirizzo_full', 'cap', 'comune', 'latitudine', 'longitudine', 'maps_share_url', 'maps_url_addr', 'stato_attivita', 'tipo_punto', 'provincia', 'localita_frazione', 'telefono', 'email', 'data_verifica', 'note_statiche', 'maps_url_coords', 'coord_quality', 'n_farmacie_provincia', 'n_farmacie_comune', 'idx_comune', 'coord_valid']
const DATA_STATS    = 'data/farmacie_stats_comune.csv';  // opzionale (debug)
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm";

/* ===============================
   STATE (RAM + localStorage)
================================ */
const STATUS_KEY = 'spg_farmacie_status_v1';
function loadStatus(){
  try { return JSON.parse(localStorage.getItem(STATUS_KEY) || '{}'); }
  catch(e){ return {}; }
}
function saveStatus(obj){
  try { localStorage.setItem(STATUS_KEY, JSON.stringify(obj)); } catch(e){}
}
let statusRAM = loadStatus(); // pharmacy_id -> {chiusa_temp, chiusa_override, incaricati:[]}

const referenti = { "Verona": ["Vincenzo Russo"] }; // puoi cambiare in seguito

/* ===============================
   MAPPA
================================ */
const map = L.map('map', { attributionControl:false, zoomControl:false }).setView([45.43,10.99], 10);
L.control.zoom({ position:'topright' }).addTo(map);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom:18 }).addTo(map);

const banner      = document.getElementById('banner');
const hudTitle    = document.getElementById('hudTitle');
const hudSub      = document.getElementById('hudSub');
const loadInfo    = document.getElementById('loadInfo');

const farmCountEl   = document.getElementById('farm-count');
const farmPrivEl    = document.getElementById('farm-private');
const farmComEl     = document.getElementById('farm-comunal');
const farmClosedEl  = document.getElementById('farm-closed');
const farmAssignEl  = document.getElementById('farm-assigned');

const refPanel    = document.getElementById('refPanel');
const refList     = document.getElementById('refList');
const refEmpty    = document.getElementById('refEmpty');
const btnToggleRef= document.getElementById('btnToggleRef');

const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
const hasRef     = n => referenti[n] && referenti[n].length > 0;

let labels = [];
let comuniSet = new Set();
let layersByNome = {};
let comuneCanonByNorm = {};
let selectedLayer = null;
let selectedNome = null;
let refVisibili = false;
let selectedZoomRef = null;

const farmLayer = L.layerGroup().addTo(map);
const farmMarkers = []; // { marker, comune, id, gestione, closed }

/* ===============================
   UTIL: normalizza comune (matching GeoJSON)
================================ */
function normKey(s){
  return (s || '')
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ');
}
function canonComune(raw){
  const k = normKey(raw);
  return comuneCanonByNorm[k] || (raw || '').trim();
}

/* ===============================
   CONTATORI
================================ */
function aggiornaContatoriGlobali(){
  const comuni = Array.from(comuniSet);
  const coperti = comuni.filter(n => hasRef(n)).length;
  const orfani = comuni.length - coperti;

  const totalFarm = farmMarkers.length;
  const closed = farmMarkers.filter(x => x.closed).length;

  document.getElementById('cntOk').innerText = coperti;
  document.getElementById('cntOrfani').innerText = orfani;
  document.getElementById('cntFarm').innerText = totalFarm;
  document.getElementById('cntClosed').innerText = closed;
}

function aggiornaContatoriComune(){
  if(!selectedNome){
    farmCountEl.textContent  = 'Farmacie: —';
    farmPrivEl.textContent   = 'Private: —';
    farmComEl.textContent    = 'Comunali: —';
    farmClosedEl.textContent = 'Chiuse temp.: —';
    farmAssignEl.textContent = 'In carico: —';
    return;
  }

  const list = farmMarkers.filter(x => x.comune === selectedNome);
  const tot = list.length;
  const priv = list.filter(x => (x.gestione || '').toLowerCase().includes('priv')).length;
  const comun = list.filter(x => (x.gestione || '').toLowerCase().includes('comun')).length;
  const closed = list.filter(x => x.closed).length;
  const assigned = list.filter(x => ((statusRAM[x.id]?.incaricati || []).length > 0)).length;

  farmCountEl.textContent  = 'Farmacie: ' + tot;
  farmPrivEl.textContent   = 'Private: ' + priv;
  farmComEl.textContent    = 'Comunali: ' + comun;
  farmClosedEl.textContent = 'Chiuse temp.: ' + closed;
  farmAssignEl.textContent = 'In carico: ' + assigned;
}

/* ===============================
   STILI COMUNI
================================ */
function styleComuneBase(nome){
  const ref = hasRef(nome);
  return {
    color: ref ? '#00ff9c' : '#ffaa00',
    weight: ref ? 2 : 1,
    dashArray: ref ? null : '5 5',
    fillColor: '#00ff9c',
    fillOpacity: ref ? 0.10 : 0
  };
}
function aggiornaStiliComuni(){
  Object.keys(layersByNome).forEach(n => {
    const layer = layersByNome[n];
    let st = styleComuneBase(n);
    if (selectedLayer && layer === selectedLayer){
      st = { ...st, color:'#ffffff', weight:3, dashArray:null, fillOpacity:0 };
    }
    layer.setStyle(st);
  });
}

/* ===============================
   LABEL COMUNI
================================ */
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    const show = (!selectedNome && z >= 9 && z <= 13);
    if(show){ if(!map.hasLayer(l)) map.addLayer(l); }
    else { if(map.hasLayer(l)) map.removeLayer(l); }
  });
}

/* ===============================
   OPACITÀ MARKER (selected + chiusa)
================================ */
function applyMarkerOpacity(x){
  const base = x.closed ? 0.35 : 1;
  if(!selectedNome) {
    x.marker.setOpacity(base);
  } else {
    x.marker.setOpacity(x.comune === selectedNome ? base : 0.18);
  }
}

/* ===============================
   RESET / SELEZIONE COMUNE
================================ */
function resetSelezione(){
  selectedLayer = null;
  selectedNome = null;
  selectedZoomRef = null;

  hudTitle.innerText = 'Provincia di Verona';
  hudSub.innerText   = 'Vista generale';
  banner.style.display = 'none';

  farmMarkers.forEach(applyMarkerOpacity);

  refPanel.style.display = 'none';
  refVisibili = false;
  btnToggleRef.innerText = 'Vedi referenti';

  aggiornaStiliComuni();
  aggiornaLabels();
  aggiornaContatoriComune();
}

function selezionaComune(layer, nome){
  selectedLayer = layer;
  selectedNome = nome;

  aggiornaStiliComuni();

  map.fitBounds(layer.getBounds(), { padding:[40,40] });
  map.once('moveend', () => { selectedZoomRef = map.getZoom(); });

  const nRef = (referenti[nome] ? referenti[nome].length : 0);
  hudTitle.innerText = 'Comune di ' + nome;
  hudSub.innerText = hasRef(nome) ? ('Referenti presenti: ' + nRef) : '⚠ Comune orfano';

  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + nome + '</b> – Referenti: ' + nRef;

  aggiornaLabels();

  farmMarkers.forEach(applyMarkerOpacity);
  aggiornaContatoriComune();

  if(refVisibili) mostraReferenti(nome);
}

/* ===============================
   REFERENTI
================================ */
function mostraReferenti(nome){
  refList.innerHTML = '';
  const lista = referenti[nome] || [];
  if(!lista.length){
    refEmpty.style.display = 'block';
    refPanel.style.display = 'block';
    return;
  }
  refEmpty.style.display = 'none';
  lista.forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = 'block';
}

document.getElementById('btnAddRef').onclick = () => {
  if(!selectedNome){ alert('Seleziona prima un comune sulla mappa'); return; }
  const n = prompt('Inserisci il tuo nome (comparirà come referente)');
  if(!n) return;
  if(!referenti[selectedNome]) referenti[selectedNome] = [];
  referenti[selectedNome].push(n);

  const nRef = referenti[selectedNome].length;
  hudSub.innerText = 'Referenti presenti: ' + nRef;
  banner.style.display = 'block';
  banner.innerHTML = '↑ Comune di <b>' + selectedNome + '</b> – Referenti: ' + nRef;

  aggiornaStiliComuni();
  aggiornaContatoriGlobali();
};

document.getElementById('btnToggleRef').onclick = () => {
  if(!selectedNome){ alert('Seleziona prima un comune sulla mappa'); return; }
  refVisibili = !refVisibili;
  btnToggleRef.innerText = refVisibili ? 'Nascondi referenti' : 'Vedi referenti';
  if(refVisibili) mostraReferenti(selectedNome);
  else refPanel.style.display = 'none';
};

/* ===============================
   MARKER ICONS
================================ */
function iconFarmacia(gestione){
  const g = (gestione || '').toLowerCase();
  if(g.includes('comun')){
    return L.divIcon({ className:'', html:`<div class="triangle contattare"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
  }
  return L.divIcon({ className:'', html:`<div class="mrk dot contattare"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
}

/* ===============================
   COORD PARSE (coordinate = "lat, lon")
================================ */
function parseCoordinate(s){
  if(s === null || s === undefined) return null;
  const txt = String(s).trim();
  // supporta "lat, lon" o "lat; lon"
  const parts = txt.split(/[;,]/).map(x => x.trim()).filter(Boolean);
  if(parts.length < 2) return null;
  const lat = parseFloat(parts[0].replace(',', '.'));
  const lon = parseFloat(parts[1].replace(',', '.'));
  if(!isFinite(lat) || !isFinite(lon)) return null;
  return { lat, lon };
}

/* ===============================
   POPUP RENDER (incaricati + chiusa)
================================ */
function ensureStatus(id){
  if(!statusRAM[id]) statusRAM[id] = { incaricati: [], chiusa_temp:false };
  if(!Array.isArray(statusRAM[id].incaricati)) statusRAM[id].incaricati = [];
}

function isClosed(id, rowClosed){
  // rowClosed = boolean da CSV (stato_attivita)
  ensureStatus(id);
  if(statusRAM[id].chiusa_override === 'chiusa') return true;
  if(statusRAM[id].chiusa_override === 'aperta') return false;
  return !!rowClosed;
}

function setClosedOverride(id, closed){
  ensureStatus(id);
  statusRAM[id].chiusa_temp = !!closed;
  statusRAM[id].chiusa_override = closed ? 'chiusa' : 'aperta';
  saveStatus(statusRAM);
}

function popupHtml(row, id, closedNow){
  const nome = String(row.descrizione_farmacia || 'Farmacia').trim();
  const comune = canonComune(String(row.comune || '').trim());
  const indirizzo = String(row.indirizzo_full || '').trim();
  const cap = String(row.cap || '').trim();
  const gestione = String(row.gestione || '').trim();
  const statoAtt = String(row.stato_attivita || '').trim();
  const mapsUrl = String(row.maps_url || '').trim();

  ensureStatus(id);
  const incaricati = statusRAM[id].incaricati || [];

  const incarList = incaricati.length
    ? incaricati.map(n => `<span style="display:inline-flex;align-items:center;gap:6px;margin:3px 6px 0 0;padding:4px 8px;border:1px solid #1f1f1f;border-radius:999px;background:#0e0e0e">
        <span style="font-size:12px">${n}</span>
        <button data-action="rm" data-name="${encodeURIComponent(n)}" style="all:unset;cursor:pointer;color:#ff4d4d;font-weight:800">×</button>
      </span>`).join('')
    : `<span style="color:#bdbdbd">Nessuno</span>`;

  const closedBadge = closedNow
    ? `<div style="margin-top:6px;color:#ffaa00;font-size:12px"><b>⚠ Chiusa temporaneamente</b></div>`
    : '';

  const statoCsvBadge = (statoAtt && statoAtt !== 'attiva' && !closedNow)
    ? `<div style="margin-top:6px;color:#4da6ff;font-size:12px"><b>Stato (CSV):</b> ${statoAtt}</div>`
    : '';

  const tools = closedNow
    ? `<button data-action="reopen" style="margin-top:10px;width:100%;border:1px solid #00ff9c;background:#041812;color:#eafff7;padding:8px 10px;border-radius:10px;cursor:pointer">Segna come RIAPERTA</button>`
    : `<button data-action="close" style="margin-top:10px;width:100%;border:1px solid #ffaa00;background:#1a1204;color:#fff1d6;padding:8px 10px;border-radius:10px;cursor:pointer">Segna CHIUSA temporaneamente</button>`;

  return `
  <div id="popup-${id}" style="min-width:240px">
    <strong>${nome}</strong><br/>
    <div style="opacity:.9">${gestione ? gestione + ' – ' : ''}${indirizzo}${cap ? ', ' + cap : ''} – ${comune}</div>
    ${closedBadge}
    ${statoCsvBadge}

    <div style="margin-top:10px">
      <a href="${mapsUrl}" target="_blank" rel="noopener">Apri in Google Maps</a><br/>
      <a href="${DRIVE_MATERIALI}" target="_blank" rel="noopener">Materiali campagna</a>
    </div>

    <div style="margin-top:10px;padding-top:10px;border-top:1px solid #222">
      <div style="font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:#9ef5d9">In carico a</div>
      <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:0px 0px">${incarList}</div>
      <button data-action="add" style="margin-top:8px;border:1px solid #00ff9c;background:#041812;color:#eafff7;padding:6px 10px;border-radius:10px;cursor:pointer">
        + aggiungi
      </button>
      <button data-action="clear" style="margin-top:8px;margin-left:6px;border:1px solid #444;background:#0e0e0e;color:#e6e6e6;padding:6px 10px;border-radius:10px;cursor:pointer">
        svuota
      </button>
    </div>

    ${tools}
  </div>
  `;
}

function wirePopup(markerObj, row){
  const id = markerObj.id;
  markerObj.marker.on('popupopen', (e) => {
    const rowClosed = String(row.stato_attivita || '').trim() === 'chiusa_temporaneamente';
    const closedNow = isClosed(id, rowClosed);

    e.popup.setContent(popupHtml(row, id, closedNow));

    // listeners
    setTimeout(() => {
      const root = document.getElementById('popup-' + id);
      if(!root) return;

      root.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', () => {
          const act = btn.dataset.action;

          if(act === 'add'){
            const n = prompt('Nome incaricato (puoi inserirne più di uno)');
            if(!n) return;
            ensureStatus(id);
            const name = n.trim();
            if(!name) return;
            if(!statusRAM[id].incaricati.includes(name)) statusRAM[id].incaricati.push(name);
            saveStatus(statusRAM);
            // rerender
            e.popup.setContent(popupHtml(row, id, isClosed(id, rowClosed)));
            wirePopup(markerObj, row); // rewire after rerender
            aggiornaContatoriComune();
            return;
          }

          if(act === 'rm'){
            const name = decodeURIComponent(btn.dataset.name || '');
            ensureStatus(id);
            statusRAM[id].incaricati = (statusRAM[id].incaricati || []).filter(x => x !== name);
            saveStatus(statusRAM);
            e.popup.setContent(popupHtml(row, id, isClosed(id, rowClosed)));
            wirePopup(markerObj, row);
            aggiornaContatoriComune();
            return;
          }

          if(act === 'clear'){
            if(!confirm('Vuoi rimuovere tutti gli incaricati?')) return;
            ensureStatus(id);
            statusRAM[id].incaricati = [];
            saveStatus(statusRAM);
            e.popup.setContent(popupHtml(row, id, isClosed(id, rowClosed)));
            wirePopup(markerObj, row);
            aggiornaContatoriComune();
            return;
          }

          if(act === 'close'){
            setClosedOverride(id, true);
            markerObj.closed = true;
            applyMarkerOpacity(markerObj);
            aggiornaContatoriGlobali();
            aggiornaContatoriComune();
            e.popup.setContent(popupHtml(row, id, true));
            wirePopup(markerObj, row);
            return;
          }

          if(act === 'reopen'){
            setClosedOverride(id, false);
            markerObj.closed = false;
            applyMarkerOpacity(markerObj);
            aggiornaContatoriGlobali();
            aggiornaContatoriComune();
            e.popup.setContent(popupHtml(row, id, false));
            wirePopup(markerObj, row);
            return;
          }
        });
      });
    }, 0);
  });
}

/* ===============================
   LOAD: COMUNI (GeoJSON) + FARMACIE (CSV)
================================ */
fetch('data/comuni_verona.json')
  .then(r => r.json())
  .then(data => {
    const geo = L.geoJSON(data, {
      style: f => {
        const n = nomeComune(f.properties);
        comuniSet.add(n);
        return styleComuneBase(n);
      },
      onEachFeature: (f, layer) => {
        const nome = nomeComune(f.properties);
        layersByNome[nome] = layer;
        comuneCanonByNorm[normKey(nome)] = nome;

        const center = layer.getBounds().getCenter();
        const label = L.marker(center, {
          icon: L.divIcon({ className:'label-comune', html: nome, iconSize:[140,16] }),
          interactive:false
        }).addTo(map);
        labels.push(label);

        layer.on('click', () => selezionaComune(layer, nome));
      }
    }).addTo(map);

    map.fitBounds(geo.getBounds());
    aggiornaStiliComuni();
    aggiornaLabels();
    aggiornaContatoriGlobali();
    aggiornaContatoriComune();

    map.on('zoomend', () => {
      const z = map.getZoom();
      if(selectedNome && selectedZoomRef !== null && z <= (selectedZoomRef - 0.6)){ resetSelezione(); return; }
      if(selectedNome && z < 9.5){ resetSelezione(); return; }
      aggiornaLabels();
    });

    caricaFarmacieCSV();
    caricaStatsSeDisponibili(); // debug / controllo qualità (opzionale)
  });

/* ===============================
   LOAD: FARMACIE
   - marker da "coordinate"
   - popup link da "maps_url"
================================ */
function caricaFarmacieCSV(){
  Papa.parse(DATA_FARMACIE, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      const rows = res.data || [];
      let added = 0, skipped = 0, noComuneMatch = 0, closedCount = 0;

      rows.forEach(row => {
        const id = String(row.farmacia_id || '').trim();
        const comuneRaw = String(row.comune || '').trim();
        const coordStr = row.coordinate || row.coordinate || row.coordinate; // placeholder

        if(!id || !comuneRaw){ skipped++; return; }

        const comune = canonComune(comuneRaw);
        if(!comuneCanonByNorm[normKey(comuneRaw)]) noComuneMatch++;

        const coord = parseCoordinate(row.coordinate || row.coordinate || row.coordinate || row.coordinate); // will be replaced below
      });

      // (We rebuild below to avoid accidental placeholder bugs.)
    }
  });
}

// Re-define with correct parsing (avoid placeholder mistakes in the generated HTML)
function caricaFarmacieCSV(){
  Papa.parse(DATA_FARMACIE, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (res) => {
      const rows = res.data || [];
      let added = 0, skipped = 0, noComuneMatch = 0, closedCount = 0;

      rows.forEach(row => {
        const id = String(row.farmacia_id || '').trim();
        const comuneRaw = String(row.comune || '').trim();
        const coord = parseCoordinate(row.coordinate);
        const mapsUrl = String(row.maps_url || '').trim();
        if(!id || !comuneRaw || !coord || !mapsUrl){ skipped++; return; }

        const comune = canonComune(comuneRaw);
        if(!comuneCanonByNorm[normKey(comuneRaw)]) noComuneMatch++;

        ensureStatus(id);
        const rowClosed = String(row.stato_attivita || '').trim() === 'chiusa_temporaneamente';
        const closedNow = isClosed(id, rowClosed);
        if(closedNow) closedCount++;

        const gestione = String(row.gestione || '').trim();

        const marker = L.marker([coord.lat, coord.lon], { icon: iconFarmacia(gestione) });
        marker.addTo(farmLayer);

        const markerObj = { marker, comune, id, gestione, closed: closedNow };
        farmMarkers.push(markerObj);

        // opacità iniziale
        applyMarkerOpacity(markerObj);

        // popup + strumenti
        wirePopup(markerObj, row);

        added++;
      });

      aggiornaContatoriGlobali();
      aggiornaContatoriComune();

      // se un comune è selezionato, riapplico dim
      farmMarkers.forEach(applyMarkerOpacity);

      loadInfo.innerHTML =
        `Farmacie caricate: <b>${added}</b> (saltate: ${skipped})` +
        ` — comuni nel GeoJSON: ${comuniSet.size}` +
        (noComuneMatch ? `<br/><span style="color:#ffaa00">⚠ Comune non riconosciuto (nome diverso dal GeoJSON): ${noComuneMatch}</span>` : '') +
        (closedCount ? `<br/>Chiuse temporaneamente (attuali): <b>${closedCount}</b>` : '');
    }
  });
}

/* ===============================
   LOAD: STATS (opzionale, per QA)
================================ */
let statsByComune = null;
function caricaStatsSeDisponibili(){
  Papa.parse(DATA_STATS, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      const rows = res.data || [];
      if(!rows.length) return;
      statsByComune = {};
      rows.forEach(r=>{
        const cRaw = String(r.comune || '').trim();
        const c = canonComune(cRaw);
        const n = parseInt(String(r.n_farmacie || '0').trim(),10) || 0;
        statsByComune[c] = n;
      });
      // confronto leggero (solo debug in loadInfo)
      const mismatch = [];
      Object.keys(statsByComune).forEach(c=>{
        const actual = farmMarkers.filter(x=>x.comune===c).length;
        const exp = statsByComune[c];
        if(actual !== exp) mismatch.push([c, exp, actual]);
      });
      if(mismatch.length){
        const ex = mismatch[0];
        loadInfo.innerHTML += `<br/><span style="color:#ffaa00">⚠ Mismatch stats (debug): ${mismatch.length} comuni differiscono. Esempio: ${ex[0]} attese ${ex[1]}, caricate ${ex[2]}.</span>`;
      }
    }
  });
}
</script>
</body>
</html>

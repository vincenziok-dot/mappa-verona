<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona – Comuni SpG</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map { position:absolute; inset:0; background:#050505; }

/* HUD */
#hud {
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 9999;
  padding: 14px 16px;
  background: rgba(5,5,5,.94);
  border-left: 4px solid #00ff9c;
  min-width: 300px;
  box-shadow: 0 0 20px rgba(0,0,0,.8);
}
.hud-title {
  font-size: 18px;
  text-transform: uppercase;
  color: #fff;
  font-weight: 650;
}
.hud-sub { margin-top:6px; font-size:13px; color:#bdbdbd; }

#stats {
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px;
}
.stat {
  font-size:11px;
  background:#0f0f0f;
  padding:6px;
}
.stat strong {
  display:block;
  font-size:18px;
}
.ok strong { color:#00ff9c; }
.warn strong { color:#ffaa00; }

.hud-buttons {
  margin-top:10px;
  display:flex;
  gap:6px;
}
.hud-btn {
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:11px;
  padding:4px 8px;
  cursor:pointer;
}
.hud-btn:hover { background:#00ff9c; color:#00110b; }

.hud-section {
  margin-top:10px;
  border-top:1px solid #222;
  padding-top:6px;
  display:none;
}
.hud-section ul {
  list-style:none;
  padding:0;
  margin:0;
}
.hud-section li {
  font-size:12px;
  color:#fff;
}

/* Etichette comuni */
.label-comune {
  color:#f0f0f0;
  font-size:11px;
  text-shadow:0 0 6px #000;
  pointer-events:none;
}

/* colori stato */
.comune-ok { color:#00ff9c; }
.comune-orfano { color:#ffaa00; }

.leaflet-interactive { cursor:pointer; }
</style>
</head>

<body>

<div id="map"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div id="stats">
    <div class="stat ok"><strong id="cntOk">0</strong>con referente</div>
    <div class="stat warn"><strong id="cntOrfani">0</strong>orfani</div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAdd">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggle">Vedi referenti</button>
  </div>

  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map=L.map('map',{attributionControl:false})
  .setView([45.43,10.99],10);

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  {maxZoom:18}
).addTo(map);

/* ===== REFERENTI (mock) ===== */
const referenti={
  "Verona":["Vincenzo R.","Anna R."]
};

let selectedLayer=null;
let labels=[];
let comuniNomi=[];
let refVisibili=false;

/* ===== HUD ===== */
const hudTitle=document.getElementById('hudTitle');
const hudSub=document.getElementById('hudSub');
const refPanel=document.getElementById('refPanel');
const refList=document.getElementById('refList');

/* ===== UTILS ===== */
const nomeComune=p=>p.nome||p.DENOM_COM||p.name||'Comune';
const hasRef=n=>referenti[n]&&referenti[n].length>0;

/* ===== COMUNI ===== */
fetch('data/comuni_verona.json')
.then(r=>r.json())
.then(data=>{
  const layer=L.geoJSON(data,{
    style:f=>{
      const n=nomeComune(f.properties);
      comuniNomi.push(n);
      return {
        color: hasRef(n) ? '#00ff9c' : '#ffaa00',
        weight:1,
        fillOpacity:0
      };
    },
    onEachFeature:(f,l)=>{
      const nome=nomeComune(f.properties);

      const center=l.getBounds().getCenter();
      const lab=L.marker(center,{
        icon:L.divIcon({
          className:'label-comune '+(hasRef(nome)?'comune-ok':'comune-orfano'),
          html:nome,
          iconSize:[120,16]
        }),
        interactive:false
      }).addTo(map);
      labels.push(lab);

      l.on('click',()=>{
        selezionaComune(l,nome);
      });

      l.on('mouseover',()=>{
        if(l!==selectedLayer) l.setStyle({color:'#fff',weight:2});
      });
      l.on('mouseout',()=>{
        if(l!==selectedLayer)
          l.setStyle({color:hasRef(nome)?'#00ff9c':'#ffaa00',weight:1});
      });
    }
  }).addTo(map);

  map.fitBounds(layer.getBounds());
  aggiornaContatori();

  map.on('zoomend',aggiornaLabelVisibilita);
  aggiornaLabelVisibilita();
});

/* ===== SELEZIONE COMUNE ===== */
function selezionaComune(layer,nome){
  if(selectedLayer){
    const pn=nomeComune(selectedLayer.feature.properties);
    selectedLayer.setStyle({
      color:hasRef(pn)?'#00ff9c':'#ffaa00',
      weight:1
    });
  }
  selectedLayer=layer;

  layer.setStyle({color:'#fff',weight:3});
  map.fitBounds(layer.getBounds(),{padding:[40,40]});

  hudTitle.innerText='Comune di '+nome;
  hudSub.innerText=hasRef(nome)?
    'Referenti presenti: '+referenti[nome].length:
    '⚠ Comune orfano';

  // nascondi label quando un comune è selezionato
  labels.forEach(l=>map.removeLayer(l));

  if(refVisibili) mostraReferenti(nome);
}

/* ===== LABEL VISIBILITA ===== */
function aggiornaLabelVisibilita(){
  if(selectedLayer) return; // se lavoro su un comune, niente label
  const z=map.getZoom();
  labels.forEach(l=>{
    if(z<=12) l.addTo(map);
    else map.removeLayer(l);
  });
}

/* ===== REFERENTI ===== */
function mostraReferenti(nome){
  refList.innerHTML='';
  const lista=referenti[nome]||[];
  if(!lista.length){
    const li=document.createElement('li');
    li.textContent='⚠ Nessun referente';
    li.style.color='#ffaa00';
    refList.appendChild(li);
  } else {
    lista.forEach(r=>{
      const li=document.createElement('li');
      li.textContent=r;
      refList.appendChild(li);
    });
  }
  refPanel.style.display='block';
}

/* ===== BOTTONI ===== */
document.getElementById('btnAdd').onclick=()=>{
  if(!selectedLayer) return alert('Seleziona un comune');
  const nome=hudTitle.innerText.replace('Comune di ','');
  const n=prompt('Inserisci il tuo nome');
  if(!n) return;
  if(!referenti[nome]) referenti[nome]=[];
  referenti[nome].push(n);

  hudSub.innerText='Referenti presenti: '+referenti[nome].length;
  aggiornaContatori();

  if(refVisibili) mostraReferenti(nome);
};

document.getElementById('btnToggle').onclick=()=>{
  refVisibili=!refVisibili;
  document.getElementById('btnToggle').innerText=
    refVisibili?'Nascondi referenti':'Vedi referenti';

  if(refVisibili && selectedLayer){
    mostraReferenti(hudTitle.innerText.replace('Comune di ',''));
  } else {
    refPanel.style.display='none';
  }
};

/* ===== CONTATORI ===== */
function aggiornaContatori(){
  const ok=comuniNomi.filter(n=>hasRef(n)).length;
  document.getElementById('cntOk').innerText=ok;
  document.getElementById('cntOrfani').innerText=comuniNomi.length-ok;
}
</script>

</body>
</html>

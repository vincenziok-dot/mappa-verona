<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map {
  position:absolute;
  inset:0;
  z-index:1;
}

/* OVERLAY SCURO (piÃ¹ leggero) */
#dark-overlay {
  position:absolute;
  inset:0;
  background: radial-gradient(
    circle at center,
    rgba(0,0,0,0.15) 0%,
    rgba(0,0,0,0.35) 55%,
    rgba(0,0,0,0.55) 100%
  );
  pointer-events:none;
  z-index:2;
}

/* HUD */
#hud {
  position: fixed;
  top: 16px;
  left: 16px;
  z-index: 9999;
  width: 330px;
  padding: 16px;
  background: rgba(8,8,8,.95);
  border-left: 4px solid #00ff9c;
  box-shadow: 0 0 22px rgba(0,0,0,.8);
  color:#fff;
}

.hud-title { font-size:18px; font-weight:650; }
.hud-sub { margin-top:6px; font-size:13px; color:#bfbfbf; }

#stats {
  margin-top:12px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.stat {
  font-size:12px;
  padding:8px;
  background:rgba(255,255,255,.05);
}
.stat strong { display:block; font-size:18px; }
.ok strong { color:#00ff9c; }
.warn strong { color:#ffaa00; }

/* BADGE */
.badge {
  margin-top:10px;
  padding:4px 8px;
  font-size:11px;
}
.badge-ok { background:rgba(0,255,156,.15); color:#bfffe8; }
.badge-warn { background:rgba(255,170,0,.25); color:#ffd699; }

/* AZIONI */
.action {
  margin-top:8px;
  padding:8px;
  text-align:center;
  font-size:13px;
  font-weight:600;
  border-radius:4px;
  cursor:pointer;
}
.primary { background:#00ff9c; color:#000; }
.secondary {
  background:#1b1b1b;
  color:#fff;
  border:1px solid #333;
}

/* REFERENTI */
#referentiBox {
  margin-top:10px;
  padding:10px;
  background:#0f0f0f;
  display:none;
  border-left:3px solid #00ff9c;
}
#referentiBox ul {
  margin:6px 0 0;
  padding-left:18px;
}

/* MARKER FARMACIE */
.farmacia-marker {
  width:14px;
  height:14px;
  border-radius:50%;
  border:2px solid #000;
}
.farmacia-da_contattare { background:#ffaa00; }
.farmacia-in_trattativa { background:#4da6ff; }
.farmacia-accetta { background:#00ff9c; }
.farmacia-rifiuta { background:#ff4d4d; }

.label-comune {
  color:rgba(240,240,240,.9);
  font-size:11px;
  text-shadow:0 0 6px #000;
  pointer-events:none;
}

.leaflet-interactive { cursor:pointer }
</style>
</head>

<body>

<div id="map"></div>
<div id="dark-overlay"></div>

<div id="hud">
  <div class="hud-title" id="hud-title">Provincia di Verona</div>
  <div class="hud-sub" id="hud-sub">Seleziona un comune</div>

  <div id="stats">
    <div class="stat ok">
      <strong id="coperti">0</strong>comuni coperti
    </div>
    <div class="stat warn">
      <strong id="orfani">0</strong>comuni orfani
    </div>
    <div class="stat">
      <strong id="farmacieCount">0</strong>farmacie visibili
    </div>
    <div class="stat">
      <strong>â€“</strong>medici/studi
    </div>
  </div>

  <div id="badge" class="badge badge-warn">â€”</div>

  <div id="addBtn" class="action primary" style="display:none">
    âž• Aggiungiti come referente
  </div>

  <div id="toggleBtn" class="action secondary" style="display:none">
    ðŸ‘¤ Vedi referenti
  </div>

  <div id="referentiBox"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== DATI ===== */
const referenti = {
  "Verona": ["Vincenzo R.", "Anna R.", "Luca M."]
};

const farmacie = [
  { nome:"Farmacia Centrale", comune:"Verona", lat:45.438, lng:10.992, stato:"accetta" },
  { nome:"Farmacia San Zeno", comune:"Verona", lat:45.443, lng:10.980, stato:"in_trattativa" },
  { nome:"Farmacia Borgo Roma", comune:"Verona", lat:45.389, lng:10.982, stato:"da_contattare" }
];

let comuneAttivo=null;
let farmacieLayer=L.layerGroup();

/* ===== MAPPA ===== */
const map=L.map('map',{attributionControl:false})
  .setView([45.43,10.99],11);

L.tileLayer(
 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
 {maxZoom:19}
).addTo(map);

farmacieLayer.addTo(map);

/* ===== UTILS ===== */
const nomeComune=p=>p.nome||p.DENOM_COM||p.name||p.COMUNE||'Comune';
const hasRef=c=>referenti[c]&&referenti[c].length>0;

/* ===== FARMACIE ===== */
function mostraFarmacie(comune){
  farmacieLayer.clearLayers();
  const visibili=farmacie.filter(f=>f.comune===comune);
  visibili.forEach(f=>{
    const marker=L.marker([f.lat,f.lng],{
      icon:L.divIcon({
        className:`farmacia-marker farmacia-${f.stato}`,
        iconSize:[14,14]
      })
    }).bindPopup(`<strong>${f.nome}</strong><br/>Stato: ${f.stato}`);
    farmacieLayer.addLayer(marker);
  });
  document.getElementById('farmacieCount').innerText=visibili.length;
}

/* ===== COMUNI ===== */
let labels=[], comuni=[], selected=null;

fetch('data/comuni_verona.json')
.then(r=>r.json())
.then(data=>{
  const layer=L.geoJSON(data,{
    style:f=>{
      const n=nomeComune(f.properties);
      comuni.push(n);
      return {
        color:hasRef(n)?'#00ff9c':'#ffaa00',
        weight:1,
        fillOpacity:0
      };
    },
    onEachFeature:(f,l)=>{
      const nome=nomeComune(f.properties);
      const c=l.getBounds().getCenter();
      const lab=L.marker(c,{
        icon:L.divIcon({className:'label-comune',html:nome,iconSize:[120,14]}),
        interactive:false
      }).addTo(map);
      labels.push(lab);

      l.on('click',()=>{
        if(selected){
          const pn=nomeComune(selected.feature.properties);
          selected.setStyle({
            color:hasRef(pn)?'#00ff9c':'#ffaa00',
            weight:1
          });
        }
        selected=l;
        comuneAttivo=nome;
        l.setStyle({color:'#fff',weight:3});

        map.fitBounds(l.getBounds(),{padding:[40,40]});

        document.getElementById('hud-title').innerText='Comune di '+nome;
        document.getElementById('badge').className=
          'badge '+(hasRef(nome)?'badge-ok':'badge-warn');
        document.getElementById('badge').innerText=
          hasRef(nome)?'Comune coperto':'âš  Comune orfano';

        document.getElementById('addBtn').style.display='block';
        document.getElementById('toggleBtn').style.display=
          hasRef(nome)?'block':'none';

        mostraFarmacie(nome);
      });
    }
  }).addTo(map);

  map.fitBounds(layer.getBounds());

  document.getElementById('coperti').innerText=
    comuni.filter(c=>hasRef(c)).length;
  document.getElementById('orfani').innerText=
    comuni.length-comuni.filter(c=>hasRef(c)).length;

  map.on('zoomend',()=>{
    labels.forEach(l=>map.getZoom()<=11?l.addTo(map):map.removeLayer(l));
  });
});
</script>

</body>
</html>

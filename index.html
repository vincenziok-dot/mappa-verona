<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mappa Verona – SpG (rev2.1)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { margin:0; height:100%; background:#000; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
#map { position:absolute; inset:0; background:#050505; }

/* TOP BANNER (comune selezionato) */
#banner{
  position:fixed; top:0; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.86);
  padding:8px 14px;
  border-bottom:3px solid #00ff9c;
  color:#fff; font-size:13px;
  display:none; z-index:9999;
  max-width: calc(100% - 24px);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* HUD */
#hud{
  position:fixed; top:14px; left:14px; z-index:9998;
  padding:12px 14px;
  background:rgba(5,5,5,.94);
  border-left:4px solid #00ff9c;
  width: min(420px, calc(100vw - 28px));
  box-shadow:0 0 20px rgba(0,0,0,.85);
  max-height: calc(100vh - 28px);
  overflow:auto;
  border-radius: 6px;
}

.hud-title{ font-size:16px; font-weight:750; color:#fff; text-transform:uppercase; letter-spacing:.04em; }
.hud-sub{ margin-top:6px; font-size:13px; color:#bdbdbd; }

.section-chip{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  margin-top:10px;
  font-size:10px; letter-spacing:.14em; text-transform:uppercase;
  color:#9ef5d9; background:#0e0e0e;
  padding:6px 8px; border:1px solid #1f1f1f;
  border-radius: 6px;
}
.section-chip small{ color:#9a9a9a; letter-spacing:.08em; text-transform:none; font-size:11px; }

.grid2{ margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat{ background:#0e0e0e; padding:8px; border:1px solid #1f1f1f; border-radius: 6px; }
.stat-title{ font-size:10px; text-transform:uppercase; letter-spacing:.12em; color:#bdbdbd; }
.stat-value{ font-size:24px; font-weight:800; margin-top:2px; }
.v-green{ color:#00ff9c; }
.v-amber{ color:#ffaa00; }
.v-blue{ color:#4da6ff; }
.v-red{ color:#ff4d4d; }
.v-muted{ color:#d0d0d0; }

#miniLegend{
  margin-top:10px; padding-top:8px;
  border-top:1px solid #222;
}

.legend-row{ display:flex; align-items:center; gap:8px; font-size:12px; color:#e6e6e6; margin:6px 0; }
.badge{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:18px; height:18px; padding:0 6px;
  border-radius:999px;
  background:#141414; border:1px solid #2a2a2a;
  font-size:11px; color:#e6e6e6;
}

.dot{ width:12px; height:12px; border-radius:50%; }
.square{ width:12px; height:12px; border-radius:2px; }

.c-contattare{ background:#ffaa00; }
.c-trattativa{ background:#4da6ff; }
.c-aderisce{ background:#00ff9c; }
.c-rifiuta{ background:#ff4d4d; }
.c-chiusa{ background:#9a9a9a; opacity:.45; }

.c-comune-coperto{ background:#00ff9c; }
.c-comune-orfano{ background:#ffaa00; }

#comuneBox{
  margin-top:12px; padding-top:10px;
  border-top:1px solid #222;
}
#comuneCounts{ margin-top:8px; }
#comuneCounts .stat-value{ font-size:20px; }

.hud-buttons{
  margin-top:12px;
  display:flex; gap:6px; flex-wrap:wrap;
  position:sticky; bottom:0;
  padding-top:10px;
  background: rgba(5,5,5,.96);
  border-top: 1px solid #222;
}
.hud-btn{
  border:1px solid #00ff9c;
  background:#041812; color:#eafff7;
  font-size:12px; padding:8px 10px; cursor:pointer;
  border-radius: 8px;
}
.hud-btn:hover{ background:#00ff9c; color:#00110b; }

#refPanel{ display:none; margin-top:8px; }
#refList{ list-style:none; padding-left: 0; margin:6px 0 0; }
#refList li{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  font-size:12px; color:#fff;
  background:#0e0e0e; border:1px solid #1f1f1f;
  padding:6px 8px; border-radius: 8px;
  margin-bottom:6px;
}
.xbtn{
  width:18px; height:18px;
  border-radius: 6px;
  border:1px solid #333;
  background:#151515; color:#ddd;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  font-size:12px; line-height:12px;
}
.xbtn:hover{ background:#ff4d4d; border-color:#ff4d4d; color:#120000; }

.label-comune{
  color:#ffffff; font-size:11px;
  text-shadow:0 0 6px rgba(0,0,0,.9);
  pointer-events:none;
}

.leaflet-control-zoom{ margin-top: 88px !important; } /* evita sovrapposizione col HUD */
@media (max-width: 720px){
  #hud{ top:auto; bottom:12px; left:12px; right:12px; width:auto; max-height: 56vh; }
  .leaflet-control-zoom{ margin-top: 12px !important; }
}

/* === Marker farmacia (divIcon) === */
.mrk{
  width:14px; height:14px;
  border:1px solid rgba(255,255,255,.18);
  box-shadow: 0 0 12px rgba(0,0,0,.35);
}
.mrk.dot{}
.mrk.sq{border-radius:2px;}
.mrk.contattare{ background:#ffaa00; }
.mrk.trattativa{ background:#4da6ff; }
.mrk.aderisce{ background:#00ff9c; }
.mrk.rifiuta{ background:#ff4d4d; }
.mrk.chiusa{ opacity:.35; filter: grayscale(1); }

/* === Popup farmacia === */
.popupWrap{
  min-width: 260px;
  color:#0b0b0b;
  font-size:13px;
}
.tipoTag{font-size:11px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#ff4d4d;}

.popupWrap h3{
  margin:0 0 6px;
  font-size:14px;
  color:#0b0b0b;
}
.popupMeta{ color:#3b3b3b; font-size:12px; }
.popupDivider{ height:1px; background:#e6e6e6; margin:10px 0; }

.seg{
  display:flex; gap:6px; flex-wrap:wrap;
}
.seg button{
  border:1px solid #d8d8d8;
  background:#ffffff;
  color:#0b0b0b;
  padding:6px 8px;
  font-size:12px;
  border-radius: 10px;
  cursor:pointer;
}
.seg button[data-on="1"]{
  border-color:#0b0b0b;
  background:#0b0b0b;
  color:#ffffff;
}
.seg button.state-contattare[data-on="1"]{ background:#ffaa00; color:#1d1200; border-color:#ffaa00; }
.seg button.state-trattativa[data-on="1"]{ background:#4da6ff; color:#001427; border-color:#4da6ff; }
.seg button.state-aderisce[data-on="1"]{ background:#00ff9c; color:#00110b; border-color:#00ff9c; }
.seg button.state-rifiuta[data-on="1"]{ background:#ff4d4d; color:#250000; border-color:#ff4d4d; }

.flagRow{ display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:#1a1a1a; }
.flagRow label{ display:flex; align-items:center; gap:6px; }

.inlineInput{
  width:100%;
  box-sizing:border-box;
  padding:8px 10px;
  border-radius: 10px;
  border:1px solid #d8d8d8;
  font-size:12px;
}
textarea.inlineInput{ min-height: 64px; resize: vertical; }

.chipBar{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
.chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 8px;
  border-radius: 999px;
  border:1px solid #d8d8d8;
  background:#fff;
  font-size:12px;
  color:#111;
}
.chip .xbtn{ width:16px; height:16px; border-radius: 999px; font-size:11px; }

.popupActions{ display:flex; gap:8px; margin-top:10px; }
.popupActions button{
  flex:1;
  border:1px solid #0b0b0b;
  background:#0b0b0b;
  color:#fff;
  padding:8px 10px;
  font-size:12px;
  border-radius: 10px;
  cursor:pointer;
}
.popupActions button.secondary{
  background:#ffffff;
  color:#0b0b0b;
  border-color:#d8d8d8;
}

.smallLink{ font-size:12px; }
.smallLink a{ color:#0b0b0b; font-weight:700; text-decoration:none; }
.smallLink a:hover{ text-decoration:underline; }
</style>
</head>

<body>
<div id="map"></div>
<div id="banner"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div class="section-chip">Globali <small id="g_hint"></small></div>

  <div class="grid2">
    <div class="stat">
      <div class="stat-title">Farmacie (totali)</div>
      <div class="stat-value v-muted" id="g_total">0</div>
    </div>
    <div class="stat">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value v-green" id="g_comuni_coperti">0</div>
    </div>
    <div class="stat">
      <div class="stat-title">Private</div>
      <div class="stat-value v-muted" id="g_private">0</div>
    </div>
    <div class="stat">
      <div class="stat-title">Comunali</div>
      <div class="stat-value v-muted" id="g_comunali">0</div>
    </div>
  </div>

  <div id="miniLegend">
    <div class="section-chip">Stati <small>colpo d’occhio</small></div>
    <div class="grid2" id="g_statusGrid"></div>

    <div style="margin-top:10px">
      <div class="section-chip">Aderisce <small>dettagli (facoltativi)</small></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
        <span class="badge">Poster <b id="g_poster" style="margin-left:6px">0</b></span>
        <span class="badge">Boicotta <b id="g_boicotta" style="margin-left:6px">0</b></span>
        <span class="badge">Promo <b id="g_promo" style="margin-left:6px">0</b></span>
        <span class="badge">Info <b id="g_info" style="margin-left:6px">0</b></span>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="section-chip">Legenda <small>mappa</small></div>
      <div class="legend-row"><span class="square c-comune-coperto"></span> Comune con referente</div>
      <div class="legend-row"><span class="square c-comune-orfano"></span> Comune orfano</div>
      <div class="legend-row"><span class="dot c-contattare"></span> Da contattare</div>
      <div class="legend-row"><span class="dot c-trattativa"></span> In trattativa</div>
      <div class="legend-row"><span class="dot c-aderisce"></span> Aderisce</div>
      <div class="legend-row"><span class="dot c-rifiuta"></span> Non aderisce</div>
      <div class="legend-row"><span class="dot c-chiusa"></span> Chiusa temporaneamente (solo strumento)</div>
    </div>
  </div>

  <div id="comuneBox">
    <div class="section-chip">Comune selezionato <small id="sel_nome">—</small></div>
    <div class="grid2" id="comuneCounts"></div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAddRef">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggleRef">Vedi referenti</button>
  </div>

  <div id="refPanel">
    <ul id="refList"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ===============================
   CONFIG
================================ */
const DRIVE_MATERIALI = "https://drive.google.com/drive/folders/1oMqJ_6ZLthMK73FkpirBtvQ_Ycif4OYS";
const PATH_FARMACIE = "data/farmacie.csv";
const PATH_COMUNI   = "data/comuni_verona.json";

/* ===============================
   STATUS STORE (localStorage)
   - 1 record per farmacia_id
================================ */
const STATUS_STORE_KEY = "spg_farmacie_status_rev2";
function loadStatusStore(){
  try { return JSON.parse(localStorage.getItem(STATUS_STORE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveStatusStore(obj){
  try { localStorage.setItem(STATUS_STORE_KEY, JSON.stringify(obj)); }
  catch(e){}
}
const statusStore = loadStatusStore();

function defaultStatus(){
  return { state:"contattare", owners:[], note:"", flags:{poster:false, boicotta:false, promo:false, info:false}, closed:false };
}
function getSt(id){
  return statusStore[id] || defaultStatus();
}
function setSt(id, next){
  statusStore[id] = next;
  saveStatusStore(statusStore);
}

/* ===============================
   REFERENTI COMUNE (RAM)
================================ */
const referentiComune = { "Verona": ["Vincenzo Russo"] };
function hasRef(nome){ return (referentiComune[nome] && referentiComune[nome].length>0); }

/* ===============================
   MAPPA
================================ */
const map = L.map("map", { attributionControl:false }).setView([45.43, 10.99], 10);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom:18 }).addTo(map);

const banner   = document.getElementById("banner");
const hudTitle = document.getElementById("hudTitle");
const hudSub   = document.getElementById("hudSub");
const selNomeEl = document.getElementById("sel_nome");

let comuniLayer = null;
let selectedComuneLayer = null;
let selectedComuneNome = null;

/* pharmacy markers */
const farmLayer = L.layerGroup().addTo(map);
const farmMarkers = []; // { id, comune, gestione, marker }

const comuniCanon = new Set(); // dall'GeoJSON

/* label comuni */
const labels = [];
function normKey(s){
  return (s||"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ");
}
const comuneCanonByNorm = {}; // norm -> canon
function esc(s){
  return String(s||"").replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}
function nomeComuneFromFeature(f){
  const p = (f && f.properties) ? f.properties : {};
  return p.nome || p.DENOM_COM || p.name || "Comune";
}
function canonComune(raw){
  const k = normKey(raw);
  return comuneCanonByNorm[k] || (raw||"").trim();
}

/* ===============================
   STILI COMUNI
================================ */
function styleComuneBase(nome){
  const ref = hasRef(nome);
  return {
    color: ref ? "#00ff9c" : "#ffaa00",
    weight: ref ? 2 : 1,
    dashArray: ref ? null : "5 5",
    fillColor: "#00ff9c",
    fillOpacity: ref ? 0.10 : 0
  };
}
function aggiornaStiliComuni(){
  if(!comuniLayer) return;
  comuniLayer.eachLayer(layer => {
    const nome = nomeComuneFromFeature(layer.feature);
    let st = styleComuneBase(nome);
    if(selectedComuneLayer && layer === selectedComuneLayer){
      st = { ...st, color:"#ffffff", weight:3, dashArray:null, fillOpacity:0 };
    }
    layer.setStyle(st);
  });
}

/* ===============================
   MARKER ICON
================================ */
function iconFarmacia(stato, closed, gestione){
  const cls = statusClass(stato);
  const closeCls = closed ? ' closed' : '';
  const g = (gestione||'').toString().toLowerCase();
  const shape = (g.includes('comunal') || g.includes('pubblic')) ? 'sq' : 'dot';
  return L.divIcon({className:'',html:`<div class="mrk ${shape} ${cls}${closeCls}"></div>`,iconSize:[14,14],iconAnchor:[7,7]});
}

function stableId(str){
  let h = 0;
  const s = String(str||"");
  for (let i=0; i<s.length; i++){
    h = ((h<<5) - h) + s.charCodeAt(i);
    h |= 0;
  }
  return String(h);
}

/* ===============================
   POPUP HTML + HANDLERS
================================ */
function buildPopupHtml(row, farmaciaId){
  const st = getSt(farmaciaId);

  const nome = row.descrizione_farmacia || row.nome || "Farmacia";
  const comune = canonComune(row.comune || "");
  const indirizzo = row.indirizzo_full || row.indirizzo || "";
  const cap = row.cap || "";
  const gestione = row.gestione || "";
  const maps = row.maps_url || "";

  const state = st.state || "contattare";
  const owners = Array.isArray(st.owners) ? st.owners : [];
  const note = st.note || "";
  const flags = st.flags || { poster:false, boicotta:false, promo:false, info:false };
  const closed = !!st.closed;

  const stateBtn = (key, label) => `<button class="state-${key}" data-role="state" data-value="${key}" data-on="${key===state?1:0}">${label}</button>`;

  return `
  <div class="popupWrap" data-farm-id="${esc(farmaciaId)}">
    <h3>${esc(nome)}</h3>
    <div class="tipoTag">${isComunale ? "COMUNALE" : "PRIVATA"}</div>
    <div class="popupMeta">${esc(indirizzo)}${cap?` – ${esc(cap)}`:""} – <b>${esc(comune)}</b>${gestione?` · ${esc(gestione)}`:""}</div>

    <div class="popupDivider"></div>

    <div style="font-size:12px; color:#3b3b3b; margin-bottom:6px"><b>Stato</b></div>
    <div class="seg" data-role="stateSeg">
      ${stateBtn("contattare","Da contattare")}
      ${stateBtn("trattativa","In trattativa")}
      ${stateBtn("aderisce","Aderisce")}
      ${stateBtn("rifiuta","Non aderisce")}
    </div>

    <div class="popupDivider"></div>

    <div data-role="aderisceFlags" style="${state==="aderisce"?"":"display:none"}">
      <div style="font-size:12px; color:#3b3b3b; margin-bottom:6px"><b>Dettagli adesione</b> (puoi selezionare più voci)</div>
      <div class="flagRow">
        <label><input type="checkbox" data-flag="boicotta" ${flags.boicotta?"checked":""}/> Boicotta (stop fornitura)</label>
        <label><input type="checkbox" data-flag="poster" ${flags.poster?"checked":""}/> Poster</label>
        <label><input type="checkbox" data-flag="promo" ${flags.promo?"checked":""}/> Promo BDS</label>
        <label><input type="checkbox" data-flag="info" ${flags.info?"checked":""}/> Informativa</label>
      </div>
      <div class="popupDivider"></div>
    </div>

    <div style="font-size:12px; color:#3b3b3b; margin-bottom:6px"><b>Incaricati</b> (puoi aggiungere più nomi)</div>
    <input class="inlineInput" type="text" data-role="ownersInput" placeholder="Es: Marco, Lucia" />
    <div class="chipBar" data-role="ownersChips">
      ${owners.map(o => '<span class="chip">'+esc(o)+' <span class="xbtn" data-role="rmOwner" data-owner="'+esc(o)+'">×</span></span>').join("")}
    </div>

    <div class="popupDivider"></div>

    <div style="font-size:12px; color:#3b3b3b; margin-bottom:6px"><b>Note</b></div>
    <textarea class="inlineInput" data-role="note" placeholder="Es: espone poster NOTEVA, parla ai clienti...">${esc(note)}</textarea>

    <div class="popupDivider"></div>

    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between">
      <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#1a1a1a">
        <input type="checkbox" data-role="closed" ${closed?"checked":""}/>
        Chiusa temporaneamente
      </label>
      <div class="smallLink">
        <a href="${esc(maps)}" target="_blank" rel="noopener">Apri in Maps</a>
        &nbsp;·&nbsp;
        <a href="${esc(DRIVE_MATERIALI)}" target="_blank" rel="noopener">Materiali</a>
      </div>
    </div>

    <div class="popupActions">
      <button data-role="save">Salva</button>
      <button class="secondary" data-role="reset">Annulla</button>
    </div>
  </div>`;
}

function applyStatusToMarker(marker, farmaciaId, row){
  const st = getSt(farmaciaId);
  marker.setIcon(iconFarmacia(st.state, st.closed, row.gestione));
  marker.setOpacity(st.closed ? 0.35 : 1);

  // tooltip rapido
  const nome = row.descrizione_farmacia || "Farmacia";
  const extra = (st.owners && st.owners.length) ? ` · incaricati: ${st.owners.join(", ")}` : "";
  marker.bindTooltip(`${nome}${extra}`, { direction:"top", opacity:0.9, offset:[0,-8] });
}

function attachPopupHandlers(marker, row, farmaciaId){
  const root = marker.getPopup()?.getElement();
  if(!root) return;
  if(root.dataset.bound === "1") return;
  root.dataset.bound = "1";

  const wrap = root.querySelector(".popupWrap");
  if(!wrap) return;

  const ownersInput = wrap.querySelector('[data-role="ownersInput"]');
  const noteEl = wrap.querySelector('[data-role="note"]');
  const closedEl = wrap.querySelector('[data-role="closed"]');
  const flagsBox = wrap.querySelector('[data-role="aderisceFlags"]');

  const getCurrentState = () => {
    const onBtn = wrap.querySelector('button[data-role="state"][data-on="1"]');
    return onBtn ? onBtn.getAttribute("data-value") : "contattare";
  };

  // state buttons
  wrap.querySelectorAll('button[data-role="state"]').forEach(btn => {
    btn.addEventListener("click", () => {
      wrap.querySelectorAll('button[data-role="state"]').forEach(b => b.setAttribute("data-on","0"));
      btn.setAttribute("data-on","1");
      const st = getCurrentState();
      if(flagsBox) flagsBox.style.display = (st==="aderisce") ? "" : "none";
    });
  });

  // remove owner chip (event delegation)
  wrap.addEventListener("click", (ev) => {
    const t = ev.target;
    if(!(t instanceof HTMLElement)) return;
    if(t.getAttribute("data-role") === "rmOwner"){
      const who = t.getAttribute("data-owner") || "";
      const st = getSt(farmaciaId);
      st.owners = (st.owners || []).filter(x => x !== who);
      setSt(farmaciaId, st);

      applyStatusToMarker(marker, farmaciaId, row);
      aggiornaHUD();
      aggiornaComuneSelezionato();

      marker.setPopupContent(buildPopupHtml(row, farmaciaId));
      marker.openPopup();
    }
  });

  // reset button
  const btnReset = wrap.querySelector('[data-role="reset"]');
  if(btnReset){
    btnReset.addEventListener("click", () => marker.closePopup());
  }

  // save button
  const btnSave = wrap.querySelector('[data-role="save"]');
  if(btnSave){
    btnSave.addEventListener("click", () => {
      const prev = getSt(farmaciaId);
      const next = { ...prev };

      next.state = getCurrentState();

      // owners: merge input
      const raw = (ownersInput && ownersInput.value) ? ownersInput.value : "";
      const add = raw.split(",").map(s=>s.trim()).filter(Boolean);
      const merged = [...(next.owners||[])];
      add.forEach(n => { if(!merged.includes(n)) merged.push(n); });
      next.owners = merged;

      next.note = noteEl ? noteEl.value : (next.note||"");
      next.closed = !!(closedEl && closedEl.checked);

      const flags = { ...(next.flags||{poster:false, boicotta:false, promo:false, info:false}) };
      wrap.querySelectorAll('input[type="checkbox"][data-flag]').forEach(cb => {
        const k = cb.getAttribute("data-flag");
        if(k) flags[k] = cb.checked;
      });
      next.flags = flags;

      setSt(farmaciaId, next);

      applyStatusToMarker(marker, farmaciaId, row);
      aggiornaHUD();
      aggiornaComuneSelezionato();

      marker.setPopupContent(buildPopupHtml(row, farmaciaId));
      marker.openPopup();
    });
  }
}

/* ===============================
   STATS
================================ */
const MAIN_STATES = [
  { key:"contattare", label:"Da contattare", cls:"v-amber" },
  { key:"trattativa", label:"Trattativa", cls:"v-blue" },
  { key:"aderisce", label:"Aderisce", cls:"v-green" },
  { key:"rifiuta", label:"Non aderisce", cls:"v-red" },
];

function aggiornaHUD(){
  document.getElementById("g_total").textContent = String(farmMarkers.length);

  const priv = farmMarkers.filter(x => /priv/i.test(String(x.gestione||""))).length;
  const comu = farmMarkers.filter(x => /comun/i.test(String(x.gestione||""))).length;
  document.getElementById("g_private").textContent = String(priv);
  document.getElementById("g_comunali").textContent = String(comu);

  let coperti=0;
  comuniCanon.forEach(n => { if(hasRef(n)) coperti++; });
  document.getElementById("g_comuni_coperti").textContent = String(coperti);

  const grid = document.getElementById("g_statusGrid");
  grid.innerHTML = "";
  for(const s of MAIN_STATES){
    const n = farmMarkers.filter(x => getSt(x.id).state === s.key).length;
    const el = document.createElement("div");
    el.className = "stat";
    el.innerHTML = `<div class="stat-title">${s.label}</div><div class="stat-value ${s.cls}">${n}</div>`;
    grid.appendChild(el);
  }

  // flags among aderisce
  const aderisce = farmMarkers.filter(x => getSt(x.id).state==="aderisce").map(x=>x.id);
  let poster=0, boicotta=0, promo=0, info=0;
  aderisce.forEach(id => {
    const f = (getSt(id).flags)||{};
    if(f.poster) poster++;
    if(f.boicotta) boicotta++;
    if(f.promo) promo++;
    if(f.info) info++;
  });
  document.getElementById("g_poster").textContent = String(poster);
  document.getElementById("g_boicotta").textContent = String(boicotta);
  document.getElementById("g_promo").textContent = String(promo);
  document.getElementById("g_info").textContent = String(info);
}

function aggiornaComuneSelezionato(){
  const grid = document.getElementById("comuneCounts");
  grid.innerHTML = "";
  if(!selectedComuneNome){
    selNomeEl.textContent = "—";
    grid.innerHTML =
      `<div class="stat"><div class="stat-title">Farmacie</div><div class="stat-value v-muted">—</div></div>
       <div class="stat"><div class="stat-title">Seleziona un comune</div><div class="stat-value v-muted">—</div></div>`;
    return;
  }
  selNomeEl.textContent = selectedComuneNome;

  const items = farmMarkers.filter(x => x.comune === selectedComuneNome);
  const total = items.length;
  const priv = items.filter(x => /priv/i.test(String(x.gestione||""))).length;
  const comu = items.filter(x => /comun/i.test(String(x.gestione||""))).length;

  const mk = (title, value, cls="v-muted") => {
    const el=document.createElement("div");
    el.className="stat";
    el.innerHTML=`<div class="stat-title">${title}</div><div class="stat-value ${cls}">${value}</div>`;
    return el;
  };
  grid.appendChild(mk("Farmacie", total, "v-muted"));
  grid.appendChild(mk("Private / Comunali", `${priv} / ${comu}`, "v-muted"));

  for(const s of MAIN_STATES){
    const n = items.filter(x => getSt(x.id).state === s.key).length;
    grid.appendChild(mk(s.label, n, s.cls));
  }
}

/* ===============================
   SELEZIONE COMUNE
================================ */
function selezionaComune(layer, nome){
  selectedComuneLayer = layer;
  selectedComuneNome = nome;

  aggiornaStiliComuni();
  map.fitBounds(layer.getBounds(), { padding:[40,40] });

  banner.style.display="block";
  banner.innerHTML = `↑ Comune di <b>${esc(nome)}</b>`;

  hudTitle.textContent = `Comune di ${nome}`;
  const nRef = hasRef(nome) ? (referentiComune[nome].length) : 0;
  hudSub.textContent = hasRef(nome) ? `Referenti presenti: ${nRef}` : `⚠ Comune orfano`;

  farmMarkers.forEach(x => x.marker.setOpacity((x.comune===nome) ? (getSt(x.id).closed?0.35:1) : 0.18));
  aggiornaComuneSelezionato();
  if(refPanelVisible) renderReferentiPanel();
}

function resetSelezione(){
  selectedComuneLayer = null;
  selectedComuneNome = null;
  banner.style.display="none";

  hudTitle.textContent="Provincia di Verona";
  hudSub.textContent="Vista generale";

  farmMarkers.forEach(x => x.marker.setOpacity(getSt(x.id).closed?0.35:1));
  aggiornaStiliComuni();
  aggiornaComuneSelezionato();
  if(refPanelVisible) renderReferentiPanel();
}

/* ===============================
   REFERENTI COMUNE UI
================================ */
const refPanel = document.getElementById("refPanel");
const refList = document.getElementById("refList");
let refPanelVisible = false;

function renderReferentiPanel(){
  if(!selectedComuneNome){
    refList.innerHTML = `<li><span>Seleziona un comune</span></li>`;
    return;
  }
  const list = referentiComune[selectedComuneNome] || [];
  refList.innerHTML = "";
  if(!list.length){
    const li=document.createElement("li");
    li.innerHTML = `<span style="color:#bdbdbd">Nessun referente inserito.</span><span></span>`;
    refList.appendChild(li);
    return;
  }
  list.forEach(name => {
    const li=document.createElement("li");
    li.innerHTML = `<span>${esc(name)}</span><span class="xbtn" title="Rimuovi" data-rm-ref="${esc(name)}">×</span>`;
    refList.appendChild(li);
  });
}

document.getElementById("btnAddRef").addEventListener("click", () => {
  if(!selectedComuneNome){ alert("Seleziona prima un comune."); return; }
  const n = prompt("Inserisci il nome del referente (visibile nella lista)");
  if(!n) return;
  if(!referentiComune[selectedComuneNome]) referentiComune[selectedComuneNome] = [];
  if(!referentiComune[selectedComuneNome].includes(n)) referentiComune[selectedComuneNome].push(n);

  aggiornaStiliComuni();
  aggiornaHUD();
  if(refPanelVisible){
    refPanel.style.display="block";
    renderReferentiPanel();
  }
  hudSub.textContent = `Referenti presenti: ${referentiComune[selectedComuneNome].length}`;
});

document.getElementById("btnToggleRef").addEventListener("click", () => {
  if(!selectedComuneNome){ alert("Seleziona prima un comune."); return; }
  refPanelVisible = !refPanelVisible;
  refPanel.style.display = refPanelVisible ? "block" : "none";
  if(refPanelVisible) renderReferentiPanel();
  document.getElementById("btnToggleRef").textContent = refPanelVisible ? "Nascondi referenti" : "Vedi referenti";
});

refList.addEventListener("click", (ev) => {
  const t = ev.target;
  if(!(t instanceof HTMLElement)) return;
  const rm = t.getAttribute("data-rm-ref");
  if(rm && selectedComuneNome){
    referentiComune[selectedComuneNome] = (referentiComune[selectedComuneNome] || []).filter(x => x !== rm);
    aggiornaStiliComuni();
    aggiornaHUD();
    renderReferentiPanel();
    hudSub.textContent = hasRef(selectedComuneNome) ? `Referenti presenti: ${(referentiComune[selectedComuneNome]||[]).length}` : "⚠ Comune orfano";
  }
});

/* ===============================
   LOAD COMUNI + FARMACIE
================================ */
function loadComuni(){
  fetch(PATH_COMUNI)
    .then(r=>r.json())
    .then(data => {
      comuniLayer = L.geoJSON(data, {
        style: f => {
          const nome = nomeComuneFromFeature(f);
          comuneCanonByNorm[normKey(nome)] = nome;
          comuniCanon.add(nome);
          return styleComuneBase(nome);
        },
        onEachFeature: (f, layer) => {
          const nome = nomeComuneFromFeature(f);
          layer.on("click", () => selezionaComune(layer, nome));

          const center = layer.getBounds().getCenter();
          const label = L.marker(center, {
            interactive:false,
            icon: L.divIcon({ className:"label-comune", html: esc(nome), iconSize:[140,16] })
          });
          labels.push(label);
        }
      }).addTo(map);

      map.fitBounds(comuniLayer.getBounds());

      // labels on zoom
      map.on("zoomend", () => {
        const z = map.getZoom();
        const show = (!selectedComuneNome && z>=9 && z<=13);
        labels.forEach(l => { show ? map.addLayer(l) : map.removeLayer(l); });
        if(selectedComuneNome && z < 9.5) resetSelezione();
      });

      aggiornaStiliComuni();
      aggiornaHUD();
      aggiornaComuneSelezionato();

      loadFarmacie();
    });
}

function loadFarmacie(){
  Papa.parse(PATH_FARMACIE, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete: (res) => {
      const rows = res.data || [];
      let added = 0, skipped = 0;

      rows.forEach(row => {
        const comuneRaw = (row.comune || "").trim();
        if(!comuneRaw){ skipped++; return; }
        const comune = canonComune(comuneRaw);

        // Header definitivo: "coordinate" = "lat, lon"
        const coord = parseCoordinateCell(row.coordinate);
        if(!coord){ skipped++; return; }

        const farmaciaId =
          (row.farmacia_id || row.farmaciaId || row.id || "").toString().trim() ||
          stableId(`${row.maps_url||""}|${row.descrizione_farmacia||""}|${comune}`);

        // Ensure record exists
        if(!statusStore[farmaciaId]) setSt(farmaciaId, getSt(farmaciaId));

        const st = getSt(farmaciaId);
        const marker = L.marker([coord.lat, coord.lon], {
          icon: iconFarmacia(st.state, st.closed, row.gestione),
          opacity: st.closed ? 0.35 : 1
        });

        marker.bindPopup(buildPopupHtml(row, farmaciaId), { maxWidth: 420 });
        marker.on("popupopen", () => attachPopupHandlers(marker, row, farmaciaId));

        marker.addTo(farmLayer);
        farmMarkers.push({ id: farmaciaId, comune, gestione: (row.gestione||""), marker });

        applyStatusToMarker(marker, farmaciaId, row);
        added++;
      });

      aggiornaHUD();
      aggiornaComuneSelezionato();

      // se un comune è già selezionato, ripristina opacità filtro
      if(selectedComuneNome){
        farmMarkers.forEach(x => x.marker.setOpacity((x.comune===selectedComuneNome) ? (getSt(x.id).closed?0.35:1) : 0.18));
      }

      // niente debug a schermo: se vuoi, puoi loggare qui
      // console.log({added, skipped});
    }
  });
}

// START
loadComuni();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona – SpG</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{margin:0;height:100%;background:#000;font-family:system-ui}
#map{position:absolute;inset:0}

/* HUD */
#hud{
 position:fixed;top:16px;left:16px;z-index:999;
 width:360px;padding:14px;
 background:rgba(5,5,5,.94);
 border-left:4px solid #00ff9c;
 box-shadow:0 0 25px #000
}
h3{margin:0;color:#fff;font-size:18px}
.sub{color:#aaa;font-size:13px;margin-bottom:8px}

/* collapsible */
.section{border-top:1px solid #222;margin-top:10px;padding-top:8px}
.toggle{cursor:pointer;color:#9ef5d9;font-size:12px}
.content{display:none;font-size:12px;color:#ddd;margin-top:6px}

/* legend */
.legend-row{display:flex;gap:6px;align-items:center;font-size:11px}
.dot{width:12px;height:12px;border-radius:50%}
.triangle{
 width:0;height:0;
 border-left:7px solid transparent;
 border-right:7px solid transparent;
 border-bottom:12px solid #00ff9c
}

/* buttons */
button{
 background:#041812;border:1px solid #00ff9c;
 color:#eafff7;font-size:11px;
 padding:4px 8px;cursor:pointer
}
button:hover{background:#00ff9c;color:#000}

.label-comune{
 color:#fff;font-size:11px;
 text-shadow:0 0 6px #000
}
</style>
</head>

<body>
<div id="map"></div>

<div id="hud">
  <h3 id="hudTitle">Provincia di Verona</h3>
  <div class="sub" id="hudSub">Vista generale</div>

  <button id="btnAdd">Aggiungi referente</button>
  <button id="btnToggle">Vedi referenti</button>

  <ul id="refList" style="display:none;margin:6px 0 0"></ul>

  <div class="section">
    <div class="toggle" onclick="toggleBox('provBox')">▸ Provincia (overview)</div>
    <div class="content" id="provBox">
      Grafici provincia (farmacie / MMG) – prossimo step
    </div>
  </div>

  <div class="section">
    <div class="toggle" onclick="toggleBox('comBox')">▸ Comune selezionato</div>
    <div class="content" id="comBox">
      Grafici comune – prossimo step
    </div>
  </div>

  <div class="section">
    <div class="legend-row"><span class="dot" style="background:#00ff9c"></span> Comune coperto</div>
    <div class="legend-row"><span class="dot" style="background:#ffaa00"></span> Comune orfano</div>
    <div class="legend-row"><span class="dot" style="background:#00ff9c"></span> Farmacia privata</div>
    <div class="legend-row"><span class="triangle"></span> Farmacia comunale</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map=L.map('map',{attributionControl:false}).setView([45.43,10.99],10)
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map)

const stato={}, layers={}, farmLayer=L.layerGroup().addTo(map)
let selected=null, showRefs=false

/* FARMACIE – RIPRISTINATE */
const farmacie=[
 {nome:"Farmacia Centrale",comune:"Verona",lat:45.438,lng:10.992,tipo:"privata"},
 {nome:"Farmacia San Zeno",comune:"Verona",lat:45.443,lng:10.980,tipo:"comunale"},
 {nome:"Farmacia Borgo Roma",comune:"Verona",lat:45.389,lng:10.982,tipo:"privata"}
]

function mostraFarmacie(com){
 farmLayer.clearLayers()
 farmacie.filter(f=>f.comune===com).forEach(f=>{
  const icon=f.tipo==="privata"
   ?'<div class="dot" style="background:#00ff9c"></div>'
   :'<div class="triangle"></div>'
  L.marker([f.lat,f.lng],{
    icon:L.divIcon({html:icon,iconSize:[16,16]})
  }).bindPopup(`
   <strong>${f.nome}</strong><br>
   ${f.tipo}<br>
   <a target=_blank href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(f.nome+' Verona')}">Apri Maps</a><br>
   <a target=_blank href="https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm">Materiali</a>
  `).addTo(farmLayer)
 })
}

/* COMUNI */
fetch('data/comuni_verona.json').then(r=>r.json()).then(data=>{
 L.geoJSON(data,{
  style:f=>{
   const n=f.properties.nome||f.properties.DENOM_COM
   stato[n]={refs:[]};return{color:'#ffaa00',weight:1}
  },
  onEachFeature:(f,l)=>{
   const n=f.properties.nome||f.properties.DENOM_COM
   layers[n]=l
   const lbl=L.marker(l.getBounds().getCenter(),{
     icon:L.divIcon({className:'label-comune',html:n})
   }).addTo(map)
   l.on('click',()=>{
     selected=n
     hudTitle.innerText='Comune di '+n
     hudSub.innerText=stato[n].refs.length?'Coperto':'Comune orfano'
     mostraFarmacie(n)
     l.setStyle({color:'#00ff9c',weight:3})
   })
  }
 }).addTo(map)
})

btnAdd.onclick=()=>{
 if(!selected) return alert('Seleziona un comune')
 const n=prompt('Nome referente')
 if(!n) return
 stato[selected].refs.push(n)
 hudSub.innerText='Referenti: '+stato[selected].refs.length
}

btnToggle.onclick=()=>{
 if(!selected) return
 showRefs=!showRefs
 refList.innerHTML=''
 stato[selected].refs.forEach(r=>{
  const li=document.createElement('li');li.textContent=r
  refList.appendChild(li)
 })
 refList.style.display=showRefs?'block':'none'
}

function toggleBox(id){
 const el=document.getElementById(id)
 el.style.display=el.style.display==='block'?'none':'block'
}
</script>
</body>
</html>

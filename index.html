<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map { position:absolute; inset:0; }

/* ===== HUD ===== */
#hud {
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 9999;
  width: 320px;
  padding: 16px;
  background: rgba(10,10,10,.94);
  border-left: 4px solid #00ff9c;
}
.hud-title { font-size:18px; font-weight:650; color:#fff; }
.hud-sub { margin-top:4px; font-size:12px; color:#bbb; }

#stats {
  margin-top:12px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.stat { font-size:12px; background:#111; padding:8px; }
.stat strong { font-size:18px; display:block; }
.ok strong { color:#00ff9c; }
.warn strong { color:#ffaa00; }

.badge {
  margin-top:10px;
  padding:4px 8px;
  font-size:11px;
  display:inline-block;
}
.badge-ok { background:rgba(0,255,156,.15); color:#bfffe8; }
.badge-warn { background:rgba(255,170,0,.2); color:#ffd699; }

/* ===== ACTION BUTTON ===== */
#action {
  margin-top:12px;
  padding:8px;
  text-align:center;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  border-radius:4px;
  background:#00ff9c;
  color:#000;
  display:none;
}
#action:hover { background:#33ffad; }

/* ===== MAP ===== */
.label-comune {
  color:rgba(240,240,240,.9);
  font-size:11px;
  text-shadow:0 0 4px #000;
  pointer-events:none;
}
.pulse { animation:pulse .8s ease-out; }
@keyframes pulse {
  0%{stroke-opacity:.3}
  50%{stroke-opacity:1}
  100%{stroke-opacity:.3}
}
.orfano { animation:glow 2.5s infinite; }
@keyframes glow {
  0%,100%{stroke-opacity:.5}
  50%{stroke-opacity:1}
}
.leaflet-interactive{cursor:pointer}
</style>
</head>

<body>

<div id="map"></div>

<div id="hud">
  <div class="hud-title">Provincia di Verona</div>
  <div class="hud-sub">Situazione territoriale</div>

  <div id="stats">
    <div class="stat ok">
      <strong id="coperti">0</strong>comuni coperti
    </div>
    <div class="stat warn">
      <strong id="orfani">0</strong>comuni orfani
    </div>
    <div class="stat">
      <strong id="farmacie">0</strong>farmacie
    </div>
    <div class="stat">
      <strong>–</strong>medici/studi
    </div>
  </div>

  <div id="badge" class="badge badge-warn">Seleziona un comune</div>
  <div id="action" onclick="aggiungiReferente()">➕ Diventa referente</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== MOCK DB (PROVVISORI) ===== */
const referenti = { "Verona": ["Anna R.", "Luca M."] };
const farmacie = [
  { nome:"Farmacia Centrale", comune:"Verona" },
  { nome:"Farmacia San Zeno", comune:"Verona" }
];

/* ===== UTILS ===== */
function nomeComune(p){
  return p.nome || p.DENOM_COM || p.name || p.COMUNE;
}
function hasReferenti(c){
  return referenti[c] && referenti[c].length>0;
}

/* ===== ACTION ===== */
let comuneAttivo = null;
function aggiungiReferente(){
  if(!comuneAttivo) return;
  const nome = prompt("Inserisci il tuo nome");
  if(!nome) return;

  if(!referenti[comuneAttivo]) referenti[comuneAttivo]=[];
  referenti[comuneAttivo].push(nome);

  // aggiornamento badge
  document.getElementById('badge').className='badge badge-ok';
  document.getElementById('badge').innerText='Comune coperto';

  document.getElementById('action').innerText='➕ Aggiungi un altro referente';

  aggiornaStats();
}

/* ===== MAPPA ===== */
const map = L.map('map',{ attributionControl:false })
  .setView([45.43,10.99],11);

L.tileLayer(
 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
 {maxZoom:19}
).addTo(map);

let labels=[], comuniNomi=[], selected=null;

fetch('data/comuni_verona.json')
.then(r=>r.json())
.then(data=>{

  L.geoJSON(data,{style:{color:'#000',weight:4,opacity:.3}}).addTo(map);

  const layer=L.geoJSON(data,{
    style:f=>{
      const n=nomeComune(f.properties);
      comuniNomi.push(n);
      return {
        color:hasReferenti(n)?'#00ff9c':'#ffaa00',
        weight:1,
        fillOpacity:0
      };
    },
    onEachFeature:(f,l)=>{
      const nome=nomeComune(f.properties);
      const orfano=!hasReferenti(nome);

      const c=l.getBounds().getCenter();
      const lab=L.marker(c,{
        icon:L.divIcon({
          className:'label-comune',
          html:nome,
          iconSize:[130,16]
        }),
        interactive:false
      }).addTo(map);
      labels.push(lab);

      if(orfano) setTimeout(()=>l._path.classList.add('orfano'),50);

      l.on('click',()=>{
        if(selected){
          const pn=nomeComune(selected.feature.properties);
          selected.setStyle({
            weight:1,
            color:hasReferenti(pn)?'#00ff9c':'#ffaa00'
          });
        }
        selected=l;
        comuneAttivo=nome;

        l.setStyle({weight:3,color:'#fff'});
        l._path.classList.add('pulse');

        map.fitBounds(l.getBounds(),{padding:[40,40]});

        document.getElementById('badge').className=
          'badge '+(orfano?'badge-warn':'badge-ok');
        document.getElementById('badge').innerText=
          orfano?'⚠ Comune orfano':'Comune coperto';

        const action=document.getElementById('action');
        action.style.display='block';
        action.innerText=orfano?
          '➕ Diventa referente di questo comune':
          '➕ Aggiungi un altro referente';
      });
    }
  }).addTo(map);

  map.fitBounds(layer.getBounds());
  aggiornaStats();

  map.on('zoomend',()=>{
    labels.forEach(l=>map.getZoom()<=11?l.addTo(map):map.removeLayer(l));
  });
});

function aggiornaStats(){
  const cop=comuniNomi.filter(c=>hasReferenti(c)).length;
  document.getElementById('coperti').innerText=cop;
  document.getElementById('orfani').innerText=comuniNomi.length-cop;
  document.getElementById('farmacie').innerText=farmacie.length;
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#map {
  position: absolute;
  inset: 0;
}

/* ================= HUD ================= */
#hud {
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 9999;
  width: 300px;
  padding: 16px;
  background: rgba(10,10,10,.92);
  border-left: 4px solid #00ff9c;
  box-shadow: 0 0 14px rgba(0,0,0,.6);
  pointer-events: none;
}

.hud-title {
  font-size: 18px;
  font-weight: 650;
  color: #fff;
  letter-spacing: .5px;
}

.hud-sub {
  margin-top: 6px;
  font-size: 12px;
  color: #bdbdbd;
}

.hud-badge {
  margin-top: 10px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  text-transform: uppercase;
  letter-spacing: .5px;
}

.badge-ok {
  color: #bfffe8;
  border: 1px solid rgba(0,255,156,.6);
  background: rgba(0,255,156,.08);
}

.badge-warn {
  color: #ffd699;
  border: 1px solid rgba(255,170,0,.7);
  background: rgba(255,170,0,.1);
}

/* =============== MAP LABELS =============== */
.label-comune {
  color: rgba(240,240,240,.9);
  font-size: 11px;
  white-space: nowrap;
  text-shadow: 0 0 4px #000;
  pointer-events: none;
}

/* =============== ANIMAZIONI =============== */
.pulse {
  animation: pulse 1.4s ease-out;
}

@keyframes pulse {
  0% { stroke-opacity: .3 }
  50% { stroke-opacity: 1 }
  100% { stroke-opacity: .3 }
}

.leaflet-interactive { cursor: pointer; }
</style>
</head>

<body>

<div id="map"></div>

<div id="hud">
  <div class="hud-title">Provincia di Verona</div>
  <div class="hud-sub">Seleziona un comune</div>
  <div id="hud-badge" class="hud-badge badge-warn">
    Comune non selezionato
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ========== MOCK REFERENTI (TEMP) ========== */
const referentiPerComune = {
  "Verona": ["Anna R.", "Luca M."]
};

/* ============== MAPPA ============== */
const map = L.map('map', {
  attributionControl: false
}).setView([45.43,10.99], 11);

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  { maxZoom: 19 }
).addTo(map);

let selectedLayer = null;
let labels = [];

function hasReferenti(nome) {
  return referentiPerComune[nome] && referentiPerComune[nome].length > 0;
}

/* ============ COMUNI ============ */
fetch('data/comuni_verona.json')
.then(r => r.json())
.then(data => {

  // Ombra
  L.geoJSON(data, {
    style: { color:'#000', weight:4, opacity:.3 }
  }).addTo(map);

  const comuni = L.geoJSON(data, {
    style: f => {
      const nome = f.properties.nome || f.properties.DENOM_COM;
      return {
        color: hasReferenti(nome) ? '#00ff9c' : '#ffaa00',
        weight: 1,
        fillOpacity: 0
      };
    },
    onEachFeature: (f, layer) => {
      const nome = f.properties.nome || f.properties.DENOM_COM;

      // Label comunale
      const c = layer.getBounds().getCenter();
      const label = L.marker(c, {
        icon: L.divIcon({
          className: 'label-comune',
          html: nome,
          iconSize: [120,14]
        }),
        interactive: false
      }).addTo(map);
      labels.push(label);

      layer.on('mouseover', () => {
        if (layer !== selectedLayer)
          layer.setStyle({ weight:2, color:'#fff' });
      });

      layer.on('mouseout', () => {
        if (layer !== selectedLayer)
          layer.setStyle({
            weight:1,
            color: hasReferenti(nome) ? '#00ff9c' : '#ffaa00'
          });
      });

      layer.on('click', () => {
        if (selectedLayer) {
          const p = selectedLayer.feature.properties;
          selectedLayer.setStyle({
            weight:1,
            color: hasReferenti(p.nome||p.DENOM_COM) ? '#00ff9c' : '#ffaa00'
          });
        }

        selectedLayer = layer;
        layer.setStyle({ weight:3, color:'#fff' });
        layer._path.classList.add('pulse');

        map.fitBounds(layer.getBounds(), { padding:[40,40] });

        document.querySelector('.hud-title').innerText =
          'Comune di ' + nome;

        const badge = document.getElementById('hud-badge');
        if (hasReferenti(nome)) {
          badge.className = 'hud-badge badge-ok';
          badge.innerText = 'Comune coperto';
        } else {
          badge.className = 'hud-badge badge-warn';
          badge.innerText = 'âš  Comune orfano';
        }
      });
    }
  }).addTo(map);

  map.fitBounds(comuni.getBounds());

  // Mostra / nasconde etichette
  function updateLabels() {
    const z = map.getZoom();
    labels.forEach(l => z <= 11 ? l.addTo(map) : map.removeLayer(l));
  }
  map.on('zoomend', updateLabels);
  updateLabels();
});
</script>

</body>
</html>

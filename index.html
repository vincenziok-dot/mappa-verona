<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Verona – SpG</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #000;
  font-family: system-ui, sans-serif;
}
#map { position:absolute; inset:0; background:#050505; }

/* HUD */
#hud {
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 9999;
  padding: 14px 16px;
  background: rgba(5,5,5,.94);
  border-left: 4px solid #00ff9c;
  min-width: 340px;
  box-shadow: 0 0 20px rgba(0,0,0,.85);
}

.hud-title {
  font-size: 18px;
  font-weight: 650;
  color: #fff;
  text-transform: uppercase;
}
.hud-sub {
  margin-top: 6px;
  font-size: 13px;
  color: #bdbdbd;
}

/* contatori comuni */
#stats {
  margin-top: 12px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.stat {
  background: #0e0e0e;
  padding: 8px;
}
.stat-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .12em;
}
.stat-value {
  font-size: 26px;
  font-weight: 700;
}
.stat-ok .stat-value { color:#00ff9c; }
.stat-warn .stat-value { color:#ffaa00; }

/* farmacie */
#farm-box {
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid #222;
}
#farm-box h4 {
  margin: 0 0 6px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #9ef5d9;
}
#farm-count {
  font-size: 12px;
  margin-bottom: 6px;
}

/* legenda farmacie */
.legend-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
}
.dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}
.triangle {
  width: 0; height: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-bottom: 12px solid;
}

/* colori stato */
.accetta { background:#00ff9c; border-bottom-color:#00ff9c; }
.in_trattativa { background:#4da6ff; border-bottom-color:#4da6ff; }
.da_contattare { background:#ffaa00; border-bottom-color:#ffaa00; }
.rifiuta { background:#ff4d4d; border-bottom-color:#ff4d4d; }

/* buttons */
.hud-buttons {
  margin-top: 12px;
  display: flex;
  gap: 6px;
}
.hud-btn {
  border:1px solid #00ff9c;
  background:#041812;
  color:#eafff7;
  font-size:11px;
  padding:4px 8px;
  cursor:pointer;
}
.hud-btn:hover {
  background:#00ff9c;
  color:#00110b;
}

/* referenti */
.hud-section {
  margin-top: 10px;
  border-top: 1px solid #222;
  padding-top: 6px;
  display: none;
}
.hud-section li {
  font-size: 12px;
  color: #fff;
}

/* label comuni */
.label-comune {
  color: #ffffff;
  font-size: 11px;
  text-shadow: 0 0 6px rgba(0,0,0,.9);
  pointer-events: none;
}

.leaflet-interactive { cursor:pointer }
</style>
</head>

<body>

<div id="map"></div>

<div id="hud">
  <div class="hud-title" id="hudTitle">Provincia di Verona</div>
  <div class="hud-sub" id="hudSub">Vista generale</div>

  <div id="stats">
    <div class="stat stat-ok">
      <div class="stat-title">Comuni coperti</div>
      <div class="stat-value" id="cntOk">0</div>
    </div>
    <div class="stat stat-warn">
      <div class="stat-title">Comuni orfani</div>
      <div class="stat-value" id="cntOrfani">0</div>
    </div>
  </div>

  <!-- FARMACIE -->
  <div id="farm-box">
    <h4>Farmacie (comune selezionato)</h4>
    <div id="farm-count">0 farmacie</div>

    <div class="legend-row"><span class="dot accetta"></span> Privata – accetta</div>
    <div class="legend-row"><span class="triangle accetta"></span> Comunale – accetta</div>
    <div class="legend-row"><span class="dot in_trattativa"></span> Privata – in trattativa</div>
    <div class="legend-row"><span class="triangle da_contattare"></span> Comunale – da contattare</div>
  </div>

  <div class="hud-buttons">
    <button class="hud-btn" id="btnAdd">Aggiungi referente</button>
    <button class="hud-btn" id="btnToggle">Vedi referenti</button>
  </div>

  <div class="hud-section" id="refPanel">
    <ul id="refList"></ul>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* MAPPA BASE */
const map = L.map('map',{ attributionControl:false })
  .setView([45.43,10.99],10);

L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  { maxZoom:18 }
).addTo(map);

/* DATI IN MEMORIA (provvisori) */
const referenti = {
  "Verona": ["Vincenzo R."]
};

const farmacie = [
  {
    nome:"Farmacia Centrale",
    comune:"Verona",
    lat:45.438,
    lng:10.992,
    tipo:"privata",
    stato:"accetta",
    indirizzo:"Via Roma 1",
    tel:"045 0000001",
    maps:"https://www.google.com/maps/search/?api=1&query=Farmacia+Centrale+Verona"
  },
  {
    nome:"Farmacia San Zeno",
    comune:"Verona",
    lat:45.443,
    lng:10.980,
    tipo:"comunale",
    stato:"in_trattativa",
    indirizzo:"Piazza Corrubbio",
    tel:"045 0000002",
    maps:"https://www.google.com/maps/search/?api=1&query=Farmacia+San+Zeno+Verona"
  },
  {
    nome:"Farmacia Borgo Roma",
    comune:"Verona",
    lat:45.389,
    lng:10.982,
    tipo:"privata",
    stato:"da_contattare",
    indirizzo:"Via Centro 12",
    tel:"045 0000003",
    maps:"https://www.google.com/maps/search/?api=1&query=Farmacia+Borgo+Roma+Verona"
  }
];

let labels = [];
let selectedLayer = null;
let refVisibili = false;
let farmLayer = L.layerGroup().addTo(map);

/* mappa nome comune → layer, per aggiornare stili dopo i cambi */
const comuneLayers = {};

/* RIFERIMENTI HUD */
const hudTitle    = document.getElementById('hudTitle');
const hudSub      = document.getElementById('hudSub');
const refPanel    = document.getElementById('refPanel');
const refList     = document.getElementById('refList');
const btnToggle   = document.getElementById('btnToggle');
const farmCountEl = document.getElementById('farm-count');

const nomeComune = p => p.nome || p.DENOM_COM || p.name || 'Comune';
const hasRef     = n => referenti[n] && referenti[n].length>0;

/* stile di base per ogni comune (non selezionato) */
function stileBase(nome){
  const coperto = hasRef(nome);
  return {
    color: coperto ? '#00ff9c' : '#ffaa00',
    weight: coperto ? 2 : 1,
    fillColor: coperto ? '#00ff9c' : '#000000',
    fillOpacity: coperto ? 0.12 : 0
  };
}

/* ri-applica lo stile base a tutti i comuni (tranne quello selezionato) */
function aggiornaStiliComuni(){
  Object.keys(comuneLayers).forEach(n => {
    const layer = comuneLayers[n];
    if(layer === selectedLayer) return;
    layer.setStyle(stileBase(n));
  });
}

/* reset selezione */
function resetSelezione(){
  if(selectedLayer){
    const prevName = nomeComune(selectedLayer.feature.properties);
    selectedLayer.setStyle(stileBase(prevName));
  }
  selectedLayer = null;
  hudTitle.innerText = 'Provincia di Verona';
  hudSub.innerText   = 'Vista generale';
  farmLayer.clearLayers();
  farmCountEl.innerText = '0 farmacie';
  refPanel.style.display = 'none';
  refVisibili = false;
  btnToggle.innerText = 'Vedi referenti';
  aggiornaLabels();
}

/* LABELS in base allo zoom e alla selezione */
function aggiornaLabels(){
  const z = map.getZoom();
  labels.forEach(l => {
    if(!selectedLayer && z >= 9){
      if(!map.hasLayer(l)) map.addLayer(l);
    } else {
      if(map.hasLayer(l)) map.removeLayer(l);
    }
  });
}

/* COMUNI */
fetch('data/comuni_verona.json')
  .then(r => r.json())
  .then(data => {

    const layer = L.geoJSON(data,{
      style: f => {
        const n = nomeComune(f.properties);
        return stileBase(n);
      },
      onEachFeature:(f,layer) => {
        const nome = nomeComune(f.properties);
        const center = layer.getBounds().getCenter();

        comuneLayers[nome] = layer;

        const label = L.marker(center,{
          icon: L.divIcon({
            className:'label-comune',
            html: nome,
            iconSize:[120,16]
          }),
          interactive:false
        });
        labels.push(label);
        label.addTo(map);

        layer.on('click', () => selezionaComune(layer,nome));
      }
    }).addTo(map);

    map.fitBounds(layer.getBounds());
    aggiornaContatori();
    aggiornaLabels();

    map.on('zoomend', () => {
      const z = map.getZoom();
      // appena fai un po' di zoom out, se eri dentro un comune, torna vista generale
      if(selectedLayer && z <= 10.5){
        resetSelezione();
      }
      aggiornaLabels();
    });
  });

/* SELEZIONE COMUNE */
function selezionaComune(layer,nome){
  if(selectedLayer){
    const prev = nomeComune(selectedLayer.feature.properties);
    selectedLayer.setStyle(stileBase(prev));
  }

  selectedLayer = layer;
  layer.setStyle({
    color:'#ffffff',
    weight:3,
    fillOpacity:0   // NESSUN RIEMPIMENTO QUANDO SELEZIONATO
  });

  map.fitBounds(layer.getBounds(),{ padding:[40,40] });

  hudTitle.innerText = 'Comune di ' + nome;
  hudSub.innerText   = hasRef(nome)
    ? 'Referenti presenti: ' + referenti[nome].length
    : '⚠ Comune orfano';

  // nascondi labels quando sto lavorando sul singolo comune
  labels.forEach(l => { if(map.hasLayer(l)) map.removeLayer(l); });

  mostraFarmacie(nome);
}

/* FARMACIE PER COMUNE */
function mostraFarmacie(comune){
  farmLayer.clearLayers();
  const vis = farmacie.filter(f => f.comune === comune);
  farmCountEl.innerText = vis.length + ' farmacie';

  vis.forEach(f => {
    const simbolo = f.tipo === 'privata'
      ? `<div class="dot ${f.stato}"></div>`
      : `<div class="triangle ${f.stato}"></div>`;

    const popupHtml = `
      <strong>${f.nome}</strong><br/>
      ${f.tipo} – ${f.indirizzo}<br/>
      Tel: ${f.tel}<br/>
      <a href="${f.maps}" target="_blank">Apri in Maps</a><br/>
      <a href="https://drive.google.com/drive/folders/1f9JTPwuquc1epCO6rpsONh2fFes8yabm" target="_blank">
        Materiali campagna
      </a>
    `;

    const m = L.marker([f.lat,f.lng],{
      icon: L.divIcon({ html: simbolo, iconSize:[14,14], className:'' })
    }).bindPopup(popupHtml);

    farmLayer.addLayer(m);
  });
}

/* CONTATORI COMUNI GLOBALI */
function aggiornaContatori(){
  const nomi = Object.keys(comuneLayers);
  const ok   = nomi.filter(n => hasRef(n)).length;
  const orfani = nomi.length - ok;
  document.getElementById('cntOk').innerText      = ok;
  document.getElementById('cntOrfani').innerText  = orfani;
}

/* REFERENTI: AGGIUNGI */
document.getElementById('btnAdd').onclick = () => {
  if(!selectedLayer){
    alert('Seleziona prima un comune sulla mappa');
    return;
  }
  const nomeComuneSel = hudTitle.innerText.replace('Comune di ','');
  const n = prompt('Inserisci il tuo nome (verrà mostrato come referente)');
  if(!n) return;
  if(!referenti[nomeComuneSel]) referenti[nomeComuneSel] = [];
  referenti[nomeComuneSel].push(n);

  hudSub.innerText = 'Referenti presenti: ' + referenti[nomeComuneSel].length;

  aggiornaStiliComuni();   // aggiorna colori (arancio⇄verde)
  aggiornaContatori();     // aggiorna contatori globali

  if(refVisibili) mostraReferenti(nomeComuneSel);
};

/* REFERENTI: TOGGLE VEDI/NASCONDI */
document.getElementById('btnToggle').onclick = () => {
  refVisibili = !refVisibili;
  btnToggle.innerText = refVisibili ? 'Nascondi referenti' : 'Vedi referenti';

  if(refVisibili && selectedLayer){
    const nomeComuneSel = hudTitle.innerText.replace('Comune di ','');
    mostraReferenti(nomeComuneSel);
  } else {
    refPanel.style.display = 'none';
  }
};

function mostraReferenti(nome){
  refList.innerHTML = '';
  const lista = referenti[nome] || [];
  lista.forEach(r => {
    const li = document.createElement('li');
    li.textContent = r;
    refList.appendChild(li);
  });
  refPanel.style.display = lista.length ? 'block' : 'none';
}
</script>

</body>
</html>
